<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Kubernetesè¯¦ç»†æ•™ç¨‹ | DevOpsHub</title>
<meta name="keywords" content="Kubernetes">
<meta name="description" content="Kubernetes æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å¼•æ“ï¼Œç”¨æ¥å¯¹å®¹å™¨åŒ–åº”ç”¨è¿›è¡Œè‡ªåŠ¨åŒ–éƒ¨ç½²ã€ æ‰©ç¼©å’Œç®¡ç†">
<meta name="author" content="">
<link rel="canonical" href="https://old.colorfulgz.com/posts/kubernetes/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://old.colorfulgz.com/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://old.colorfulgz.com/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://old.colorfulgz.com/img/Q.gif">
<link rel="apple-touch-icon" href="https://old.colorfulgz.com/img/Q.gif">
<link rel="mask-icon" href="https://old.colorfulgz.com/img/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<link rel="stylesheet" href="https://gitee.com/xyenvy/hugo-style/blob/master/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="https://gitee.com/xyenvy/hugo-style/blob/master/jquery.min.js"></script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="Kubernetesè¯¦ç»†æ•™ç¨‹" />
<meta property="og:description" content="Kubernetes æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å¼•æ“ï¼Œç”¨æ¥å¯¹å®¹å™¨åŒ–åº”ç”¨è¿›è¡Œè‡ªåŠ¨åŒ–éƒ¨ç½²ã€ æ‰©ç¼©å’Œç®¡ç†" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://old.colorfulgz.com/posts/kubernetes/" />
<meta property="og:image" content="https://old.colorfulgz.com/posts.images/banner/index.jpg" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-20T00:23:06+08:00" />
<meta property="article:modified_time" content="2023-05-20T00:23:06+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://old.colorfulgz.com/posts.images/banner/index.jpg" />
<meta name="twitter:title" content="Kubernetesè¯¦ç»†æ•™ç¨‹"/>
<meta name="twitter:description" content="Kubernetes æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å¼•æ“ï¼Œç”¨æ¥å¯¹å®¹å™¨åŒ–åº”ç”¨è¿›è¡Œè‡ªåŠ¨åŒ–éƒ¨ç½²ã€ æ‰©ç¼©å’Œç®¡ç†"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "ğŸ“šæ–‡ç« ",
          "item": "https://old.colorfulgz.com/posts/"
        }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Kubernetesè¯¦ç»†æ•™ç¨‹",
      "item": "https://old.colorfulgz.com/posts/kubernetes/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Kubernetesè¯¦ç»†æ•™ç¨‹",
  "name": "Kubernetesè¯¦ç»†æ•™ç¨‹",
  "description": "Kubernetes æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å¼•æ“ï¼Œç”¨æ¥å¯¹å®¹å™¨åŒ–åº”ç”¨è¿›è¡Œè‡ªåŠ¨åŒ–éƒ¨ç½²ã€ æ‰©ç¼©å’Œç®¡ç†",
  "keywords": [
    "Kubernetes"
  ],
  "articleBody": "Kubernetesè¯¦ç»†æ•™ç¨‹ 1. Kubernetesä»‹ç» 1.1 åº”ç”¨éƒ¨ç½²æ–¹å¼æ¼”å˜ åœ¨éƒ¨ç½²åº”ç”¨ç¨‹åºçš„æ–¹å¼ä¸Šï¼Œä¸»è¦ç»å†äº†ä¸‰ä¸ªæ—¶ä»£ï¼š\nä¼ ç»Ÿéƒ¨ç½²ï¼šäº’è”ç½‘æ—©æœŸï¼Œä¼šç›´æ¥å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åœ¨ç‰©ç†æœºä¸Š\nä¼˜ç‚¹ï¼šç®€å•ï¼Œä¸éœ€è¦å…¶å®ƒæŠ€æœ¯çš„å‚ä¸\nç¼ºç‚¹ï¼šä¸èƒ½ä¸ºåº”ç”¨ç¨‹åºå®šä¹‰èµ„æºä½¿ç”¨è¾¹ç•Œï¼Œå¾ˆéš¾åˆç†åœ°åˆ†é…è®¡ç®—èµ„æºï¼Œè€Œä¸”ç¨‹åºä¹‹é—´å®¹æ˜“äº§ç”Ÿå½±å“\nè™šæ‹ŸåŒ–éƒ¨ç½²ï¼šå¯ä»¥åœ¨ä¸€å°ç‰©ç†æœºä¸Šè¿è¡Œå¤šä¸ªè™šæ‹Ÿæœºï¼Œæ¯ä¸ªè™šæ‹Ÿæœºéƒ½æ˜¯ç‹¬ç«‹çš„ä¸€ä¸ªç¯å¢ƒ\nä¼˜ç‚¹ï¼šç¨‹åºç¯å¢ƒä¸ä¼šç›¸äº’äº§ç”Ÿå½±å“ï¼Œæä¾›äº†ä¸€å®šç¨‹åº¦çš„å®‰å…¨æ€§\nç¼ºç‚¹ï¼šå¢åŠ äº†æ“ä½œç³»ç»Ÿï¼Œæµªè´¹äº†éƒ¨åˆ†èµ„æº\nå®¹å™¨åŒ–éƒ¨ç½²ï¼šä¸è™šæ‹ŸåŒ–ç±»ä¼¼ï¼Œä½†æ˜¯å…±äº«äº†æ“ä½œç³»ç»Ÿ\nä¼˜ç‚¹ï¼š\nå¯ä»¥ä¿è¯æ¯ä¸ªå®¹å™¨æ‹¥æœ‰è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿã€CPUã€å†…å­˜ã€è¿›ç¨‹ç©ºé—´ç­‰\nè¿è¡Œåº”ç”¨ç¨‹åºæ‰€éœ€è¦çš„èµ„æºéƒ½è¢«å®¹å™¨åŒ…è£…ï¼Œå¹¶å’Œåº•å±‚åŸºç¡€æ¶æ„è§£è€¦\nå®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºå¯ä»¥è·¨äº‘æœåŠ¡å•†ã€è·¨Linuxæ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆè¿›è¡Œéƒ¨ç½²\nå®¹å™¨åŒ–éƒ¨ç½²æ–¹å¼ç»™å¸¦æ¥å¾ˆå¤šçš„ä¾¿åˆ©ï¼Œä½†æ˜¯ä¹Ÿä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚è¯´ï¼š\nä¸€ä¸ªå®¹å™¨æ•…éšœåœæœºäº†ï¼Œæ€ä¹ˆæ ·è®©å¦å¤–ä¸€ä¸ªå®¹å™¨ç«‹åˆ»å¯åŠ¨å»æ›¿è¡¥åœæœºçš„å®¹å™¨ å½“å¹¶å‘è®¿é—®é‡å˜å¤§çš„æ—¶å€™ï¼Œæ€ä¹ˆæ ·åšåˆ°æ¨ªå‘æ‰©å±•å®¹å™¨æ•°é‡ è¿™äº›å®¹å™¨ç®¡ç†çš„é—®é¢˜ç»Ÿç§°ä¸ºå®¹å™¨ç¼–æ’é—®é¢˜ï¼Œä¸ºäº†è§£å†³è¿™äº›å®¹å™¨ç¼–æ’é—®é¢˜ï¼Œå°±äº§ç”Ÿäº†ä¸€äº›å®¹å™¨ç¼–æ’çš„è½¯ä»¶ï¼š\nSwarmï¼šDockerè‡ªå·±çš„å®¹å™¨ç¼–æ’å·¥å…· Mesosï¼šApacheçš„ä¸€ä¸ªèµ„æºç»Ÿä¸€ç®¡æ§çš„å·¥å…·ï¼Œéœ€è¦å’ŒMarathonç»“åˆä½¿ç”¨ Kubernetesï¼šGoogleå¼€æºçš„çš„å®¹å™¨ç¼–æ’å·¥å…· 1.2 kubernetesç®€ä»‹ kubernetesï¼Œæ˜¯ä¸€ä¸ªå…¨æ–°çš„åŸºäºå®¹å™¨æŠ€æœ¯çš„åˆ†å¸ƒå¼æ¶æ„é¢†å…ˆæ–¹æ¡ˆï¼Œæ˜¯è°·æ­Œä¸¥æ ¼ä¿å¯†åå‡ å¹´çš„ç§˜å¯†æ­¦å™¨â€”-Borgç³»ç»Ÿçš„ä¸€ä¸ªå¼€æºç‰ˆæœ¬ï¼Œäº2014å¹´9æœˆå‘å¸ƒç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œ2015å¹´7æœˆå‘å¸ƒç¬¬ä¸€ä¸ªæ­£å¼ç‰ˆæœ¬ã€‚\nkubernetesçš„æœ¬è´¨æ˜¯ä¸€ç»„æœåŠ¡å™¨é›†ç¾¤ï¼Œå®ƒå¯ä»¥åœ¨é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œç‰¹å®šçš„ç¨‹åºï¼Œæ¥å¯¹èŠ‚ç‚¹ä¸­çš„å®¹å™¨è¿›è¡Œç®¡ç†ã€‚ç›®çš„æ˜¯å®ç°èµ„æºç®¡ç†çš„è‡ªåŠ¨åŒ–ï¼Œä¸»è¦æä¾›äº†å¦‚ä¸‹çš„ä¸»è¦åŠŸèƒ½ï¼š\nè‡ªæˆ‘ä¿®å¤ï¼šä¸€æ—¦æŸä¸€ä¸ªå®¹å™¨å´©æºƒï¼Œèƒ½å¤Ÿåœ¨1ç§’ä¸­å·¦å³è¿…é€Ÿå¯åŠ¨æ–°çš„å®¹å™¨ å¼¹æ€§ä¼¸ç¼©ï¼šå¯ä»¥æ ¹æ®éœ€è¦ï¼Œè‡ªåŠ¨å¯¹é›†ç¾¤ä¸­æ­£åœ¨è¿è¡Œçš„å®¹å™¨æ•°é‡è¿›è¡Œè°ƒæ•´ æœåŠ¡å‘ç°ï¼šæœåŠ¡å¯ä»¥é€šè¿‡è‡ªåŠ¨å‘ç°çš„å½¢å¼æ‰¾åˆ°å®ƒæ‰€ä¾èµ–çš„æœåŠ¡ è´Ÿè½½å‡è¡¡ï¼šå¦‚æœä¸€ä¸ªæœåŠ¡èµ·åŠ¨äº†å¤šä¸ªå®¹å™¨ï¼Œèƒ½å¤Ÿè‡ªåŠ¨å®ç°è¯·æ±‚çš„è´Ÿè½½å‡è¡¡ ç‰ˆæœ¬å›é€€ï¼šå¦‚æœå‘ç°æ–°å‘å¸ƒçš„ç¨‹åºç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œå¯ä»¥ç«‹å³å›é€€åˆ°åŸæ¥çš„ç‰ˆæœ¬ å­˜å‚¨ç¼–æ’ï¼šå¯ä»¥æ ¹æ®å®¹å™¨è‡ªèº«çš„éœ€æ±‚è‡ªåŠ¨åˆ›å»ºå­˜å‚¨å· 1.3 kubernetesç»„ä»¶ ä¸€ä¸ªkubernetesé›†ç¾¤ä¸»è¦æ˜¯ç”±æ§åˆ¶èŠ‚ç‚¹(master)ã€å·¥ä½œèŠ‚ç‚¹(node)æ„æˆï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½ä¼šå®‰è£…ä¸åŒçš„ç»„ä»¶ã€‚\nmasterï¼šé›†ç¾¤çš„æ§åˆ¶å¹³é¢ï¼Œè´Ÿè´£é›†ç¾¤çš„å†³ç­– ( ç®¡ç† )\nApiServer : èµ„æºæ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œæ¥æ”¶ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤ï¼Œæä¾›è®¤è¯ã€æˆæƒã€APIæ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶\nScheduler : è´Ÿè´£é›†ç¾¤èµ„æºè°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°†Podè°ƒåº¦åˆ°ç›¸åº”çš„nodeèŠ‚ç‚¹ä¸Š\nControllerManager : è´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚ç¨‹åºéƒ¨ç½²å®‰æ’ã€æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•ã€æ»šåŠ¨æ›´æ–°ç­‰\nEtcd ï¼šè´Ÿè´£å­˜å‚¨é›†ç¾¤ä¸­å„ç§èµ„æºå¯¹è±¡çš„ä¿¡æ¯\nnodeï¼šé›†ç¾¤çš„æ•°æ®å¹³é¢ï¼Œè´Ÿè´£ä¸ºå®¹å™¨æä¾›è¿è¡Œç¯å¢ƒ ( å¹²æ´» )\nKubelet : è´Ÿè´£ç»´æŠ¤å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå³é€šè¿‡æ§åˆ¶dockerï¼Œæ¥åˆ›å»ºã€æ›´æ–°ã€é”€æ¯å®¹å™¨\nKubeProxy : è´Ÿè´£æä¾›é›†ç¾¤å†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡\nDocker : è´Ÿè´£èŠ‚ç‚¹ä¸Šå®¹å™¨çš„å„ç§æ“ä½œ\nä¸‹é¢ï¼Œä»¥éƒ¨ç½²ä¸€ä¸ªnginxæœåŠ¡æ¥è¯´æ˜kubernetesç³»ç»Ÿå„ä¸ªç»„ä»¶è°ƒç”¨å…³ç³»ï¼š\né¦–å…ˆè¦æ˜ç¡®ï¼Œä¸€æ—¦kubernetesç¯å¢ƒå¯åŠ¨ä¹‹åï¼Œmasterå’Œnodeéƒ½ä¼šå°†è‡ªèº«çš„ä¿¡æ¯å­˜å‚¨åˆ°etcdæ•°æ®åº“ä¸­\nä¸€ä¸ªnginxæœåŠ¡çš„å®‰è£…è¯·æ±‚ä¼šé¦–å…ˆè¢«å‘é€åˆ°masterèŠ‚ç‚¹çš„apiServerç»„ä»¶\napiServerç»„ä»¶ä¼šè°ƒç”¨schedulerç»„ä»¶æ¥å†³å®šåˆ°åº•åº”è¯¥æŠŠè¿™ä¸ªæœåŠ¡å®‰è£…åˆ°å“ªä¸ªnodeèŠ‚ç‚¹ä¸Š\nåœ¨æ­¤æ—¶ï¼Œå®ƒä¼šä»etcdä¸­è¯»å–å„ä¸ªnodeèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œç„¶åæŒ‰ç…§ä¸€å®šçš„ç®—æ³•è¿›è¡Œé€‰æ‹©ï¼Œå¹¶å°†ç»“æœå‘ŠçŸ¥apiServer\napiServerè°ƒç”¨controller-managerå»è°ƒåº¦NodeèŠ‚ç‚¹å®‰è£…nginxæœåŠ¡\nkubeletæ¥æ”¶åˆ°æŒ‡ä»¤åï¼Œä¼šé€šçŸ¥dockerï¼Œç„¶åç”±dockeræ¥å¯åŠ¨ä¸€ä¸ªnginxçš„pod\npodæ˜¯kubernetesçš„æœ€å°æ“ä½œå•å…ƒï¼Œå®¹å™¨å¿…é¡»è·‘åœ¨podä¸­è‡³æ­¤ï¼Œ\nä¸€ä¸ªnginxæœåŠ¡å°±è¿è¡Œäº†ï¼Œå¦‚æœéœ€è¦è®¿é—®nginxï¼Œå°±éœ€è¦é€šè¿‡kube-proxyæ¥å¯¹podäº§ç”Ÿè®¿é—®çš„ä»£ç†\nè¿™æ ·ï¼Œå¤–ç•Œç”¨æˆ·å°±å¯ä»¥è®¿é—®é›†ç¾¤ä¸­çš„nginxæœåŠ¡äº†\n1.4 kubernetesæ¦‚å¿µ Masterï¼šé›†ç¾¤æ§åˆ¶èŠ‚ç‚¹ï¼Œæ¯ä¸ªé›†ç¾¤éœ€è¦è‡³å°‘ä¸€ä¸ªmasterèŠ‚ç‚¹è´Ÿè´£é›†ç¾¤çš„ç®¡æ§\nNodeï¼šå·¥ä½œè´Ÿè½½èŠ‚ç‚¹ï¼Œç”±masteråˆ†é…å®¹å™¨åˆ°è¿™äº›nodeå·¥ä½œèŠ‚ç‚¹ä¸Šï¼Œç„¶ånodeèŠ‚ç‚¹ä¸Šçš„dockerè´Ÿè´£å®¹å™¨çš„è¿è¡Œ\nPodï¼škubernetesçš„æœ€å°æ§åˆ¶å•å…ƒï¼Œå®¹å™¨éƒ½æ˜¯è¿è¡Œåœ¨podä¸­çš„ï¼Œä¸€ä¸ªpodä¸­å¯ä»¥æœ‰1ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨\nControllerï¼šæ§åˆ¶å™¨ï¼Œé€šè¿‡å®ƒæ¥å®ç°å¯¹podçš„ç®¡ç†ï¼Œæ¯”å¦‚å¯åŠ¨podã€åœæ­¢podã€ä¼¸ç¼©podçš„æ•°é‡ç­‰ç­‰\nServiceï¼špodå¯¹å¤–æœåŠ¡çš„ç»Ÿä¸€å…¥å£ï¼Œä¸‹é¢å¯ä»¥ç»´æŠ¤è€…åŒä¸€ç±»çš„å¤šä¸ªpod\nLabelï¼šæ ‡ç­¾ï¼Œç”¨äºå¯¹podè¿›è¡Œåˆ†ç±»ï¼ŒåŒä¸€ç±»podä¼šæ‹¥æœ‰ç›¸åŒçš„æ ‡ç­¾\nNameSpaceï¼šå‘½åç©ºé—´ï¼Œç”¨æ¥éš”ç¦»podçš„è¿è¡Œç¯å¢ƒ\n2. kubernetesé›†ç¾¤ç¯å¢ƒæ­å»º 2.1 å‰ç½®çŸ¥è¯†ç‚¹ ç›®å‰ç”Ÿäº§éƒ¨ç½²Kubernetes é›†ç¾¤ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š\nkubeadm\nKubeadm æ˜¯ä¸€ä¸ªK8s éƒ¨ç½²å·¥å…·ï¼Œæä¾›kubeadm init å’Œkubeadm joinï¼Œç”¨äºå¿«é€Ÿéƒ¨ç½²Kubernetes é›†ç¾¤ã€‚\nå®˜æ–¹åœ°å€ï¼šhttps:/kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/\näºŒè¿›åˆ¶åŒ…\nä»github ä¸‹è½½å‘è¡Œç‰ˆçš„äºŒè¿›åˆ¶åŒ…ï¼Œæ‰‹åŠ¨éƒ¨ç½²æ¯ä¸ªç»„ä»¶ï¼Œç»„æˆKubernetes é›†ç¾¤ã€‚\nKubeadm é™ä½éƒ¨ç½²é—¨æ§›ï¼Œä½†å±è”½äº†å¾ˆå¤šç»†èŠ‚ï¼Œé‡åˆ°é—®é¢˜å¾ˆéš¾æ’æŸ¥ã€‚å¦‚æœæƒ³æ›´å®¹æ˜“å¯æ§ï¼Œæ¨èä½¿ç”¨äºŒè¿›åˆ¶åŒ…éƒ¨ç½²Kubernetes é›†ç¾¤ï¼Œè™½ç„¶æ‰‹åŠ¨éƒ¨ç½²éº»çƒ¦ç‚¹ï¼ŒæœŸé—´å¯ä»¥å­¦ä¹ å¾ˆå¤šå·¥ä½œåŸç†ï¼Œä¹Ÿåˆ©äºåæœŸç»´æŠ¤ã€‚\n2.2 kubeadm éƒ¨ç½²æ–¹å¼ä»‹ç» kubeadm æ˜¯å®˜æ–¹ç¤¾åŒºæ¨å‡ºçš„ä¸€ä¸ªç”¨äºå¿«é€Ÿéƒ¨ç½²kubernetes é›†ç¾¤çš„å·¥å…·ï¼Œè¿™ä¸ªå·¥å…·èƒ½é€šè¿‡ä¸¤æ¡æŒ‡ä»¤å®Œæˆä¸€ä¸ªkubernetes é›†ç¾¤çš„éƒ¨ç½²ï¼š\nåˆ›å»ºä¸€ä¸ªMaster èŠ‚ç‚¹kubeadm init å°†Node èŠ‚ç‚¹åŠ å…¥åˆ°å½“å‰é›†ç¾¤ä¸­$ kubeadm join 2.3 å®‰è£…è¦æ±‚ åœ¨å¼€å§‹ä¹‹å‰ï¼Œéƒ¨ç½²Kubernetes é›†ç¾¤æœºå™¨éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š\nä¸€å°æˆ–å¤šå°æœºå™¨ï¼Œæ“ä½œç³»ç»ŸCentOS7.x-86_x64 ç¡¬ä»¶é…ç½®ï¼š2GB æˆ–æ›´å¤šRAMï¼Œ2 ä¸ªCPU æˆ–æ›´å¤šCPUï¼Œç¡¬ç›˜30GB æˆ–æ›´å¤š é›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨ä¹‹é—´ç½‘ç»œäº’é€š å¯ä»¥è®¿é—®å¤–ç½‘ï¼Œéœ€è¦æ‹‰å–é•œåƒ ç¦æ­¢swap åˆ†åŒº 2.4 æœ€ç»ˆç›®æ ‡ åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå®‰è£…Docker å’Œkubeadm éƒ¨ç½²Kubernetes Master éƒ¨ç½²å®¹å™¨ç½‘ç»œæ’ä»¶ éƒ¨ç½²Kubernetes Nodeï¼Œå°†èŠ‚ç‚¹åŠ å…¥Kubernetes é›†ç¾¤ä¸­ éƒ¨ç½²Dashboard Web é¡µé¢ï¼Œå¯è§†åŒ–æŸ¥çœ‹Kubernetes èµ„æº 2.5 å‡†å¤‡ç¯å¢ƒ è§’è‰² IPåœ°å€ ç»„ä»¶ master01 192.168.90.100 dockerï¼Œkubectlï¼Œkubeadmï¼Œkubelet node01 192.168.90.106 dockerï¼Œkubectlï¼Œkubeadmï¼Œkubelet node02 192.168.90.107 dockerï¼Œkubectlï¼Œkubeadmï¼Œkubelet 2.6 ç¯å¢ƒåˆå§‹åŒ– 2.6.1 æ£€æŸ¥æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬ # æ­¤æ–¹å¼ä¸‹å®‰è£…kubernetesé›†ç¾¤è¦æ±‚Centosç‰ˆæœ¬è¦åœ¨7.5æˆ–ä¹‹ä¸Š [root@master ~]# cat /etc/redhat-release Centos Linux 7.5.1804 (Core) 2.6.2 ä¸»æœºåè§£æ ä¸ºäº†æ–¹ä¾¿é›†ç¾¤èŠ‚ç‚¹é—´çš„ç›´æ¥è°ƒç”¨ï¼Œåœ¨è¿™ä¸ªé…ç½®ä¸€ä¸‹ä¸»æœºåè§£æï¼Œä¼ä¸šä¸­æ¨èä½¿ç”¨å†…éƒ¨DNSæœåŠ¡å™¨\n# ä¸»æœºåæˆè§£æ ç¼–è¾‘ä¸‰å°æœåŠ¡å™¨çš„/etc/hostsæ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢å†…å®¹ 192.168.90.100 master 192.168.90.106 node1 192.168.90.107 node2 2.6.3 æ—¶é—´åŒæ­¥ kubernetesè¦æ±‚é›†ç¾¤ä¸­çš„èŠ‚ç‚¹æ—¶é—´å¿…é¡»ç²¾ç¡®ä¸€ç›´ï¼Œè¿™é‡Œä½¿ç”¨chronydæœåŠ¡ä»ç½‘ç»œåŒæ­¥æ—¶é—´\nä¼ä¸šä¸­å»ºè®®é…ç½®å†…éƒ¨çš„ä¼šè§åŒæ­¥æœåŠ¡å™¨\n# å¯åŠ¨chronydæœåŠ¡ [root@master ~]# systemctl start chronyd [root@master ~]# systemctl enable chronyd [root@master ~]# date 2.6.4 ç¦ç”¨iptableå’ŒfirewalldæœåŠ¡ kuberneteså’Œdocker åœ¨è¿è¡Œçš„ä¸­ä¼šäº§ç”Ÿå¤§é‡çš„iptablesè§„åˆ™ï¼Œä¸ºäº†ä¸è®©ç³»ç»Ÿè§„åˆ™è·Ÿå®ƒä»¬æ··æ·†ï¼Œç›´æ¥å…³é—­ç³»ç»Ÿçš„è§„åˆ™\n# 1 å…³é—­firewalldæœåŠ¡ [root@master ~]# systemctl stop firewalld [root@master ~]# systemctl disable firewalld # 2 å…³é—­iptablesæœåŠ¡ [root@master ~]# systemctl stop iptables [root@master ~]# systemctl disable iptables 2.6.5 ç¦ç”¨selinux selinuxæ˜¯linuxç³»ç»Ÿä¸‹çš„ä¸€ä¸ªå®‰å…¨æœåŠ¡ï¼Œå¦‚æœä¸å…³é—­å®ƒï¼Œåœ¨å®‰è£…é›†ç¾¤ä¸­ä¼šäº§ç”Ÿå„ç§å„æ ·çš„å¥‡è‘©é—®é¢˜\n# ç¼–è¾‘ /etc/selinux/config æ–‡ä»¶ï¼Œä¿®æ”¹SELINUXçš„å€¼ä¸ºdisable # æ³¨æ„ä¿®æ”¹å®Œæ¯•ä¹‹åéœ€è¦é‡å¯linuxæœåŠ¡ SELINUX=disabled 2.6.6 ç¦ç”¨swapåˆ†åŒº swapåˆ†åŒºæŒ‡çš„æ˜¯è™šæ‹Ÿå†…å­˜åˆ†åŒºï¼Œå®ƒçš„ä½œç”¨æ˜¯ç‰©ç†å†…å­˜ä½¿ç”¨å®Œï¼Œä¹‹åå°†ç£ç›˜ç©ºé—´è™šæ‹Ÿæˆå†…å­˜æ¥ä½¿ç”¨ï¼Œå¯ç”¨swapè®¾å¤‡ä¼šå¯¹ç³»ç»Ÿçš„æ€§èƒ½äº§ç”Ÿéå¸¸è´Ÿé¢çš„å½±å“ï¼Œå› æ­¤kubernetesè¦æ±‚æ¯ä¸ªèŠ‚ç‚¹éƒ½è¦ç¦ç”¨swapè®¾å¤‡ï¼Œä½†æ˜¯å¦‚æœå› ä¸ºæŸäº›åŸå› ç¡®å®ä¸èƒ½å…³é—­swapåˆ†åŒºï¼Œå°±éœ€è¦åœ¨é›†ç¾¤å®‰è£…è¿‡ç¨‹ä¸­é€šè¿‡æ˜ç¡®çš„å‚æ•°è¿›è¡Œé…ç½®è¯´æ˜\n# ç¼–è¾‘åˆ†åŒºé…ç½®æ–‡ä»¶/etc/fstabï¼Œæ³¨é‡Šæ‰swapåˆ†åŒºä¸€è¡Œ # æ³¨æ„ä¿®æ”¹å®Œæ¯•ä¹‹åéœ€è¦é‡å¯linuxæœåŠ¡ vim /etc/fstab æ³¨é‡Šæ‰ /dev/mapper/centos-swap swap # /dev/mapper/centos-swap swap 2.6.7 ä¿®æ”¹linuxçš„å†…æ ¸å‚æ•° # ä¿®æ”¹linuxçš„å†…æ ¸é‡‡çº³æ•°ï¼Œæ·»åŠ ç½‘æ¡¥è¿‡æ»¤å’Œåœ°å€è½¬å‘åŠŸèƒ½ # ç¼–è¾‘/etc/sysctl.d/kubernetes.confæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®ï¼š net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 net.ipv4.ip_forward = 1 # é‡æ–°åŠ è½½é…ç½® [root@master ~]# sysctl -p # åŠ è½½ç½‘æ¡¥è¿‡æ»¤æ¨¡å— [root@master ~]# modprobe br_netfilter # æŸ¥çœ‹ç½‘æ¡¥è¿‡æ»¤æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ [root@master ~]# lsmod | grep br_netfilter 2.6.8 é…ç½®ipvsåŠŸèƒ½ åœ¨Kubernetesä¸­Serviceæœ‰ä¸¤ç§å¸¦æ¥æ¨¡å‹ï¼Œä¸€ç§æ˜¯åŸºäºiptablesçš„ï¼Œä¸€ç§æ˜¯åŸºäºipvsçš„ä¸¤è€…æ¯”è¾ƒçš„è¯ï¼Œipvsçš„æ€§èƒ½æ˜æ˜¾è¦é«˜ä¸€äº›ï¼Œä½†æ˜¯å¦‚æœè¦ä½¿ç”¨å®ƒï¼Œéœ€è¦æ‰‹åŠ¨è½½å…¥ipvsæ¨¡å—\n# 1.å®‰è£…ipsetå’Œipvsadm [root@master ~]# yum install ipset ipvsadm -y # 2.æ·»åŠ éœ€è¦åŠ è½½çš„æ¨¡å—å†™å…¥è„šæœ¬æ–‡ä»¶ [root@master ~]# cat \u003c /etc/sysconfig/modules/ipvs.modules #!/bin/bash modprobe -- ip_vs modprobe -- ip_vs_rr modprobe -- ip_vs_wrr modprobe -- ip_vs_sh modprobe -- nf_conntrack_ipv4 EOF # 3.ä¸ºè„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™ [root@master ~]# chmod +x /etc/sysconfig/modules/ipvs.modules # 4.æ‰§è¡Œè„šæœ¬æ–‡ä»¶ [root@master ~]# /bin/bash /etc/sysconfig/modules/ipvs.modules # 5.æŸ¥çœ‹å¯¹åº”çš„æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ [root@master ~]# lsmod | grep -e ip_vs -e nf_conntrack_ipv4 2.6.9 å®‰è£…docker # 1ã€åˆ‡æ¢é•œåƒæº [root@master ~]# wget https:/mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo # 2ã€æŸ¥çœ‹å½“å‰é•œåƒæºä¸­æ”¯æŒçš„dockerç‰ˆæœ¬ [root@master ~]# yum list docker-ce --showduplicates # 3ã€å®‰è£…ç‰¹å®šç‰ˆæœ¬çš„docker-ce # å¿…é¡»åˆ¶å®š--setopt=obsoletes=0ï¼Œå¦åˆ™yumä¼šè‡ªåŠ¨å®‰è£…æ›´é«˜ç‰ˆæœ¬ [root@master ~]# yum install --setopt=obsoletes=0 docker-ce-18.06.3.ce-3.el7 -y # 4ã€æ·»åŠ ä¸€ä¸ªé…ç½®æ–‡ä»¶ #Docker åœ¨é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨Vgroup Driverä¸ºcgroupfsï¼Œè€ŒKubernetesæ¨èä½¿ç”¨systemdæ¥æ›¿ä»£cgroupfs [root@master ~]# mkdir /etc/docker [root@master ~]# cat \u003c /etc/docker/daemon.json { \"exec-opts\": [\"native.cgroupdriver=systemd\"], \"registry-mirrors\": [\"https:/kn0t2bca.mirror.aliyuncs.com\"] } EOF # 5ã€å¯åŠ¨dokcer [root@master ~]# systemctl restart docker [root@master ~]# systemctl enable docker 2.6.10 å®‰è£…Kubernetesç»„ä»¶ # 1ã€ç”±äºkubernetesçš„é•œåƒåœ¨å›½å¤–ï¼Œé€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œè¿™é‡Œåˆ‡æ¢æˆå›½å†…çš„é•œåƒæº # 2ã€ç¼–è¾‘/etc/yum.repos.d/kubernetes.repo,æ·»åŠ ä¸‹é¢çš„é…ç½® [kubernetes] name=Kubernetes baseurl=http:/mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64 enabled=1 gpgchech=0 repo_gpgcheck=0 gpgkey=http:/mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http:/mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg # 3ã€å®‰è£…kubeadmã€kubeletå’Œkubectl [root@master ~]# yum install --setopt=obsoletes=0 kubeadm-1.17.4-0 kubelet-1.17.4-0 kubectl-1.17.4-0 -y # 4ã€é…ç½®kubeletçš„cgroup #ç¼–è¾‘/etc/sysconfig/kubelet, æ·»åŠ ä¸‹é¢çš„é…ç½® KUBELET_CGROUP_ARGS=\"--cgroup-driver=systemd\" KUBE_PROXY_MODE=\"ipvs\" # 5ã€è®¾ç½®kubeletå¼€æœºè‡ªå¯ [root@master ~]# systemctl enable kubelet 2.6.11 å‡†å¤‡é›†ç¾¤é•œåƒ # åœ¨å®‰è£…kubernetesé›†ç¾¤ä¹‹å‰ï¼Œå¿…é¡»è¦æå‰å‡†å¤‡å¥½é›†ç¾¤éœ€è¦çš„é•œåƒï¼Œæ‰€éœ€é•œåƒå¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥çœ‹ [root@master ~]# kubeadm config /kubernetes.images list # ä¸‹è½½é•œåƒ # æ­¤é•œåƒkubernetesçš„ä»“åº“ä¸­ï¼Œç”±äºç½‘ç»œåŸå› ï¼Œæ— æ³•è¿æ¥ï¼Œä¸‹é¢æä¾›äº†ä¸€ç§æ›¿æ¢æ–¹æ¡ˆ /kubernetes.images=( kube-apiserver:v1.17.4 kube-controller-manager:v1.17.4 kube-scheduler:v1.17.4 kube-proxy:v1.17.4 pause:3.1 etcd:3.4.3-0 coredns:1.6.5 ) for imageName in ${/kubernetes.images[@]};do docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName k8s.gcr.io/$imageName docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName done 2.6.11 é›†ç¾¤åˆå§‹åŒ– ä¸‹é¢çš„æ“ä½œåªéœ€è¦åœ¨masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œå³å¯\n# åˆ›å»ºé›†ç¾¤ [root@master ~]# kubeadm init \\ --apiserver-advertise-address=192.168.90.100 \\ --image-repository registry.aliyuncs.com/google_containers \\ --kubernetes-version=v1.17.4 \\ --service-cidr=10.96.0.0/12 \\ --pod-network-cidr=10.244.0.0/16 # åˆ›å»ºå¿…è¦æ–‡ä»¶ [root@master ~]# mkdir -p $HOME/.kube [root@master ~]# sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config [root@master ~]# sudo chown $(id -u):$(id -g) $HOME/.kube/config ä¸‹é¢çš„æ“ä½œåªéœ€è¦åœ¨nodeèŠ‚ç‚¹ä¸Šæ‰§è¡Œå³å¯\nkubeadm join 192.168.0.100:6443 --token awk15p.t6bamck54w69u4s8 \\ --discovery-token-ca-cert-hash sha256:a94fa09562466d32d29523ab6cff122186f1127599fa4dcd5fa0152694f17117 åœ¨masterä¸ŠæŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯\n[root@master ~]# kubectl get nodes NAME STATUS ROLES AGE VERSION master NotReady master 6m v1.17.4 node1 NotReady 22s v1.17.4 node2 NotReady 19s v1.17.4 2.6.13 å®‰è£…ç½‘ç»œæ’ä»¶ï¼Œåªåœ¨masterèŠ‚ç‚¹æ“ä½œå³å¯ wget https:/raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml ç”±äºå¤–ç½‘ä¸å¥½è®¿é—®ï¼Œå¦‚æœå‡ºç°æ— æ³•è®¿é—®çš„æƒ…å†µï¼Œå¯ä»¥ç›´æ¥ç”¨ä¸‹é¢çš„ è®°å¾—æ–‡ä»¶åæ˜¯kube-flannel.ymlï¼Œä½ç½®ï¼š/root/kube-flannel.ymlå†…å®¹ï¼š\nhttps:/github.com/flannel-io/flannel/tree/master/Documentation/kube-flannel.yml ä¹Ÿå¯æ‰‹åŠ¨æ‹‰å–æŒ‡å®šç‰ˆæœ¬ docker pull quay.io/coreos/flannel:v0.14.0 #æ‹‰å–flannelç½‘ç»œï¼Œä¸‰å°ä¸»æœº docker /kubernetes.images #æŸ¥çœ‹ä»“åº“æ˜¯å¦æ‹‰å»ä¸‹æ¥\nä¸ªäººç¬”è®° è‹¥æ˜¯é›†ç¾¤çŠ¶æ€ä¸€ç›´æ˜¯ notready,ç”¨ä¸‹é¢è¯­å¥æŸ¥çœ‹åŸå› ï¼Œ journalctl -f -u kubelet.service è‹¥åŸå› æ˜¯ï¼š cni.go:237] Unable to update cni config: no networks found in /etc/cni/net.d mkdir -p /etc/cni/net.d #åˆ›å»ºç›®å½•ç»™flannelåšé…ç½®æ–‡ä»¶ vim /etc/cni/net.d/10-flannel.conf #ç¼–å†™é…ç½®æ–‡ä»¶\n{ \"name\":\"cbr0\", \"cniVersion\":\"0.3.1\", \"type\":\"flannel\", \"deledate\":{ \"hairpinMode\":true, \"isDefaultGateway\":true } } 2.6.14 ä½¿ç”¨kubeadm reseté‡ç½®é›†ç¾¤ #åœ¨masterèŠ‚ç‚¹ä¹‹å¤–çš„èŠ‚ç‚¹è¿›è¡Œæ“ä½œ kubeadm reset systemctl stop kubelet systemctl stop docker rm -rf /var/lib/cni/ rm -rf /var/lib/kubelet/* rm -rf /etc/cni/ ifconfig cni0 down ifconfig flannel.1 down ifconfig docker0 down ip link delete cni0 ip link delete flannel.1 ##é‡å¯kubelet systemctl restart kubelet ##é‡å¯docker systemctl restart docker 2.6.15 é‡å¯kubeletå’Œdocker # é‡å¯kubelet systemctl restart kubelet # é‡å¯docker systemctl restart docker ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨fannel\nkubectl apply -f kube-flannel.yml ç­‰å¾…å®ƒå®‰è£…å®Œæ¯• å‘ç°å·²ç»æ˜¯ é›†ç¾¤çš„çŠ¶æ€å·²ç»æ˜¯Ready\n2.6.16 kubeadmä¸­çš„å‘½ä»¤ # ç”Ÿæˆ æ–°çš„token [root@master ~]# kubeadm token create --print-join-command 2.7 é›†ç¾¤æµ‹è¯• 2.7.1 åˆ›å»ºä¸€ä¸ªnginxæœåŠ¡ kubectl create deployment nginx --image=nginx:1.14-alpine 2.7.2 æš´éœ²ç«¯å£ kubectl expose deploy nginx --port=80 --target-port=80 --type=NodePort 2.7.3 æŸ¥çœ‹æœåŠ¡ kubectl get pod,svc 2.7.4 æŸ¥çœ‹pod æµè§ˆå™¨æµ‹è¯•ç»“æœï¼š\n3. èµ„æºç®¡ç† 3.1 èµ„æºç®¡ç†ä»‹ç» åœ¨kubernetesä¸­ï¼Œæ‰€æœ‰çš„å†…å®¹éƒ½æŠ½è±¡ä¸ºèµ„æºï¼Œç”¨æˆ·éœ€è¦é€šè¿‡æ“ä½œèµ„æºæ¥ç®¡ç†kubernetesã€‚\nkubernetesçš„æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªé›†ç¾¤ç³»ç»Ÿï¼Œç”¨æˆ·å¯ä»¥åœ¨é›†ç¾¤ä¸­éƒ¨ç½²å„ç§æœåŠ¡ï¼Œæ‰€è°“çš„éƒ¨ç½²æœåŠ¡ï¼Œå…¶å®å°±æ˜¯åœ¨kubernetesé›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ªä¸ªçš„å®¹å™¨ï¼Œå¹¶å°†æŒ‡å®šçš„ç¨‹åºè·‘åœ¨å®¹å™¨ä¸­ã€‚\nkubernetesçš„æœ€å°ç®¡ç†å•å…ƒæ˜¯podè€Œä¸æ˜¯å®¹å™¨ï¼Œæ‰€ä»¥åªèƒ½å°†å®¹å™¨æ”¾åœ¨Podä¸­ï¼Œè€Œkubernetesä¸€èˆ¬ä¹Ÿä¸ä¼šç›´æ¥ç®¡ç†Podï¼Œè€Œæ˜¯é€šè¿‡Podæ§åˆ¶å™¨æ¥ç®¡ç†Podçš„ã€‚\nPodå¯ä»¥æä¾›æœåŠ¡ä¹‹åï¼Œå°±è¦è€ƒè™‘å¦‚ä½•è®¿é—®Podä¸­æœåŠ¡ï¼Œkubernetesæä¾›äº†Serviceèµ„æºå®ç°è¿™ä¸ªåŠŸèƒ½ã€‚\nå½“ç„¶ï¼Œå¦‚æœPodä¸­ç¨‹åºçš„æ•°æ®éœ€è¦æŒä¹…åŒ–ï¼Œkubernetesè¿˜æä¾›äº†å„ç§å­˜å‚¨ç³»ç»Ÿã€‚\nå­¦ä¹ kubernetesçš„æ ¸å¿ƒï¼Œå°±æ˜¯å­¦ä¹ å¦‚ä½•å¯¹é›†ç¾¤ä¸Šçš„Podã€Podæ§åˆ¶å™¨ã€Serviceã€å­˜å‚¨ç­‰å„ç§èµ„æºè¿›è¡Œæ“ä½œ\n3.2 YAMLè¯­è¨€ä»‹ç» YAMLæ˜¯ä¸€ä¸ªç±»ä¼¼ XMLã€JSON çš„æ ‡è®°æ€§è¯­è¨€ã€‚å®ƒå¼ºè°ƒä»¥æ•°æ®ä¸ºä¸­å¿ƒï¼Œå¹¶ä¸æ˜¯ä»¥æ ‡è¯†è¯­è¨€ä¸ºé‡ç‚¹ã€‚å› è€ŒYAMLæœ¬èº«çš„å®šä¹‰æ¯”è¾ƒç®€å•ï¼Œå·ç§°\"ä¸€ç§äººæ€§åŒ–çš„æ•°æ®æ ¼å¼è¯­è¨€\"ã€‚\n\u003cheima\u003e \u003cage\u003e15\u003c/age\u003e \u003caddress\u003eBeijing\u003c/address\u003e \u003c/heima\u003e heima: age: 15 address: Beijing YAMLçš„è¯­æ³•æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æœ‰ä¸‹é¢å‡ ä¸ªï¼š\nå¤§å°å†™æ•æ„Ÿ ä½¿ç”¨ç¼©è¿›è¡¨ç¤ºå±‚çº§å…³ç³» ç¼©è¿›ä¸å…è®¸ä½¿ç”¨tabï¼Œåªå…è®¸ç©ºæ ¼( ä½ç‰ˆæœ¬é™åˆ¶ ) ç¼©è¿›çš„ç©ºæ ¼æ•°ä¸é‡è¦ï¼Œåªè¦ç›¸åŒå±‚çº§çš„å…ƒç´ å·¦å¯¹é½å³å¯ â€˜#â€˜è¡¨ç¤ºæ³¨é‡Š YAMLæ”¯æŒä»¥ä¸‹å‡ ç§æ•°æ®ç±»å‹ï¼š\nçº¯é‡ï¼šå•ä¸ªçš„ã€ä¸å¯å†åˆ†çš„å€¼ å¯¹è±¡ï¼šé”®å€¼å¯¹çš„é›†åˆï¼Œåˆç§°ä¸ºæ˜ å°„ï¼ˆmappingï¼‰/ å“ˆå¸Œï¼ˆhashï¼‰ / å­—å…¸ï¼ˆdictionaryï¼‰ æ•°ç»„ï¼šä¸€ç»„æŒ‰æ¬¡åºæ’åˆ—çš„å€¼ï¼Œåˆç§°ä¸ºåºåˆ—ï¼ˆsequenceï¼‰ / åˆ—è¡¨ï¼ˆlistï¼‰ # çº¯é‡, å°±æ˜¯æŒ‡çš„ä¸€ä¸ªç®€å•çš„å€¼ï¼Œå­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ã€æ•´æ•°ã€æµ®ç‚¹æ•°ã€Nullã€æ—¶é—´ã€æ—¥æœŸ # 1 å¸ƒå°”ç±»å‹ c1: true (æˆ–è€…True) # 2 æ•´å‹ c2: 234 # 3 æµ®ç‚¹å‹ c3: 3.14 # 4 nullç±»å‹ c4: ~ # ä½¿ç”¨~è¡¨ç¤ºnull # 5 æ—¥æœŸç±»å‹ c5: 2018-02-17 # æ—¥æœŸå¿…é¡»ä½¿ç”¨ISO 8601æ ¼å¼ï¼Œå³yyyy-MM-dd # 6 æ—¶é—´ç±»å‹ c6: 2018-02-17T15:02:31+08:00 # æ—¶é—´ä½¿ç”¨ISO 8601æ ¼å¼ï¼Œæ—¶é—´å’Œæ—¥æœŸä¹‹é—´ä½¿ç”¨Tè¿æ¥ï¼Œæœ€åä½¿ç”¨+ä»£è¡¨æ—¶åŒº # 7 å­—ç¬¦ä¸²ç±»å‹ c7: heima # ç®€å•å†™æ³•ï¼Œç›´æ¥å†™å€¼ , å¦‚æœå­—ç¬¦ä¸²ä¸­é—´æœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œå¿…é¡»ä½¿ç”¨åŒå¼•å·æˆ–è€…å•å¼•å·åŒ…è£¹ c8: line1 line2 # å­—ç¬¦ä¸²è¿‡å¤šçš„æƒ…å†µå¯ä»¥æ‹†æˆå¤šè¡Œï¼Œæ¯ä¸€è¡Œä¼šè¢«è½¬åŒ–æˆä¸€ä¸ªç©ºæ ¼ # å¯¹è±¡ # å½¢å¼ä¸€(æ¨è): heima: age: 15 address: Beijing # å½¢å¼äºŒ(äº†è§£): heima: {age: 15,address: Beijing} # æ•°ç»„ # å½¢å¼ä¸€(æ¨è): address: - é¡ºä¹‰ - æ˜Œå¹³ # å½¢å¼äºŒ(äº†è§£): address: [é¡ºä¹‰,æ˜Œå¹³] å°æç¤ºï¼š\n1 ä¹¦å†™yamlåˆ‡è®°: åé¢è¦åŠ ä¸€ä¸ªç©ºæ ¼\n2 å¦‚æœéœ€è¦å°†å¤šæ®µyamlé…ç½®æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œä¸­é—´è¦ä½¿ç”¨---åˆ†éš”\n3 ä¸‹é¢æ˜¯ä¸€ä¸ªyamlè½¬jsonçš„ç½‘ç«™ï¼Œå¯ä»¥é€šè¿‡å®ƒéªŒè¯yamlæ˜¯å¦ä¹¦å†™æ­£ç¡® https:/www.json2yaml.com/convert-yaml-to-json\n3.3 èµ„æºç®¡ç†æ–¹å¼ å‘½ä»¤å¼å¯¹è±¡ç®¡ç†ï¼šç›´æ¥ä½¿ç”¨å‘½ä»¤å»æ“ä½œkubernetesèµ„æº\nkubectl run nginx-pod --image=nginx:1.17.1 --port=80 å‘½ä»¤å¼å¯¹è±¡é…ç½®ï¼šé€šè¿‡å‘½ä»¤é…ç½®å’Œé…ç½®æ–‡ä»¶å»æ“ä½œkubernetesèµ„æº\nkubectl create/patch -f nginx-pod.yaml å£°æ˜å¼å¯¹è±¡é…ç½®ï¼šé€šè¿‡applyå‘½ä»¤å’Œé…ç½®æ–‡ä»¶å»æ“ä½œkubernetesèµ„æº\nkubectl apply -f nginx-pod.yaml ç±»å‹ æ“ä½œå¯¹è±¡ é€‚ç”¨ç¯å¢ƒ ä¼˜ç‚¹ ç¼ºç‚¹ å‘½ä»¤å¼å¯¹è±¡ç®¡ç† å¯¹è±¡ æµ‹è¯• ç®€å• åªèƒ½æ“ä½œæ´»åŠ¨å¯¹è±¡ï¼Œæ— æ³•å®¡è®¡ã€è·Ÿè¸ª å‘½ä»¤å¼å¯¹è±¡é…ç½® æ–‡ä»¶ å¼€å‘ å¯ä»¥å®¡è®¡ã€è·Ÿè¸ª é¡¹ç›®å¤§æ—¶ï¼Œé…ç½®æ–‡ä»¶å¤šï¼Œæ“ä½œéº»çƒ¦ å£°æ˜å¼å¯¹è±¡é…ç½® ç›®å½• å¼€å‘ æ”¯æŒç›®å½•æ“ä½œ æ„å¤–æƒ…å†µä¸‹éš¾ä»¥è°ƒè¯• 3.3.1 å‘½ä»¤å¼å¯¹è±¡ç®¡ç† kubectlå‘½ä»¤\nkubectlæ˜¯kubernetesé›†ç¾¤çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œé€šè¿‡å®ƒèƒ½å¤Ÿå¯¹é›†ç¾¤æœ¬èº«è¿›è¡Œç®¡ç†ï¼Œå¹¶èƒ½å¤Ÿåœ¨é›†ç¾¤ä¸Šè¿›è¡Œå®¹å™¨åŒ–åº”ç”¨çš„å®‰è£…éƒ¨ç½²ã€‚kubectlå‘½ä»¤çš„è¯­æ³•å¦‚ä¸‹ï¼š\nkubectl [command] [type] [name] [flags] comandï¼šæŒ‡å®šè¦å¯¹èµ„æºæ‰§è¡Œçš„æ“ä½œï¼Œä¾‹å¦‚createã€getã€delete\ntypeï¼šæŒ‡å®šèµ„æºç±»å‹ï¼Œæ¯”å¦‚deploymentã€podã€service\nnameï¼šæŒ‡å®šèµ„æºçš„åç§°ï¼Œåç§°å¤§å°å†™æ•æ„Ÿ\nflagsï¼šæŒ‡å®šé¢å¤–çš„å¯é€‰å‚æ•°\n# æŸ¥çœ‹æ‰€æœ‰pod kubectl get pod # æŸ¥çœ‹æŸä¸ªpod kubectl get pod pod_name # æŸ¥çœ‹æŸä¸ªpod,ä»¥yamlæ ¼å¼å±•ç¤ºç»“æœ kubectl get pod pod_name -o yaml èµ„æºç±»å‹\nkubernetesä¸­æ‰€æœ‰çš„å†…å®¹éƒ½æŠ½è±¡ä¸ºèµ„æºï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹:\nkubectl api-resources ç»å¸¸ä½¿ç”¨çš„èµ„æºæœ‰ä¸‹é¢è¿™äº›ï¼š\nèµ„æºåˆ†ç±» èµ„æºåç§° ç¼©å†™ èµ„æºä½œç”¨ é›†ç¾¤çº§åˆ«èµ„æº nodes no é›†ç¾¤ç»„æˆéƒ¨åˆ† namespaces ns éš”ç¦»Pod podèµ„æº pods po è£…è½½å®¹å™¨ podèµ„æºæ§åˆ¶å™¨ replicationcontrollers rc æ§åˆ¶podèµ„æº replicasets rs æ§åˆ¶podèµ„æº deployments deploy æ§åˆ¶podèµ„æº daemonsets ds æ§åˆ¶podèµ„æº jobs æ§åˆ¶podèµ„æº cronjobs cj æ§åˆ¶podèµ„æº horizontalpodautoscalers hpa æ§åˆ¶podèµ„æº statefulsets sts æ§åˆ¶podèµ„æº æœåŠ¡å‘ç°èµ„æº services svc ç»Ÿä¸€podå¯¹å¤–æ¥å£ ingress ing ç»Ÿä¸€podå¯¹å¤–æ¥å£ å­˜å‚¨èµ„æº volumeattachments å­˜å‚¨ persistentvolumes pv å­˜å‚¨ persistentvolumeclaims pvc å­˜å‚¨ é…ç½®èµ„æº configmaps cm é…ç½® secrets é…ç½® æ“ä½œ\nkuberneteså…è®¸å¯¹èµ„æºè¿›è¡Œå¤šç§æ“ä½œï¼Œå¯ä»¥é€šè¿‡â€“helpæŸ¥çœ‹è¯¦ç»†çš„æ“ä½œå‘½ä»¤\nkubectl --help ç»å¸¸ä½¿ç”¨çš„æ“ä½œæœ‰ä¸‹é¢è¿™äº›ï¼š\nå‘½ä»¤åˆ†ç±» å‘½ä»¤ ç¿»è¯‘ å‘½ä»¤ä½œç”¨ åŸºæœ¬å‘½ä»¤ create åˆ›å»º åˆ›å»ºä¸€ä¸ªèµ„æº edit ç¼–è¾‘ ç¼–è¾‘ä¸€ä¸ªèµ„æº get è·å– è·å–ä¸€ä¸ªèµ„æº patch æ›´æ–° æ›´æ–°ä¸€ä¸ªèµ„æº delete åˆ é™¤ åˆ é™¤ä¸€ä¸ªèµ„æº explain è§£é‡Š å±•ç¤ºèµ„æºæ–‡æ¡£ è¿è¡Œå’Œè°ƒè¯• run è¿è¡Œ åœ¨é›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ªæŒ‡å®šçš„é•œåƒ expose æš´éœ² æš´éœ²èµ„æºä¸ºService describe æè¿° æ˜¾ç¤ºèµ„æºå†…éƒ¨ä¿¡æ¯ logs æ—¥å¿—è¾“å‡ºå®¹å™¨åœ¨ pod ä¸­çš„æ—¥å¿— è¾“å‡ºå®¹å™¨åœ¨ pod ä¸­çš„æ—¥å¿— attach ç¼ ç»•è¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨ è¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨ exec æ‰§è¡Œå®¹å™¨ä¸­çš„ä¸€ä¸ªå‘½ä»¤ æ‰§è¡Œå®¹å™¨ä¸­çš„ä¸€ä¸ªå‘½ä»¤ cp å¤åˆ¶ åœ¨Podå†…å¤–å¤åˆ¶æ–‡ä»¶ rollout é¦–æ¬¡å±•ç¤º ç®¡ç†èµ„æºçš„å‘å¸ƒ scale è§„æ¨¡ æ‰©(ç¼©)å®¹Podçš„æ•°é‡ autoscale è‡ªåŠ¨è°ƒæ•´ è‡ªåŠ¨è°ƒæ•´Podçš„æ•°é‡ é«˜çº§å‘½ä»¤ apply rc é€šè¿‡æ–‡ä»¶å¯¹èµ„æºè¿›è¡Œé…ç½® label æ ‡ç­¾ æ›´æ–°èµ„æºä¸Šçš„æ ‡ç­¾ å…¶ä»–å‘½ä»¤ cluster-info é›†ç¾¤ä¿¡æ¯ æ˜¾ç¤ºé›†ç¾¤ä¿¡æ¯ version ç‰ˆæœ¬ æ˜¾ç¤ºå½“å‰Serverå’ŒClientçš„ç‰ˆæœ¬ ä¸‹é¢ä»¥ä¸€ä¸ªnamespace / podçš„åˆ›å»ºå’Œåˆ é™¤ç®€å•æ¼”ç¤ºä¸‹å‘½ä»¤çš„ä½¿ç”¨ï¼š\n# åˆ›å»ºä¸€ä¸ªnamespace [root@master ~]# kubectl create namespace dev namespace/dev created # è·å–namespace [root@master ~]# kubectl get ns NAME STATUS AGE default Active 21h dev Active 21s kube-node-lease Active 21h kube-public Active 21h kube-system Active 21h # åœ¨æ­¤namespaceä¸‹åˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªnginxçš„Pod [root@master ~]# kubectl run pod --image=nginx:latest -n dev kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead. deployment.apps/pod created # æŸ¥çœ‹æ–°åˆ›å»ºçš„pod [root@master ~]# kubectl get pod -n dev NAME READY STATUS RESTARTS AGE pod 1/1 Running 0 21s # åˆ é™¤æŒ‡å®šçš„pod [root@master ~]# kubectl delete pod pod-864f9875b9-pcw7x pod \"pod\" deleted # åˆ é™¤æŒ‡å®šçš„namespace [root@master ~]# kubectl delete ns dev namespace \"dev\" deleted 3.3.2 å‘½ä»¤å¼å¯¹è±¡é…ç½® å‘½ä»¤å¼å¯¹è±¡é…ç½®å°±æ˜¯ä½¿ç”¨å‘½ä»¤é…åˆé…ç½®æ–‡ä»¶ä¸€èµ·æ¥æ“ä½œkubernetesèµ„æºã€‚\n1ï¼‰ åˆ›å»ºä¸€ä¸ªnginxpod.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š\napiVersion: v1 kind: Namespace metadata: name: dev --- apiVersion: v1 kind: Pod metadata: name: nginxpod namespace: dev spec: containers: - name: nginx-containers image: nginx:latest 2ï¼‰æ‰§è¡Œcreateå‘½ä»¤ï¼Œåˆ›å»ºèµ„æºï¼š\n[root@master ~]# kubectl create -f nginxpod.yaml namespace/dev created pod/nginxpod created æ­¤æ—¶å‘ç°åˆ›å»ºäº†ä¸¤ä¸ªèµ„æºå¯¹è±¡ï¼Œåˆ†åˆ«æ˜¯namespaceå’Œpod\n3ï¼‰æ‰§è¡Œgetå‘½ä»¤ï¼ŒæŸ¥çœ‹èµ„æºï¼š\n[root@master ~]# kubectl get -f nginxpod.yaml NAME STATUS AGE namespace/dev Active 18s NAME READY STATUS RESTARTS AGE pod/nginxpod 1/1 Running 0 17s è¿™æ ·å°±æ˜¾ç¤ºäº†ä¸¤ä¸ªèµ„æºå¯¹è±¡çš„ä¿¡æ¯\n4ï¼‰æ‰§è¡Œdeleteå‘½ä»¤ï¼Œåˆ é™¤èµ„æºï¼š\n[root@master ~]# kubectl delete -f nginxpod.yaml namespace \"dev\" deleted pod \"nginxpod\" deleted æ­¤æ—¶å‘ç°ä¸¤ä¸ªèµ„æºå¯¹è±¡è¢«åˆ é™¤äº†\næ€»ç»“: å‘½ä»¤å¼å¯¹è±¡é…ç½®çš„æ–¹å¼æ“ä½œèµ„æºï¼Œå¯ä»¥ç®€å•çš„è®¤ä¸ºï¼šå‘½ä»¤ + yamlé…ç½®æ–‡ä»¶ï¼ˆé‡Œé¢æ˜¯å‘½ä»¤éœ€è¦çš„å„ç§å‚æ•°ï¼‰ 3.3.3 å£°æ˜å¼å¯¹è±¡é…ç½® å£°æ˜å¼å¯¹è±¡é…ç½®è·Ÿå‘½ä»¤å¼å¯¹è±¡é…ç½®å¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯å®ƒåªæœ‰ä¸€ä¸ªå‘½ä»¤applyã€‚\n# é¦–å…ˆæ‰§è¡Œä¸€æ¬¡kubectl apply -f yamlæ–‡ä»¶ï¼Œå‘ç°åˆ›å»ºäº†èµ„æº [root@master ~]# kubectl apply -f nginxpod.yaml namespace/dev created pod/nginxpod created # å†æ¬¡æ‰§è¡Œä¸€æ¬¡kubectl apply -f yamlæ–‡ä»¶ï¼Œå‘ç°è¯´èµ„æºæ²¡æœ‰å˜åŠ¨ [root@master ~]# kubectl apply -f nginxpod.yaml namespace/dev unchanged pod/nginxpod unchanged æ€»ç»“: å…¶å®å£°æ˜å¼å¯¹è±¡é…ç½®å°±æ˜¯ä½¿ç”¨applyæè¿°ä¸€ä¸ªèµ„æºæœ€ç»ˆçš„çŠ¶æ€ï¼ˆåœ¨yamlä¸­å®šä¹‰çŠ¶æ€ï¼‰ ä½¿ç”¨applyæ“ä½œèµ„æºï¼š å¦‚æœèµ„æºä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºï¼Œç›¸å½“äº kubectl create å¦‚æœèµ„æºå·²å­˜åœ¨ï¼Œå°±æ›´æ–°ï¼Œç›¸å½“äº kubectl patch æ‰©å±•ï¼škubectlå¯ä»¥åœ¨nodeèŠ‚ç‚¹ä¸Šè¿è¡Œå— ?\nkubectlçš„è¿è¡Œæ˜¯éœ€è¦è¿›è¡Œé…ç½®çš„ï¼Œå®ƒçš„é…ç½®æ–‡ä»¶æ˜¯$HOME/.kubeï¼Œå¦‚æœæƒ³è¦åœ¨nodeèŠ‚ç‚¹è¿è¡Œæ­¤å‘½ä»¤ï¼Œéœ€è¦å°†masterä¸Šçš„.kubeæ–‡ä»¶å¤åˆ¶åˆ°nodeèŠ‚ç‚¹ä¸Šï¼Œå³åœ¨masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œä¸‹é¢æ“ä½œï¼š\nscp -r HOME/.kube node1: HOME/ ä½¿ç”¨æ¨è: ä¸‰ç§æ–¹å¼åº”è¯¥æ€ä¹ˆç”¨ ?\nåˆ›å»º/æ›´æ–°èµ„æº ä½¿ç”¨å£°æ˜å¼å¯¹è±¡é…ç½® kubectl apply -f XXX.yaml\nåˆ é™¤èµ„æº ä½¿ç”¨å‘½ä»¤å¼å¯¹è±¡é…ç½® kubectl delete -f XXX.yaml\næŸ¥è¯¢èµ„æº ä½¿ç”¨å‘½ä»¤å¼å¯¹è±¡ç®¡ç† kubectl get(describe) èµ„æºåç§°\n4. å®æˆ˜å…¥é—¨ æœ¬ç« èŠ‚å°†ä»‹ç»å¦‚ä½•åœ¨kubernetesé›†ç¾¤ä¸­éƒ¨ç½²ä¸€ä¸ªnginxæœåŠ¡ï¼Œå¹¶ä¸”èƒ½å¤Ÿå¯¹å…¶è¿›è¡Œè®¿é—®ã€‚\n4.1 Namespace Namespaceæ˜¯kubernetesç³»ç»Ÿä¸­çš„ä¸€ç§éå¸¸é‡è¦èµ„æºï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ç”¨æ¥å®ç°å¤šå¥—ç¯å¢ƒçš„èµ„æºéš”ç¦»æˆ–è€…å¤šç§Ÿæˆ·çš„èµ„æºéš”ç¦»ã€‚\né»˜è®¤æƒ…å†µä¸‹ï¼Œkubernetesé›†ç¾¤ä¸­çš„æ‰€æœ‰çš„Podéƒ½æ˜¯å¯ä»¥ç›¸äº’è®¿é—®çš„ã€‚ä½†æ˜¯åœ¨å®é™…ä¸­ï¼Œå¯èƒ½ä¸æƒ³è®©ä¸¤ä¸ªPodä¹‹é—´è¿›è¡Œäº’ç›¸çš„è®¿é—®ï¼Œé‚£æ­¤æ—¶å°±å¯ä»¥å°†ä¸¤ä¸ªPodåˆ’åˆ†åˆ°ä¸åŒçš„namespaceä¸‹ã€‚kubernetesé€šè¿‡å°†é›†ç¾¤å†…éƒ¨çš„èµ„æºåˆ†é…åˆ°ä¸åŒçš„Namespaceä¸­ï¼Œå¯ä»¥å½¢æˆé€»è¾‘ä¸Šçš„\"ç»„\"ï¼Œä»¥æ–¹ä¾¿ä¸åŒçš„ç»„çš„èµ„æºè¿›è¡Œéš”ç¦»ä½¿ç”¨å’Œç®¡ç†ã€‚\nå¯ä»¥é€šè¿‡kubernetesçš„æˆæƒæœºåˆ¶ï¼Œå°†ä¸åŒçš„namespaceäº¤ç»™ä¸åŒç§Ÿæˆ·è¿›è¡Œç®¡ç†ï¼Œè¿™æ ·å°±å®ç°äº†å¤šç§Ÿæˆ·çš„èµ„æºéš”ç¦»ã€‚æ­¤æ—¶è¿˜èƒ½ç»“åˆkubernetesçš„èµ„æºé…é¢æœºåˆ¶ï¼Œé™å®šä¸åŒç§Ÿæˆ·èƒ½å ç”¨çš„èµ„æºï¼Œä¾‹å¦‚CPUä½¿ç”¨é‡ã€å†…å­˜ä½¿ç”¨é‡ç­‰ç­‰ï¼Œæ¥å®ç°ç§Ÿæˆ·å¯ç”¨èµ„æºçš„ç®¡ç†ã€‚\nkubernetesåœ¨é›†ç¾¤å¯åŠ¨ä¹‹åï¼Œä¼šé»˜è®¤åˆ›å»ºå‡ ä¸ªnamespace\n[root@master ~]# kubectl get namespace NAME STATUS AGE default Active 45h # æ‰€æœ‰æœªæŒ‡å®šNamespaceçš„å¯¹è±¡éƒ½ä¼šè¢«åˆ†é…åœ¨defaultå‘½åç©ºé—´ kube-node-lease Active 45h # é›†ç¾¤èŠ‚ç‚¹ä¹‹é—´çš„å¿ƒè·³ç»´æŠ¤ï¼Œv1.13å¼€å§‹å¼•å…¥ kube-public Active 45h # æ­¤å‘½åç©ºé—´ä¸‹çš„èµ„æºå¯ä»¥è¢«æ‰€æœ‰äººè®¿é—®ï¼ˆåŒ…æ‹¬æœªè®¤è¯ç”¨æˆ·ï¼‰ kube-system Active 45h # æ‰€æœ‰ç”±Kubernetesç³»ç»Ÿåˆ›å»ºçš„èµ„æºéƒ½å¤„äºè¿™ä¸ªå‘½åç©ºé—´ ä¸‹é¢æ¥çœ‹namespaceèµ„æºçš„å…·ä½“æ“ä½œï¼š\n4.1.1 æŸ¥çœ‹ # 1 æŸ¥çœ‹æ‰€æœ‰çš„ns å‘½ä»¤ï¼škubectl get ns [root@master ~]# kubectl get ns NAME STATUS AGE default Active 45h kube-node-lease Active 45h kube-public Active 45h kube-system Active 45h # 2 æŸ¥çœ‹æŒ‡å®šçš„ns å‘½ä»¤ï¼škubectl get ns nsåç§° [root@master ~]# kubectl get ns default NAME STATUS AGE default Active 45h # 3 æŒ‡å®šè¾“å‡ºæ ¼å¼ å‘½ä»¤ï¼škubectl get ns nsåç§° -o æ ¼å¼å‚æ•° # kubernetesæ”¯æŒçš„æ ¼å¼æœ‰å¾ˆå¤šï¼Œæ¯”è¾ƒå¸¸è§çš„æ˜¯wideã€jsonã€yaml [root@master ~]# kubectl get ns default -o yaml apiVersion: v1 kind: Namespace metadata: creationTimestamp: \"2021-05-08T04:44:16Z\" name: default resourceVersion: \"151\" selfLink: /api/v1/namespaces/default uid: 7405f73a-e486-43d4-9db6-145f1409f090 spec: finalizers: - kubernetes status: phase: Active # 4 æŸ¥çœ‹nsè¯¦æƒ… å‘½ä»¤ï¼škubectl describe ns nsåç§° [root@master ~]# kubectl describe ns default Name: default Labels: Annotations: Status: Active # Active å‘½åç©ºé—´æ­£åœ¨ä½¿ç”¨ä¸­ Terminating æ­£åœ¨åˆ é™¤å‘½åç©ºé—´ # ResourceQuota é’ˆå¯¹namespaceåšçš„èµ„æºé™åˆ¶ # LimitRangeé’ˆå¯¹namespaceä¸­çš„æ¯ä¸ªç»„ä»¶åšçš„èµ„æºé™åˆ¶ No resource quota. No LimitRange resource. 4.1.2 åˆ›å»º # åˆ›å»ºnamespace [root@master ~]# kubectl create ns dev namespace/dev created 4.1.3 åˆ é™¤ # åˆ é™¤namespace [root@master ~]# kubectl delete ns dev namespace \"dev\" deleted 4.1.4 é…ç½®æ–¹å¼ é¦–å…ˆå‡†å¤‡ä¸€ä¸ªyamlæ–‡ä»¶ï¼šns-dev.yaml\napiVersion: v1 kind: Namespace metadata: name: dev ç„¶åå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„åˆ›å»ºå’Œåˆ é™¤å‘½ä»¤äº†ï¼š\nåˆ›å»ºï¼škubectl create -f ns-dev.yaml\nåˆ é™¤ï¼škubectl delete -f ns-dev.yaml\n4.2 Pod Podæ˜¯kubernetesé›†ç¾¤è¿›è¡Œç®¡ç†çš„æœ€å°å•å…ƒï¼Œç¨‹åºè¦è¿è¡Œå¿…é¡»éƒ¨ç½²åœ¨å®¹å™¨ä¸­ï¼Œè€Œå®¹å™¨å¿…é¡»å­˜åœ¨äºPodä¸­ã€‚\nPodå¯ä»¥è®¤ä¸ºæ˜¯å®¹å™¨çš„å°è£…ï¼Œä¸€ä¸ªPodä¸­å¯ä»¥å­˜åœ¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ã€‚\nkubernetesåœ¨é›†ç¾¤å¯åŠ¨ä¹‹åï¼Œé›†ç¾¤ä¸­çš„å„ä¸ªç»„ä»¶ä¹Ÿéƒ½æ˜¯ä»¥Podæ–¹å¼è¿è¡Œçš„ã€‚å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥çœ‹ï¼š\n[root@master ~]# kubectl get pod -n kube-system NAMESPACE NAME READY STATUS RESTARTS AGE kube-system coredns-6955765f44-68g6v 1/1 Running 0 2d1h kube-system coredns-6955765f44-cs5r8 1/1 Running 0 2d1h kube-system etcd-master 1/1 Running 0 2d1h kube-system kube-apiserver-master 1/1 Running 0 2d1h kube-system kube-controller-manager-master 1/1 Running 0 2d1h kube-system kube-flannel-ds-amd64-47r25 1/1 Running 0 2d1h kube-system kube-flannel-ds-amd64-ls5lh 1/1 Running 0 2d1h kube-system kube-proxy-685tk 1/1 Running 0 2d1h kube-system kube-proxy-87spt 1/1 Running 0 2d1h kube-system kube-scheduler-master 1/1 Running 0 2d1h 4.2.1 åˆ›å»ºå¹¶è¿è¡Œ kubernetesæ²¡æœ‰æä¾›å•ç‹¬è¿è¡ŒPodçš„å‘½ä»¤ï¼Œéƒ½æ˜¯é€šè¿‡Podæ§åˆ¶å™¨æ¥å®ç°çš„\n# å‘½ä»¤æ ¼å¼ï¼š kubectl run (podæ§åˆ¶å™¨åç§°) [å‚æ•°] # --image æŒ‡å®šPodçš„é•œåƒ # --port æŒ‡å®šç«¯å£ # --namespace æŒ‡å®šnamespace [root@master ~]# kubectl run nginx --image=nginx:latest --port=80 --namespace dev deployment.apps/nginx created 4.2.2 æŸ¥çœ‹podä¿¡æ¯ # æŸ¥çœ‹PodåŸºæœ¬ä¿¡æ¯ [root@master ~]# kubectl get pods -n dev NAME READY STATUS RESTARTS AGE nginx 1/1 Running 0 43s # æŸ¥çœ‹Podçš„è¯¦ç»†ä¿¡æ¯ [root@master ~]# kubectl describe pod nginx -n dev Name: nginx Namespace: dev Priority: 0 Node: node1/192.168.5.4 Start Time: Wed, 08 May 2021 09:29:24 +0800 Labels: pod-template-hash=5ff7956ff6 run=nginx Annotations: Status: Running IP: 10.244.1.23 IPs: IP: 10.244.1.23 Controlled By: ReplicaSet/nginx Containers: nginx: Container ID: docker:/4c62b8c0648d2512380f4ffa5da2c99d16e05634979973449c98e9b829f6253c Image: nginx:latest Image ID: docker-pullable:/nginx@sha256:485b610fefec7ff6c463ced9623314a04ed67e3945b9c08d7e53a47f6d108dc7 Port: 80/TCP Host Port: 0/TCP State: Running Started: Wed, 08 May 2021 09:30:01 +0800 Ready: True Restart Count: 0 Environment: Mounts: /var/run/secrets/kubernetes.io/serviceaccount from default-token-hwvvw (ro) Conditions: Type Status Initialized True Ready True ContainersReady True PodScheduled True Volumes: default-token-hwvvw: Type: Secret (a volume populated by a Secret) SecretName: default-token-hwvvw Optional: false QoS Class: BestEffort Node-Selectors: Tolerations: node.kubernetes.io/not-ready:NoExecute for 300s node.kubernetes.io/unreachable:NoExecute for 300s Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled default-scheduler Successfully assigned dev/nginx-5ff7956ff6-fg2db to node1 Normal Pulling 4m11s kubelet, node1 Pulling image \"nginx:latest\" Normal Pulled 3m36s kubelet, node1 Successfully pulled image \"nginx:latest\" Normal Created 3m36s kubelet, node1 Created container nginx Normal Started 3m36s kubelet, node1 Started container nginx 4.2.3 è®¿é—®Pod # è·å–podIP [root@master ~]# kubectl get pods -n dev -o wide NAME READY STATUS RESTARTS AGE IP NODE ... nginx 1/1 Running 0 190s 10.244.1.23 node1 ... #è®¿é—®POD [root@master ~]# curl http:/10.244.1.23:80 \u003c!DOCTYPE html\u003e Welcome to nginx! Thank you for using nginx.\n4.2.4 åˆ é™¤æŒ‡å®šPod # åˆ é™¤æŒ‡å®šPod [root@master ~]# kubectl delete pod nginx -n dev pod \"nginx\" deleted # æ­¤æ—¶ï¼Œæ˜¾ç¤ºåˆ é™¤PodæˆåŠŸï¼Œä½†æ˜¯å†æŸ¥è¯¢ï¼Œå‘ç°åˆæ–°äº§ç”Ÿäº†ä¸€ä¸ª [root@master ~]# kubectl get pods -n dev NAME READY STATUS RESTARTS AGE nginx 1/1 Running 0 21s # è¿™æ˜¯å› ä¸ºå½“å‰Podæ˜¯ç”±Podæ§åˆ¶å™¨åˆ›å»ºçš„ï¼Œæ§åˆ¶å™¨ä¼šç›‘æ§PodçŠ¶å†µï¼Œä¸€æ—¦å‘ç°Podæ­»äº¡ï¼Œä¼šç«‹å³é‡å»º # æ­¤æ—¶è¦æƒ³åˆ é™¤Podï¼Œå¿…é¡»åˆ é™¤Podæ§åˆ¶å™¨ # å…ˆæ¥æŸ¥è¯¢ä¸€ä¸‹å½“å‰namespaceä¸‹çš„Podæ§åˆ¶å™¨ [root@master ~]# kubectl get deploy -n dev NAME READY UP-TO-DATE AVAILABLE AGE nginx 1/1 1 1 9m7s # æ¥ä¸‹æ¥ï¼Œåˆ é™¤æ­¤PodPodæ§åˆ¶å™¨ [root@master ~]# kubectl delete deploy nginx -n dev deployment.apps \"nginx\" deleted # ç¨ç­‰ç‰‡åˆ»ï¼Œå†æŸ¥è¯¢Podï¼Œå‘ç°Podè¢«åˆ é™¤äº† [root@master ~]# kubectl get pods -n dev No resources found in dev namespace. 4.2.5 é…ç½®æ“ä½œ åˆ›å»ºä¸€ä¸ªpod-nginx.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š\napiVersion: v1 kind: Pod metadata: name: nginx namespace: dev spec: containers: - image: nginx:latest name: pod ports: - name: nginx-port containerPort: 80 protocol: TCP ç„¶åå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„åˆ›å»ºå’Œåˆ é™¤å‘½ä»¤äº†ï¼š\nåˆ›å»ºï¼škubectl create -f pod-nginx.yaml\nåˆ é™¤ï¼škubectl delete -f pod-nginx.yaml\n4.3 Label Labelæ˜¯kubernetesç³»ç»Ÿä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µã€‚å®ƒçš„ä½œç”¨å°±æ˜¯åœ¨èµ„æºä¸Šæ·»åŠ æ ‡è¯†ï¼Œç”¨æ¥å¯¹å®ƒä»¬è¿›è¡ŒåŒºåˆ†å’Œé€‰æ‹©ã€‚\nLabelçš„ç‰¹ç‚¹ï¼š\nä¸€ä¸ªLabelä¼šä»¥key/valueé”®å€¼å¯¹çš„å½¢å¼é™„åŠ åˆ°å„ç§å¯¹è±¡ä¸Šï¼Œå¦‚Nodeã€Podã€Serviceç­‰ç­‰ ä¸€ä¸ªèµ„æºå¯¹è±¡å¯ä»¥å®šä¹‰ä»»æ„æ•°é‡çš„Label ï¼ŒåŒä¸€ä¸ªLabelä¹Ÿå¯ä»¥è¢«æ·»åŠ åˆ°ä»»æ„æ•°é‡çš„èµ„æºå¯¹è±¡ä¸Šå» Labelé€šå¸¸åœ¨èµ„æºå¯¹è±¡å®šä¹‰æ—¶ç¡®å®šï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨å¯¹è±¡åˆ›å»ºååŠ¨æ€æ·»åŠ æˆ–è€…åˆ é™¤ å¯ä»¥é€šè¿‡Labelå®ç°èµ„æºçš„å¤šç»´åº¦åˆ†ç»„ï¼Œä»¥ä¾¿çµæ´»ã€æ–¹ä¾¿åœ°è¿›è¡Œèµ„æºåˆ†é…ã€è°ƒåº¦ã€é…ç½®ã€éƒ¨ç½²ç­‰ç®¡ç†å·¥ä½œã€‚\nä¸€äº›å¸¸ç”¨çš„Label ç¤ºä¾‹å¦‚ä¸‹ï¼š\nç‰ˆæœ¬æ ‡ç­¾ï¼šâ€œversionâ€:â€œreleaseâ€, â€œversionâ€:â€œstableâ€â€¦â€¦ ç¯å¢ƒæ ‡ç­¾ï¼šâ€œenvironmentâ€:â€œdevâ€ï¼Œâ€œenvironmentâ€:â€œtestâ€ï¼Œâ€œenvironmentâ€:â€œproâ€ æ¶æ„æ ‡ç­¾ï¼šâ€œtierâ€:â€œfrontendâ€ï¼Œâ€œtierâ€:â€œbackendâ€ æ ‡ç­¾å®šä¹‰å®Œæ¯•ä¹‹åï¼Œè¿˜è¦è€ƒè™‘åˆ°æ ‡ç­¾çš„é€‰æ‹©ï¼Œè¿™å°±è¦ä½¿ç”¨åˆ°Label Selectorï¼Œå³ï¼š\nLabelç”¨äºç»™æŸä¸ªèµ„æºå¯¹è±¡å®šä¹‰æ ‡è¯†\nLabel Selectorç”¨äºæŸ¥è¯¢å’Œç­›é€‰æ‹¥æœ‰æŸäº›æ ‡ç­¾çš„èµ„æºå¯¹è±¡\nå½“å‰æœ‰ä¸¤ç§Label Selectorï¼š\nåŸºäºç­‰å¼çš„Label Selector\nname = slave: é€‰æ‹©æ‰€æœ‰åŒ…å«Labelä¸­key=â€œname\"ä¸”value=â€œslave\"çš„å¯¹è±¡\nenv != production: é€‰æ‹©æ‰€æœ‰åŒ…æ‹¬Labelä¸­çš„key=â€œenv\"ä¸”valueä¸ç­‰äº\"production\"çš„å¯¹è±¡\nåŸºäºé›†åˆçš„Label Selector\nname in (master, slave): é€‰æ‹©æ‰€æœ‰åŒ…å«Labelä¸­çš„key=â€œname\"ä¸”value=â€œmaster\"æˆ–\"slave\"çš„å¯¹è±¡\nname not in (frontend): é€‰æ‹©æ‰€æœ‰åŒ…å«Labelä¸­çš„key=â€œname\"ä¸”valueä¸ç­‰äº\"frontend\"çš„å¯¹è±¡\næ ‡ç­¾çš„é€‰æ‹©æ¡ä»¶å¯ä»¥ä½¿ç”¨å¤šä¸ªï¼Œæ­¤æ—¶å°†å¤šä¸ªLabel Selectorè¿›è¡Œç»„åˆï¼Œä½¿ç”¨é€—å·â€,â€œè¿›è¡Œåˆ†éš”å³å¯ã€‚ä¾‹å¦‚ï¼š\nname=slaveï¼Œenv!=production\nname not in (frontend)ï¼Œenv!=production\n4.3.1 å‘½ä»¤æ–¹å¼ # ä¸ºpodèµ„æºæ‰“æ ‡ç­¾ [root@master ~]# kubectl label pod nginx-pod version=1.0 -n dev pod/nginx-pod labeled # ä¸ºpodèµ„æºæ›´æ–°æ ‡ç­¾ [root@master ~]# kubectl label pod nginx-pod version=2.0 -n dev --overwrite pod/nginx-pod labeled # æŸ¥çœ‹æ ‡ç­¾ [root@master ~]# kubectl get pod nginx-pod -n dev --show-labels NAME READY STATUS RESTARTS AGE LABELS nginx-pod 1/1 Running 0 10m version=2.0 # ç­›é€‰æ ‡ç­¾ [root@master ~]# kubectl get pod -n dev -l version=2.0 --show-labels NAME READY STATUS RESTARTS AGE LABELS nginx-pod 1/1 Running 0 17m version=2.0 [root@master ~]# kubectl get pod -n dev -l version!=2.0 --show-labels No resources found in dev namespace. #åˆ é™¤æ ‡ç­¾ [root@master ~]# kubectl label pod nginx-pod -n dev tier- pod/nginx unlabeled 4.3.2 é…ç½®æ–¹å¼ apiVersion: v1 kind: Pod metadata: name: nginx namespace: dev labels: version: \"3.0\" env: \"test\" spec: containers: - image: nginx:latest name: pod ports: - name: nginx-port containerPort: 80 protocol: TCP ç„¶åå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„æ›´æ–°å‘½ä»¤äº†ï¼škubectl apply -f pod-nginx.yaml\n4.4 Deployment åœ¨kubernetesä¸­ï¼ŒPodæ˜¯æœ€å°çš„æ§åˆ¶å•å…ƒï¼Œä½†æ˜¯kuberneteså¾ˆå°‘ç›´æ¥æ§åˆ¶Podï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡Podæ§åˆ¶å™¨æ¥å®Œæˆçš„ã€‚Podæ§åˆ¶å™¨ç”¨äºpodçš„ç®¡ç†ï¼Œç¡®ä¿podèµ„æºç¬¦åˆé¢„æœŸçš„çŠ¶æ€ï¼Œå½“podçš„èµ„æºå‡ºç°æ•…éšœæ—¶ï¼Œä¼šå°è¯•è¿›è¡Œé‡å¯æˆ–é‡å»ºpodã€‚\nåœ¨kubernetesä¸­Podæ§åˆ¶å™¨çš„ç§ç±»æœ‰å¾ˆå¤šï¼Œæœ¬ç« èŠ‚åªä»‹ç»ä¸€ç§ï¼šDeploymentã€‚\n4.4.1 å‘½ä»¤æ“ä½œ # å‘½ä»¤æ ¼å¼: kubectl create deployment åç§° [å‚æ•°] # --image æŒ‡å®špodçš„é•œåƒ # --port æŒ‡å®šç«¯å£ # --replicas æŒ‡å®šåˆ›å»ºpodæ•°é‡ # --namespace æŒ‡å®šnamespace [root@master ~]# kubectl run nginx --image=nginx:latest --port=80 --replicas=3 -n dev deployment.apps/nginx created # æŸ¥çœ‹åˆ›å»ºçš„Pod [root@master ~]# kubectl get pods -n dev NAME READY STATUS RESTARTS AGE nginx-5ff7956ff6-6k8cb 1/1 Running 0 19s nginx-5ff7956ff6-jxfjt 1/1 Running 0 19s nginx-5ff7956ff6-v6jqw 1/1 Running 0 19s # æŸ¥çœ‹deploymentçš„ä¿¡æ¯ [root@master ~]# kubectl get deploy -n dev NAME READY UP-TO-DATE AVAILABLE AGE nginx 3/3 3 3 2m42s # UP-TO-DATEï¼šæˆåŠŸå‡çº§çš„å‰¯æœ¬æ•°é‡ # AVAILABLEï¼šå¯ç”¨å‰¯æœ¬çš„æ•°é‡ [root@master ~]# kubectl get deploy -n dev -o wide NAME READY UP-TO-DATE AVAILABLE AGE CONTAINERS IMAGES SELECTOR nginx 3/3 3 3 2m51s nginx nginx:latest run=nginx # æŸ¥çœ‹deploymentçš„è¯¦ç»†ä¿¡æ¯ [root@master ~]# kubectl describe deploy nginx -n dev Name: nginx Namespace: dev CreationTimestamp: Wed, 08 May 2021 11:14:14 +0800 Labels: run=nginx Annotations: deployment.kubernetes.io/revision: 1 Selector: run=nginx Replicas: 3 desired | 3 updated | 3 total | 3 available | 0 unavailable StrategyType: RollingUpdate MinReadySeconds: 0 RollingUpdateStrategy: 25% max unavailable, 25% max è¿è§„è¯æ±‡ Pod Template: Labels: run=nginx Containers: nginx: Image: nginx:latest Port: 80/TCP Host Port: 0/TCP Environment: Mounts: Volumes: Conditions: Type Status Reason ---- ------ ------ Available True MinimumReplicasAvailable Progressing True NewReplicaSetAvailable OldReplicaSets: NewReplicaSet: nginx-5ff7956ff6 (3/3 replicas created) Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal ScalingReplicaSet 5m43s deployment-controller Scaled up replicaset nginx-5ff7956ff6 to 3 # åˆ é™¤ [root@master ~]# kubectl delete deploy nginx -n dev deployment.apps \"nginx\" deleted 4.4.2 é…ç½®æ“ä½œ åˆ›å»ºä¸€ä¸ªdeploy-nginx.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š\napiVersion: apps/v1 kind: Deployment metadata: name: nginx namespace: dev spec: replicas: 3 selector: matchLabels: run: nginx template: metadata: labels: run: nginx spec: containers: - image: nginx:latest name: nginx ports: - containerPort: 80 protocol: TCP ç„¶åå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„åˆ›å»ºå’Œåˆ é™¤å‘½ä»¤äº†ï¼š\nåˆ›å»ºï¼škubectl create -f deploy-nginx.yaml\nåˆ é™¤ï¼škubectl delete -f deploy-nginx.yaml\n4.5 Service é€šè¿‡ä¸ŠèŠ‚è¯¾çš„å­¦ä¹ ï¼Œå·²ç»èƒ½å¤Ÿåˆ©ç”¨Deploymentæ¥åˆ›å»ºä¸€ç»„Podæ¥æä¾›å…·æœ‰é«˜å¯ç”¨æ€§çš„æœåŠ¡ã€‚\nè™½ç„¶æ¯ä¸ªPodéƒ½ä¼šåˆ†é…ä¸€ä¸ªå•ç‹¬çš„Pod IPï¼Œç„¶è€Œå´å­˜åœ¨å¦‚ä¸‹ä¸¤é—®é¢˜ï¼š\nPod IP ä¼šéšç€Podçš„é‡å»ºäº§ç”Ÿå˜åŒ– Pod IP ä»…ä»…æ˜¯é›†ç¾¤å†…å¯è§çš„è™šæ‹ŸIPï¼Œå¤–éƒ¨æ— æ³•è®¿é—® è¿™æ ·å¯¹äºè®¿é—®è¿™ä¸ªæœåŠ¡å¸¦æ¥äº†éš¾åº¦ã€‚å› æ­¤ï¼Œkubernetesè®¾è®¡äº†Serviceæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\nServiceå¯ä»¥çœ‹ä½œæ˜¯ä¸€ç»„åŒç±»Podå¯¹å¤–çš„è®¿é—®æ¥å£ã€‚å€ŸåŠ©Serviceï¼Œåº”ç”¨å¯ä»¥æ–¹ä¾¿åœ°å®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚\n4.5.1 åˆ›å»ºé›†ç¾¤å†…éƒ¨å¯è®¿é—®çš„Service # æš´éœ²Service [root@master ~]# kubectl expose deploy nginx --name=svc-nginx1 --type=ClusterIP --port=80 --target-port=80 -n dev service/svc-nginx1 exposed # æŸ¥çœ‹service [root@master ~]# kubectl get svc svc-nginx1 -n dev -o wide NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR svc-nginx1 ClusterIP 10.109.179.231 80/TCP 3m51s run=nginx # è¿™é‡Œäº§ç”Ÿäº†ä¸€ä¸ªCLUSTER-IPï¼Œè¿™å°±æ˜¯serviceçš„IPï¼Œåœ¨Serviceçš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œè¿™ä¸ªåœ°å€æ˜¯ä¸ä¼šå˜åŠ¨çš„ # å¯ä»¥é€šè¿‡è¿™ä¸ªIPè®¿é—®å½“å‰serviceå¯¹åº”çš„POD [root@master ~]# curl 10.109.179.231:80 \u003c!DOCTYPE html\u003e Welcome to nginx! Welcome to nginx! ....... 4.5.2 åˆ›å»ºé›†ç¾¤å¤–éƒ¨ä¹Ÿå¯è®¿é—®çš„Service # ä¸Šé¢åˆ›å»ºçš„Serviceçš„typeç±»å‹ä¸ºClusterIPï¼Œè¿™ä¸ªipåœ°å€åªç”¨é›†ç¾¤å†…éƒ¨å¯è®¿é—® # å¦‚æœéœ€è¦åˆ›å»ºå¤–éƒ¨ä¹Ÿå¯ä»¥è®¿é—®çš„Serviceï¼Œéœ€è¦ä¿®æ”¹typeä¸ºNodePort [root@master ~]# kubectl expose deploy nginx --name=svc-nginx2 --type=NodePort --port=80 --target-port=80 -n dev service/svc-nginx2 exposed # æ­¤æ—¶æŸ¥çœ‹ï¼Œä¼šå‘ç°å‡ºç°äº†NodePortç±»å‹çš„Serviceï¼Œè€Œä¸”æœ‰ä¸€å¯¹Portï¼ˆ80:31928/TCï¼‰ [root@master ~]# kubectl get svc svc-nginx2 -n dev -o wide NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR svc-nginx2 NodePort 10.100.94.0 80:31928/TCP 9s run=nginx # æ¥ä¸‹æ¥å°±å¯ä»¥é€šè¿‡é›†ç¾¤å¤–çš„ä¸»æœºè®¿é—® èŠ‚ç‚¹IP:31928è®¿é—®æœåŠ¡äº† # ä¾‹å¦‚åœ¨çš„ç”µè„‘ä¸»æœºä¸Šé€šè¿‡æµè§ˆå™¨è®¿é—®ä¸‹é¢çš„åœ°å€ http:/192.168.90.100:31928/ 4.5.3 åˆ é™¤Service [root@master ~]# kubectl delete svc svc-nginx-1 -n dev service \"svc-nginx-1\" deleted 4.5.4 é…ç½®æ–¹å¼ åˆ›å»ºä¸€ä¸ªsvc-nginx.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š\napiVersion: v1 kind: Service metadata: name: svc-nginx namespace: dev spec: clusterIP: 10.109.179.231 #å›ºå®šsvcçš„å†…ç½‘ip ports: - port: 80 protocol: TCP targetPort: 80 selector: run: nginx type: ClusterIP ç„¶åå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„åˆ›å»ºå’Œåˆ é™¤å‘½ä»¤äº†ï¼š\nåˆ›å»ºï¼škubectl create -f svc-nginx.yaml\nåˆ é™¤ï¼škubectl delete -f svc-nginx.yaml\nå°ç»“\nè‡³æ­¤ï¼Œå·²ç»æŒæ¡äº†Namespaceã€Podã€Deploymentã€Serviceèµ„æºçš„åŸºæœ¬æ“ä½œï¼Œæœ‰äº†è¿™äº›æ“ä½œï¼Œå°±å¯ä»¥åœ¨kubernetesé›†ç¾¤ä¸­å®ç°ä¸€ä¸ªæœåŠ¡çš„ç®€å•éƒ¨ç½²å’Œè®¿é—®äº†ï¼Œä½†æ˜¯å¦‚æœæƒ³è¦æ›´å¥½çš„ä½¿ç”¨kubernetesï¼Œå°±éœ€è¦æ·±å…¥å­¦ä¹ è¿™å‡ ç§èµ„æºçš„ç»†èŠ‚å’ŒåŸç†ã€‚\n5. Podè¯¦è§£ 5.1 Podä»‹ç» 5.1.1 Podç»“æ„ æ¯ä¸ªPodä¸­éƒ½å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ï¼Œè¿™äº›å®¹å™¨å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š\nç”¨æˆ·ç¨‹åºæ‰€åœ¨çš„å®¹å™¨ï¼Œæ•°é‡å¯å¤šå¯å°‘\nPauseå®¹å™¨ï¼Œè¿™æ˜¯æ¯ä¸ªPodéƒ½ä¼šæœ‰çš„ä¸€ä¸ªæ ¹å®¹å™¨ï¼Œå®ƒçš„ä½œç”¨æœ‰ä¸¤ä¸ªï¼š\nå¯ä»¥ä»¥å®ƒä¸ºä¾æ®ï¼Œè¯„ä¼°æ•´ä¸ªPodçš„å¥åº·çŠ¶æ€\nå¯ä»¥åœ¨æ ¹å®¹å™¨ä¸Šè®¾ç½®Ipåœ°å€ï¼Œå…¶å®ƒå®¹å™¨éƒ½æ­¤Ipï¼ˆPod IPï¼‰ï¼Œä»¥å®ç°Podå†…éƒ¨çš„ç½‘è·¯é€šä¿¡\nè¿™é‡Œæ˜¯Podå†…éƒ¨çš„é€šè®¯ï¼ŒPodçš„ä¹‹é—´çš„é€šè®¯é‡‡ç”¨è™šæ‹ŸäºŒå±‚ç½‘ç»œæŠ€æœ¯æ¥å®ç°ï¼Œæˆ‘ä»¬å½“å‰ç¯å¢ƒç”¨çš„æ˜¯Flannel 5.1.2 Podå®šä¹‰ ä¸‹é¢æ˜¯Podçš„èµ„æºæ¸…å•ï¼š\napiVersion: v1 #å¿…é€‰ï¼Œç‰ˆæœ¬å·ï¼Œä¾‹å¦‚v1 kind: Pod #å¿…é€‰ï¼Œèµ„æºç±»å‹ï¼Œä¾‹å¦‚ Pod metadata: #å¿…é€‰ï¼Œå…ƒæ•°æ® name: string #å¿…é€‰ï¼ŒPodåç§° namespace: string #Podæ‰€å±çš„å‘½åç©ºé—´,é»˜è®¤ä¸º\"default\" labels: #è‡ªå®šä¹‰æ ‡ç­¾åˆ—è¡¨ - name: string spec: #å¿…é€‰ï¼ŒPodä¸­å®¹å™¨çš„è¯¦ç»†å®šä¹‰ containers: #å¿…é€‰ï¼ŒPodä¸­å®¹å™¨åˆ—è¡¨ - name: string #å¿…é€‰ï¼Œå®¹å™¨åç§° image: string #å¿…é€‰ï¼Œå®¹å™¨çš„é•œåƒåç§° imagePullPolicy: [ Always|Never|IfNotPresent ] #è·å–é•œåƒçš„ç­–ç•¥ command: [string] #å®¹å™¨çš„å¯åŠ¨å‘½ä»¤åˆ—è¡¨ï¼Œå¦‚ä¸æŒ‡å®šï¼Œä½¿ç”¨æ‰“åŒ…æ—¶ä½¿ç”¨çš„å¯åŠ¨å‘½ä»¤ args: [string] #å®¹å™¨çš„å¯åŠ¨å‘½ä»¤å‚æ•°åˆ—è¡¨ workingDir: string #å®¹å™¨çš„å·¥ä½œç›®å½• volumeMounts: #æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨çš„å­˜å‚¨å·é…ç½® - name: string #å¼•ç”¨podå®šä¹‰çš„å…±äº«å­˜å‚¨å·çš„åç§°ï¼Œéœ€ç”¨volumes[]éƒ¨åˆ†å®šä¹‰çš„çš„å·å mountPath: string #å­˜å‚¨å·åœ¨å®¹å™¨å†…mountçš„ç»å¯¹è·¯å¾„ï¼Œåº”å°‘äº512å­—ç¬¦ readOnly: boolean #æ˜¯å¦ä¸ºåªè¯»æ¨¡å¼ ports: #éœ€è¦æš´éœ²çš„ç«¯å£åº“å·åˆ—è¡¨ - name: string #ç«¯å£çš„åç§° containerPort: int #å®¹å™¨éœ€è¦ç›‘å¬çš„ç«¯å£å· hostPort: int #å®¹å™¨æ‰€åœ¨ä¸»æœºéœ€è¦ç›‘å¬çš„ç«¯å£å·ï¼Œé»˜è®¤ä¸Containerç›¸åŒ protocol: string #ç«¯å£åè®®ï¼Œæ”¯æŒTCPå’ŒUDPï¼Œé»˜è®¤TCP env: #å®¹å™¨è¿è¡Œå‰éœ€è®¾ç½®çš„ç¯å¢ƒå˜é‡åˆ—è¡¨ - name: string #ç¯å¢ƒå˜é‡åç§° value: string #ç¯å¢ƒå˜é‡çš„å€¼ resources: #èµ„æºé™åˆ¶å’Œè¯·æ±‚çš„è®¾ç½® limits: #èµ„æºé™åˆ¶çš„è®¾ç½® cpu: string #Cpuçš„é™åˆ¶ï¼Œå•ä½ä¸ºcoreæ•°ï¼Œå°†ç”¨äºdocker run --cpu-shareså‚æ•° memory: string #å†…å­˜é™åˆ¶ï¼Œå•ä½å¯ä»¥ä¸ºMib/Gibï¼Œå°†ç”¨äºdocker run --memoryå‚æ•° requests: #èµ„æºè¯·æ±‚çš„è®¾ç½® cpu: string #Cpuè¯·æ±‚ï¼Œå®¹å™¨å¯åŠ¨çš„åˆå§‹å¯ç”¨æ•°é‡ memory: string #å†…å­˜è¯·æ±‚,å®¹å™¨å¯åŠ¨çš„åˆå§‹å¯ç”¨æ•°é‡ lifecycle: #ç”Ÿå‘½å‘¨æœŸé’©å­ postStart: #å®¹å™¨å¯åŠ¨åç«‹å³æ‰§è¡Œæ­¤é’©å­,å¦‚æœæ‰§è¡Œå¤±è´¥,ä¼šæ ¹æ®é‡å¯ç­–ç•¥è¿›è¡Œé‡å¯ preStop: #å®¹å™¨ç»ˆæ­¢å‰æ‰§è¡Œæ­¤é’©å­,æ— è®ºç»“æœå¦‚ä½•,å®¹å™¨éƒ½ä¼šç»ˆæ­¢ livenessProbe: #å¯¹Podå†…å„å®¹å™¨å¥åº·æ£€æŸ¥çš„è®¾ç½®ï¼Œå½“æ¢æµ‹æ— å“åº”å‡ æ¬¡åå°†è‡ªåŠ¨é‡å¯è¯¥å®¹å™¨ exec: #å¯¹Podå®¹å™¨å†…æ£€æŸ¥æ–¹å¼è®¾ç½®ä¸ºexecæ–¹å¼ command: [string] #execæ–¹å¼éœ€è¦åˆ¶å®šçš„å‘½ä»¤æˆ–è„šæœ¬ httpGet: #å¯¹Podå†…ä¸ªå®¹å™¨å¥åº·æ£€æŸ¥æ–¹æ³•è®¾ç½®ä¸ºHttpGetï¼Œéœ€è¦åˆ¶å®šPathã€port path: string port: number host: string scheme: string HttpHeaders: - name: string value: string tcpSocket: #å¯¹Podå†…ä¸ªå®¹å™¨å¥åº·æ£€æŸ¥æ–¹å¼è®¾ç½®ä¸ºtcpSocketæ–¹å¼ port: number initialDelaySeconds: 0 #å®¹å™¨å¯åŠ¨å®Œæˆåé¦–æ¬¡æ¢æµ‹çš„æ—¶é—´ï¼Œå•ä½ä¸ºç§’ timeoutSeconds: 0 #å¯¹å®¹å™¨å¥åº·æ£€æŸ¥æ¢æµ‹ç­‰å¾…å“åº”çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ç§’ï¼Œé»˜è®¤1ç§’ periodSeconds: 0 #å¯¹å®¹å™¨ç›‘æ§æ£€æŸ¥çš„å®šæœŸæ¢æµ‹æ—¶é—´è®¾ç½®ï¼Œå•ä½ç§’ï¼Œé»˜è®¤10ç§’ä¸€æ¬¡ successThreshold: 0 failureThreshold: 0 securityContext: privileged: false restartPolicy: [Always | Never | OnFailure] #Podçš„é‡å¯ç­–ç•¥ nodeName: #è®¾ç½®NodeNameè¡¨ç¤ºå°†è¯¥Podè°ƒåº¦åˆ°æŒ‡å®šåˆ°åç§°çš„nodeèŠ‚ç‚¹ä¸Š nodeSelector: obeject #è®¾ç½®NodeSelectorè¡¨ç¤ºå°†è¯¥Podè°ƒåº¦åˆ°åŒ…å«è¿™ä¸ªlabelçš„nodeä¸Š imagePullSecrets: #Pullé•œåƒæ—¶ä½¿ç”¨çš„secretåç§°ï¼Œä»¥keyï¼šsecretkeyæ ¼å¼æŒ‡å®š - name: string hostNetwork: false #æ˜¯å¦ä½¿ç”¨ä¸»æœºç½‘ç»œæ¨¡å¼ï¼Œé»˜è®¤ä¸ºfalseï¼Œå¦‚æœè®¾ç½®ä¸ºtrueï¼Œè¡¨ç¤ºä½¿ç”¨å®¿ä¸»æœºç½‘ç»œ volumes: #åœ¨è¯¥podä¸Šå®šä¹‰å…±äº«å­˜å‚¨å·åˆ—è¡¨ - name: string #å…±äº«å­˜å‚¨å·åç§° ï¼ˆvolumesç±»å‹æœ‰å¾ˆå¤šç§ï¼‰ emptyDir: {} #ç±»å‹ä¸ºemtyDirçš„å­˜å‚¨å·ï¼Œä¸PodåŒç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªä¸´æ—¶ç›®å½•ã€‚ä¸ºç©ºå€¼ hostPath: string #ç±»å‹ä¸ºhostPathçš„å­˜å‚¨å·ï¼Œè¡¨ç¤ºæŒ‚è½½Podæ‰€åœ¨å®¿ä¸»æœºçš„ç›®å½• path: string #Podæ‰€åœ¨å®¿ä¸»æœºçš„ç›®å½•ï¼Œå°†è¢«ç”¨äºåŒæœŸä¸­mountçš„ç›®å½• secret: #ç±»å‹ä¸ºsecretçš„å­˜å‚¨å·ï¼ŒæŒ‚è½½é›†ç¾¤ä¸å®šä¹‰çš„secretå¯¹è±¡åˆ°å®¹å™¨å†…éƒ¨ scretname: string items: - key: string path: string configMap: #ç±»å‹ä¸ºconfigMapçš„å­˜å‚¨å·ï¼ŒæŒ‚è½½é¢„å®šä¹‰çš„configMapå¯¹è±¡åˆ°å®¹å™¨å†…éƒ¨ name: string items: - key: string path: string #å°æç¤ºï¼š # åœ¨è¿™é‡Œï¼Œå¯é€šè¿‡ä¸€ä¸ªå‘½ä»¤æ¥æŸ¥çœ‹æ¯ç§èµ„æºçš„å¯é…ç½®é¡¹ # kubectl explain èµ„æºç±»å‹ æŸ¥çœ‹æŸç§èµ„æºå¯ä»¥é…ç½®çš„ä¸€çº§å±æ€§ # kubectl explain èµ„æºç±»å‹.å±æ€§ æŸ¥çœ‹å±æ€§çš„å­å±æ€§ [root@k8s-master01 ~]# kubectl explain pod KIND: Pod VERSION: v1 FIELDS: apiVersion kind metadata spec status [root@k8s-master01 ~]# kubectl explain pod.metadata KIND: Pod VERSION: v1 RESOURCE: metadata FIELDS: annotations ",
  "wordCount" : "54291",
  "inLanguage": "en",
  "image":"https://old.colorfulgz.com/posts.images/banner/index.jpg","datePublished": "2023-05-20T00:23:06+08:00",
  "dateModified": "2023-05-20T00:23:06+08:00",
  "author":[{
    "@type": "Person",
    "name": ""
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://old.colorfulgz.com/posts/kubernetes/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "DevOpsHub",
    "logo": {
      "@type": "ImageObject",
      "url": "https://old.colorfulgz.com/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://old.colorfulgz.com" accesskey="h" title="DevOpsHub (Alt + H)">
            <img src="https://old.colorfulgz.com/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">DevOpsHub</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://old.colorfulgz.com/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://old.colorfulgz.com/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://old.colorfulgz.com/posts" title="ğŸ“š æ–‡ç« ">
                <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://old.colorfulgz.com/tags" title="ğŸ§© æ ‡ç­¾">
                <span>ğŸ§© æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://old.colorfulgz.com/archives/" title="â±ï¸ æ—¶é—´è½´">
                <span>â±ï¸ æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://old.colorfulgz.com/about" title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº">
                <span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://old.colorfulgz.com">ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://old.colorfulgz.com/posts/">ğŸ“šæ–‡ç« </a></div>
            <h1 class="post-title">
                Kubernetesè¯¦ç»†æ•™ç¨‹
            </h1>
            <div class="post-description">
                Kubernetes æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å¼•æ“ï¼Œç”¨æ¥å¯¹å®¹å™¨åŒ–åº”ç”¨è¿›è¡Œè‡ªåŠ¨åŒ–éƒ¨ç½²ã€ æ‰©ç¼©å’Œç®¡ç†
            </div>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2023-05-20
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>54291å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>109åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://old.colorfulgz.com/tags/kubernetes/" style="color: var(--secondary)!important;">kubernetes</a>
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    <span id="post_meta_style_8">
                        <span class="fa fa-commenting-o"></span>
                        <span>
                            <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js"></script>
                            <script>
                                let url = document.documentURI
                                
                                let dnsUrl = "https://old.colorfulgz.com"
                                let urlSplit = url.split(dnsUrl)
                                let finalUrl = urlSplit[1]
                                if (finalUrl[0] !== '/') {
                                    finalUrl = '/'+finalUrl
                                }
                                twikoo.getCommentsCount({
                                    envId:  null , 
                                region:  null , 
                                urls: [ 
                                    
                                    finalUrl,
                                ],
                                    includeReply: false 
                                }).then(function (res) {
                                    let count = res[0].count
                                    const obj = document.getElementById("comment_count");
                                    obj.innerText = count
                                    
                                    
                                    
                                }).catch(function (err) {
                                    
                                    console.error(err);
                                });
                            </script>
                            <span id="comment_count"></span>
                        </span>
                    </span>
                </span>

</div>
        </header> 
<figure class="entry-cover1"><img style="zoom:;" loading="lazy" src="https://old.colorfulgz.com/posts.images/banner/index.jpg" alt="">
    
</figure><aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#kubernetes%e8%af%a6%e7%bb%86%e6%95%99%e7%a8%8b" aria-label="Kubernetesè¯¦ç»†æ•™ç¨‹">Kubernetesè¯¦ç»†æ•™ç¨‹</a><ul>
                        
                <li>
                    <a href="#1-kubernetes%e4%bb%8b%e7%bb%8d" aria-label="1. Kubernetesä»‹ç»">1. Kubernetesä»‹ç»</a><ul>
                        
                <li>
                    <a href="#11-%e5%ba%94%e7%94%a8%e9%83%a8%e7%bd%b2%e6%96%b9%e5%bc%8f%e6%bc%94%e5%8f%98" aria-label="1.1 åº”ç”¨éƒ¨ç½²æ–¹å¼æ¼”å˜">1.1 åº”ç”¨éƒ¨ç½²æ–¹å¼æ¼”å˜</a></li>
                <li>
                    <a href="#12-kubernetes%e7%ae%80%e4%bb%8b" aria-label="1.2 kubernetesç®€ä»‹">1.2 kubernetesç®€ä»‹</a></li>
                <li>
                    <a href="#13-kubernetes%e7%bb%84%e4%bb%b6" aria-label="1.3 kubernetesç»„ä»¶">1.3 kubernetesç»„ä»¶</a></li>
                <li>
                    <a href="#14-kubernetes%e6%a6%82%e5%bf%b5" aria-label="1.4 kubernetesæ¦‚å¿µ">1.4 kubernetesæ¦‚å¿µ</a></li></ul>
                </li>
                <li>
                    <a href="#2-kubernetes%e9%9b%86%e7%be%a4%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba" aria-label="2. kubernetesé›†ç¾¤ç¯å¢ƒæ­å»º">2. kubernetesé›†ç¾¤ç¯å¢ƒæ­å»º</a><ul>
                        
                <li>
                    <a href="#21-%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86%e7%82%b9" aria-label="2.1 å‰ç½®çŸ¥è¯†ç‚¹">2.1 å‰ç½®çŸ¥è¯†ç‚¹</a></li>
                <li>
                    <a href="#22-kubeadm-%e9%83%a8%e7%bd%b2%e6%96%b9%e5%bc%8f%e4%bb%8b%e7%bb%8d" aria-label="2.2 kubeadm éƒ¨ç½²æ–¹å¼ä»‹ç»">2.2 kubeadm éƒ¨ç½²æ–¹å¼ä»‹ç»</a></li>
                <li>
                    <a href="#23-%e5%ae%89%e8%a3%85%e8%a6%81%e6%b1%82" aria-label="2.3 å®‰è£…è¦æ±‚">2.3 å®‰è£…è¦æ±‚</a></li>
                <li>
                    <a href="#24-%e6%9c%80%e7%bb%88%e7%9b%ae%e6%a0%87" aria-label="2.4 æœ€ç»ˆç›®æ ‡">2.4 æœ€ç»ˆç›®æ ‡</a></li>
                <li>
                    <a href="#25-%e5%87%86%e5%a4%87%e7%8e%af%e5%a2%83" aria-label="2.5 å‡†å¤‡ç¯å¢ƒ">2.5 å‡†å¤‡ç¯å¢ƒ</a></li>
                <li>
                    <a href="#26-%e7%8e%af%e5%a2%83%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="2.6 ç¯å¢ƒåˆå§‹åŒ–">2.6 ç¯å¢ƒåˆå§‹åŒ–</a><ul>
                        
                <li>
                    <a href="#261-%e6%a3%80%e6%9f%a5%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e7%9a%84%e7%89%88%e6%9c%ac" aria-label="2.6.1 æ£€æŸ¥æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬">2.6.1 æ£€æŸ¥æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬</a></li>
                <li>
                    <a href="#262-%e4%b8%bb%e6%9c%ba%e5%90%8d%e8%a7%a3%e6%9e%90" aria-label="2.6.2 ä¸»æœºåè§£æ">2.6.2 ä¸»æœºåè§£æ</a></li>
                <li>
                    <a href="#263-%e6%97%b6%e9%97%b4%e5%90%8c%e6%ad%a5" aria-label="2.6.3 æ—¶é—´åŒæ­¥">2.6.3 æ—¶é—´åŒæ­¥</a></li>
                <li>
                    <a href="#264--%e7%a6%81%e7%94%a8iptable%e5%92%8cfirewalld%e6%9c%8d%e5%8a%a1" aria-label="2.6.4  ç¦ç”¨iptableå’ŒfirewalldæœåŠ¡">2.6.4  ç¦ç”¨iptableå’ŒfirewalldæœåŠ¡</a></li>
                <li>
                    <a href="#265-%e7%a6%81%e7%94%a8selinux" aria-label="2.6.5 ç¦ç”¨selinux">2.6.5 ç¦ç”¨selinux</a></li>
                <li>
                    <a href="#266-%e7%a6%81%e7%94%a8swap%e5%88%86%e5%8c%ba" aria-label="2.6.6 ç¦ç”¨swapåˆ†åŒº">2.6.6 ç¦ç”¨swapåˆ†åŒº</a></li>
                <li>
                    <a href="#267-%e4%bf%ae%e6%94%b9linux%e7%9a%84%e5%86%85%e6%a0%b8%e5%8f%82%e6%95%b0" aria-label="2.6.7 ä¿®æ”¹linuxçš„å†…æ ¸å‚æ•°">2.6.7 ä¿®æ”¹linuxçš„å†…æ ¸å‚æ•°</a></li>
                <li>
                    <a href="#268-%e9%85%8d%e7%bd%aeipvs%e5%8a%9f%e8%83%bd" aria-label="2.6.8 é…ç½®ipvsåŠŸèƒ½">2.6.8 é…ç½®ipvsåŠŸèƒ½</a></li>
                <li>
                    <a href="#269-%e5%ae%89%e8%a3%85docker" aria-label="2.6.9 å®‰è£…docker">2.6.9 å®‰è£…docker</a></li>
                <li>
                    <a href="#2610-%e5%ae%89%e8%a3%85kubernetes%e7%bb%84%e4%bb%b6" aria-label="2.6.10 å®‰è£…Kubernetesç»„ä»¶">2.6.10 å®‰è£…Kubernetesç»„ä»¶</a></li>
                <li>
                    <a href="#2611-%e5%87%86%e5%a4%87%e9%9b%86%e7%be%a4%e9%95%9c%e5%83%8f" aria-label="2.6.11 å‡†å¤‡é›†ç¾¤é•œåƒ">2.6.11 å‡†å¤‡é›†ç¾¤é•œåƒ</a></li>
                <li>
                    <a href="#2611-%e9%9b%86%e7%be%a4%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="2.6.11 é›†ç¾¤åˆå§‹åŒ–">2.6.11 é›†ç¾¤åˆå§‹åŒ–</a></li>
                <li>
                    <a href="#2613-%e5%ae%89%e8%a3%85%e7%bd%91%e7%bb%9c%e6%8f%92%e4%bb%b6%e5%8f%aa%e5%9c%a8master%e8%8a%82%e7%82%b9%e6%93%8d%e4%bd%9c%e5%8d%b3%e5%8f%af" aria-label="2.6.13 å®‰è£…ç½‘ç»œæ’ä»¶ï¼Œåªåœ¨masterèŠ‚ç‚¹æ“ä½œå³å¯">2.6.13 å®‰è£…ç½‘ç»œæ’ä»¶ï¼Œåªåœ¨masterèŠ‚ç‚¹æ“ä½œå³å¯</a></li>
                <li>
                    <a href="#2614-%e4%bd%bf%e7%94%a8kubeadm-reset%e9%87%8d%e7%bd%ae%e9%9b%86%e7%be%a4" aria-label="2.6.14 ä½¿ç”¨kubeadm reseté‡ç½®é›†ç¾¤">2.6.14 ä½¿ç”¨kubeadm reseté‡ç½®é›†ç¾¤</a></li>
                <li>
                    <a href="#2615-%e9%87%8d%e5%90%afkubelet%e5%92%8cdocker" aria-label="2.6.15 é‡å¯kubeletå’Œdocker">2.6.15 é‡å¯kubeletå’Œdocker</a></li>
                <li>
                    <a href="#2616-kubeadm%e4%b8%ad%e7%9a%84%e5%91%bd%e4%bb%a4" aria-label="2.6.16 kubeadmä¸­çš„å‘½ä»¤">2.6.16 kubeadmä¸­çš„å‘½ä»¤</a></li></ul>
                </li>
                <li>
                    <a href="#27-%e9%9b%86%e7%be%a4%e6%b5%8b%e8%af%95" aria-label="2.7 é›†ç¾¤æµ‹è¯•">2.7 é›†ç¾¤æµ‹è¯•</a><ul>
                        
                <li>
                    <a href="#271-%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aanginx%e6%9c%8d%e5%8a%a1" aria-label="2.7.1 åˆ›å»ºä¸€ä¸ªnginxæœåŠ¡">2.7.1 åˆ›å»ºä¸€ä¸ªnginxæœåŠ¡</a></li>
                <li>
                    <a href="#272-%e6%9a%b4%e9%9c%b2%e7%ab%af%e5%8f%a3" aria-label="2.7.2 æš´éœ²ç«¯å£">2.7.2 æš´éœ²ç«¯å£</a></li>
                <li>
                    <a href="#273-%e6%9f%a5%e7%9c%8b%e6%9c%8d%e5%8a%a1" aria-label="2.7.3 æŸ¥çœ‹æœåŠ¡">2.7.3 æŸ¥çœ‹æœåŠ¡</a></li>
                <li>
                    <a href="#274-%e6%9f%a5%e7%9c%8bpod" aria-label="2.7.4 æŸ¥çœ‹pod">2.7.4 æŸ¥çœ‹pod</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#3-%e8%b5%84%e6%ba%90%e7%ae%a1%e7%90%86" aria-label="3. èµ„æºç®¡ç†">3. èµ„æºç®¡ç†</a><ul>
                        
                <li>
                    <a href="#31-%e8%b5%84%e6%ba%90%e7%ae%a1%e7%90%86%e4%bb%8b%e7%bb%8d" aria-label="3.1 èµ„æºç®¡ç†ä»‹ç»">3.1 èµ„æºç®¡ç†ä»‹ç»</a></li>
                <li>
                    <a href="#32-yaml%e8%af%ad%e8%a8%80%e4%bb%8b%e7%bb%8d" aria-label="3.2 YAMLè¯­è¨€ä»‹ç»">3.2 YAMLè¯­è¨€ä»‹ç»</a></li>
                <li>
                    <a href="#33-%e8%b5%84%e6%ba%90%e7%ae%a1%e7%90%86%e6%96%b9%e5%bc%8f" aria-label="3.3 èµ„æºç®¡ç†æ–¹å¼">3.3 èµ„æºç®¡ç†æ–¹å¼</a><ul>
                        
                <li>
                    <a href="#331-%e5%91%bd%e4%bb%a4%e5%bc%8f%e5%af%b9%e8%b1%a1%e7%ae%a1%e7%90%86" aria-label="3.3.1 å‘½ä»¤å¼å¯¹è±¡ç®¡ç†">3.3.1 å‘½ä»¤å¼å¯¹è±¡ç®¡ç†</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#332-%e5%91%bd%e4%bb%a4%e5%bc%8f%e5%af%b9%e8%b1%a1%e9%85%8d%e7%bd%ae" aria-label="3.3.2 å‘½ä»¤å¼å¯¹è±¡é…ç½®">3.3.2 å‘½ä»¤å¼å¯¹è±¡é…ç½®</a></li>
                <li>
                    <a href="#333-%e5%a3%b0%e6%98%8e%e5%bc%8f%e5%af%b9%e8%b1%a1%e9%85%8d%e7%bd%ae" aria-label="3.3.3 å£°æ˜å¼å¯¹è±¡é…ç½®">3.3.3 å£°æ˜å¼å¯¹è±¡é…ç½®</a></li>
                <li>
                    <a href="#4-%e5%ae%9e%e6%88%98%e5%85%a5%e9%97%a8" aria-label="4. å®æˆ˜å…¥é—¨">4. å®æˆ˜å…¥é—¨</a><ul>
                        
                <li>
                    <a href="#41-namespace" aria-label="4.1 Namespace">4.1 Namespace</a><ul>
                        
                <li>
                    <a href="#411-%e6%9f%a5%e7%9c%8b" aria-label="4.1.1 æŸ¥çœ‹">4.1.1 æŸ¥çœ‹</a></li>
                <li>
                    <a href="#412-%e5%88%9b%e5%bb%ba" aria-label="4.1.2 åˆ›å»º">4.1.2 åˆ›å»º</a></li>
                <li>
                    <a href="#413-%e5%88%a0%e9%99%a4" aria-label="4.1.3 åˆ é™¤">4.1.3 åˆ é™¤</a></li>
                <li>
                    <a href="#414-%e9%85%8d%e7%bd%ae%e6%96%b9%e5%bc%8f" aria-label="4.1.4 é…ç½®æ–¹å¼">4.1.4 é…ç½®æ–¹å¼</a></li></ul>
                </li>
                <li>
                    <a href="#42-pod" aria-label="4.2 Pod">4.2 Pod</a><ul>
                        
                <li>
                    <a href="#421-%e5%88%9b%e5%bb%ba%e5%b9%b6%e8%bf%90%e8%a1%8c" aria-label="4.2.1 åˆ›å»ºå¹¶è¿è¡Œ">4.2.1 åˆ›å»ºå¹¶è¿è¡Œ</a></li>
                <li>
                    <a href="#422-%e6%9f%a5%e7%9c%8bpod%e4%bf%a1%e6%81%af" aria-label="4.2.2 æŸ¥çœ‹podä¿¡æ¯">4.2.2 æŸ¥çœ‹podä¿¡æ¯</a></li>
                <li>
                    <a href="#423-%e8%ae%bf%e9%97%aepod" aria-label="4.2.3 è®¿é—®Pod">4.2.3 è®¿é—®Pod</a></li>
                <li>
                    <a href="#424-%e5%88%a0%e9%99%a4%e6%8c%87%e5%ae%9apod" aria-label="4.2.4 åˆ é™¤æŒ‡å®šPod">4.2.4 åˆ é™¤æŒ‡å®šPod</a></li>
                <li>
                    <a href="#425-%e9%85%8d%e7%bd%ae%e6%93%8d%e4%bd%9c" aria-label="4.2.5 é…ç½®æ“ä½œ">4.2.5 é…ç½®æ“ä½œ</a></li></ul>
                </li>
                <li>
                    <a href="#43-label" aria-label="4.3 Label">4.3 Label</a><ul>
                        
                <li>
                    <a href="#431-%e5%91%bd%e4%bb%a4%e6%96%b9%e5%bc%8f" aria-label="4.3.1 å‘½ä»¤æ–¹å¼">4.3.1 å‘½ä»¤æ–¹å¼</a></li>
                <li>
                    <a href="#432-%e9%85%8d%e7%bd%ae%e6%96%b9%e5%bc%8f" aria-label="4.3.2 é…ç½®æ–¹å¼">4.3.2 é…ç½®æ–¹å¼</a></li></ul>
                </li>
                <li>
                    <a href="#44-deployment" aria-label="4.4 Deployment">4.4 Deployment</a><ul>
                        
                <li>
                    <a href="#441-%e5%91%bd%e4%bb%a4%e6%93%8d%e4%bd%9c" aria-label="4.4.1 å‘½ä»¤æ“ä½œ">4.4.1 å‘½ä»¤æ“ä½œ</a></li>
                <li>
                    <a href="#442-%e9%85%8d%e7%bd%ae%e6%93%8d%e4%bd%9c" aria-label="4.4.2 é…ç½®æ“ä½œ">4.4.2 é…ç½®æ“ä½œ</a></li></ul>
                </li>
                <li>
                    <a href="#45-service" aria-label="4.5 Service">4.5 Service</a><ul>
                        
                <li>
                    <a href="#451-%e5%88%9b%e5%bb%ba%e9%9b%86%e7%be%a4%e5%86%85%e9%83%a8%e5%8f%af%e8%ae%bf%e9%97%ae%e7%9a%84service" aria-label="4.5.1 åˆ›å»ºé›†ç¾¤å†…éƒ¨å¯è®¿é—®çš„Service">4.5.1 åˆ›å»ºé›†ç¾¤å†…éƒ¨å¯è®¿é—®çš„Service</a></li>
                <li>
                    <a href="#452-%e5%88%9b%e5%bb%ba%e9%9b%86%e7%be%a4%e5%a4%96%e9%83%a8%e4%b9%9f%e5%8f%af%e8%ae%bf%e9%97%ae%e7%9a%84service" aria-label="4.5.2 åˆ›å»ºé›†ç¾¤å¤–éƒ¨ä¹Ÿå¯è®¿é—®çš„Service">4.5.2 åˆ›å»ºé›†ç¾¤å¤–éƒ¨ä¹Ÿå¯è®¿é—®çš„Service</a></li>
                <li>
                    <a href="#453-%e5%88%a0%e9%99%a4service" aria-label="4.5.3 åˆ é™¤Service">4.5.3 åˆ é™¤Service</a></li>
                <li>
                    <a href="#454-%e9%85%8d%e7%bd%ae%e6%96%b9%e5%bc%8f" aria-label="4.5.4 é…ç½®æ–¹å¼">4.5.4 é…ç½®æ–¹å¼</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#5-pod%e8%af%a6%e8%a7%a3" aria-label="5. Podè¯¦è§£">5. Podè¯¦è§£</a><ul>
                        
                <li>
                    <a href="#51-pod%e4%bb%8b%e7%bb%8d" aria-label="5.1 Podä»‹ç»">5.1 Podä»‹ç»</a><ul>
                        
                <li>
                    <a href="#511-pod%e7%bb%93%e6%9e%84" aria-label="5.1.1 Podç»“æ„">5.1.1 Podç»“æ„</a></li>
                <li>
                    <a href="#512-pod%e5%ae%9a%e4%b9%89" aria-label="5.1.2 Podå®šä¹‰">5.1.2 Podå®šä¹‰</a></li></ul>
                </li>
                <li>
                    <a href="#52-pod%e9%85%8d%e7%bd%ae" aria-label="5.2 Podé…ç½®">5.2 Podé…ç½®</a><ul>
                        
                <li>
                    <a href="#521-%e5%9f%ba%e6%9c%ac%e9%85%8d%e7%bd%ae" aria-label="5.2.1 åŸºæœ¬é…ç½®">5.2.1 åŸºæœ¬é…ç½®</a></li>
                <li>
                    <a href="#522-%e9%95%9c%e5%83%8f%e6%8b%89%e5%8f%96" aria-label="5.2.2 é•œåƒæ‹‰å–">5.2.2 é•œåƒæ‹‰å–</a></li>
                <li>
                    <a href="#523-%e5%90%af%e5%8a%a8%e5%91%bd%e4%bb%a4" aria-label="5.2.3 å¯åŠ¨å‘½ä»¤">5.2.3 å¯åŠ¨å‘½ä»¤</a></li>
                <li>
                    <a href="#524-%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f" aria-label="5.2.4 ç¯å¢ƒå˜é‡">5.2.4 ç¯å¢ƒå˜é‡</a></li>
                <li>
                    <a href="#525-%e7%ab%af%e5%8f%a3%e8%ae%be%e7%bd%ae" aria-label="5.2.5 ç«¯å£è®¾ç½®">5.2.5 ç«¯å£è®¾ç½®</a></li>
                <li>
                    <a href="#526-%e8%b5%84%e6%ba%90%e9%85%8d%e9%a2%9d" aria-label="5.2.6 èµ„æºé…é¢">5.2.6 èµ„æºé…é¢</a></li></ul>
                </li>
                <li>
                    <a href="#53-pod%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" aria-label="5.3 Podç”Ÿå‘½å‘¨æœŸ">5.3 Podç”Ÿå‘½å‘¨æœŸ</a><ul>
                        
                <li>
                    <a href="#531-%e5%88%9b%e5%bb%ba%e5%92%8c%e7%bb%88%e6%ad%a2" aria-label="5.3.1 åˆ›å»ºå’Œç»ˆæ­¢">5.3.1 åˆ›å»ºå’Œç»ˆæ­¢</a></li>
                <li>
                    <a href="#532-%e5%88%9d%e5%a7%8b%e5%8c%96%e5%ae%b9%e5%99%a8" aria-label="5.3.2 åˆå§‹åŒ–å®¹å™¨">5.3.2 åˆå§‹åŒ–å®¹å™¨</a></li>
                <li>
                    <a href="#533-%e9%92%a9%e5%ad%90%e5%87%bd%e6%95%b0" aria-label="5.3.3 é’©å­å‡½æ•°">5.3.3 é’©å­å‡½æ•°</a></li>
                <li>
                    <a href="#534-%e5%ae%b9%e5%99%a8%e6%8e%a2%e6%b5%8b" aria-label="5.3.4 å®¹å™¨æ¢æµ‹">5.3.4 å®¹å™¨æ¢æµ‹</a></li>
                <li>
                    <a href="#535-%e9%87%8d%e5%90%af%e7%ad%96%e7%95%a5" aria-label="5.3.5 é‡å¯ç­–ç•¥">5.3.5 é‡å¯ç­–ç•¥</a></li></ul>
                </li>
                <li>
                    <a href="#54-pod%e8%b0%83%e5%ba%a6" aria-label="5.4 Podè°ƒåº¦">5.4 Podè°ƒåº¦</a><ul>
                        
                <li>
                    <a href="#541-%e5%ae%9a%e5%90%91%e8%b0%83%e5%ba%a6" aria-label="5.4.1 å®šå‘è°ƒåº¦">5.4.1 å®šå‘è°ƒåº¦</a></li>
                <li>
                    <a href="#542-%e4%ba%b2%e5%92%8c%e6%80%a7%e8%b0%83%e5%ba%a6" aria-label="5.4.2 äº²å’Œæ€§è°ƒåº¦">5.4.2 äº²å’Œæ€§è°ƒåº¦</a></li>
                <li>
                    <a href="#543-%e6%b1%a1%e7%82%b9%e5%92%8c%e5%ae%b9%e5%bf%8d" aria-label="5.4.3 æ±¡ç‚¹å’Œå®¹å¿">5.4.3 æ±¡ç‚¹å’Œå®¹å¿</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#6-pod%e6%8e%a7%e5%88%b6%e5%99%a8%e8%af%a6%e8%a7%a3" aria-label="6. Podæ§åˆ¶å™¨è¯¦è§£">6. Podæ§åˆ¶å™¨è¯¦è§£</a><ul>
                        
                <li>
                    <a href="#61-pod%e6%8e%a7%e5%88%b6%e5%99%a8%e4%bb%8b%e7%bb%8d" aria-label="6.1 Podæ§åˆ¶å™¨ä»‹ç»">6.1 Podæ§åˆ¶å™¨ä»‹ç»</a></li>
                <li>
                    <a href="#62-replicasetrs" aria-label="6.2 ReplicaSet(RS)">6.2 ReplicaSet(RS)</a></li>
                <li>
                    <a href="#63-deploymentdeploy" aria-label="6.3 Deployment(Deploy)">6.3 Deployment(Deploy)</a><ul>
                        
                <li>
                    <a href="#631-%e5%88%9b%e5%bb%badeployment" aria-label="6.3.1 åˆ›å»ºdeployment">6.3.1 åˆ›å»ºdeployment</a></li>
                <li>
                    <a href="#632-%e6%89%a9%e7%bc%a9%e5%ae%b9" aria-label="6.3.2 æ‰©ç¼©å®¹">6.3.2 æ‰©ç¼©å®¹</a></li>
                <li>
                    <a href="#633-%e7%89%88%e6%9c%ac%e5%9b%9e%e9%80%80" aria-label="6.3.3 ç‰ˆæœ¬å›é€€">6.3.3 ç‰ˆæœ¬å›é€€</a></li>
                <li>
                    <a href="#634-%e9%87%91%e4%b8%9d%e9%9b%80%e5%8f%91%e5%b8%83" aria-label="6.3.4 é‡‘ä¸é›€å‘å¸ƒ">6.3.4 é‡‘ä¸é›€å‘å¸ƒ</a></li></ul>
                </li>
                <li>
                    <a href="#64-horizontal-pod-autoscalerhpa" aria-label="6.4 Horizontal Pod Autoscaler(HPA)">6.4 Horizontal Pod Autoscaler(HPA)</a><ul>
                        
                <li>
                    <a href="#641-%e5%ae%89%e8%a3%85metrics-server" aria-label="6.4.1 å®‰è£…metrics-server">6.4.1 å®‰è£…metrics-server</a></li>
                <li>
                    <a href="#642-%e5%87%86%e5%a4%87deployment%e5%92%8cservie" aria-label="6.4.2 å‡†å¤‡deploymentå’Œservie">6.4.2 å‡†å¤‡deploymentå’Œservie</a></li>
                <li>
                    <a href="#643-%e9%83%a8%e7%bd%b2hpa" aria-label="6.4.3 éƒ¨ç½²HPA">6.4.3 éƒ¨ç½²HPA</a></li>
                <li>
                    <a href="#644-%e6%b5%8b%e8%af%95" aria-label="6.4.4 æµ‹è¯•">6.4.4 æµ‹è¯•</a></li></ul>
                </li>
                <li>
                    <a href="#65-daemonsetds" aria-label="6.5 DaemonSet(DS)">6.5 DaemonSet(DS)</a></li>
                <li>
                    <a href="#66-job" aria-label="6.6 Job">6.6 Job</a></li>
                <li>
                    <a href="#67-cronjobcj" aria-label="6.7 CronJob(CJ)">6.7 CronJob(CJ)</a></li></ul>
                </li>
                <li>
                    <a href="#7-service%e8%af%a6%e8%a7%a3" aria-label="7. Serviceè¯¦è§£">7. Serviceè¯¦è§£</a><ul>
                        
                <li>
                    <a href="#71-service%e4%bb%8b%e7%bb%8d" aria-label="7.1 Serviceä»‹ç»">7.1 Serviceä»‹ç»</a><ul>
                        
                <li>
                    <a href="#711-userspace-%e6%a8%a1%e5%bc%8f" aria-label="7.1.1 userspace æ¨¡å¼">7.1.1 userspace æ¨¡å¼</a></li>
                <li>
                    <a href="#712-iptables-%e6%a8%a1%e5%bc%8f" aria-label="7.1.2 iptables æ¨¡å¼">7.1.2 iptables æ¨¡å¼</a></li>
                <li>
                    <a href="#713-ipvs-%e6%a8%a1%e5%bc%8f" aria-label="7.1.3 ipvs æ¨¡å¼">7.1.3 ipvs æ¨¡å¼</a></li></ul>
                </li>
                <li>
                    <a href="#72-service%e7%b1%bb%e5%9e%8b" aria-label="7.2 Serviceç±»å‹">7.2 Serviceç±»å‹</a></li>
                <li>
                    <a href="#73-service%e4%bd%bf%e7%94%a8" aria-label="7.3 Serviceä½¿ç”¨">7.3 Serviceä½¿ç”¨</a><ul>
                        
                <li>
                    <a href="#731-%e5%ae%9e%e9%aa%8c%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87" aria-label="7.3.1 å®éªŒç¯å¢ƒå‡†å¤‡">7.3.1 å®éªŒç¯å¢ƒå‡†å¤‡</a></li>
                <li>
                    <a href="#732-clusterip%e7%b1%bb%e5%9e%8b%e7%9a%84service" aria-label="7.3.2 ClusterIPç±»å‹çš„Service">7.3.2 ClusterIPç±»å‹çš„Service</a></li>
                <li>
                    <a href="#733-endpoint" aria-label="7.3.3 Endpoint">7.3.3 Endpoint</a></li>
                <li>
                    <a href="#734-headliness%e7%b1%bb%e5%9e%8b%e7%9a%84service" aria-label="7.3.4 HeadLinessç±»å‹çš„Service">7.3.4 HeadLinessç±»å‹çš„Service</a></li>
                <li>
                    <a href="#735-nodeport%e7%b1%bb%e5%9e%8b%e7%9a%84service" aria-label="7.3.5 NodePortç±»å‹çš„Service">7.3.5 NodePortç±»å‹çš„Service</a></li>
                <li>
                    <a href="#736-loadbalancer%e7%b1%bb%e5%9e%8b%e7%9a%84service" aria-label="7.3.6 LoadBalancerç±»å‹çš„Service">7.3.6 LoadBalancerç±»å‹çš„Service</a></li>
                <li>
                    <a href="#737-externalname%e7%b1%bb%e5%9e%8b%e7%9a%84service" aria-label="7.3.7 ExternalNameç±»å‹çš„Service">7.3.7 ExternalNameç±»å‹çš„Service</a></li></ul>
                </li>
                <li>
                    <a href="#74-ingress%e4%bb%8b%e7%bb%8d" aria-label="7.4 Ingressä»‹ç»">7.4 Ingressä»‹ç»</a></li>
                <li>
                    <a href="#75-ingress%e4%bd%bf%e7%94%a8" aria-label="7.5 Ingressä½¿ç”¨">7.5 Ingressä½¿ç”¨</a><ul>
                        
                <li>
                    <a href="#751-%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87-%e6%90%ad%e5%bb%baingress%e7%8e%af%e5%a2%83" aria-label="7.5.1 ç¯å¢ƒå‡†å¤‡ æ­å»ºingressç¯å¢ƒ">7.5.1 ç¯å¢ƒå‡†å¤‡ æ­å»ºingressç¯å¢ƒ</a></li>
                <li>
                    <a href="#752-%e5%87%86%e5%a4%87service%e5%92%8cpod" aria-label="7.5.2 å‡†å¤‡serviceå’Œpod">7.5.2 å‡†å¤‡serviceå’Œpod</a></li>
                <li>
                    <a href="#753-http%e4%bb%a3%e7%90%86" aria-label="7.5.3 Httpä»£ç†">7.5.3 Httpä»£ç†</a></li>
                <li>
                    <a href="#754-https%e4%bb%a3%e7%90%86" aria-label="7.5.4 Httpsä»£ç†">7.5.4 Httpsä»£ç†</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#8-%e6%95%b0%e6%8d%ae%e5%ad%98%e5%82%a8" aria-label="8. æ•°æ®å­˜å‚¨">8. æ•°æ®å­˜å‚¨</a><ul>
                        
                <li>
                    <a href="#81-%e5%9f%ba%e6%9c%ac%e5%ad%98%e5%82%a8" aria-label="8.1 åŸºæœ¬å­˜å‚¨">8.1 åŸºæœ¬å­˜å‚¨</a><ul>
                        
                <li>
                    <a href="#811-emptydir" aria-label="8.1.1 EmptyDir">8.1.1 EmptyDir</a></li>
                <li>
                    <a href="#812-hostpath" aria-label="8.1.2 HostPath">8.1.2 HostPath</a></li>
                <li>
                    <a href="#813-nfs" aria-label="8.1.3 NFS">8.1.3 NFS</a></li></ul>
                </li>
                <li>
                    <a href="#82-%e9%ab%98%e7%ba%a7%e5%ad%98%e5%82%a8" aria-label="8.2 é«˜çº§å­˜å‚¨">8.2 é«˜çº§å­˜å‚¨</a><ul>
                        
                <li>
                    <a href="#821-pv" aria-label="8.2.1 PV">8.2.1 PV</a></li>
                <li>
                    <a href="#822-pvc" aria-label="8.2.2 PVC">8.2.2 PVC</a></li>
                <li>
                    <a href="#823-%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" aria-label="8.2.3 ç”Ÿå‘½å‘¨æœŸ">8.2.3 ç”Ÿå‘½å‘¨æœŸ</a></li></ul>
                </li>
                <li>
                    <a href="#83-%e9%85%8d%e7%bd%ae%e5%ad%98%e5%82%a8" aria-label="8.3 é…ç½®å­˜å‚¨">8.3 é…ç½®å­˜å‚¨</a><ul>
                        
                <li>
                    <a href="#831-configmap" aria-label="8.3.1 ConfigMap">8.3.1 ConfigMap</a></li>
                <li>
                    <a href="#832-secret" aria-label="8.3.2 Secret">8.3.2 Secret</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#9-%e5%ae%89%e5%85%a8%e8%ae%a4%e8%af%81" aria-label="9. å®‰å…¨è®¤è¯">9. å®‰å…¨è®¤è¯</a><ul>
                        
                <li>
                    <a href="#91-%e8%ae%bf%e9%97%ae%e6%8e%a7%e5%88%b6%e6%a6%82%e8%bf%b0" aria-label="9.1 è®¿é—®æ§åˆ¶æ¦‚è¿°">9.1 è®¿é—®æ§åˆ¶æ¦‚è¿°</a></li>
                <li>
                    <a href="#92-%e8%ae%a4%e8%af%81%e7%ae%a1%e7%90%86" aria-label="9.2 è®¤è¯ç®¡ç†">9.2 è®¤è¯ç®¡ç†</a></li>
                <li>
                    <a href="#93-%e6%8e%88%e6%9d%83%e7%ae%a1%e7%90%86" aria-label="9.3 æˆæƒç®¡ç†">9.3 æˆæƒç®¡ç†</a></li>
                <li>
                    <a href="#94-%e5%87%86%e5%85%a5%e6%8e%a7%e5%88%b6" aria-label="9.4 å‡†å…¥æ§åˆ¶">9.4 å‡†å…¥æ§åˆ¶</a></li></ul>
                </li>
                <li>
                    <a href="#10-dashboard" aria-label="10. DashBoard">10. DashBoard</a><ul>
                        
                <li>
                    <a href="#101-%e9%83%a8%e7%bd%b2dashboard" aria-label="10.1 éƒ¨ç½²Dashboard">10.1 éƒ¨ç½²Dashboard</a></li>
                <li>
                    <a href="#102-%e4%bd%bf%e7%94%a8dashboard" aria-label="10.2 ä½¿ç”¨DashBoard">10.2 ä½¿ç”¨DashBoard</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h2 id="kubernetesè¯¦ç»†æ•™ç¨‹">Kubernetesè¯¦ç»†æ•™ç¨‹<a hidden class="anchor" aria-hidden="true" href="#kubernetesè¯¦ç»†æ•™ç¨‹">#</a></h2>
<h3 id="1-kubernetesä»‹ç»">1. Kubernetesä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#1-kubernetesä»‹ç»">#</a></h3>
<h4 id="11-åº”ç”¨éƒ¨ç½²æ–¹å¼æ¼”å˜">1.1 åº”ç”¨éƒ¨ç½²æ–¹å¼æ¼”å˜<a hidden class="anchor" aria-hidden="true" href="#11-åº”ç”¨éƒ¨ç½²æ–¹å¼æ¼”å˜">#</a></h4>
<p>åœ¨éƒ¨ç½²åº”ç”¨ç¨‹åºçš„æ–¹å¼ä¸Šï¼Œä¸»è¦ç»å†äº†ä¸‰ä¸ªæ—¶ä»£ï¼š</p>
<ul>
<li>
<p>ä¼ ç»Ÿéƒ¨ç½²ï¼šäº’è”ç½‘æ—©æœŸï¼Œä¼šç›´æ¥å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åœ¨ç‰©ç†æœºä¸Š</p>
<blockquote>
<p>ä¼˜ç‚¹ï¼šç®€å•ï¼Œä¸éœ€è¦å…¶å®ƒæŠ€æœ¯çš„å‚ä¸</p>
<p>ç¼ºç‚¹ï¼šä¸èƒ½ä¸ºåº”ç”¨ç¨‹åºå®šä¹‰èµ„æºä½¿ç”¨è¾¹ç•Œï¼Œå¾ˆéš¾åˆç†åœ°åˆ†é…è®¡ç®—èµ„æºï¼Œè€Œä¸”ç¨‹åºä¹‹é—´å®¹æ˜“äº§ç”Ÿå½±å“</p>
</blockquote>
</li>
<li>
<p>è™šæ‹ŸåŒ–éƒ¨ç½²ï¼šå¯ä»¥åœ¨ä¸€å°ç‰©ç†æœºä¸Šè¿è¡Œå¤šä¸ªè™šæ‹Ÿæœºï¼Œæ¯ä¸ªè™šæ‹Ÿæœºéƒ½æ˜¯ç‹¬ç«‹çš„ä¸€ä¸ªç¯å¢ƒ</p>
<blockquote>
<p>ä¼˜ç‚¹ï¼šç¨‹åºç¯å¢ƒä¸ä¼šç›¸äº’äº§ç”Ÿå½±å“ï¼Œæä¾›äº†ä¸€å®šç¨‹åº¦çš„å®‰å…¨æ€§</p>
<p>ç¼ºç‚¹ï¼šå¢åŠ äº†æ“ä½œç³»ç»Ÿï¼Œæµªè´¹äº†éƒ¨åˆ†èµ„æº</p>
</blockquote>
</li>
<li>
<p>å®¹å™¨åŒ–éƒ¨ç½²ï¼šä¸è™šæ‹ŸåŒ–ç±»ä¼¼ï¼Œä½†æ˜¯å…±äº«äº†æ“ä½œç³»ç»Ÿ</p>
<blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<p>å¯ä»¥ä¿è¯æ¯ä¸ªå®¹å™¨æ‹¥æœ‰è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿã€CPUã€å†…å­˜ã€è¿›ç¨‹ç©ºé—´ç­‰</p>
<p>è¿è¡Œåº”ç”¨ç¨‹åºæ‰€éœ€è¦çš„èµ„æºéƒ½è¢«å®¹å™¨åŒ…è£…ï¼Œå¹¶å’Œåº•å±‚åŸºç¡€æ¶æ„è§£è€¦</p>
<p>å®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºå¯ä»¥è·¨äº‘æœåŠ¡å•†ã€è·¨Linuxæ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆè¿›è¡Œéƒ¨ç½²</p>
</blockquote>
</li>
</ul>
<p><img loading="lazy" src="/kubernetes.images/image-20200505183738289.png" alt="image-20200505183738289"  />
</p>
<p>å®¹å™¨åŒ–éƒ¨ç½²æ–¹å¼ç»™å¸¦æ¥å¾ˆå¤šçš„ä¾¿åˆ©ï¼Œä½†æ˜¯ä¹Ÿä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚è¯´ï¼š</p>
<ul>
<li>ä¸€ä¸ªå®¹å™¨æ•…éšœåœæœºäº†ï¼Œæ€ä¹ˆæ ·è®©å¦å¤–ä¸€ä¸ªå®¹å™¨ç«‹åˆ»å¯åŠ¨å»æ›¿è¡¥åœæœºçš„å®¹å™¨</li>
<li>å½“å¹¶å‘è®¿é—®é‡å˜å¤§çš„æ—¶å€™ï¼Œæ€ä¹ˆæ ·åšåˆ°æ¨ªå‘æ‰©å±•å®¹å™¨æ•°é‡</li>
</ul>
<p>è¿™äº›å®¹å™¨ç®¡ç†çš„é—®é¢˜ç»Ÿç§°ä¸ºå®¹å™¨ç¼–æ’é—®é¢˜ï¼Œä¸ºäº†è§£å†³è¿™äº›å®¹å™¨ç¼–æ’é—®é¢˜ï¼Œå°±äº§ç”Ÿäº†ä¸€äº›å®¹å™¨ç¼–æ’çš„è½¯ä»¶ï¼š</p>
<ul>
<li>Swarmï¼šDockerè‡ªå·±çš„å®¹å™¨ç¼–æ’å·¥å…·</li>
<li>Mesosï¼šApacheçš„ä¸€ä¸ªèµ„æºç»Ÿä¸€ç®¡æ§çš„å·¥å…·ï¼Œéœ€è¦å’ŒMarathonç»“åˆä½¿ç”¨</li>
<li>Kubernetesï¼šGoogleå¼€æºçš„çš„å®¹å™¨ç¼–æ’å·¥å…·</li>
</ul>
<p><img loading="lazy" src="/kubernetes.images/image-20200524150339551.png" alt="image-20200524150339551"  />
</p>
<h4 id="12-kubernetesç®€ä»‹">1.2 kubernetesç®€ä»‹<a hidden class="anchor" aria-hidden="true" href="#12-kubernetesç®€ä»‹">#</a></h4>
<p><img loading="lazy" src="/kubernetes.images/image-20200406232838722.png" alt="image-20200406232838722"  />
</p>
<p>kubernetesï¼Œæ˜¯ä¸€ä¸ªå…¨æ–°çš„åŸºäºå®¹å™¨æŠ€æœ¯çš„åˆ†å¸ƒå¼æ¶æ„é¢†å…ˆæ–¹æ¡ˆï¼Œæ˜¯è°·æ­Œä¸¥æ ¼ä¿å¯†åå‡ å¹´çš„ç§˜å¯†æ­¦å™¨&mdash;-Borgç³»ç»Ÿçš„ä¸€ä¸ªå¼€æºç‰ˆæœ¬ï¼Œäº2014å¹´9æœˆå‘å¸ƒç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œ2015å¹´7æœˆå‘å¸ƒç¬¬ä¸€ä¸ªæ­£å¼ç‰ˆæœ¬ã€‚</p>
<p>kubernetesçš„æœ¬è´¨æ˜¯ä¸€ç»„æœåŠ¡å™¨é›†ç¾¤ï¼Œå®ƒå¯ä»¥åœ¨é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œç‰¹å®šçš„ç¨‹åºï¼Œæ¥å¯¹èŠ‚ç‚¹ä¸­çš„å®¹å™¨è¿›è¡Œç®¡ç†ã€‚ç›®çš„æ˜¯å®ç°èµ„æºç®¡ç†çš„è‡ªåŠ¨åŒ–ï¼Œä¸»è¦æä¾›äº†å¦‚ä¸‹çš„ä¸»è¦åŠŸèƒ½ï¼š</p>
<ul>
<li>è‡ªæˆ‘ä¿®å¤ï¼šä¸€æ—¦æŸä¸€ä¸ªå®¹å™¨å´©æºƒï¼Œèƒ½å¤Ÿåœ¨1ç§’ä¸­å·¦å³è¿…é€Ÿå¯åŠ¨æ–°çš„å®¹å™¨</li>
<li>å¼¹æ€§ä¼¸ç¼©ï¼šå¯ä»¥æ ¹æ®éœ€è¦ï¼Œè‡ªåŠ¨å¯¹é›†ç¾¤ä¸­æ­£åœ¨è¿è¡Œçš„å®¹å™¨æ•°é‡è¿›è¡Œè°ƒæ•´</li>
<li>æœåŠ¡å‘ç°ï¼šæœåŠ¡å¯ä»¥é€šè¿‡è‡ªåŠ¨å‘ç°çš„å½¢å¼æ‰¾åˆ°å®ƒæ‰€ä¾èµ–çš„æœåŠ¡</li>
<li>è´Ÿè½½å‡è¡¡ï¼šå¦‚æœä¸€ä¸ªæœåŠ¡èµ·åŠ¨äº†å¤šä¸ªå®¹å™¨ï¼Œèƒ½å¤Ÿè‡ªåŠ¨å®ç°è¯·æ±‚çš„è´Ÿè½½å‡è¡¡</li>
<li>ç‰ˆæœ¬å›é€€ï¼šå¦‚æœå‘ç°æ–°å‘å¸ƒçš„ç¨‹åºç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œå¯ä»¥ç«‹å³å›é€€åˆ°åŸæ¥çš„ç‰ˆæœ¬</li>
<li>å­˜å‚¨ç¼–æ’ï¼šå¯ä»¥æ ¹æ®å®¹å™¨è‡ªèº«çš„éœ€æ±‚è‡ªåŠ¨åˆ›å»ºå­˜å‚¨å·</li>
</ul>
<h4 id="13-kubernetesç»„ä»¶">1.3 kubernetesç»„ä»¶<a hidden class="anchor" aria-hidden="true" href="#13-kubernetesç»„ä»¶">#</a></h4>
<p>ä¸€ä¸ªkubernetesé›†ç¾¤ä¸»è¦æ˜¯ç”±æ§åˆ¶èŠ‚ç‚¹(master)ã€å·¥ä½œèŠ‚ç‚¹(node)æ„æˆï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½ä¼šå®‰è£…ä¸åŒçš„ç»„ä»¶ã€‚</p>
<p>masterï¼šé›†ç¾¤çš„æ§åˆ¶å¹³é¢ï¼Œè´Ÿè´£é›†ç¾¤çš„å†³ç­– ( ç®¡ç† )</p>
<blockquote>
<p>ApiServer : èµ„æºæ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œæ¥æ”¶ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤ï¼Œæä¾›è®¤è¯ã€æˆæƒã€APIæ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶</p>
<p>Scheduler : è´Ÿè´£é›†ç¾¤èµ„æºè°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°†Podè°ƒåº¦åˆ°ç›¸åº”çš„nodeèŠ‚ç‚¹ä¸Š</p>
<p>ControllerManager : è´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚ç¨‹åºéƒ¨ç½²å®‰æ’ã€æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•ã€æ»šåŠ¨æ›´æ–°ç­‰</p>
<p>Etcd ï¼šè´Ÿè´£å­˜å‚¨é›†ç¾¤ä¸­å„ç§èµ„æºå¯¹è±¡çš„ä¿¡æ¯</p>
</blockquote>
<p>nodeï¼šé›†ç¾¤çš„æ•°æ®å¹³é¢ï¼Œè´Ÿè´£ä¸ºå®¹å™¨æä¾›è¿è¡Œç¯å¢ƒ ( å¹²æ´» )</p>
<blockquote>
<p>Kubelet : è´Ÿè´£ç»´æŠ¤å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå³é€šè¿‡æ§åˆ¶dockerï¼Œæ¥åˆ›å»ºã€æ›´æ–°ã€é”€æ¯å®¹å™¨</p>
<p>KubeProxy : è´Ÿè´£æä¾›é›†ç¾¤å†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</p>
<p>Docker : è´Ÿè´£èŠ‚ç‚¹ä¸Šå®¹å™¨çš„å„ç§æ“ä½œ</p>
</blockquote>
<p><img loading="lazy" src="/kubernetes.images/image-20200406184656917.png" alt="image-20200406184656917"  />
</p>
<p>ä¸‹é¢ï¼Œä»¥éƒ¨ç½²ä¸€ä¸ªnginxæœåŠ¡æ¥è¯´æ˜kubernetesç³»ç»Ÿå„ä¸ªç»„ä»¶è°ƒç”¨å…³ç³»ï¼š</p>
<ol>
<li>
<p>é¦–å…ˆè¦æ˜ç¡®ï¼Œä¸€æ—¦kubernetesç¯å¢ƒå¯åŠ¨ä¹‹åï¼Œmasterå’Œnodeéƒ½ä¼šå°†è‡ªèº«çš„ä¿¡æ¯å­˜å‚¨åˆ°etcdæ•°æ®åº“ä¸­</p>
</li>
<li>
<p>ä¸€ä¸ªnginxæœåŠ¡çš„å®‰è£…è¯·æ±‚ä¼šé¦–å…ˆè¢«å‘é€åˆ°masterèŠ‚ç‚¹çš„apiServerç»„ä»¶</p>
</li>
<li>
<p>apiServerç»„ä»¶ä¼šè°ƒç”¨schedulerç»„ä»¶æ¥å†³å®šåˆ°åº•åº”è¯¥æŠŠè¿™ä¸ªæœåŠ¡å®‰è£…åˆ°å“ªä¸ªnodeèŠ‚ç‚¹ä¸Š</p>
<p>åœ¨æ­¤æ—¶ï¼Œå®ƒä¼šä»etcdä¸­è¯»å–å„ä¸ªnodeèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œç„¶åæŒ‰ç…§ä¸€å®šçš„ç®—æ³•è¿›è¡Œé€‰æ‹©ï¼Œå¹¶å°†ç»“æœå‘ŠçŸ¥apiServer</p>
</li>
<li>
<p>apiServerè°ƒç”¨controller-managerå»è°ƒåº¦NodeèŠ‚ç‚¹å®‰è£…nginxæœåŠ¡</p>
</li>
<li>
<p>kubeletæ¥æ”¶åˆ°æŒ‡ä»¤åï¼Œä¼šé€šçŸ¥dockerï¼Œç„¶åç”±dockeræ¥å¯åŠ¨ä¸€ä¸ªnginxçš„pod</p>
<p>podæ˜¯kubernetesçš„æœ€å°æ“ä½œå•å…ƒï¼Œå®¹å™¨å¿…é¡»è·‘åœ¨podä¸­è‡³æ­¤ï¼Œ</p>
</li>
<li>
<p>ä¸€ä¸ªnginxæœåŠ¡å°±è¿è¡Œäº†ï¼Œå¦‚æœéœ€è¦è®¿é—®nginxï¼Œå°±éœ€è¦é€šè¿‡kube-proxyæ¥å¯¹podäº§ç”Ÿè®¿é—®çš„ä»£ç†</p>
</li>
</ol>
<p>è¿™æ ·ï¼Œå¤–ç•Œç”¨æˆ·å°±å¯ä»¥è®¿é—®é›†ç¾¤ä¸­çš„nginxæœåŠ¡äº†</p>
<h4 id="14-kubernetesæ¦‚å¿µ">1.4 kubernetesæ¦‚å¿µ<a hidden class="anchor" aria-hidden="true" href="#14-kubernetesæ¦‚å¿µ">#</a></h4>
<p>Masterï¼šé›†ç¾¤æ§åˆ¶èŠ‚ç‚¹ï¼Œæ¯ä¸ªé›†ç¾¤éœ€è¦è‡³å°‘ä¸€ä¸ªmasterèŠ‚ç‚¹è´Ÿè´£é›†ç¾¤çš„ç®¡æ§</p>
<p>Nodeï¼šå·¥ä½œè´Ÿè½½èŠ‚ç‚¹ï¼Œç”±masteråˆ†é…å®¹å™¨åˆ°è¿™äº›nodeå·¥ä½œèŠ‚ç‚¹ä¸Šï¼Œç„¶ånodeèŠ‚ç‚¹ä¸Šçš„dockerè´Ÿè´£å®¹å™¨çš„è¿è¡Œ</p>
<p>Podï¼škubernetesçš„æœ€å°æ§åˆ¶å•å…ƒï¼Œå®¹å™¨éƒ½æ˜¯è¿è¡Œåœ¨podä¸­çš„ï¼Œä¸€ä¸ªpodä¸­å¯ä»¥æœ‰1ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨</p>
<p>Controllerï¼šæ§åˆ¶å™¨ï¼Œé€šè¿‡å®ƒæ¥å®ç°å¯¹podçš„ç®¡ç†ï¼Œæ¯”å¦‚å¯åŠ¨podã€åœæ­¢podã€ä¼¸ç¼©podçš„æ•°é‡ç­‰ç­‰</p>
<p>Serviceï¼špodå¯¹å¤–æœåŠ¡çš„ç»Ÿä¸€å…¥å£ï¼Œä¸‹é¢å¯ä»¥ç»´æŠ¤è€…åŒä¸€ç±»çš„å¤šä¸ªpod</p>
<p>Labelï¼šæ ‡ç­¾ï¼Œç”¨äºå¯¹podè¿›è¡Œåˆ†ç±»ï¼ŒåŒä¸€ç±»podä¼šæ‹¥æœ‰ç›¸åŒçš„æ ‡ç­¾</p>
<p>NameSpaceï¼šå‘½åç©ºé—´ï¼Œç”¨æ¥éš”ç¦»podçš„è¿è¡Œç¯å¢ƒ</p>
<h3 id="2-kubernetesé›†ç¾¤ç¯å¢ƒæ­å»º">2. kubernetesé›†ç¾¤ç¯å¢ƒæ­å»º<a hidden class="anchor" aria-hidden="true" href="#2-kubernetesé›†ç¾¤ç¯å¢ƒæ­å»º">#</a></h3>
<h4 id="21-å‰ç½®çŸ¥è¯†ç‚¹">2.1 å‰ç½®çŸ¥è¯†ç‚¹<a hidden class="anchor" aria-hidden="true" href="#21-å‰ç½®çŸ¥è¯†ç‚¹">#</a></h4>
<p>ç›®å‰ç”Ÿäº§éƒ¨ç½²Kubernetes é›†ç¾¤ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<p>kubeadm</p>
<p>Kubeadm æ˜¯ä¸€ä¸ªK8s éƒ¨ç½²å·¥å…·ï¼Œæä¾›kubeadm init å’Œkubeadm joinï¼Œç”¨äºå¿«é€Ÿéƒ¨ç½²Kubernetes é›†ç¾¤ã€‚</p>
<p>å®˜æ–¹åœ°å€ï¼š<a href="https:/kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/">https:/kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/</a></p>
<p>äºŒè¿›åˆ¶åŒ…</p>
<p>ä»github ä¸‹è½½å‘è¡Œç‰ˆçš„äºŒè¿›åˆ¶åŒ…ï¼Œæ‰‹åŠ¨éƒ¨ç½²æ¯ä¸ªç»„ä»¶ï¼Œç»„æˆKubernetes é›†ç¾¤ã€‚</p>
<p>Kubeadm é™ä½éƒ¨ç½²é—¨æ§›ï¼Œä½†å±è”½äº†å¾ˆå¤šç»†èŠ‚ï¼Œé‡åˆ°é—®é¢˜å¾ˆéš¾æ’æŸ¥ã€‚å¦‚æœæƒ³æ›´å®¹æ˜“å¯æ§ï¼Œæ¨èä½¿ç”¨äºŒè¿›åˆ¶åŒ…éƒ¨ç½²Kubernetes é›†ç¾¤ï¼Œè™½ç„¶æ‰‹åŠ¨éƒ¨ç½²éº»çƒ¦ç‚¹ï¼ŒæœŸé—´å¯ä»¥å­¦ä¹ å¾ˆå¤šå·¥ä½œåŸç†ï¼Œä¹Ÿåˆ©äºåæœŸç»´æŠ¤ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200404094800622.png" alt="image-20200404094800622"  />
</p>
<h4 id="22-kubeadm-éƒ¨ç½²æ–¹å¼ä»‹ç»">2.2 kubeadm éƒ¨ç½²æ–¹å¼ä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#22-kubeadm-éƒ¨ç½²æ–¹å¼ä»‹ç»">#</a></h4>
<p>kubeadm æ˜¯å®˜æ–¹ç¤¾åŒºæ¨å‡ºçš„ä¸€ä¸ªç”¨äºå¿«é€Ÿéƒ¨ç½²kubernetes é›†ç¾¤çš„å·¥å…·ï¼Œè¿™ä¸ªå·¥å…·èƒ½é€šè¿‡ä¸¤æ¡æŒ‡ä»¤å®Œæˆä¸€ä¸ªkubernetes é›†ç¾¤çš„éƒ¨ç½²ï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªMaster èŠ‚ç‚¹kubeadm init</li>
<li>å°†Node èŠ‚ç‚¹åŠ å…¥åˆ°å½“å‰é›†ç¾¤ä¸­$ kubeadm join &lt;Master èŠ‚ç‚¹çš„IP å’Œç«¯å£&gt;</li>
</ul>
<h4 id="23-å®‰è£…è¦æ±‚">2.3 å®‰è£…è¦æ±‚<a hidden class="anchor" aria-hidden="true" href="#23-å®‰è£…è¦æ±‚">#</a></h4>
<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œéƒ¨ç½²Kubernetes é›†ç¾¤æœºå™¨éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li>ä¸€å°æˆ–å¤šå°æœºå™¨ï¼Œæ“ä½œç³»ç»ŸCentOS7.x-86_x64</li>
<li>ç¡¬ä»¶é…ç½®ï¼š2GB æˆ–æ›´å¤šRAMï¼Œ2 ä¸ªCPU æˆ–æ›´å¤šCPUï¼Œç¡¬ç›˜30GB æˆ–æ›´å¤š</li>
<li>é›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨ä¹‹é—´ç½‘ç»œäº’é€š</li>
<li>å¯ä»¥è®¿é—®å¤–ç½‘ï¼Œéœ€è¦æ‹‰å–é•œåƒ</li>
<li>ç¦æ­¢swap åˆ†åŒº</li>
</ul>
<h4 id="24-æœ€ç»ˆç›®æ ‡">2.4 æœ€ç»ˆç›®æ ‡<a hidden class="anchor" aria-hidden="true" href="#24-æœ€ç»ˆç›®æ ‡">#</a></h4>
<ul>
<li>åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå®‰è£…Docker å’Œkubeadm</li>
<li>éƒ¨ç½²Kubernetes Master</li>
<li>éƒ¨ç½²å®¹å™¨ç½‘ç»œæ’ä»¶</li>
<li>éƒ¨ç½²Kubernetes Nodeï¼Œå°†èŠ‚ç‚¹åŠ å…¥Kubernetes é›†ç¾¤ä¸­</li>
<li>éƒ¨ç½²Dashboard Web é¡µé¢ï¼Œå¯è§†åŒ–æŸ¥çœ‹Kubernetes èµ„æº</li>
</ul>
<h4 id="25-å‡†å¤‡ç¯å¢ƒ">2.5 å‡†å¤‡ç¯å¢ƒ<a hidden class="anchor" aria-hidden="true" href="#25-å‡†å¤‡ç¯å¢ƒ">#</a></h4>
<p><img loading="lazy" src="/kubernetes.images/image-20210609000002940.png" alt="image-20210609000002940"  />
</p>
<table>
<thead>
<tr>
<th style="text-align:left">è§’è‰²</th>
<th style="text-align:left">IPåœ°å€</th>
<th style="text-align:left">ç»„ä»¶</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">master01</td>
<td style="text-align:left">192.168.90.100</td>
<td style="text-align:left">dockerï¼Œkubectlï¼Œkubeadmï¼Œkubelet</td>
</tr>
<tr>
<td style="text-align:left">node01</td>
<td style="text-align:left">192.168.90.106</td>
<td style="text-align:left">dockerï¼Œkubectlï¼Œkubeadmï¼Œkubelet</td>
</tr>
<tr>
<td style="text-align:left">node02</td>
<td style="text-align:left">192.168.90.107</td>
<td style="text-align:left">dockerï¼Œkubectlï¼Œkubeadmï¼Œkubelet</td>
</tr>
</tbody>
</table>
<h4 id="26-ç¯å¢ƒåˆå§‹åŒ–">2.6 ç¯å¢ƒåˆå§‹åŒ–<a hidden class="anchor" aria-hidden="true" href="#26-ç¯å¢ƒåˆå§‹åŒ–">#</a></h4>
<h5 id="261-æ£€æŸ¥æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬">2.6.1 æ£€æŸ¥æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬<a hidden class="anchor" aria-hidden="true" href="#261-æ£€æŸ¥æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># æ­¤æ–¹å¼ä¸‹å®‰è£…kubernetesé›†ç¾¤è¦æ±‚Centosç‰ˆæœ¬è¦åœ¨7.5æˆ–ä¹‹ä¸Š</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># cat /etc/redhat-release</span>
</span></span><span style="display:flex;"><span>Centos Linux <span style="color:#ae81ff">7.5</span>.1804 (Core)
</span></span></code></pre></div><h5 id="262-ä¸»æœºåè§£æ">2.6.2 ä¸»æœºåè§£æ<a hidden class="anchor" aria-hidden="true" href="#262-ä¸»æœºåè§£æ">#</a></h5>
<p>ä¸ºäº†æ–¹ä¾¿é›†ç¾¤èŠ‚ç‚¹é—´çš„ç›´æ¥è°ƒç”¨ï¼Œåœ¨è¿™ä¸ªé…ç½®ä¸€ä¸‹ä¸»æœºåè§£æï¼Œä¼ä¸šä¸­æ¨èä½¿ç”¨å†…éƒ¨DNSæœåŠ¡å™¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># ä¸»æœºåæˆè§£æ ç¼–è¾‘ä¸‰å°æœåŠ¡å™¨çš„/etc/hostsæ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢å†…å®¹</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">192.168</span>.90.100 master
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">192.168</span>.90.106 node1
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">192.168</span>.90.107 node2
</span></span></code></pre></div><h5 id="263-æ—¶é—´åŒæ­¥">2.6.3 æ—¶é—´åŒæ­¥<a hidden class="anchor" aria-hidden="true" href="#263-æ—¶é—´åŒæ­¥">#</a></h5>
<p>kubernetesè¦æ±‚é›†ç¾¤ä¸­çš„èŠ‚ç‚¹æ—¶é—´å¿…é¡»ç²¾ç¡®ä¸€ç›´ï¼Œè¿™é‡Œä½¿ç”¨chronydæœåŠ¡ä»ç½‘ç»œåŒæ­¥æ—¶é—´</p>
<p>ä¼ä¸šä¸­å»ºè®®é…ç½®å†…éƒ¨çš„ä¼šè§åŒæ­¥æœåŠ¡å™¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># å¯åŠ¨chronydæœåŠ¡</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># systemctl start chronyd</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># systemctl enable chronyd</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># date</span>
</span></span></code></pre></div><h5 id="264--ç¦ç”¨iptableå’ŒfirewalldæœåŠ¡">2.6.4  ç¦ç”¨iptableå’ŒfirewalldæœåŠ¡<a hidden class="anchor" aria-hidden="true" href="#264--ç¦ç”¨iptableå’ŒfirewalldæœåŠ¡">#</a></h5>
<p>kuberneteså’Œdocker åœ¨è¿è¡Œçš„ä¸­ä¼šäº§ç”Ÿå¤§é‡çš„iptablesè§„åˆ™ï¼Œä¸ºäº†ä¸è®©ç³»ç»Ÿè§„åˆ™è·Ÿå®ƒä»¬æ··æ·†ï¼Œç›´æ¥å…³é—­ç³»ç»Ÿçš„è§„åˆ™</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 1 å…³é—­firewalldæœåŠ¡</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># systemctl stop firewalld</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># systemctl disable firewalld</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2 å…³é—­iptablesæœåŠ¡</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># systemctl stop iptables</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># systemctl disable iptables</span>
</span></span></code></pre></div><h5 id="265-ç¦ç”¨selinux">2.6.5 ç¦ç”¨selinux<a hidden class="anchor" aria-hidden="true" href="#265-ç¦ç”¨selinux">#</a></h5>
<p>selinuxæ˜¯linuxç³»ç»Ÿä¸‹çš„ä¸€ä¸ªå®‰å…¨æœåŠ¡ï¼Œå¦‚æœä¸å…³é—­å®ƒï¼Œåœ¨å®‰è£…é›†ç¾¤ä¸­ä¼šäº§ç”Ÿå„ç§å„æ ·çš„å¥‡è‘©é—®é¢˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># ç¼–è¾‘ /etc/selinux/config æ–‡ä»¶ï¼Œä¿®æ”¹SELINUXçš„å€¼ä¸ºdisable</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ³¨æ„ä¿®æ”¹å®Œæ¯•ä¹‹åéœ€è¦é‡å¯linuxæœåŠ¡</span>
</span></span><span style="display:flex;"><span>SELINUX=disabled
</span></span></code></pre></div><h5 id="266-ç¦ç”¨swapåˆ†åŒº">2.6.6 ç¦ç”¨swapåˆ†åŒº<a hidden class="anchor" aria-hidden="true" href="#266-ç¦ç”¨swapåˆ†åŒº">#</a></h5>
<p>swapåˆ†åŒºæŒ‡çš„æ˜¯è™šæ‹Ÿå†…å­˜åˆ†åŒºï¼Œå®ƒçš„ä½œç”¨æ˜¯ç‰©ç†å†…å­˜ä½¿ç”¨å®Œï¼Œä¹‹åå°†ç£ç›˜ç©ºé—´è™šæ‹Ÿæˆå†…å­˜æ¥ä½¿ç”¨ï¼Œå¯ç”¨swapè®¾å¤‡ä¼šå¯¹ç³»ç»Ÿçš„æ€§èƒ½äº§ç”Ÿéå¸¸è´Ÿé¢çš„å½±å“ï¼Œå› æ­¤kubernetesè¦æ±‚æ¯ä¸ªèŠ‚ç‚¹éƒ½è¦ç¦ç”¨swapè®¾å¤‡ï¼Œä½†æ˜¯å¦‚æœå› ä¸ºæŸäº›åŸå› ç¡®å®ä¸èƒ½å…³é—­swapåˆ†åŒºï¼Œå°±éœ€è¦åœ¨é›†ç¾¤å®‰è£…è¿‡ç¨‹ä¸­é€šè¿‡æ˜ç¡®çš„å‚æ•°è¿›è¡Œé…ç½®è¯´æ˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># ç¼–è¾‘åˆ†åŒºé…ç½®æ–‡ä»¶/etc/fstabï¼Œæ³¨é‡Šæ‰swapåˆ†åŒºä¸€è¡Œ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ³¨æ„ä¿®æ”¹å®Œæ¯•ä¹‹åéœ€è¦é‡å¯linuxæœåŠ¡</span>
</span></span><span style="display:flex;"><span>vim /etc/fstab
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">æ³¨é‡Šæ‰</span> /dev/mapper/centos-swap swap
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /dev/mapper/centos-swap swap</span>
</span></span></code></pre></div><h5 id="267-ä¿®æ”¹linuxçš„å†…æ ¸å‚æ•°">2.6.7 ä¿®æ”¹linuxçš„å†…æ ¸å‚æ•°<a hidden class="anchor" aria-hidden="true" href="#267-ä¿®æ”¹linuxçš„å†…æ ¸å‚æ•°">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># ä¿®æ”¹linuxçš„å†…æ ¸é‡‡çº³æ•°ï¼Œæ·»åŠ ç½‘æ¡¥è¿‡æ»¤å’Œåœ°å€è½¬å‘åŠŸèƒ½</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¼–è¾‘/etc/sysctl.d/kubernetes.confæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</span>
</span></span><span style="display:flex;"><span>net.bridge.bridge-nf-call-ip6tables = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.bridge.bridge-nf-call-iptables = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.ipv4.ip_forward = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é‡æ–°åŠ è½½é…ç½®</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># sysctl -p</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åŠ è½½ç½‘æ¡¥è¿‡æ»¤æ¨¡å—</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># modprobe br_netfilter</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹ç½‘æ¡¥è¿‡æ»¤æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># lsmod | grep br_netfilter</span>
</span></span></code></pre></div><h5 id="268-é…ç½®ipvsåŠŸèƒ½">2.6.8 é…ç½®ipvsåŠŸèƒ½<a hidden class="anchor" aria-hidden="true" href="#268-é…ç½®ipvsåŠŸèƒ½">#</a></h5>
<p>åœ¨Kubernetesä¸­Serviceæœ‰ä¸¤ç§å¸¦æ¥æ¨¡å‹ï¼Œä¸€ç§æ˜¯åŸºäºiptablesçš„ï¼Œä¸€ç§æ˜¯åŸºäºipvsçš„ä¸¤è€…æ¯”è¾ƒçš„è¯ï¼Œipvsçš„æ€§èƒ½æ˜æ˜¾è¦é«˜ä¸€äº›ï¼Œä½†æ˜¯å¦‚æœè¦ä½¿ç”¨å®ƒï¼Œéœ€è¦æ‰‹åŠ¨è½½å…¥ipvsæ¨¡å—</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 1.å®‰è£…ipsetå’Œipvsadm</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># yum install ipset ipvsadm -y</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2.æ·»åŠ éœ€è¦åŠ è½½çš„æ¨¡å—å†™å…¥è„šæœ¬æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># cat &lt;&lt;EOF&gt; /etc/sysconfig/modules/ipvs.modules</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash</span>
</span></span><span style="display:flex;"><span>modprobe -- ip_vs
</span></span><span style="display:flex;"><span>modprobe -- ip_vs_rr
</span></span><span style="display:flex;"><span>modprobe -- ip_vs_wrr
</span></span><span style="display:flex;"><span>modprobe -- ip_vs_sh
</span></span><span style="display:flex;"><span>modprobe -- nf_conntrack_ipv4
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3.ä¸ºè„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># chmod +x /etc/sysconfig/modules/ipvs.modules</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4.æ‰§è¡Œè„šæœ¬æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># /bin/bash /etc/sysconfig/modules/ipvs.modules</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5.æŸ¥çœ‹å¯¹åº”çš„æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span>
</span></span></code></pre></div><h5 id="269-å®‰è£…docker">2.6.9 å®‰è£…docker<a hidden class="anchor" aria-hidden="true" href="#269-å®‰è£…docker">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 1ã€åˆ‡æ¢é•œåƒæº</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># wget https:/mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2ã€æŸ¥çœ‹å½“å‰é•œåƒæºä¸­æ”¯æŒçš„dockerç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># yum list docker-ce --showduplicates</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3ã€å®‰è£…ç‰¹å®šç‰ˆæœ¬çš„docker-ce</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¿…é¡»åˆ¶å®š--setopt=obsoletes=0ï¼Œå¦åˆ™yumä¼šè‡ªåŠ¨å®‰è£…æ›´é«˜ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># yum install --setopt=obsoletes=0 docker-ce-18.06.3.ce-3.el7 -y</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4ã€æ·»åŠ ä¸€ä¸ªé…ç½®æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Docker åœ¨é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨Vgroup Driverä¸ºcgroupfsï¼Œè€ŒKubernetesæ¨èä½¿ç”¨systemdæ¥æ›¿ä»£cgroupfs</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># mkdir /etc/docker</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># cat &lt;&lt;EOF&gt; /etc/docker/daemon.json</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;exec-opts&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [<span style="color:#e6db74">&#34;native.cgroupdriver=systemd&#34;</span>],
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;registry-mirrors&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [<span style="color:#e6db74">&#34;https:/kn0t2bca.mirror.aliyuncs.com&#34;</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5ã€å¯åŠ¨dokcer</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># systemctl restart docker</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># systemctl enable docker</span>
</span></span></code></pre></div><h5 id="2610-å®‰è£…kubernetesç»„ä»¶">2.6.10 å®‰è£…Kubernetesç»„ä»¶<a hidden class="anchor" aria-hidden="true" href="#2610-å®‰è£…kubernetesç»„ä»¶">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># 1ã€ç”±äºkubernetesçš„é•œåƒåœ¨å›½å¤–ï¼Œé€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œè¿™é‡Œåˆ‡æ¢æˆå›½å†…çš„é•œåƒæº</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2ã€ç¼–è¾‘/etc/yum.repos.d/kubernetes.repo,æ·»åŠ ä¸‹é¢çš„é…ç½®</span>
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">kubernetes</span>]
</span></span><span style="display:flex;"><span>name=Kubernetes
</span></span><span style="display:flex;"><span>baseurl=http<span style="color:#960050;background-color:#1e0010">:</span>/mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span><span style="display:flex;"><span>enabled=<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>gpgchech=<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>repo_gpgcheck=<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>gpgkey=http<span style="color:#960050;background-color:#1e0010">:</span>/mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
</span></span><span style="display:flex;"><span>       http<span style="color:#960050;background-color:#1e0010">:</span>/mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3ã€å®‰è£…kubeadmã€kubeletå’Œkubectl</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># yum install --setopt=obsoletes=0 kubeadm-1.17.4-0 kubelet-1.17.4-0 kubectl-1.17.4-0 -y</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4ã€é…ç½®kubeletçš„cgroup</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ç¼–è¾‘/etc/sysconfig/kubelet, æ·»åŠ ä¸‹é¢çš„é…ç½®</span>
</span></span><span style="display:flex;"><span>KUBELET_CGROUP_ARGS=<span style="color:#e6db74">&#34;--cgroup-driver=systemd&#34;</span>
</span></span><span style="display:flex;"><span>KUBE_PROXY_MODE=<span style="color:#e6db74">&#34;ipvs&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5ã€è®¾ç½®kubeletå¼€æœºè‡ªå¯</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># systemctl enable kubelet</span>
</span></span></code></pre></div><h5 id="2611-å‡†å¤‡é›†ç¾¤é•œåƒ">2.6.11 å‡†å¤‡é›†ç¾¤é•œåƒ<a hidden class="anchor" aria-hidden="true" href="#2611-å‡†å¤‡é›†ç¾¤é•œåƒ">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># åœ¨å®‰è£…kubernetesé›†ç¾¤ä¹‹å‰ï¼Œå¿…é¡»è¦æå‰å‡†å¤‡å¥½é›†ç¾¤éœ€è¦çš„é•œåƒï¼Œæ‰€éœ€é•œåƒå¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥çœ‹</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># kubeadm config /kubernetes.images list</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸‹è½½é•œåƒ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ­¤é•œåƒkubernetesçš„ä»“åº“ä¸­ï¼Œç”±äºç½‘ç»œåŸå› ï¼Œæ— æ³•è¿æ¥ï¼Œä¸‹é¢æä¾›äº†ä¸€ç§æ›¿æ¢æ–¹æ¡ˆ</span>
</span></span><span style="display:flex;"><span>/kubernetes.images=(
</span></span><span style="display:flex;"><span>  kube-apiserver<span style="color:#960050;background-color:#1e0010">:</span>v1.17.4
</span></span><span style="display:flex;"><span>  kube-controller-manager:v1.17.4
</span></span><span style="display:flex;"><span>  kube-scheduler<span style="color:#960050;background-color:#1e0010">:</span>v1.17.4
</span></span><span style="display:flex;"><span>  kube-proxy<span style="color:#960050;background-color:#1e0010">:</span>v1.17.4
</span></span><span style="display:flex;"><span>  pause<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">3.1</span>
</span></span><span style="display:flex;"><span>  etcd<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">3.4</span>.<span style="color:#ae81ff">3</span>-<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  coredns<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">1.6</span>.5
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> imageName <span style="color:#66d9ef">in</span> ${/kubernetes.images[@]};<span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName
</span></span><span style="display:flex;"><span>  docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName k8s.gcr.io/$imageName
</span></span><span style="display:flex;"><span>  docker rmi registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName 
</span></span><span style="display:flex;"><span>done
</span></span></code></pre></div><h5 id="2611-é›†ç¾¤åˆå§‹åŒ–">2.6.11 é›†ç¾¤åˆå§‹åŒ–<a hidden class="anchor" aria-hidden="true" href="#2611-é›†ç¾¤åˆå§‹åŒ–">#</a></h5>
<blockquote>
<p>ä¸‹é¢çš„æ“ä½œåªéœ€è¦åœ¨masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œå³å¯</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºé›†ç¾¤</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># kubeadm init \</span>
</span></span><span style="display:flex;"><span> --apiserver-advertise-address=<span style="color:#ae81ff">192.168</span>.90.100 \
</span></span><span style="display:flex;"><span> --image-repository registry.aliyuncs.com/google_containers \
</span></span><span style="display:flex;"><span> --kubernetes-version=v1.17.4 \
</span></span><span style="display:flex;"><span> --service-cidr=<span style="color:#ae81ff">10.96</span>.0.<span style="color:#ae81ff">0</span>/<span style="color:#ae81ff">12</span> \
</span></span><span style="display:flex;"><span> --pod-network-cidr=<span style="color:#ae81ff">10.244</span>.0.<span style="color:#ae81ff">0</span>/<span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºå¿…è¦æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># mkdir -p $HOME/.kube</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># sudo chown $(id -u):$(id -g) $HOME/.kube/config</span>
</span></span></code></pre></div><blockquote>
<p>ä¸‹é¢çš„æ“ä½œåªéœ€è¦åœ¨nodeèŠ‚ç‚¹ä¸Šæ‰§è¡Œå³å¯</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>kubeadm join <span style="color:#ae81ff">192.168</span>.0.<span style="color:#ae81ff">100</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">6443</span> --token awk15p.t6bamck54w69u4s8 \
</span></span><span style="display:flex;"><span>    --discovery-token-ca-cert-hash sha256<span style="color:#960050;background-color:#1e0010">:</span>a94fa09562466d32d29523ab6cff122186f1127599fa4dcd5fa0152694f17117 
</span></span></code></pre></div><p>åœ¨masterä¸ŠæŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># kubectl get nodes</span>
</span></span><span style="display:flex;"><span>NAME    STATUS   ROLES     AGE   VERSION
</span></span><span style="display:flex;"><span>master  NotReady  master   <span style="color:#ae81ff">6m</span>    v1.17.4
</span></span><span style="display:flex;"><span>node1   NotReady   &lt;none&gt;  22s   v1.17.4
</span></span><span style="display:flex;"><span>node2   NotReady   &lt;none&gt;  19s   v1.17.4
</span></span></code></pre></div><h5 id="2613-å®‰è£…ç½‘ç»œæ’ä»¶åªåœ¨masterèŠ‚ç‚¹æ“ä½œå³å¯">2.6.13 å®‰è£…ç½‘ç»œæ’ä»¶ï¼Œåªåœ¨masterèŠ‚ç‚¹æ“ä½œå³å¯<a hidden class="anchor" aria-hidden="true" href="#2613-å®‰è£…ç½‘ç»œæ’ä»¶åªåœ¨masterèŠ‚ç‚¹æ“ä½œå³å¯">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>wget https<span style="color:#960050;background-color:#1e0010">:</span>/raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span></code></pre></div><p>ç”±äºå¤–ç½‘ä¸å¥½è®¿é—®ï¼Œå¦‚æœå‡ºç°æ— æ³•è®¿é—®çš„æƒ…å†µï¼Œå¯ä»¥ç›´æ¥ç”¨ä¸‹é¢çš„ è®°å¾—æ–‡ä»¶åæ˜¯kube-flannel.ymlï¼Œä½ç½®ï¼š/root/kube-flannel.ymlå†…å®¹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>https<span style="color:#960050;background-color:#1e0010">:</span>/github.com/flannel-io/flannel/tree/master/Documentation/kube-flannel.yml
</span></span></code></pre></div><p>ä¹Ÿå¯æ‰‹åŠ¨æ‹‰å–æŒ‡å®šç‰ˆæœ¬
docker pull quay.io/coreos/flannel:v0.14.0              #æ‹‰å–flannelç½‘ç»œï¼Œä¸‰å°ä¸»æœº
docker /kubernetes.images                  #æŸ¥çœ‹ä»“åº“æ˜¯å¦æ‹‰å»ä¸‹æ¥</p>
<p><code>ä¸ªäººç¬”è®°</code>
è‹¥æ˜¯é›†ç¾¤çŠ¶æ€ä¸€ç›´æ˜¯ notready,ç”¨ä¸‹é¢è¯­å¥æŸ¥çœ‹åŸå› ï¼Œ
journalctl -f -u kubelet.service
è‹¥åŸå› æ˜¯ï¼š cni.go:237] Unable to update cni config: no networks found in /etc/cni/net.d
mkdir -p /etc/cni/net.d                    #åˆ›å»ºç›®å½•ç»™flannelåšé…ç½®æ–‡ä»¶
vim /etc/cni/net.d/10-flannel.conf         #ç¼–å†™é…ç½®æ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;name&#34;</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;cbr0&#34;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;cniVersion&#34;</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;0.3.1&#34;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;type&#34;</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;flannel&#34;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;deledate&#34;</span><span style="color:#960050;background-color:#1e0010">:</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;hairpinMode&#34;</span><span style="color:#960050;background-color:#1e0010">:</span>true,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;isDefaultGateway&#34;</span><span style="color:#960050;background-color:#1e0010">:</span>true
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="2614-ä½¿ç”¨kubeadm-reseté‡ç½®é›†ç¾¤">2.6.14 ä½¿ç”¨kubeadm reseté‡ç½®é›†ç¾¤<a hidden class="anchor" aria-hidden="true" href="#2614-ä½¿ç”¨kubeadm-reseté‡ç½®é›†ç¾¤">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-TEXT" data-lang="TEXT"><span style="display:flex;"><span>#åœ¨masterèŠ‚ç‚¹ä¹‹å¤–çš„èŠ‚ç‚¹è¿›è¡Œæ“ä½œ
</span></span><span style="display:flex;"><span>kubeadm reset
</span></span><span style="display:flex;"><span>systemctl stop kubelet
</span></span><span style="display:flex;"><span>systemctl stop docker
</span></span><span style="display:flex;"><span>rm -rf /var/lib/cni/
</span></span><span style="display:flex;"><span>rm -rf /var/lib/kubelet/*
</span></span><span style="display:flex;"><span>rm -rf /etc/cni/
</span></span><span style="display:flex;"><span>ifconfig cni0 down
</span></span><span style="display:flex;"><span>ifconfig flannel.1 down
</span></span><span style="display:flex;"><span>ifconfig docker0 down
</span></span><span style="display:flex;"><span>ip link delete cni0
</span></span><span style="display:flex;"><span>ip link delete flannel.1
</span></span><span style="display:flex;"><span>##é‡å¯kubelet
</span></span><span style="display:flex;"><span>systemctl restart kubelet
</span></span><span style="display:flex;"><span>##é‡å¯docker
</span></span><span style="display:flex;"><span>systemctl restart docker
</span></span></code></pre></div><h5 id="2615-é‡å¯kubeletå’Œdocker">2.6.15 é‡å¯kubeletå’Œdocker<a hidden class="anchor" aria-hidden="true" href="#2615-é‡å¯kubeletå’Œdocker">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># é‡å¯kubelet</span>
</span></span><span style="display:flex;"><span>systemctl restart kubelet
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é‡å¯docker</span>
</span></span><span style="display:flex;"><span>systemctl restart docker
</span></span></code></pre></div><p>ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨fannel</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>kubectl apply <span style="color:#f92672">-f</span> kube-flannel.yml
</span></span></code></pre></div><p>ç­‰å¾…å®ƒå®‰è£…å®Œæ¯• å‘ç°å·²ç»æ˜¯ é›†ç¾¤çš„çŠ¶æ€å·²ç»æ˜¯Ready</p>
<p><img loading="lazy" src="/kubernetes.images/2232696-20210621233106024-1676033717.png" alt="img"  />
</p>
<h5 id="2616-kubeadmä¸­çš„å‘½ä»¤">2.6.16 kubeadmä¸­çš„å‘½ä»¤<a hidden class="anchor" aria-hidden="true" href="#2616-kubeadmä¸­çš„å‘½ä»¤">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># ç”Ÿæˆ æ–°çš„token</span>
</span></span><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># kubeadm token create --print-join-command</span>
</span></span></code></pre></div><h4 id="27-é›†ç¾¤æµ‹è¯•">2.7 é›†ç¾¤æµ‹è¯•<a hidden class="anchor" aria-hidden="true" href="#27-é›†ç¾¤æµ‹è¯•">#</a></h4>
<h5 id="271-åˆ›å»ºä¸€ä¸ªnginxæœåŠ¡">2.7.1 åˆ›å»ºä¸€ä¸ªnginxæœåŠ¡<a hidden class="anchor" aria-hidden="true" href="#271-åˆ›å»ºä¸€ä¸ªnginxæœåŠ¡">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>kubectl create deployment nginx  --image=nginx<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">1.14</span>-alpine
</span></span></code></pre></div><h5 id="272-æš´éœ²ç«¯å£">2.7.2 æš´éœ²ç«¯å£<a hidden class="anchor" aria-hidden="true" href="#272-æš´éœ²ç«¯å£">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>kubectl expose deploy nginx  --port=<span style="color:#ae81ff">80</span> --target-port=<span style="color:#ae81ff">80</span>  --type=NodePort
</span></span></code></pre></div><h5 id="273-æŸ¥çœ‹æœåŠ¡">2.7.3 æŸ¥çœ‹æœåŠ¡<a hidden class="anchor" aria-hidden="true" href="#273-æŸ¥çœ‹æœåŠ¡">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>kubectl get pod,svc
</span></span></code></pre></div><h5 id="274-æŸ¥çœ‹pod">2.7.4 æŸ¥çœ‹pod<a hidden class="anchor" aria-hidden="true" href="#274-æŸ¥çœ‹pod">#</a></h5>
<p><img loading="lazy" src="/kubernetes.images/2232696-20210621233130477-111035427.png" alt="2232696-20210621233130477-111035427"  />
</p>
<p>æµè§ˆå™¨æµ‹è¯•ç»“æœï¼š</p>
<p><img loading="lazy" src="/kubernetes.images/2232696-20210621233157075-1117518703.png" alt="img"  />
</p>
<h3 id="3-èµ„æºç®¡ç†">3. èµ„æºç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#3-èµ„æºç®¡ç†">#</a></h3>
<h4 id="31-èµ„æºç®¡ç†ä»‹ç»">3.1 èµ„æºç®¡ç†ä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#31-èµ„æºç®¡ç†ä»‹ç»">#</a></h4>
<p>åœ¨kubernetesä¸­ï¼Œæ‰€æœ‰çš„å†…å®¹éƒ½æŠ½è±¡ä¸ºèµ„æºï¼Œç”¨æˆ·éœ€è¦é€šè¿‡æ“ä½œèµ„æºæ¥ç®¡ç†kubernetesã€‚</p>
<blockquote>
<p>kubernetesçš„æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªé›†ç¾¤ç³»ç»Ÿï¼Œç”¨æˆ·å¯ä»¥åœ¨é›†ç¾¤ä¸­éƒ¨ç½²å„ç§æœåŠ¡ï¼Œæ‰€è°“çš„éƒ¨ç½²æœåŠ¡ï¼Œå…¶å®å°±æ˜¯åœ¨kubernetesé›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ªä¸ªçš„å®¹å™¨ï¼Œå¹¶å°†æŒ‡å®šçš„ç¨‹åºè·‘åœ¨å®¹å™¨ä¸­ã€‚</p>
<p>kubernetesçš„æœ€å°ç®¡ç†å•å…ƒæ˜¯podè€Œä¸æ˜¯å®¹å™¨ï¼Œæ‰€ä»¥åªèƒ½å°†å®¹å™¨æ”¾åœ¨<code>Pod</code>ä¸­ï¼Œè€Œkubernetesä¸€èˆ¬ä¹Ÿä¸ä¼šç›´æ¥ç®¡ç†Podï¼Œè€Œæ˜¯é€šè¿‡<code>Podæ§åˆ¶å™¨</code>æ¥ç®¡ç†Podçš„ã€‚</p>
<p>Podå¯ä»¥æä¾›æœåŠ¡ä¹‹åï¼Œå°±è¦è€ƒè™‘å¦‚ä½•è®¿é—®Podä¸­æœåŠ¡ï¼Œkubernetesæä¾›äº†<code>Service</code>èµ„æºå®ç°è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœPodä¸­ç¨‹åºçš„æ•°æ®éœ€è¦æŒä¹…åŒ–ï¼Œkubernetesè¿˜æä¾›äº†å„ç§<code>å­˜å‚¨</code>ç³»ç»Ÿã€‚</p>
</blockquote>
<p><img loading="lazy" src="/kubernetes.images/image-20200406225334627.png" alt="image-20200406225334627"  />
</p>
<blockquote>
<p>å­¦ä¹ kubernetesçš„æ ¸å¿ƒï¼Œå°±æ˜¯å­¦ä¹ å¦‚ä½•å¯¹é›†ç¾¤ä¸Šçš„<code>Podã€Podæ§åˆ¶å™¨ã€Serviceã€å­˜å‚¨</code>ç­‰å„ç§èµ„æºè¿›è¡Œæ“ä½œ</p>
</blockquote>
<h4 id="32-yamlè¯­è¨€ä»‹ç»">3.2 YAMLè¯­è¨€ä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#32-yamlè¯­è¨€ä»‹ç»">#</a></h4>
<p>YAMLæ˜¯ä¸€ä¸ªç±»ä¼¼ XMLã€JSON çš„æ ‡è®°æ€§è¯­è¨€ã€‚å®ƒå¼ºè°ƒä»¥æ•°æ®ä¸ºä¸­å¿ƒï¼Œå¹¶ä¸æ˜¯ä»¥æ ‡è¯†è¯­è¨€ä¸ºé‡ç‚¹ã€‚å› è€ŒYAMLæœ¬èº«çš„å®šä¹‰æ¯”è¾ƒç®€å•ï¼Œå·ç§°&quot;ä¸€ç§äººæ€§åŒ–çš„æ•°æ®æ ¼å¼è¯­è¨€&quot;ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">heima</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">age</span>&gt;15&lt;/<span style="color:#f92672">age</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">address</span>&gt;Beijing&lt;/<span style="color:#f92672">address</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">heima</span>&gt;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>heima:
</span></span><span style="display:flex;"><span>  age: <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>  address: Beijing
</span></span></code></pre></div><p>YAMLçš„è¯­æ³•æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æœ‰ä¸‹é¢å‡ ä¸ªï¼š</p>
<ul>
<li>å¤§å°å†™æ•æ„Ÿ</li>
<li>ä½¿ç”¨ç¼©è¿›è¡¨ç¤ºå±‚çº§å…³ç³»</li>
<li>ç¼©è¿›ä¸å…è®¸ä½¿ç”¨tabï¼Œåªå…è®¸ç©ºæ ¼( ä½ç‰ˆæœ¬é™åˆ¶ )</li>
<li>ç¼©è¿›çš„ç©ºæ ¼æ•°ä¸é‡è¦ï¼Œåªè¦ç›¸åŒå±‚çº§çš„å…ƒç´ å·¦å¯¹é½å³å¯</li>
<li>&lsquo;#&lsquo;è¡¨ç¤ºæ³¨é‡Š</li>
</ul>
<p>YAMLæ”¯æŒä»¥ä¸‹å‡ ç§æ•°æ®ç±»å‹ï¼š</p>
<ul>
<li>çº¯é‡ï¼šå•ä¸ªçš„ã€ä¸å¯å†åˆ†çš„å€¼</li>
<li>å¯¹è±¡ï¼šé”®å€¼å¯¹çš„é›†åˆï¼Œåˆç§°ä¸ºæ˜ å°„ï¼ˆmappingï¼‰/ å“ˆå¸Œï¼ˆhashï¼‰ / å­—å…¸ï¼ˆdictionaryï¼‰</li>
<li>æ•°ç»„ï¼šä¸€ç»„æŒ‰æ¬¡åºæ’åˆ—çš„å€¼ï¼Œåˆç§°ä¸ºåºåˆ—ï¼ˆsequenceï¼‰ / åˆ—è¡¨ï¼ˆlistï¼‰</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#75715e"># çº¯é‡, å°±æ˜¯æŒ‡çš„ä¸€ä¸ªç®€å•çš„å€¼ï¼Œå­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ã€æ•´æ•°ã€æµ®ç‚¹æ•°ã€Nullã€æ—¶é—´ã€æ—¥æœŸ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1 å¸ƒå°”ç±»å‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">c1</span>: <span style="color:#66d9ef">true</span> <span style="color:#ae81ff">(æˆ–è€…True)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2 æ•´å‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">c2</span>: <span style="color:#ae81ff">234</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3 æµ®ç‚¹å‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">c3</span>: <span style="color:#ae81ff">3.14</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4 nullç±»å‹ </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">c4</span>: <span style="color:#ae81ff">~ </span> <span style="color:#75715e"># ä½¿ç”¨~è¡¨ç¤ºnull</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5 æ—¥æœŸç±»å‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">c5</span>: <span style="color:#e6db74">2018-02-17</span>    <span style="color:#75715e"># æ—¥æœŸå¿…é¡»ä½¿ç”¨ISO 8601æ ¼å¼ï¼Œå³yyyy-MM-dd</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6 æ—¶é—´ç±»å‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">c6</span>: <span style="color:#e6db74">2018-02-17T15:02:31</span><span style="color:#ae81ff">+08</span>:<span style="color:#ae81ff">00</span>  <span style="color:#75715e"># æ—¶é—´ä½¿ç”¨ISO 8601æ ¼å¼ï¼Œæ—¶é—´å’Œæ—¥æœŸä¹‹é—´ä½¿ç”¨Tè¿æ¥ï¼Œæœ€åä½¿ç”¨+ä»£è¡¨æ—¶åŒº</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 7 å­—ç¬¦ä¸²ç±»å‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">c7</span>: <span style="color:#ae81ff">heima    </span> <span style="color:#75715e"># ç®€å•å†™æ³•ï¼Œç›´æ¥å†™å€¼ , å¦‚æœå­—ç¬¦ä¸²ä¸­é—´æœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œå¿…é¡»ä½¿ç”¨åŒå¼•å·æˆ–è€…å•å¼•å·åŒ…è£¹ </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">c8</span>: <span style="color:#ae81ff">line1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">line2    </span> <span style="color:#75715e"># å­—ç¬¦ä¸²è¿‡å¤šçš„æƒ…å†µå¯ä»¥æ‹†æˆå¤šè¡Œï¼Œæ¯ä¸€è¡Œä¼šè¢«è½¬åŒ–æˆä¸€ä¸ªç©ºæ ¼</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># å¯¹è±¡</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å½¢å¼ä¸€(æ¨è):</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">heima</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">age</span>: <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">address</span>: <span style="color:#ae81ff">Beijing</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å½¢å¼äºŒ(äº†è§£):</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">heima</span>: {<span style="color:#f92672">age: 15,address</span>: <span style="color:#ae81ff">Beijing}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># æ•°ç»„</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å½¢å¼ä¸€(æ¨è):</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">address</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">é¡ºä¹‰</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">æ˜Œå¹³  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å½¢å¼äºŒ(äº†è§£):</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">address</span>: [<span style="color:#ae81ff">é¡ºä¹‰,æ˜Œå¹³]</span>
</span></span></code></pre></div><blockquote>
<p>å°æç¤ºï¼š</p>
<p>1 ä¹¦å†™yamlåˆ‡è®°<code>:</code> åé¢è¦åŠ ä¸€ä¸ªç©ºæ ¼</p>
<p>2 å¦‚æœéœ€è¦å°†å¤šæ®µyamlé…ç½®æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œä¸­é—´è¦ä½¿ç”¨<code>---</code>åˆ†éš”</p>
<p>3 ä¸‹é¢æ˜¯ä¸€ä¸ªyamlè½¬jsonçš„ç½‘ç«™ï¼Œå¯ä»¥é€šè¿‡å®ƒéªŒè¯yamlæ˜¯å¦ä¹¦å†™æ­£ç¡®
<a href="https:/www.json2yaml.com/convert-yaml-to-json">https:/www.json2yaml.com/convert-yaml-to-json</a></p>
</blockquote>
<h4 id="33-èµ„æºç®¡ç†æ–¹å¼">3.3 èµ„æºç®¡ç†æ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#33-èµ„æºç®¡ç†æ–¹å¼">#</a></h4>
<ul>
<li>
<p>å‘½ä»¤å¼å¯¹è±¡ç®¡ç†ï¼šç›´æ¥ä½¿ç”¨å‘½ä»¤å»æ“ä½œkubernetesèµ„æº</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>kubectl run nginx-pod --image=nginx<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">1.17</span>.1 --port=<span style="color:#ae81ff">80</span>
</span></span></code></pre></div></li>
<li>
<p>å‘½ä»¤å¼å¯¹è±¡é…ç½®ï¼šé€šè¿‡å‘½ä»¤é…ç½®å’Œé…ç½®æ–‡ä»¶å»æ“ä½œkubernetesèµ„æº</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>kubectl create/patch <span style="color:#f92672">-f</span> nginx-pod.yaml
</span></span></code></pre></div></li>
<li>
<p>å£°æ˜å¼å¯¹è±¡é…ç½®ï¼šé€šè¿‡applyå‘½ä»¤å’Œé…ç½®æ–‡ä»¶å»æ“ä½œkubernetesèµ„æº</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>kubectl apply <span style="color:#f92672">-f</span> nginx-pod.yaml
</span></span></code></pre></div></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">ç±»å‹</th>
<th style="text-align:left">æ“ä½œå¯¹è±¡</th>
<th style="text-align:left">é€‚ç”¨ç¯å¢ƒ</th>
<th style="text-align:left">ä¼˜ç‚¹</th>
<th style="text-align:left">ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">å‘½ä»¤å¼å¯¹è±¡ç®¡ç†</td>
<td style="text-align:left">å¯¹è±¡</td>
<td style="text-align:left">æµ‹è¯•</td>
<td style="text-align:left">ç®€å•</td>
<td style="text-align:left">åªèƒ½æ“ä½œæ´»åŠ¨å¯¹è±¡ï¼Œæ— æ³•å®¡è®¡ã€è·Ÿè¸ª</td>
</tr>
<tr>
<td style="text-align:left">å‘½ä»¤å¼å¯¹è±¡é…ç½®</td>
<td style="text-align:left">æ–‡ä»¶</td>
<td style="text-align:left">å¼€å‘</td>
<td style="text-align:left">å¯ä»¥å®¡è®¡ã€è·Ÿè¸ª</td>
<td style="text-align:left">é¡¹ç›®å¤§æ—¶ï¼Œé…ç½®æ–‡ä»¶å¤šï¼Œæ“ä½œéº»çƒ¦</td>
</tr>
<tr>
<td style="text-align:left">å£°æ˜å¼å¯¹è±¡é…ç½®</td>
<td style="text-align:left">ç›®å½•</td>
<td style="text-align:left">å¼€å‘</td>
<td style="text-align:left">æ”¯æŒç›®å½•æ“ä½œ</td>
<td style="text-align:left">æ„å¤–æƒ…å†µä¸‹éš¾ä»¥è°ƒè¯•</td>
</tr>
</tbody>
</table>
<h5 id="331-å‘½ä»¤å¼å¯¹è±¡ç®¡ç†">3.3.1 å‘½ä»¤å¼å¯¹è±¡ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#331-å‘½ä»¤å¼å¯¹è±¡ç®¡ç†">#</a></h5>
<p>kubectlå‘½ä»¤</p>
<p>kubectlæ˜¯kubernetesé›†ç¾¤çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œé€šè¿‡å®ƒèƒ½å¤Ÿå¯¹é›†ç¾¤æœ¬èº«è¿›è¡Œç®¡ç†ï¼Œå¹¶èƒ½å¤Ÿåœ¨é›†ç¾¤ä¸Šè¿›è¡Œå®¹å™¨åŒ–åº”ç”¨çš„å®‰è£…éƒ¨ç½²ã€‚kubectlå‘½ä»¤çš„è¯­æ³•å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl <span style="color:#f92672">[</span>command<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>name<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>flags<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>comandï¼šæŒ‡å®šè¦å¯¹èµ„æºæ‰§è¡Œçš„æ“ä½œï¼Œä¾‹å¦‚createã€getã€delete</p>
<p>typeï¼šæŒ‡å®šèµ„æºç±»å‹ï¼Œæ¯”å¦‚deploymentã€podã€service</p>
<p>nameï¼šæŒ‡å®šèµ„æºçš„åç§°ï¼Œåç§°å¤§å°å†™æ•æ„Ÿ</p>
<p>flagsï¼šæŒ‡å®šé¢å¤–çš„å¯é€‰å‚æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹æ‰€æœ‰pod</span>
</span></span><span style="display:flex;"><span>kubectl get pod 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹æŸä¸ªpod</span>
</span></span><span style="display:flex;"><span>kubectl get pod pod_name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹æŸä¸ªpod,ä»¥yamlæ ¼å¼å±•ç¤ºç»“æœ</span>
</span></span><span style="display:flex;"><span>kubectl get pod pod_name -o yaml
</span></span></code></pre></div><p>èµ„æºç±»å‹</p>
<p>kubernetesä¸­æ‰€æœ‰çš„å†…å®¹éƒ½æŠ½è±¡ä¸ºèµ„æºï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl api-resources
</span></span></code></pre></div><p>ç»å¸¸ä½¿ç”¨çš„èµ„æºæœ‰ä¸‹é¢è¿™äº›ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">èµ„æºåˆ†ç±»</th>
<th style="text-align:left">èµ„æºåç§°</th>
<th style="text-align:left">ç¼©å†™</th>
<th style="text-align:left">èµ„æºä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">é›†ç¾¤çº§åˆ«èµ„æº</td>
<td style="text-align:left">nodes</td>
<td style="text-align:left">no</td>
<td style="text-align:left">é›†ç¾¤ç»„æˆéƒ¨åˆ†</td>
</tr>
<tr>
<td style="text-align:left">namespaces</td>
<td style="text-align:left">ns</td>
<td style="text-align:left">éš”ç¦»Pod</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">podèµ„æº</td>
<td style="text-align:left">pods</td>
<td style="text-align:left">po</td>
<td style="text-align:left">è£…è½½å®¹å™¨</td>
</tr>
<tr>
<td style="text-align:left">podèµ„æºæ§åˆ¶å™¨</td>
<td style="text-align:left">replicationcontrollers</td>
<td style="text-align:left">rc</td>
<td style="text-align:left">æ§åˆ¶podèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">replicasets</td>
<td style="text-align:left">rs</td>
<td style="text-align:left">æ§åˆ¶podèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">deployments</td>
<td style="text-align:left">deploy</td>
<td style="text-align:left">æ§åˆ¶podèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">daemonsets</td>
<td style="text-align:left">ds</td>
<td style="text-align:left">æ§åˆ¶podèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">jobs</td>
<td style="text-align:left"></td>
<td style="text-align:left">æ§åˆ¶podèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">cronjobs</td>
<td style="text-align:left">cj</td>
<td style="text-align:left">æ§åˆ¶podèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">horizontalpodautoscalers</td>
<td style="text-align:left">hpa</td>
<td style="text-align:left">æ§åˆ¶podèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">statefulsets</td>
<td style="text-align:left">sts</td>
<td style="text-align:left">æ§åˆ¶podèµ„æº</td>
</tr>
<tr>
<td style="text-align:left">æœåŠ¡å‘ç°èµ„æº</td>
<td style="text-align:left">services</td>
<td style="text-align:left">svc</td>
<td style="text-align:left">ç»Ÿä¸€podå¯¹å¤–æ¥å£</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">ingress</td>
<td style="text-align:left">ing</td>
<td style="text-align:left">ç»Ÿä¸€podå¯¹å¤–æ¥å£</td>
</tr>
<tr>
<td style="text-align:left">å­˜å‚¨èµ„æº</td>
<td style="text-align:left">volumeattachments</td>
<td style="text-align:left"></td>
<td style="text-align:left">å­˜å‚¨</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">persistentvolumes</td>
<td style="text-align:left">pv</td>
<td style="text-align:left">å­˜å‚¨</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">persistentvolumeclaims</td>
<td style="text-align:left">pvc</td>
<td style="text-align:left">å­˜å‚¨</td>
</tr>
<tr>
<td style="text-align:left">é…ç½®èµ„æº</td>
<td style="text-align:left">configmaps</td>
<td style="text-align:left">cm</td>
<td style="text-align:left">é…ç½®</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">secrets</td>
<td style="text-align:left"></td>
<td style="text-align:left">é…ç½®</td>
</tr>
</tbody>
</table>
<p>æ“ä½œ</p>
<p>kuberneteså…è®¸å¯¹èµ„æºè¿›è¡Œå¤šç§æ“ä½œï¼Œå¯ä»¥é€šè¿‡&ndash;helpæŸ¥çœ‹è¯¦ç»†çš„æ“ä½œå‘½ä»¤</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl --help
</span></span></code></pre></div><p>ç»å¸¸ä½¿ç”¨çš„æ“ä½œæœ‰ä¸‹é¢è¿™äº›ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">å‘½ä»¤åˆ†ç±»</th>
<th style="text-align:left">å‘½ä»¤</th>
<th style="text-align:left">ç¿»è¯‘</th>
<th style="text-align:left">å‘½ä»¤ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">åŸºæœ¬å‘½ä»¤</td>
<td style="text-align:left">create</td>
<td style="text-align:left">åˆ›å»º</td>
<td style="text-align:left">åˆ›å»ºä¸€ä¸ªèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">edit</td>
<td style="text-align:left">ç¼–è¾‘</td>
<td style="text-align:left">ç¼–è¾‘ä¸€ä¸ªèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">get</td>
<td style="text-align:left">è·å–</td>
<td style="text-align:left">è·å–ä¸€ä¸ªèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">patch</td>
<td style="text-align:left">æ›´æ–°</td>
<td style="text-align:left">æ›´æ–°ä¸€ä¸ªèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">delete</td>
<td style="text-align:left">åˆ é™¤</td>
<td style="text-align:left">åˆ é™¤ä¸€ä¸ªèµ„æº</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">explain</td>
<td style="text-align:left">è§£é‡Š</td>
<td style="text-align:left">å±•ç¤ºèµ„æºæ–‡æ¡£</td>
</tr>
<tr>
<td style="text-align:left">è¿è¡Œå’Œè°ƒè¯•</td>
<td style="text-align:left">run</td>
<td style="text-align:left">è¿è¡Œ</td>
<td style="text-align:left">åœ¨é›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ªæŒ‡å®šçš„é•œåƒ</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">expose</td>
<td style="text-align:left">æš´éœ²</td>
<td style="text-align:left">æš´éœ²èµ„æºä¸ºService</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">describe</td>
<td style="text-align:left">æè¿°</td>
<td style="text-align:left">æ˜¾ç¤ºèµ„æºå†…éƒ¨ä¿¡æ¯</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">logs</td>
<td style="text-align:left">æ—¥å¿—è¾“å‡ºå®¹å™¨åœ¨ pod ä¸­çš„æ—¥å¿—</td>
<td style="text-align:left">è¾“å‡ºå®¹å™¨åœ¨ pod ä¸­çš„æ—¥å¿—</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">attach</td>
<td style="text-align:left">ç¼ ç»•è¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨</td>
<td style="text-align:left">è¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">exec</td>
<td style="text-align:left">æ‰§è¡Œå®¹å™¨ä¸­çš„ä¸€ä¸ªå‘½ä»¤</td>
<td style="text-align:left">æ‰§è¡Œå®¹å™¨ä¸­çš„ä¸€ä¸ªå‘½ä»¤</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">cp</td>
<td style="text-align:left">å¤åˆ¶</td>
<td style="text-align:left">åœ¨Podå†…å¤–å¤åˆ¶æ–‡ä»¶</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">rollout</td>
<td style="text-align:left">é¦–æ¬¡å±•ç¤º</td>
<td style="text-align:left">ç®¡ç†èµ„æºçš„å‘å¸ƒ</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">scale</td>
<td style="text-align:left">è§„æ¨¡</td>
<td style="text-align:left">æ‰©(ç¼©)å®¹Podçš„æ•°é‡</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">autoscale</td>
<td style="text-align:left">è‡ªåŠ¨è°ƒæ•´</td>
<td style="text-align:left">è‡ªåŠ¨è°ƒæ•´Podçš„æ•°é‡</td>
</tr>
<tr>
<td style="text-align:left">é«˜çº§å‘½ä»¤</td>
<td style="text-align:left">apply</td>
<td style="text-align:left">rc</td>
<td style="text-align:left">é€šè¿‡æ–‡ä»¶å¯¹èµ„æºè¿›è¡Œé…ç½®</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">label</td>
<td style="text-align:left">æ ‡ç­¾</td>
<td style="text-align:left">æ›´æ–°èµ„æºä¸Šçš„æ ‡ç­¾</td>
</tr>
<tr>
<td style="text-align:left">å…¶ä»–å‘½ä»¤</td>
<td style="text-align:left">cluster-info</td>
<td style="text-align:left">é›†ç¾¤ä¿¡æ¯</td>
<td style="text-align:left">æ˜¾ç¤ºé›†ç¾¤ä¿¡æ¯</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">version</td>
<td style="text-align:left">ç‰ˆæœ¬</td>
<td style="text-align:left">æ˜¾ç¤ºå½“å‰Serverå’ŒClientçš„ç‰ˆæœ¬</td>
</tr>
</tbody>
</table>
<p>ä¸‹é¢ä»¥ä¸€ä¸ªnamespace / podçš„åˆ›å»ºå’Œåˆ é™¤ç®€å•æ¼”ç¤ºä¸‹å‘½ä»¤çš„ä½¿ç”¨ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºä¸€ä¸ªnamespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create namespace dev</span>
</span></span><span style="display:flex;"><span>namespace/dev created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è·å–namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get ns</span>
</span></span><span style="display:flex;"><span>NAME              STATUS   AGE
</span></span><span style="display:flex;"><span>default           Active   21h
</span></span><span style="display:flex;"><span>dev               Active   21s
</span></span><span style="display:flex;"><span>kube-node-lease   Active   21h
</span></span><span style="display:flex;"><span>kube-public       Active   21h
</span></span><span style="display:flex;"><span>kube-system       Active   21h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åœ¨æ­¤namespaceä¸‹åˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªnginxçš„Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl run pod --image=nginx:latest -n dev</span>
</span></span><span style="display:flex;"><span>kubectl run --generator<span style="color:#f92672">=</span>deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator<span style="color:#f92672">=</span>run-pod/v1 or kubectl create instead.
</span></span><span style="display:flex;"><span>deployment.apps/pod created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹æ–°åˆ›å»ºçš„pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n dev</span>
</span></span><span style="display:flex;"><span>NAME  READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod   1/1     Running   <span style="color:#ae81ff">0</span>          21s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ é™¤æŒ‡å®šçš„pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete pod pod-864f9875b9-pcw7x</span>
</span></span><span style="display:flex;"><span>pod <span style="color:#e6db74">&#34;pod&#34;</span> deleted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ é™¤æŒ‡å®šçš„namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete ns dev</span>
</span></span><span style="display:flex;"><span>namespace <span style="color:#e6db74">&#34;dev&#34;</span> deleted
</span></span></code></pre></div><h3 id="332-å‘½ä»¤å¼å¯¹è±¡é…ç½®">3.3.2 å‘½ä»¤å¼å¯¹è±¡é…ç½®<a hidden class="anchor" aria-hidden="true" href="#332-å‘½ä»¤å¼å¯¹è±¡é…ç½®">#</a></h3>
<p>å‘½ä»¤å¼å¯¹è±¡é…ç½®å°±æ˜¯ä½¿ç”¨å‘½ä»¤é…åˆé…ç½®æ–‡ä»¶ä¸€èµ·æ¥æ“ä½œkubernetesèµ„æºã€‚</p>
<p>1ï¼‰ åˆ›å»ºä¸€ä¸ªnginxpod.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginxpod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-containers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:latest</span>
</span></span></code></pre></div><p>2ï¼‰æ‰§è¡Œcreateå‘½ä»¤ï¼Œåˆ›å»ºèµ„æºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>[root@master ~]<span style="color:#75715e"># kubectl create -f nginxpod.yaml</span>
</span></span><span style="display:flex;"><span>namespace/dev created
</span></span><span style="display:flex;"><span>pod/nginxpod created
</span></span></code></pre></div><p>æ­¤æ—¶å‘ç°åˆ›å»ºäº†ä¸¤ä¸ªèµ„æºå¯¹è±¡ï¼Œåˆ†åˆ«æ˜¯namespaceå’Œpod</p>
<p>3ï¼‰æ‰§è¡Œgetå‘½ä»¤ï¼ŒæŸ¥çœ‹èµ„æºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e">#  kubectl get -f nginxpod.yaml</span>
</span></span><span style="display:flex;"><span>NAME            STATUS   AGE
</span></span><span style="display:flex;"><span>namespace/dev   Active   18s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME            READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/nginxpod    1/1     Running   <span style="color:#ae81ff">0</span>          17s
</span></span></code></pre></div><p>è¿™æ ·å°±æ˜¾ç¤ºäº†ä¸¤ä¸ªèµ„æºå¯¹è±¡çš„ä¿¡æ¯</p>
<p>4ï¼‰æ‰§è¡Œdeleteå‘½ä»¤ï¼Œåˆ é™¤èµ„æºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete -f nginxpod.yaml</span>
</span></span><span style="display:flex;"><span>namespace <span style="color:#e6db74">&#34;dev&#34;</span> deleted
</span></span><span style="display:flex;"><span>pod <span style="color:#e6db74">&#34;nginxpod&#34;</span> deleted
</span></span></code></pre></div><p>æ­¤æ—¶å‘ç°ä¸¤ä¸ªèµ„æºå¯¹è±¡è¢«åˆ é™¤äº†</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>æ€»ç»“:
</span></span><span style="display:flex;"><span>    å‘½ä»¤å¼å¯¹è±¡é…ç½®çš„æ–¹å¼æ“ä½œèµ„æºï¼Œå¯ä»¥ç®€å•çš„è®¤ä¸ºï¼šå‘½ä»¤  +  yamlé…ç½®æ–‡ä»¶ï¼ˆé‡Œé¢æ˜¯å‘½ä»¤éœ€è¦çš„å„ç§å‚æ•°ï¼‰
</span></span></code></pre></div><h3 id="333-å£°æ˜å¼å¯¹è±¡é…ç½®">3.3.3 å£°æ˜å¼å¯¹è±¡é…ç½®<a hidden class="anchor" aria-hidden="true" href="#333-å£°æ˜å¼å¯¹è±¡é…ç½®">#</a></h3>
<p>å£°æ˜å¼å¯¹è±¡é…ç½®è·Ÿå‘½ä»¤å¼å¯¹è±¡é…ç½®å¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯å®ƒåªæœ‰ä¸€ä¸ªå‘½ä»¤applyã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># é¦–å…ˆæ‰§è¡Œä¸€æ¬¡kubectl apply -f yamlæ–‡ä»¶ï¼Œå‘ç°åˆ›å»ºäº†èµ„æº</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e">#  kubectl apply -f nginxpod.yaml</span>
</span></span><span style="display:flex;"><span>namespace/dev created
</span></span><span style="display:flex;"><span>pod/nginxpod created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å†æ¬¡æ‰§è¡Œä¸€æ¬¡kubectl apply -f yamlæ–‡ä»¶ï¼Œå‘ç°è¯´èµ„æºæ²¡æœ‰å˜åŠ¨</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e">#  kubectl apply -f nginxpod.yaml</span>
</span></span><span style="display:flex;"><span>namespace/dev unchanged
</span></span><span style="display:flex;"><span>pod/nginxpod unchanged
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">æ€»ç»“:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">å…¶å®å£°æ˜å¼å¯¹è±¡é…ç½®å°±æ˜¯ä½¿ç”¨</span>apply<span style="color:#960050;background-color:#1e0010">æè¿°ä¸€ä¸ªèµ„æºæœ€ç»ˆçš„çŠ¶æ€ï¼ˆåœ¨</span>yaml<span style="color:#960050;background-color:#1e0010">ä¸­å®šä¹‰çŠ¶æ€ï¼‰</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">ä½¿ç”¨</span>apply<span style="color:#960050;background-color:#1e0010">æ“ä½œèµ„æºï¼š</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">å¦‚æœèµ„æºä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºï¼Œç›¸å½“äº</span> kubectl create
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">å¦‚æœèµ„æºå·²å­˜åœ¨ï¼Œå°±æ›´æ–°ï¼Œç›¸å½“äº</span> kubectl patch
</span></span></code></pre></div><blockquote>
<p>æ‰©å±•ï¼škubectlå¯ä»¥åœ¨nodeèŠ‚ç‚¹ä¸Šè¿è¡Œå— ?</p>
</blockquote>
<p>kubectlçš„è¿è¡Œæ˜¯éœ€è¦è¿›è¡Œé…ç½®çš„ï¼Œå®ƒçš„é…ç½®æ–‡ä»¶æ˜¯$HOME/.kubeï¼Œå¦‚æœæƒ³è¦åœ¨nodeèŠ‚ç‚¹è¿è¡Œæ­¤å‘½ä»¤ï¼Œéœ€è¦å°†masterä¸Šçš„.kubeæ–‡ä»¶å¤åˆ¶åˆ°nodeèŠ‚ç‚¹ä¸Šï¼Œå³åœ¨masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œä¸‹é¢æ“ä½œï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>scp  -r  HOME/.kube   node1: HOME/
</span></span></code></pre></div><blockquote>
<p>ä½¿ç”¨æ¨è: ä¸‰ç§æ–¹å¼åº”è¯¥æ€ä¹ˆç”¨ ?</p>
</blockquote>
<p>åˆ›å»º/æ›´æ–°èµ„æº ä½¿ç”¨å£°æ˜å¼å¯¹è±¡é…ç½® kubectl apply -f XXX.yaml</p>
<p>åˆ é™¤èµ„æº ä½¿ç”¨å‘½ä»¤å¼å¯¹è±¡é…ç½® kubectl delete -f XXX.yaml</p>
<p>æŸ¥è¯¢èµ„æº ä½¿ç”¨å‘½ä»¤å¼å¯¹è±¡ç®¡ç† kubectl get(describe) èµ„æºåç§°</p>
<h3 id="4-å®æˆ˜å…¥é—¨">4. å®æˆ˜å…¥é—¨<a hidden class="anchor" aria-hidden="true" href="#4-å®æˆ˜å…¥é—¨">#</a></h3>
<p>æœ¬ç« èŠ‚å°†ä»‹ç»å¦‚ä½•åœ¨kubernetesé›†ç¾¤ä¸­éƒ¨ç½²ä¸€ä¸ªnginxæœåŠ¡ï¼Œå¹¶ä¸”èƒ½å¤Ÿå¯¹å…¶è¿›è¡Œè®¿é—®ã€‚</p>
<h4 id="41-namespace">4.1 Namespace<a hidden class="anchor" aria-hidden="true" href="#41-namespace">#</a></h4>
<p>Namespaceæ˜¯kubernetesç³»ç»Ÿä¸­çš„ä¸€ç§éå¸¸é‡è¦èµ„æºï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ç”¨æ¥å®ç°å¤šå¥—ç¯å¢ƒçš„èµ„æºéš”ç¦»æˆ–è€…å¤šç§Ÿæˆ·çš„èµ„æºéš”ç¦»ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œkubernetesé›†ç¾¤ä¸­çš„æ‰€æœ‰çš„Podéƒ½æ˜¯å¯ä»¥ç›¸äº’è®¿é—®çš„ã€‚ä½†æ˜¯åœ¨å®é™…ä¸­ï¼Œå¯èƒ½ä¸æƒ³è®©ä¸¤ä¸ªPodä¹‹é—´è¿›è¡Œäº’ç›¸çš„è®¿é—®ï¼Œé‚£æ­¤æ—¶å°±å¯ä»¥å°†ä¸¤ä¸ªPodåˆ’åˆ†åˆ°ä¸åŒçš„namespaceä¸‹ã€‚kubernetesé€šè¿‡å°†é›†ç¾¤å†…éƒ¨çš„èµ„æºåˆ†é…åˆ°ä¸åŒçš„Namespaceä¸­ï¼Œå¯ä»¥å½¢æˆé€»è¾‘ä¸Šçš„&quot;ç»„&quot;ï¼Œä»¥æ–¹ä¾¿ä¸åŒçš„ç»„çš„èµ„æºè¿›è¡Œéš”ç¦»ä½¿ç”¨å’Œç®¡ç†ã€‚</p>
<p>å¯ä»¥é€šè¿‡kubernetesçš„æˆæƒæœºåˆ¶ï¼Œå°†ä¸åŒçš„namespaceäº¤ç»™ä¸åŒç§Ÿæˆ·è¿›è¡Œç®¡ç†ï¼Œè¿™æ ·å°±å®ç°äº†å¤šç§Ÿæˆ·çš„èµ„æºéš”ç¦»ã€‚æ­¤æ—¶è¿˜èƒ½ç»“åˆkubernetesçš„èµ„æºé…é¢æœºåˆ¶ï¼Œé™å®šä¸åŒç§Ÿæˆ·èƒ½å ç”¨çš„èµ„æºï¼Œä¾‹å¦‚CPUä½¿ç”¨é‡ã€å†…å­˜ä½¿ç”¨é‡ç­‰ç­‰ï¼Œæ¥å®ç°ç§Ÿæˆ·å¯ç”¨èµ„æºçš„ç®¡ç†ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200407100850484.png" alt="image-20200407100850484"  />
</p>
<p>kubernetesåœ¨é›†ç¾¤å¯åŠ¨ä¹‹åï¼Œä¼šé»˜è®¤åˆ›å»ºå‡ ä¸ªnamespace</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl  get namespace</span>
</span></span><span style="display:flex;"><span>NAME              STATUS   AGE
</span></span><span style="display:flex;"><span>default           Active   45h     <span style="color:#75715e">#  æ‰€æœ‰æœªæŒ‡å®šNamespaceçš„å¯¹è±¡éƒ½ä¼šè¢«åˆ†é…åœ¨defaultå‘½åç©ºé—´</span>
</span></span><span style="display:flex;"><span>kube-node-lease   Active   45h     <span style="color:#75715e">#  é›†ç¾¤èŠ‚ç‚¹ä¹‹é—´çš„å¿ƒè·³ç»´æŠ¤ï¼Œv1.13å¼€å§‹å¼•å…¥</span>
</span></span><span style="display:flex;"><span>kube-public       Active   45h     <span style="color:#75715e">#  æ­¤å‘½åç©ºé—´ä¸‹çš„èµ„æºå¯ä»¥è¢«æ‰€æœ‰äººè®¿é—®ï¼ˆåŒ…æ‹¬æœªè®¤è¯ç”¨æˆ·ï¼‰</span>
</span></span><span style="display:flex;"><span>kube-system       Active   45h     <span style="color:#75715e">#  æ‰€æœ‰ç”±Kubernetesç³»ç»Ÿåˆ›å»ºçš„èµ„æºéƒ½å¤„äºè¿™ä¸ªå‘½åç©ºé—´</span>
</span></span></code></pre></div><p>ä¸‹é¢æ¥çœ‹namespaceèµ„æºçš„å…·ä½“æ“ä½œï¼š</p>
<h5 id="411-æŸ¥çœ‹">4.1.1 æŸ¥çœ‹<a hidden class="anchor" aria-hidden="true" href="#411-æŸ¥çœ‹">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 1 æŸ¥çœ‹æ‰€æœ‰çš„ns  å‘½ä»¤ï¼škubectl get ns</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get ns</span>
</span></span><span style="display:flex;"><span>NAME              STATUS   AGE
</span></span><span style="display:flex;"><span>default           Active   45h
</span></span><span style="display:flex;"><span>kube-node-lease   Active   45h
</span></span><span style="display:flex;"><span>kube-public       Active   45h     
</span></span><span style="display:flex;"><span>kube-system       Active   45h     
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2 æŸ¥çœ‹æŒ‡å®šçš„ns   å‘½ä»¤ï¼škubectl get ns nsåç§°</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get ns default</span>
</span></span><span style="display:flex;"><span>NAME      STATUS   AGE
</span></span><span style="display:flex;"><span>default   Active   45h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3 æŒ‡å®šè¾“å‡ºæ ¼å¼  å‘½ä»¤ï¼škubectl get ns nsåç§°  -o æ ¼å¼å‚æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubernetesæ”¯æŒçš„æ ¼å¼æœ‰å¾ˆå¤šï¼Œæ¯”è¾ƒå¸¸è§çš„æ˜¯wideã€jsonã€yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get ns default -o yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Namespace
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  creationTimestamp: <span style="color:#e6db74">&#34;2021-05-08T04:44:16Z&#34;</span>
</span></span><span style="display:flex;"><span>  name: default
</span></span><span style="display:flex;"><span>  resourceVersion: <span style="color:#e6db74">&#34;151&#34;</span>
</span></span><span style="display:flex;"><span>  selfLink: /api/v1/namespaces/default
</span></span><span style="display:flex;"><span>  uid: 7405f73a-e486-43d4-9db6-145f1409f090
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  finalizers:
</span></span><span style="display:flex;"><span>  - kubernetes
</span></span><span style="display:flex;"><span>status:
</span></span><span style="display:flex;"><span>  phase: Active
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4 æŸ¥çœ‹nsè¯¦æƒ…  å‘½ä»¤ï¼škubectl describe ns nsåç§°</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe ns default</span>
</span></span><span style="display:flex;"><span>Name:         default
</span></span><span style="display:flex;"><span>Labels:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex;"><span>Status:       Active  <span style="color:#75715e"># Active å‘½åç©ºé—´æ­£åœ¨ä½¿ç”¨ä¸­  Terminating æ­£åœ¨åˆ é™¤å‘½åç©ºé—´</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ResourceQuota é’ˆå¯¹namespaceåšçš„èµ„æºé™åˆ¶</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># LimitRangeé’ˆå¯¹namespaceä¸­çš„æ¯ä¸ªç»„ä»¶åšçš„èµ„æºé™åˆ¶</span>
</span></span><span style="display:flex;"><span>No resource quota.
</span></span><span style="display:flex;"><span>No LimitRange resource.
</span></span></code></pre></div><h5 id="412-åˆ›å»º">4.1.2 åˆ›å»º<a hidden class="anchor" aria-hidden="true" href="#412-åˆ›å»º">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºnamespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create ns dev</span>
</span></span><span style="display:flex;"><span>namespace/dev created
</span></span></code></pre></div><h5 id="413-åˆ é™¤">4.1.3 åˆ é™¤<a hidden class="anchor" aria-hidden="true" href="#413-åˆ é™¤">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ é™¤namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete ns dev</span>
</span></span><span style="display:flex;"><span>namespace <span style="color:#e6db74">&#34;dev&#34;</span> deleted
</span></span></code></pre></div><h5 id="414-é…ç½®æ–¹å¼">4.1.4 é…ç½®æ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#414-é…ç½®æ–¹å¼">#</a></h5>
<p>é¦–å…ˆå‡†å¤‡ä¸€ä¸ªyamlæ–‡ä»¶ï¼šns-dev.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dev</span>
</span></span></code></pre></div><p>ç„¶åå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„åˆ›å»ºå’Œåˆ é™¤å‘½ä»¤äº†ï¼š</p>
<p>åˆ›å»ºï¼škubectl create -f ns-dev.yaml</p>
<p>åˆ é™¤ï¼škubectl delete -f ns-dev.yaml</p>
<h4 id="42-pod">4.2 Pod<a hidden class="anchor" aria-hidden="true" href="#42-pod">#</a></h4>
<p>Podæ˜¯kubernetesé›†ç¾¤è¿›è¡Œç®¡ç†çš„æœ€å°å•å…ƒï¼Œç¨‹åºè¦è¿è¡Œå¿…é¡»éƒ¨ç½²åœ¨å®¹å™¨ä¸­ï¼Œè€Œå®¹å™¨å¿…é¡»å­˜åœ¨äºPodä¸­ã€‚</p>
<p>Podå¯ä»¥è®¤ä¸ºæ˜¯å®¹å™¨çš„å°è£…ï¼Œä¸€ä¸ªPodä¸­å¯ä»¥å­˜åœ¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200407121501907.png" alt="image-20200407121501907"  />
</p>
<p>kubernetesåœ¨é›†ç¾¤å¯åŠ¨ä¹‹åï¼Œé›†ç¾¤ä¸­çš„å„ä¸ªç»„ä»¶ä¹Ÿéƒ½æ˜¯ä»¥Podæ–¹å¼è¿è¡Œçš„ã€‚å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥çœ‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n kube-system</span>
</span></span><span style="display:flex;"><span>NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>kube-system   coredns-6955765f44-68g6v         1/1     Running   <span style="color:#ae81ff">0</span>          2d1h
</span></span><span style="display:flex;"><span>kube-system   coredns-6955765f44-cs5r8         1/1     Running   <span style="color:#ae81ff">0</span>          2d1h
</span></span><span style="display:flex;"><span>kube-system   etcd-master                      1/1     Running   <span style="color:#ae81ff">0</span>          2d1h
</span></span><span style="display:flex;"><span>kube-system   kube-apiserver-master            1/1     Running   <span style="color:#ae81ff">0</span>          2d1h
</span></span><span style="display:flex;"><span>kube-system   kube-controller-manager-master   1/1     Running   <span style="color:#ae81ff">0</span>          2d1h
</span></span><span style="display:flex;"><span>kube-system   kube-flannel-ds-amd64-47r25      1/1     Running   <span style="color:#ae81ff">0</span>          2d1h
</span></span><span style="display:flex;"><span>kube-system   kube-flannel-ds-amd64-ls5lh      1/1     Running   <span style="color:#ae81ff">0</span>          2d1h
</span></span><span style="display:flex;"><span>kube-system   kube-proxy-685tk                 1/1     Running   <span style="color:#ae81ff">0</span>          2d1h
</span></span><span style="display:flex;"><span>kube-system   kube-proxy-87spt                 1/1     Running   <span style="color:#ae81ff">0</span>          2d1h
</span></span><span style="display:flex;"><span>kube-system   kube-scheduler-master            1/1     Running   <span style="color:#ae81ff">0</span>          2d1h
</span></span></code></pre></div><h5 id="421-åˆ›å»ºå¹¶è¿è¡Œ">4.2.1 åˆ›å»ºå¹¶è¿è¡Œ<a hidden class="anchor" aria-hidden="true" href="#421-åˆ›å»ºå¹¶è¿è¡Œ">#</a></h5>
<p>kubernetesæ²¡æœ‰æä¾›å•ç‹¬è¿è¡ŒPodçš„å‘½ä»¤ï¼Œéƒ½æ˜¯é€šè¿‡Podæ§åˆ¶å™¨æ¥å®ç°çš„</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># å‘½ä»¤æ ¼å¼ï¼š kubectl run (podæ§åˆ¶å™¨åç§°) [å‚æ•°] </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --image  æŒ‡å®šPodçš„é•œåƒ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --port   æŒ‡å®šç«¯å£</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --namespace  æŒ‡å®šnamespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl run nginx --image=nginx:latest --port=80 --namespace dev </span>
</span></span><span style="display:flex;"><span>deployment.apps/nginx created
</span></span></code></pre></div><h5 id="422-æŸ¥çœ‹podä¿¡æ¯">4.2.2 æŸ¥çœ‹podä¿¡æ¯<a hidden class="anchor" aria-hidden="true" href="#422-æŸ¥çœ‹podä¿¡æ¯">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹PodåŸºæœ¬ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME    READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>nginx   1/1     Running   <span style="color:#ae81ff">0</span>          43s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹Podçš„è¯¦ç»†ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe pod nginx -n dev</span>
</span></span><span style="display:flex;"><span>Name:         nginx
</span></span><span style="display:flex;"><span>Namespace:    dev
</span></span><span style="display:flex;"><span>Priority:     <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Node:         node1/192.168.5.4
</span></span><span style="display:flex;"><span>Start Time:   Wed, <span style="color:#ae81ff">08</span> May <span style="color:#ae81ff">2021</span> 09:29:24 +0800
</span></span><span style="display:flex;"><span>Labels:       pod-template-hash<span style="color:#f92672">=</span>5ff7956ff6
</span></span><span style="display:flex;"><span>              run<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex;"><span>Status:       Running
</span></span><span style="display:flex;"><span>IP:           10.244.1.23
</span></span><span style="display:flex;"><span>IPs:
</span></span><span style="display:flex;"><span>  IP:           10.244.1.23
</span></span><span style="display:flex;"><span>Controlled By:  ReplicaSet/nginx
</span></span><span style="display:flex;"><span>Containers:
</span></span><span style="display:flex;"><span>  nginx:
</span></span><span style="display:flex;"><span>    Container ID:   docker:/4c62b8c0648d2512380f4ffa5da2c99d16e05634979973449c98e9b829f6253c
</span></span><span style="display:flex;"><span>    Image:          nginx:latest
</span></span><span style="display:flex;"><span>    Image ID:       docker-pullable:/nginx@sha256:485b610fefec7ff6c463ced9623314a04ed67e3945b9c08d7e53a47f6d108dc7
</span></span><span style="display:flex;"><span>    Port:           80/TCP
</span></span><span style="display:flex;"><span>    Host Port:      0/TCP
</span></span><span style="display:flex;"><span>    State:          Running
</span></span><span style="display:flex;"><span>      Started:      Wed, <span style="color:#ae81ff">08</span> May <span style="color:#ae81ff">2021</span> 09:30:01 +0800
</span></span><span style="display:flex;"><span>    Ready:          True
</span></span><span style="display:flex;"><span>    Restart Count:  <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    Environment:    &lt;none&gt;
</span></span><span style="display:flex;"><span>    Mounts:
</span></span><span style="display:flex;"><span>      /var/run/secrets/kubernetes.io/serviceaccount from default-token-hwvvw <span style="color:#f92672">(</span>ro<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Conditions:
</span></span><span style="display:flex;"><span>  Type              Status
</span></span><span style="display:flex;"><span>  Initialized       True
</span></span><span style="display:flex;"><span>  Ready             True
</span></span><span style="display:flex;"><span>  ContainersReady   True
</span></span><span style="display:flex;"><span>  PodScheduled      True
</span></span><span style="display:flex;"><span>Volumes:
</span></span><span style="display:flex;"><span>  default-token-hwvvw:
</span></span><span style="display:flex;"><span>    Type:        Secret <span style="color:#f92672">(</span>a volume populated by a Secret<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    SecretName:  default-token-hwvvw
</span></span><span style="display:flex;"><span>    Optional:    false
</span></span><span style="display:flex;"><span>QoS Class:       BestEffort
</span></span><span style="display:flex;"><span>Node-Selectors:  &lt;none&gt;
</span></span><span style="display:flex;"><span>Tolerations:     node.kubernetes.io/not-ready:NoExecute <span style="color:#66d9ef">for</span> 300s
</span></span><span style="display:flex;"><span>                 node.kubernetes.io/unreachable:NoExecute <span style="color:#66d9ef">for</span> 300s
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type    Reason     Age        From               Message
</span></span><span style="display:flex;"><span>  ----    ------     ----       ----               -------
</span></span><span style="display:flex;"><span>  Normal  Scheduled  &lt;unknown&gt;  default-scheduler  Successfully assigned dev/nginx-5ff7956ff6-fg2db to node1
</span></span><span style="display:flex;"><span>  Normal  Pulling    4m11s      kubelet, node1     Pulling image <span style="color:#e6db74">&#34;nginx:latest&#34;</span>
</span></span><span style="display:flex;"><span>  Normal  Pulled     3m36s      kubelet, node1     Successfully pulled image <span style="color:#e6db74">&#34;nginx:latest&#34;</span>
</span></span><span style="display:flex;"><span>  Normal  Created    3m36s      kubelet, node1     Created container nginx
</span></span><span style="display:flex;"><span>  Normal  Started    3m36s      kubelet, node1     Started container nginx
</span></span></code></pre></div><h5 id="423-è®¿é—®pod">4.2.3 è®¿é—®Pod<a hidden class="anchor" aria-hidden="true" href="#423-è®¿é—®pod">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># è·å–podIP</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME    READY   STATUS    RESTARTS   AGE    IP             NODE    ... 
</span></span><span style="display:flex;"><span>nginx   1/1     Running   <span style="color:#ae81ff">0</span>          190s   10.244.1.23   node1   ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#è®¿é—®POD</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># curl http:/10.244.1.23:80</span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE html&gt;
</span></span><span style="display:flex;"><span>&lt;html&gt;
</span></span><span style="display:flex;"><span>&lt;head&gt;
</span></span><span style="display:flex;"><span> &lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span style="display:flex;"><span>&lt;/head&gt;
</span></span><span style="display:flex;"><span>&lt;body&gt;
</span></span><span style="display:flex;"><span> &lt;p&gt;&lt;em&gt;Thank you <span style="color:#66d9ef">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span style="display:flex;"><span>&lt;/body&gt;
</span></span><span style="display:flex;"><span>&lt;/html&gt;
</span></span></code></pre></div><h5 id="424-åˆ é™¤æŒ‡å®špod">4.2.4 åˆ é™¤æŒ‡å®šPod<a hidden class="anchor" aria-hidden="true" href="#424-åˆ é™¤æŒ‡å®špod">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ é™¤æŒ‡å®šPod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete pod nginx -n dev</span>
</span></span><span style="display:flex;"><span>pod <span style="color:#e6db74">&#34;nginx&#34;</span> deleted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ­¤æ—¶ï¼Œæ˜¾ç¤ºåˆ é™¤PodæˆåŠŸï¼Œä½†æ˜¯å†æŸ¥è¯¢ï¼Œå‘ç°åˆæ–°äº§ç”Ÿäº†ä¸€ä¸ª </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME    READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>nginx   1/1     Running   <span style="color:#ae81ff">0</span>          21s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è¿™æ˜¯å› ä¸ºå½“å‰Podæ˜¯ç”±Podæ§åˆ¶å™¨åˆ›å»ºçš„ï¼Œæ§åˆ¶å™¨ä¼šç›‘æ§PodçŠ¶å†µï¼Œä¸€æ—¦å‘ç°Podæ­»äº¡ï¼Œä¼šç«‹å³é‡å»º</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ­¤æ—¶è¦æƒ³åˆ é™¤Podï¼Œå¿…é¡»åˆ é™¤Podæ§åˆ¶å™¨</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å…ˆæ¥æŸ¥è¯¢ä¸€ä¸‹å½“å‰namespaceä¸‹çš„Podæ§åˆ¶å™¨</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy -n  dev</span>
</span></span><span style="display:flex;"><span>NAME    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>nginx   1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           9m7s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¥ä¸‹æ¥ï¼Œåˆ é™¤æ­¤PodPodæ§åˆ¶å™¨</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete deploy nginx -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps <span style="color:#e6db74">&#34;nginx&#34;</span> deleted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¨ç­‰ç‰‡åˆ»ï¼Œå†æŸ¥è¯¢Podï¼Œå‘ç°Podè¢«åˆ é™¤äº†</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>No resources found in dev namespace.
</span></span></code></pre></div><h5 id="425-é…ç½®æ“ä½œ">4.2.5 é…ç½®æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#425-é…ç½®æ“ä½œ">#</a></h5>
<p>åˆ›å»ºä¸€ä¸ªpod-nginx.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span></code></pre></div><p>ç„¶åå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„åˆ›å»ºå’Œåˆ é™¤å‘½ä»¤äº†ï¼š</p>
<p>åˆ›å»ºï¼škubectl create -f pod-nginx.yaml</p>
<p>åˆ é™¤ï¼škubectl delete -f pod-nginx.yaml</p>
<h4 id="43-label">4.3 Label<a hidden class="anchor" aria-hidden="true" href="#43-label">#</a></h4>
<p>Labelæ˜¯kubernetesç³»ç»Ÿä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µã€‚å®ƒçš„ä½œç”¨å°±æ˜¯åœ¨èµ„æºä¸Šæ·»åŠ æ ‡è¯†ï¼Œç”¨æ¥å¯¹å®ƒä»¬è¿›è¡ŒåŒºåˆ†å’Œé€‰æ‹©ã€‚</p>
<p>Labelçš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ä¸€ä¸ªLabelä¼šä»¥key/valueé”®å€¼å¯¹çš„å½¢å¼é™„åŠ åˆ°å„ç§å¯¹è±¡ä¸Šï¼Œå¦‚Nodeã€Podã€Serviceç­‰ç­‰</li>
<li>ä¸€ä¸ªèµ„æºå¯¹è±¡å¯ä»¥å®šä¹‰ä»»æ„æ•°é‡çš„Label ï¼ŒåŒä¸€ä¸ªLabelä¹Ÿå¯ä»¥è¢«æ·»åŠ åˆ°ä»»æ„æ•°é‡çš„èµ„æºå¯¹è±¡ä¸Šå»</li>
<li>Labelé€šå¸¸åœ¨èµ„æºå¯¹è±¡å®šä¹‰æ—¶ç¡®å®šï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨å¯¹è±¡åˆ›å»ºååŠ¨æ€æ·»åŠ æˆ–è€…åˆ é™¤</li>
</ul>
<p>å¯ä»¥é€šè¿‡Labelå®ç°èµ„æºçš„å¤šç»´åº¦åˆ†ç»„ï¼Œä»¥ä¾¿çµæ´»ã€æ–¹ä¾¿åœ°è¿›è¡Œèµ„æºåˆ†é…ã€è°ƒåº¦ã€é…ç½®ã€éƒ¨ç½²ç­‰ç®¡ç†å·¥ä½œã€‚</p>
<blockquote>
<p>ä¸€äº›å¸¸ç”¨çš„Label ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ç‰ˆæœ¬æ ‡ç­¾ï¼š&ldquo;version&rdquo;:&ldquo;release&rdquo;, &ldquo;version&rdquo;:&ldquo;stable&rdquo;&hellip;&hellip;</li>
<li>ç¯å¢ƒæ ‡ç­¾ï¼š&ldquo;environment&rdquo;:&ldquo;dev&rdquo;ï¼Œ&ldquo;environment&rdquo;:&ldquo;test&rdquo;ï¼Œ&ldquo;environment&rdquo;:&ldquo;pro&rdquo;</li>
<li>æ¶æ„æ ‡ç­¾ï¼š&ldquo;tier&rdquo;:&ldquo;frontend&rdquo;ï¼Œ&ldquo;tier&rdquo;:&ldquo;backend&rdquo;</li>
</ul>
</blockquote>
<p>æ ‡ç­¾å®šä¹‰å®Œæ¯•ä¹‹åï¼Œè¿˜è¦è€ƒè™‘åˆ°æ ‡ç­¾çš„é€‰æ‹©ï¼Œè¿™å°±è¦ä½¿ç”¨åˆ°Label Selectorï¼Œå³ï¼š</p>
<p>Labelç”¨äºç»™æŸä¸ªèµ„æºå¯¹è±¡å®šä¹‰æ ‡è¯†</p>
<p>Label Selectorç”¨äºæŸ¥è¯¢å’Œç­›é€‰æ‹¥æœ‰æŸäº›æ ‡ç­¾çš„èµ„æºå¯¹è±¡</p>
<p>å½“å‰æœ‰ä¸¤ç§Label Selectorï¼š</p>
<ul>
<li>
<p>åŸºäºç­‰å¼çš„Label Selector</p>
<p>name = slave: é€‰æ‹©æ‰€æœ‰åŒ…å«Labelä¸­key=&ldquo;name&quot;ä¸”value=&ldquo;slave&quot;çš„å¯¹è±¡</p>
<p>env != production: é€‰æ‹©æ‰€æœ‰åŒ…æ‹¬Labelä¸­çš„key=&ldquo;env&quot;ä¸”valueä¸ç­‰äº&quot;production&quot;çš„å¯¹è±¡</p>
</li>
<li>
<p>åŸºäºé›†åˆçš„Label Selector</p>
<p>name in (master, slave): é€‰æ‹©æ‰€æœ‰åŒ…å«Labelä¸­çš„key=&ldquo;name&quot;ä¸”value=&ldquo;master&quot;æˆ–&quot;slave&quot;çš„å¯¹è±¡</p>
<p>name not in (frontend): é€‰æ‹©æ‰€æœ‰åŒ…å«Labelä¸­çš„key=&ldquo;name&quot;ä¸”valueä¸ç­‰äº&quot;frontend&quot;çš„å¯¹è±¡</p>
</li>
</ul>
<p>æ ‡ç­¾çš„é€‰æ‹©æ¡ä»¶å¯ä»¥ä½¿ç”¨å¤šä¸ªï¼Œæ­¤æ—¶å°†å¤šä¸ªLabel Selectorè¿›è¡Œç»„åˆï¼Œä½¿ç”¨é€—å·&rdquo;,&ldquo;è¿›è¡Œåˆ†éš”å³å¯ã€‚ä¾‹å¦‚ï¼š</p>
<p>name=slaveï¼Œenv!=production</p>
<p>name not in (frontend)ï¼Œenv!=production</p>
<h5 id="431-å‘½ä»¤æ–¹å¼">4.3.1 å‘½ä»¤æ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#431-å‘½ä»¤æ–¹å¼">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ä¸ºpodèµ„æºæ‰“æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl label pod nginx-pod version=1.0 -n dev</span>
</span></span><span style="display:flex;"><span>pod/nginx-pod labeled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸ºpodèµ„æºæ›´æ–°æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl label pod nginx-pod version=2.0 -n dev --overwrite</span>
</span></span><span style="display:flex;"><span>pod/nginx-pod labeled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod nginx-pod  -n dev --show-labels</span>
</span></span><span style="display:flex;"><span>NAME        READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span style="display:flex;"><span>nginx-pod   1/1     Running   <span style="color:#ae81ff">0</span>          10m   version<span style="color:#f92672">=</span>2.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç­›é€‰æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n dev -l version=2.0  --show-labels</span>
</span></span><span style="display:flex;"><span>NAME        READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span style="display:flex;"><span>nginx-pod   1/1     Running   <span style="color:#ae81ff">0</span>          17m   version<span style="color:#f92672">=</span>2.0
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n dev -l version!=2.0 --show-labels</span>
</span></span><span style="display:flex;"><span>No resources found in dev namespace.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#åˆ é™¤æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl label pod nginx-pod -n dev tier-</span>
</span></span><span style="display:flex;"><span>pod/nginx unlabeled
</span></span></code></pre></div><h5 id="432-é…ç½®æ–¹å¼">4.3.2 é…ç½®æ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#432-é…ç½®æ–¹å¼">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.0&#34;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>: <span style="color:#e6db74">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span></code></pre></div><p>ç„¶åå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„æ›´æ–°å‘½ä»¤äº†ï¼škubectl apply -f pod-nginx.yaml</p>
<h4 id="44-deployment">4.4 Deployment<a hidden class="anchor" aria-hidden="true" href="#44-deployment">#</a></h4>
<p>åœ¨kubernetesä¸­ï¼ŒPodæ˜¯æœ€å°çš„æ§åˆ¶å•å…ƒï¼Œä½†æ˜¯kuberneteså¾ˆå°‘ç›´æ¥æ§åˆ¶Podï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡Podæ§åˆ¶å™¨æ¥å®Œæˆçš„ã€‚Podæ§åˆ¶å™¨ç”¨äºpodçš„ç®¡ç†ï¼Œç¡®ä¿podèµ„æºç¬¦åˆé¢„æœŸçš„çŠ¶æ€ï¼Œå½“podçš„èµ„æºå‡ºç°æ•…éšœæ—¶ï¼Œä¼šå°è¯•è¿›è¡Œé‡å¯æˆ–é‡å»ºpodã€‚</p>
<p>åœ¨kubernetesä¸­Podæ§åˆ¶å™¨çš„ç§ç±»æœ‰å¾ˆå¤šï¼Œæœ¬ç« èŠ‚åªä»‹ç»ä¸€ç§ï¼šDeploymentã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200408193950807.png" alt="image-20200408193950807"  />
</p>
<h5 id="441-å‘½ä»¤æ“ä½œ">4.4.1 å‘½ä»¤æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#441-å‘½ä»¤æ“ä½œ">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># å‘½ä»¤æ ¼å¼: kubectl create deployment åç§°  [å‚æ•°] </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --image  æŒ‡å®špodçš„é•œåƒ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --port   æŒ‡å®šç«¯å£</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --replicas  æŒ‡å®šåˆ›å»ºpodæ•°é‡</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --namespace  æŒ‡å®šnamespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl run nginx --image=nginx:latest --port=80 --replicas=3 -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps/nginx created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹åˆ›å»ºçš„Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                     READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>nginx-5ff7956ff6-6k8cb   1/1     Running   <span style="color:#ae81ff">0</span>          19s
</span></span><span style="display:flex;"><span>nginx-5ff7956ff6-jxfjt   1/1     Running   <span style="color:#ae81ff">0</span>          19s
</span></span><span style="display:flex;"><span>nginx-5ff7956ff6-v6jqw   1/1     Running   <span style="color:#ae81ff">0</span>          19s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹deploymentçš„ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy -n dev</span>
</span></span><span style="display:flex;"><span>NAME    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>nginx   3/3     <span style="color:#ae81ff">3</span>            <span style="color:#ae81ff">3</span>           2m42s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># UP-TO-DATEï¼šæˆåŠŸå‡çº§çš„å‰¯æœ¬æ•°é‡</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AVAILABLEï¼šå¯ç”¨å‰¯æœ¬çš„æ•°é‡</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME    READY UP-TO-DATE  AVAILABLE   AGE     CONTAINERS   IMAGES              SELECTOR
</span></span><span style="display:flex;"><span>nginx   3/3     <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>           2m51s   nginx        nginx:latest        run<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹deploymentçš„è¯¦ç»†ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe deploy nginx -n dev</span>
</span></span><span style="display:flex;"><span>Name:                   nginx
</span></span><span style="display:flex;"><span>Namespace:              dev
</span></span><span style="display:flex;"><span>CreationTimestamp:      Wed, <span style="color:#ae81ff">08</span> May <span style="color:#ae81ff">2021</span> 11:14:14 +0800
</span></span><span style="display:flex;"><span>Labels:                 run<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>Annotations:            deployment.kubernetes.io/revision: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Selector:               run<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>Replicas:               <span style="color:#ae81ff">3</span> desired | <span style="color:#ae81ff">3</span> updated | <span style="color:#ae81ff">3</span> total | <span style="color:#ae81ff">3</span> available | <span style="color:#ae81ff">0</span> unavailable
</span></span><span style="display:flex;"><span>StrategyType:           RollingUpdate
</span></span><span style="display:flex;"><span>MinReadySeconds:        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>RollingUpdateStrategy:  25% max unavailable, 25% max è¿è§„è¯æ±‡
</span></span><span style="display:flex;"><span>Pod Template:
</span></span><span style="display:flex;"><span>  Labels:  run<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>  Containers:
</span></span><span style="display:flex;"><span>   nginx:
</span></span><span style="display:flex;"><span>    Image:        nginx:latest
</span></span><span style="display:flex;"><span>    Port:         80/TCP
</span></span><span style="display:flex;"><span>    Host Port:    0/TCP
</span></span><span style="display:flex;"><span>    Environment:  &lt;none&gt;
</span></span><span style="display:flex;"><span>    Mounts:       &lt;none&gt;
</span></span><span style="display:flex;"><span>  Volumes:        &lt;none&gt;
</span></span><span style="display:flex;"><span>Conditions:
</span></span><span style="display:flex;"><span>  Type           Status  Reason
</span></span><span style="display:flex;"><span>  ----           ------  ------
</span></span><span style="display:flex;"><span>  Available      True    MinimumReplicasAvailable
</span></span><span style="display:flex;"><span>  Progressing    True    NewReplicaSetAvailable
</span></span><span style="display:flex;"><span>OldReplicaSets:  &lt;none&gt;
</span></span><span style="display:flex;"><span>NewReplicaSet:   nginx-5ff7956ff6 <span style="color:#f92672">(</span>3/3 replicas created<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type    Reason             Age    From                   Message
</span></span><span style="display:flex;"><span>  ----    ------             ----   ----                   -------
</span></span><span style="display:flex;"><span>  Normal  ScalingReplicaSet  5m43s  deployment-controller  Scaled up replicaset nginx-5ff7956ff6 to <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ é™¤ </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete deploy nginx -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps <span style="color:#e6db74">&#34;nginx&#34;</span> deleted
</span></span></code></pre></div><h5 id="442-é…ç½®æ“ä½œ">4.4.2 é…ç½®æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#442-é…ç½®æ“ä½œ">#</a></h5>
<p>åˆ›å»ºä¸€ä¸ªdeploy-nginx.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">run</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">run</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:latest</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span></code></pre></div><p>ç„¶åå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„åˆ›å»ºå’Œåˆ é™¤å‘½ä»¤äº†ï¼š</p>
<p>åˆ›å»ºï¼škubectl create -f deploy-nginx.yaml</p>
<p>åˆ é™¤ï¼škubectl delete -f deploy-nginx.yaml</p>
<h4 id="45-service">4.5 Service<a hidden class="anchor" aria-hidden="true" href="#45-service">#</a></h4>
<p>é€šè¿‡ä¸ŠèŠ‚è¯¾çš„å­¦ä¹ ï¼Œå·²ç»èƒ½å¤Ÿåˆ©ç”¨Deploymentæ¥åˆ›å»ºä¸€ç»„Podæ¥æä¾›å…·æœ‰é«˜å¯ç”¨æ€§çš„æœåŠ¡ã€‚</p>
<p>è™½ç„¶æ¯ä¸ªPodéƒ½ä¼šåˆ†é…ä¸€ä¸ªå•ç‹¬çš„Pod IPï¼Œç„¶è€Œå´å­˜åœ¨å¦‚ä¸‹ä¸¤é—®é¢˜ï¼š</p>
<ul>
<li>Pod IP ä¼šéšç€Podçš„é‡å»ºäº§ç”Ÿå˜åŒ–</li>
<li>Pod IP ä»…ä»…æ˜¯é›†ç¾¤å†…å¯è§çš„è™šæ‹ŸIPï¼Œå¤–éƒ¨æ— æ³•è®¿é—®</li>
</ul>
<p>è¿™æ ·å¯¹äºè®¿é—®è¿™ä¸ªæœåŠ¡å¸¦æ¥äº†éš¾åº¦ã€‚å› æ­¤ï¼Œkubernetesè®¾è®¡äº†Serviceæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>Serviceå¯ä»¥çœ‹ä½œæ˜¯ä¸€ç»„åŒç±»Podå¯¹å¤–çš„è®¿é—®æ¥å£ã€‚å€ŸåŠ©Serviceï¼Œåº”ç”¨å¯ä»¥æ–¹ä¾¿åœ°å®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200408194716912.png" alt="image-20200408194716912"  />
</p>
<h5 id="451-åˆ›å»ºé›†ç¾¤å†…éƒ¨å¯è®¿é—®çš„service">4.5.1 åˆ›å»ºé›†ç¾¤å†…éƒ¨å¯è®¿é—®çš„Service<a hidden class="anchor" aria-hidden="true" href="#451-åˆ›å»ºé›†ç¾¤å†…éƒ¨å¯è®¿é—®çš„service">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># æš´éœ²Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl expose deploy nginx --name=svc-nginx1 --type=ClusterIP --port=80 --target-port=80 -n dev</span>
</span></span><span style="display:flex;"><span>service/svc-nginx1 exposed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc svc-nginx1 -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>   AGE     SELECTOR
</span></span><span style="display:flex;"><span>svc-nginx1   ClusterIP   10.109.179.231   &lt;none&gt;        80/TCP    3m51s   run<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è¿™é‡Œäº§ç”Ÿäº†ä¸€ä¸ªCLUSTER-IPï¼Œè¿™å°±æ˜¯serviceçš„IPï¼Œåœ¨Serviceçš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œè¿™ä¸ªåœ°å€æ˜¯ä¸ä¼šå˜åŠ¨çš„</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯ä»¥é€šè¿‡è¿™ä¸ªIPè®¿é—®å½“å‰serviceå¯¹åº”çš„POD</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># curl 10.109.179.231:80</span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE html&gt;
</span></span><span style="display:flex;"><span>&lt;html&gt;
</span></span><span style="display:flex;"><span>&lt;head&gt;
</span></span><span style="display:flex;"><span>&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span style="display:flex;"><span>&lt;/head&gt;
</span></span><span style="display:flex;"><span>&lt;body&gt;
</span></span><span style="display:flex;"><span>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span>&lt;/body&gt;
</span></span><span style="display:flex;"><span>&lt;/html&gt;
</span></span></code></pre></div><h5 id="452-åˆ›å»ºé›†ç¾¤å¤–éƒ¨ä¹Ÿå¯è®¿é—®çš„service">4.5.2 åˆ›å»ºé›†ç¾¤å¤–éƒ¨ä¹Ÿå¯è®¿é—®çš„Service<a hidden class="anchor" aria-hidden="true" href="#452-åˆ›å»ºé›†ç¾¤å¤–éƒ¨ä¹Ÿå¯è®¿é—®çš„service">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ä¸Šé¢åˆ›å»ºçš„Serviceçš„typeç±»å‹ä¸ºClusterIPï¼Œè¿™ä¸ªipåœ°å€åªç”¨é›†ç¾¤å†…éƒ¨å¯è®¿é—®</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¦‚æœéœ€è¦åˆ›å»ºå¤–éƒ¨ä¹Ÿå¯ä»¥è®¿é—®çš„Serviceï¼Œéœ€è¦ä¿®æ”¹typeä¸ºNodePort</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl expose deploy nginx --name=svc-nginx2 --type=NodePort --port=80 --target-port=80 -n dev</span>
</span></span><span style="display:flex;"><span>service/svc-nginx2 exposed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ­¤æ—¶æŸ¥çœ‹ï¼Œä¼šå‘ç°å‡ºç°äº†NodePortç±»å‹çš„Serviceï¼Œè€Œä¸”æœ‰ä¸€å¯¹Portï¼ˆ80:31928/TCï¼‰</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc  svc-nginx2  -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>        AGE    SELECTOR
</span></span><span style="display:flex;"><span>svc-nginx2    NodePort    10.100.94.0      &lt;none&gt;        80:31928/TCP   9s     run<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¥ä¸‹æ¥å°±å¯ä»¥é€šè¿‡é›†ç¾¤å¤–çš„ä¸»æœºè®¿é—® èŠ‚ç‚¹IP:31928è®¿é—®æœåŠ¡äº†</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¾‹å¦‚åœ¨çš„ç”µè„‘ä¸»æœºä¸Šé€šè¿‡æµè§ˆå™¨è®¿é—®ä¸‹é¢çš„åœ°å€</span>
</span></span><span style="display:flex;"><span>http:/192.168.90.100:31928/
</span></span></code></pre></div><h5 id="453-åˆ é™¤service">4.5.3 åˆ é™¤Service<a hidden class="anchor" aria-hidden="true" href="#453-åˆ é™¤service">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@master ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete svc svc-nginx-1 -n dev </span>
</span></span><span style="display:flex;"><span>service <span style="color:#e6db74">&#34;svc-nginx-1&#34;</span> deleted
</span></span></code></pre></div><h5 id="454-é…ç½®æ–¹å¼">4.5.4 é…ç½®æ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#454-é…ç½®æ–¹å¼">#</a></h5>
<p>åˆ›å»ºä¸€ä¸ªsvc-nginx.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">svc-nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">10.109.179.231</span> <span style="color:#75715e">#å›ºå®šsvcçš„å†…ç½‘ip</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">run</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span></code></pre></div><p>ç„¶åå°±å¯ä»¥æ‰§è¡Œå¯¹åº”çš„åˆ›å»ºå’Œåˆ é™¤å‘½ä»¤äº†ï¼š</p>
<p>åˆ›å»ºï¼škubectl create -f svc-nginx.yaml</p>
<p>åˆ é™¤ï¼škubectl delete -f svc-nginx.yaml</p>
<blockquote>
<p>å°ç»“</p>
<p>è‡³æ­¤ï¼Œå·²ç»æŒæ¡äº†Namespaceã€Podã€Deploymentã€Serviceèµ„æºçš„åŸºæœ¬æ“ä½œï¼Œæœ‰äº†è¿™äº›æ“ä½œï¼Œå°±å¯ä»¥åœ¨kubernetesé›†ç¾¤ä¸­å®ç°ä¸€ä¸ªæœåŠ¡çš„ç®€å•éƒ¨ç½²å’Œè®¿é—®äº†ï¼Œä½†æ˜¯å¦‚æœæƒ³è¦æ›´å¥½çš„ä½¿ç”¨kubernetesï¼Œå°±éœ€è¦æ·±å…¥å­¦ä¹ è¿™å‡ ç§èµ„æºçš„ç»†èŠ‚å’ŒåŸç†ã€‚</p>
</blockquote>
<h3 id="5-podè¯¦è§£">5. Podè¯¦è§£<a hidden class="anchor" aria-hidden="true" href="#5-podè¯¦è§£">#</a></h3>
<h4 id="51-podä»‹ç»">5.1 Podä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#51-podä»‹ç»">#</a></h4>
<h5 id="511-podç»“æ„">5.1.1 Podç»“æ„<a hidden class="anchor" aria-hidden="true" href="#511-podç»“æ„">#</a></h5>
<p><img loading="lazy" src="/kubernetes.images/image-20200407121501907-1626781151898.png" alt="image-20200407121501907"  />
</p>
<p>æ¯ä¸ªPodä¸­éƒ½å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ï¼Œè¿™äº›å®¹å™¨å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ul>
<li>
<p>ç”¨æˆ·ç¨‹åºæ‰€åœ¨çš„å®¹å™¨ï¼Œæ•°é‡å¯å¤šå¯å°‘</p>
</li>
<li>
<p>Pauseå®¹å™¨ï¼Œè¿™æ˜¯æ¯ä¸ªPodéƒ½ä¼šæœ‰çš„ä¸€ä¸ªæ ¹å®¹å™¨ï¼Œå®ƒçš„ä½œç”¨æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>
<p>å¯ä»¥ä»¥å®ƒä¸ºä¾æ®ï¼Œè¯„ä¼°æ•´ä¸ªPodçš„å¥åº·çŠ¶æ€</p>
</li>
<li>
<p>å¯ä»¥åœ¨æ ¹å®¹å™¨ä¸Šè®¾ç½®Ipåœ°å€ï¼Œå…¶å®ƒå®¹å™¨éƒ½æ­¤Ipï¼ˆPod IPï¼‰ï¼Œä»¥å®ç°Podå†…éƒ¨çš„ç½‘è·¯é€šä¿¡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>è¿™é‡Œæ˜¯Podå†…éƒ¨çš„é€šè®¯ï¼ŒPodçš„ä¹‹é—´çš„é€šè®¯é‡‡ç”¨è™šæ‹ŸäºŒå±‚ç½‘ç»œæŠ€æœ¯æ¥å®ç°ï¼Œæˆ‘ä»¬å½“å‰ç¯å¢ƒç”¨çš„æ˜¯Flannel
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
<h5 id="512-podå®šä¹‰">5.1.2 Podå®šä¹‰<a hidden class="anchor" aria-hidden="true" href="#512-podå®šä¹‰">#</a></h5>
<p>ä¸‹é¢æ˜¯Podçš„èµ„æºæ¸…å•ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>apiVersion: v1     <span style="color:#75715e">#å¿…é€‰ï¼Œç‰ˆæœ¬å·ï¼Œä¾‹å¦‚v1</span>
</span></span><span style="display:flex;"><span>kind: Pod       ã€€ <span style="color:#75715e">#å¿…é€‰ï¼Œèµ„æºç±»å‹ï¼Œä¾‹å¦‚ Pod</span>
</span></span><span style="display:flex;"><span>metadata:       ã€€ <span style="color:#75715e">#å¿…é€‰ï¼Œå…ƒæ•°æ®</span>
</span></span><span style="display:flex;"><span>  name: string     <span style="color:#75715e">#å¿…é€‰ï¼ŒPodåç§°</span>
</span></span><span style="display:flex;"><span>  namespace: string  <span style="color:#75715e">#Podæ‰€å±çš„å‘½åç©ºé—´,é»˜è®¤ä¸º&#34;default&#34;</span>
</span></span><span style="display:flex;"><span>  labels:       ã€€ã€€  <span style="color:#75715e">#è‡ªå®šä¹‰æ ‡ç­¾åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>    - name: string      ã€€          
</span></span><span style="display:flex;"><span>spec:  <span style="color:#75715e">#å¿…é€‰ï¼ŒPodä¸­å®¹å™¨çš„è¯¦ç»†å®šä¹‰</span>
</span></span><span style="display:flex;"><span>  containers:  <span style="color:#75715e">#å¿…é€‰ï¼ŒPodä¸­å®¹å™¨åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>  - name: string   <span style="color:#75715e">#å¿…é€‰ï¼Œå®¹å™¨åç§°</span>
</span></span><span style="display:flex;"><span>    image: string  <span style="color:#75715e">#å¿…é€‰ï¼Œå®¹å™¨çš„é•œåƒåç§°</span>
</span></span><span style="display:flex;"><span>    imagePullPolicy: <span style="color:#f92672">[</span> Always|Never|IfNotPresent <span style="color:#f92672">]</span>  <span style="color:#75715e">#è·å–é•œåƒçš„ç­–ç•¥ </span>
</span></span><span style="display:flex;"><span>    command: <span style="color:#f92672">[</span>string<span style="color:#f92672">]</span>   <span style="color:#75715e">#å®¹å™¨çš„å¯åŠ¨å‘½ä»¤åˆ—è¡¨ï¼Œå¦‚ä¸æŒ‡å®šï¼Œä½¿ç”¨æ‰“åŒ…æ—¶ä½¿ç”¨çš„å¯åŠ¨å‘½ä»¤</span>
</span></span><span style="display:flex;"><span>    args: <span style="color:#f92672">[</span>string<span style="color:#f92672">]</span>      <span style="color:#75715e">#å®¹å™¨çš„å¯åŠ¨å‘½ä»¤å‚æ•°åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>    workingDir: string  <span style="color:#75715e">#å®¹å™¨çš„å·¥ä½œç›®å½•</span>
</span></span><span style="display:flex;"><span>    volumeMounts:       <span style="color:#75715e">#æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨çš„å­˜å‚¨å·é…ç½®</span>
</span></span><span style="display:flex;"><span>    - name: string      <span style="color:#75715e">#å¼•ç”¨podå®šä¹‰çš„å…±äº«å­˜å‚¨å·çš„åç§°ï¼Œéœ€ç”¨volumes[]éƒ¨åˆ†å®šä¹‰çš„çš„å·å</span>
</span></span><span style="display:flex;"><span>      mountPath: string <span style="color:#75715e">#å­˜å‚¨å·åœ¨å®¹å™¨å†…mountçš„ç»å¯¹è·¯å¾„ï¼Œåº”å°‘äº512å­—ç¬¦</span>
</span></span><span style="display:flex;"><span>      readOnly: boolean <span style="color:#75715e">#æ˜¯å¦ä¸ºåªè¯»æ¨¡å¼</span>
</span></span><span style="display:flex;"><span>    ports: <span style="color:#75715e">#éœ€è¦æš´éœ²çš„ç«¯å£åº“å·åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>    - name: string        <span style="color:#75715e">#ç«¯å£çš„åç§°</span>
</span></span><span style="display:flex;"><span>      containerPort: int  <span style="color:#75715e">#å®¹å™¨éœ€è¦ç›‘å¬çš„ç«¯å£å·</span>
</span></span><span style="display:flex;"><span>      hostPort: int       <span style="color:#75715e">#å®¹å™¨æ‰€åœ¨ä¸»æœºéœ€è¦ç›‘å¬çš„ç«¯å£å·ï¼Œé»˜è®¤ä¸Containerç›¸åŒ</span>
</span></span><span style="display:flex;"><span>      protocol: string    <span style="color:#75715e">#ç«¯å£åè®®ï¼Œæ”¯æŒTCPå’ŒUDPï¼Œé»˜è®¤TCP</span>
</span></span><span style="display:flex;"><span>    env:   <span style="color:#75715e">#å®¹å™¨è¿è¡Œå‰éœ€è®¾ç½®çš„ç¯å¢ƒå˜é‡åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>    - name: string  <span style="color:#75715e">#ç¯å¢ƒå˜é‡åç§°</span>
</span></span><span style="display:flex;"><span>      value: string <span style="color:#75715e">#ç¯å¢ƒå˜é‡çš„å€¼</span>
</span></span><span style="display:flex;"><span>    resources: <span style="color:#75715e">#èµ„æºé™åˆ¶å’Œè¯·æ±‚çš„è®¾ç½®</span>
</span></span><span style="display:flex;"><span>      limits:  <span style="color:#75715e">#èµ„æºé™åˆ¶çš„è®¾ç½®</span>
</span></span><span style="display:flex;"><span>        cpu: string     <span style="color:#75715e">#Cpuçš„é™åˆ¶ï¼Œå•ä½ä¸ºcoreæ•°ï¼Œå°†ç”¨äºdocker run --cpu-shareså‚æ•°</span>
</span></span><span style="display:flex;"><span>        memory: string  <span style="color:#75715e">#å†…å­˜é™åˆ¶ï¼Œå•ä½å¯ä»¥ä¸ºMib/Gibï¼Œå°†ç”¨äºdocker run --memoryå‚æ•°</span>
</span></span><span style="display:flex;"><span>      requests: <span style="color:#75715e">#èµ„æºè¯·æ±‚çš„è®¾ç½®</span>
</span></span><span style="display:flex;"><span>        cpu: string    <span style="color:#75715e">#Cpuè¯·æ±‚ï¼Œå®¹å™¨å¯åŠ¨çš„åˆå§‹å¯ç”¨æ•°é‡</span>
</span></span><span style="display:flex;"><span>        memory: string <span style="color:#75715e">#å†…å­˜è¯·æ±‚,å®¹å™¨å¯åŠ¨çš„åˆå§‹å¯ç”¨æ•°é‡</span>
</span></span><span style="display:flex;"><span>    lifecycle: <span style="color:#75715e">#ç”Ÿå‘½å‘¨æœŸé’©å­</span>
</span></span><span style="display:flex;"><span>        postStart: <span style="color:#75715e">#å®¹å™¨å¯åŠ¨åç«‹å³æ‰§è¡Œæ­¤é’©å­,å¦‚æœæ‰§è¡Œå¤±è´¥,ä¼šæ ¹æ®é‡å¯ç­–ç•¥è¿›è¡Œé‡å¯</span>
</span></span><span style="display:flex;"><span>        preStop: <span style="color:#75715e">#å®¹å™¨ç»ˆæ­¢å‰æ‰§è¡Œæ­¤é’©å­,æ— è®ºç»“æœå¦‚ä½•,å®¹å™¨éƒ½ä¼šç»ˆæ­¢</span>
</span></span><span style="display:flex;"><span>    livenessProbe:  <span style="color:#75715e">#å¯¹Podå†…å„å®¹å™¨å¥åº·æ£€æŸ¥çš„è®¾ç½®ï¼Œå½“æ¢æµ‹æ— å“åº”å‡ æ¬¡åå°†è‡ªåŠ¨é‡å¯è¯¥å®¹å™¨</span>
</span></span><span style="display:flex;"><span>      exec:       ã€€ <span style="color:#75715e">#å¯¹Podå®¹å™¨å†…æ£€æŸ¥æ–¹å¼è®¾ç½®ä¸ºexecæ–¹å¼</span>
</span></span><span style="display:flex;"><span>        command: <span style="color:#f92672">[</span>string<span style="color:#f92672">]</span>  <span style="color:#75715e">#execæ–¹å¼éœ€è¦åˆ¶å®šçš„å‘½ä»¤æˆ–è„šæœ¬</span>
</span></span><span style="display:flex;"><span>      httpGet:       <span style="color:#75715e">#å¯¹Podå†…ä¸ªå®¹å™¨å¥åº·æ£€æŸ¥æ–¹æ³•è®¾ç½®ä¸ºHttpGetï¼Œéœ€è¦åˆ¶å®šPathã€port</span>
</span></span><span style="display:flex;"><span>        path: string
</span></span><span style="display:flex;"><span>        port: number
</span></span><span style="display:flex;"><span>        host: string
</span></span><span style="display:flex;"><span>        scheme: string
</span></span><span style="display:flex;"><span>        HttpHeaders:
</span></span><span style="display:flex;"><span>        - name: string
</span></span><span style="display:flex;"><span>          value: string
</span></span><span style="display:flex;"><span>      tcpSocket:     <span style="color:#75715e">#å¯¹Podå†…ä¸ªå®¹å™¨å¥åº·æ£€æŸ¥æ–¹å¼è®¾ç½®ä¸ºtcpSocketæ–¹å¼</span>
</span></span><span style="display:flex;"><span>         port: number
</span></span><span style="display:flex;"><span>       initialDelaySeconds: <span style="color:#ae81ff">0</span>       <span style="color:#75715e">#å®¹å™¨å¯åŠ¨å®Œæˆåé¦–æ¬¡æ¢æµ‹çš„æ—¶é—´ï¼Œå•ä½ä¸ºç§’</span>
</span></span><span style="display:flex;"><span>       timeoutSeconds: <span style="color:#ae81ff">0</span>    ã€€ã€€    <span style="color:#75715e">#å¯¹å®¹å™¨å¥åº·æ£€æŸ¥æ¢æµ‹ç­‰å¾…å“åº”çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ç§’ï¼Œé»˜è®¤1ç§’</span>
</span></span><span style="display:flex;"><span>       periodSeconds: <span style="color:#ae81ff">0</span>     ã€€ã€€    <span style="color:#75715e">#å¯¹å®¹å™¨ç›‘æ§æ£€æŸ¥çš„å®šæœŸæ¢æµ‹æ—¶é—´è®¾ç½®ï¼Œå•ä½ç§’ï¼Œé»˜è®¤10ç§’ä¸€æ¬¡</span>
</span></span><span style="display:flex;"><span>       successThreshold: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>       failureThreshold: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>       securityContext:
</span></span><span style="display:flex;"><span>         privileged: false
</span></span><span style="display:flex;"><span>  restartPolicy: <span style="color:#f92672">[</span>Always | Never | OnFailure<span style="color:#f92672">]</span>  <span style="color:#75715e">#Podçš„é‡å¯ç­–ç•¥</span>
</span></span><span style="display:flex;"><span>  nodeName: &lt;string&gt; <span style="color:#75715e">#è®¾ç½®NodeNameè¡¨ç¤ºå°†è¯¥Podè°ƒåº¦åˆ°æŒ‡å®šåˆ°åç§°çš„nodeèŠ‚ç‚¹ä¸Š</span>
</span></span><span style="display:flex;"><span>  nodeSelector: obeject <span style="color:#75715e">#è®¾ç½®NodeSelectorè¡¨ç¤ºå°†è¯¥Podè°ƒåº¦åˆ°åŒ…å«è¿™ä¸ªlabelçš„nodeä¸Š</span>
</span></span><span style="display:flex;"><span>  imagePullSecrets: <span style="color:#75715e">#Pullé•œåƒæ—¶ä½¿ç”¨çš„secretåç§°ï¼Œä»¥keyï¼šsecretkeyæ ¼å¼æŒ‡å®š</span>
</span></span><span style="display:flex;"><span>  - name: string
</span></span><span style="display:flex;"><span>  hostNetwork: false   <span style="color:#75715e">#æ˜¯å¦ä½¿ç”¨ä¸»æœºç½‘ç»œæ¨¡å¼ï¼Œé»˜è®¤ä¸ºfalseï¼Œå¦‚æœè®¾ç½®ä¸ºtrueï¼Œè¡¨ç¤ºä½¿ç”¨å®¿ä¸»æœºç½‘ç»œ</span>
</span></span><span style="display:flex;"><span>  volumes:   <span style="color:#75715e">#åœ¨è¯¥podä¸Šå®šä¹‰å…±äº«å­˜å‚¨å·åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>  - name: string    <span style="color:#75715e">#å…±äº«å­˜å‚¨å·åç§° ï¼ˆvolumesç±»å‹æœ‰å¾ˆå¤šç§ï¼‰</span>
</span></span><span style="display:flex;"><span>    emptyDir: <span style="color:#f92672">{}</span>       <span style="color:#75715e">#ç±»å‹ä¸ºemtyDirçš„å­˜å‚¨å·ï¼Œä¸PodåŒç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªä¸´æ—¶ç›®å½•ã€‚ä¸ºç©ºå€¼</span>
</span></span><span style="display:flex;"><span>    hostPath: string   <span style="color:#75715e">#ç±»å‹ä¸ºhostPathçš„å­˜å‚¨å·ï¼Œè¡¨ç¤ºæŒ‚è½½Podæ‰€åœ¨å®¿ä¸»æœºçš„ç›®å½•</span>
</span></span><span style="display:flex;"><span>      path: string      ã€€ã€€        <span style="color:#75715e">#Podæ‰€åœ¨å®¿ä¸»æœºçš„ç›®å½•ï¼Œå°†è¢«ç”¨äºåŒæœŸä¸­mountçš„ç›®å½•</span>
</span></span><span style="display:flex;"><span>    secret:       ã€€ã€€ã€€#ç±»å‹ä¸ºsecretçš„å­˜å‚¨å·ï¼ŒæŒ‚è½½é›†ç¾¤ä¸å®šä¹‰çš„secretå¯¹è±¡åˆ°å®¹å™¨å†…éƒ¨
</span></span><span style="display:flex;"><span>      scretname: string  
</span></span><span style="display:flex;"><span>      items:     
</span></span><span style="display:flex;"><span>      - key: string
</span></span><span style="display:flex;"><span>        path: string
</span></span><span style="display:flex;"><span>    configMap:         <span style="color:#75715e">#ç±»å‹ä¸ºconfigMapçš„å­˜å‚¨å·ï¼ŒæŒ‚è½½é¢„å®šä¹‰çš„configMapå¯¹è±¡åˆ°å®¹å™¨å†…éƒ¨</span>
</span></span><span style="display:flex;"><span>      name: string
</span></span><span style="display:flex;"><span>      items:
</span></span><span style="display:flex;"><span>      - key: string
</span></span><span style="display:flex;"><span>        path: string
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#å°æç¤ºï¼š</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   åœ¨è¿™é‡Œï¼Œå¯é€šè¿‡ä¸€ä¸ªå‘½ä»¤æ¥æŸ¥çœ‹æ¯ç§èµ„æºçš„å¯é…ç½®é¡¹</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   kubectl explain èµ„æºç±»å‹         æŸ¥çœ‹æŸç§èµ„æºå¯ä»¥é…ç½®çš„ä¸€çº§å±æ€§</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   kubectl explain èµ„æºç±»å‹.å±æ€§     æŸ¥çœ‹å±æ€§çš„å­å±æ€§</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl explain pod</span>
</span></span><span style="display:flex;"><span>KIND:     Pod
</span></span><span style="display:flex;"><span>VERSION:  v1
</span></span><span style="display:flex;"><span>FIELDS:
</span></span><span style="display:flex;"><span>   apiVersion   &lt;string&gt;
</span></span><span style="display:flex;"><span>   kind &lt;string&gt;
</span></span><span style="display:flex;"><span>   metadata     &lt;Object&gt;
</span></span><span style="display:flex;"><span>   spec &lt;Object&gt;
</span></span><span style="display:flex;"><span>   status       &lt;Object&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl explain pod.metadata</span>
</span></span><span style="display:flex;"><span>KIND:     Pod
</span></span><span style="display:flex;"><span>VERSION:  v1
</span></span><span style="display:flex;"><span>RESOURCE: metadata &lt;Object&gt;
</span></span><span style="display:flex;"><span>FIELDS:
</span></span><span style="display:flex;"><span>   annotations  &lt;map<span style="color:#f92672">[</span>string<span style="color:#f92672">]</span>string&gt;
</span></span><span style="display:flex;"><span>   clusterName  &lt;string&gt;
</span></span><span style="display:flex;"><span>   creationTimestamp    &lt;string&gt;
</span></span><span style="display:flex;"><span>   deletionGracePeriodSeconds   &lt;integer&gt;
</span></span><span style="display:flex;"><span>   deletionTimestamp    &lt;string&gt;
</span></span><span style="display:flex;"><span>   finalizers   &lt;<span style="color:#f92672">[]</span>string&gt;
</span></span><span style="display:flex;"><span>   generateName &lt;string&gt;
</span></span><span style="display:flex;"><span>   generation   &lt;integer&gt;
</span></span><span style="display:flex;"><span>   labels       &lt;map<span style="color:#f92672">[</span>string<span style="color:#f92672">]</span>string&gt;
</span></span><span style="display:flex;"><span>   managedFields        &lt;<span style="color:#f92672">[]</span>Object&gt;
</span></span><span style="display:flex;"><span>   name &lt;string&gt;
</span></span><span style="display:flex;"><span>   namespace    &lt;string&gt;
</span></span><span style="display:flex;"><span>   ownerReferences      &lt;<span style="color:#f92672">[]</span>Object&gt;
</span></span><span style="display:flex;"><span>   resourceVersion      &lt;string&gt;
</span></span><span style="display:flex;"><span>   selfLink     &lt;string&gt;
</span></span><span style="display:flex;"><span>   uid  &lt;string&gt;
</span></span></code></pre></div><p>åœ¨kubernetesä¸­åŸºæœ¬æ‰€æœ‰èµ„æºçš„ä¸€çº§å±æ€§éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸»è¦åŒ…å«5éƒ¨åˆ†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- apiVersion &lt;string&gt; ç‰ˆæœ¬ï¼Œç”±kuberneteså†…éƒ¨å®šä¹‰ï¼Œç‰ˆæœ¬å·å¿…é¡»å¯ä»¥ç”¨ kubectl api-versions æŸ¥è¯¢åˆ°
</span></span><span style="display:flex;"><span>- kind &lt;string&gt; ç±»å‹ï¼Œç”±kuberneteså†…éƒ¨å®šä¹‰ï¼Œç‰ˆæœ¬å·å¿…é¡»å¯ä»¥ç”¨ kubectl api-resources æŸ¥è¯¢åˆ°
</span></span><span style="display:flex;"><span>- metadata &lt;Object&gt; å…ƒæ•°æ®ï¼Œä¸»è¦æ˜¯èµ„æºæ ‡è¯†å’Œè¯´æ˜ï¼Œå¸¸ç”¨çš„æœ‰nameã€namespaceã€labelsç­‰
</span></span><span style="display:flex;"><span>- spec &lt;Object&gt; æè¿°ï¼Œè¿™æ˜¯é…ç½®ä¸­æœ€é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œé‡Œé¢æ˜¯å¯¹å„ç§èµ„æºé…ç½®çš„è¯¦ç»†æè¿°
</span></span><span style="display:flex;"><span>- status &lt;Object&gt; çŠ¶æ€ä¿¡æ¯ï¼Œé‡Œé¢çš„å†…å®¹ä¸éœ€è¦å®šä¹‰ï¼Œç”±kubernetesè‡ªåŠ¨ç”Ÿæˆ
</span></span></code></pre></div><p>åœ¨ä¸Šé¢çš„å±æ€§ä¸­ï¼Œspecæ˜¯æ¥ä¸‹æ¥ç ”ç©¶çš„é‡ç‚¹ï¼Œç»§ç»­çœ‹ä¸‹å®ƒçš„å¸¸è§å­å±æ€§:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- containers &lt;[]Object&gt; å®¹å™¨åˆ—è¡¨ï¼Œç”¨äºå®šä¹‰å®¹å™¨çš„è¯¦ç»†ä¿¡æ¯
</span></span><span style="display:flex;"><span>- nodeName &lt;String&gt; æ ¹æ®nodeNameçš„å€¼å°†podè°ƒåº¦åˆ°æŒ‡å®šçš„NodeèŠ‚ç‚¹ä¸Š
</span></span><span style="display:flex;"><span>- nodeSelector &lt;map[]&gt; æ ¹æ®NodeSelectorä¸­å®šä¹‰çš„ä¿¡æ¯é€‰æ‹©å°†è¯¥Podè°ƒåº¦åˆ°åŒ…å«è¿™äº›labelçš„Node ä¸Š
</span></span><span style="display:flex;"><span>- hostNetwork &lt;boolean&gt; æ˜¯å¦ä½¿ç”¨ä¸»æœºç½‘ç»œæ¨¡å¼ï¼Œé»˜è®¤ä¸ºfalseï¼Œå¦‚æœè®¾ç½®ä¸ºtrueï¼Œè¡¨ç¤ºä½¿ç”¨å®¿ä¸»æœºç½‘ç»œ
</span></span><span style="display:flex;"><span>- volumes &lt;[]Object&gt; å­˜å‚¨å·ï¼Œç”¨äºå®šä¹‰Podä¸Šé¢æŒ‚åœ¨çš„å­˜å‚¨ä¿¡æ¯
</span></span><span style="display:flex;"><span>- restartPolicy &lt;string&gt; é‡å¯ç­–ç•¥ï¼Œè¡¨ç¤ºPodåœ¨é‡åˆ°æ•…éšœçš„æ—¶å€™çš„å¤„ç†ç­–ç•¥
</span></span></code></pre></div><h4 id="52-podé…ç½®">5.2 Podé…ç½®<a hidden class="anchor" aria-hidden="true" href="#52-podé…ç½®">#</a></h4>
<p>æœ¬å°èŠ‚ä¸»è¦æ¥ç ”ç©¶<code>pod.spec.containers</code>å±æ€§ï¼Œè¿™ä¹Ÿæ˜¯podé…ç½®ä¸­æœ€ä¸ºå…³é”®çš„ä¸€é¡¹é…ç½®ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl explain pod.spec.containers</span>
</span></span><span style="display:flex;"><span>KIND:     Pod
</span></span><span style="display:flex;"><span>VERSION:  v1
</span></span><span style="display:flex;"><span>RESOURCE: containers &lt;<span style="color:#f92672">[]</span>Object&gt;   <span style="color:#75715e"># æ•°ç»„ï¼Œä»£è¡¨å¯ä»¥æœ‰å¤šä¸ªå®¹å™¨</span>
</span></span><span style="display:flex;"><span>FIELDS:
</span></span><span style="display:flex;"><span>   name  &lt;string&gt;     <span style="color:#75715e"># å®¹å™¨åç§°</span>
</span></span><span style="display:flex;"><span>   image &lt;string&gt;     <span style="color:#75715e"># å®¹å™¨éœ€è¦çš„é•œåƒåœ°å€</span>
</span></span><span style="display:flex;"><span>   imagePullPolicy  &lt;string&gt; <span style="color:#75715e"># é•œåƒæ‹‰å–ç­–ç•¥ </span>
</span></span><span style="display:flex;"><span>   command  &lt;<span style="color:#f92672">[]</span>string&gt; <span style="color:#75715e"># å®¹å™¨çš„å¯åŠ¨å‘½ä»¤åˆ—è¡¨ï¼Œå¦‚ä¸æŒ‡å®šï¼Œä½¿ç”¨æ‰“åŒ…æ—¶ä½¿ç”¨çš„å¯åŠ¨å‘½ä»¤</span>
</span></span><span style="display:flex;"><span>   args     &lt;<span style="color:#f92672">[]</span>string&gt; <span style="color:#75715e"># å®¹å™¨çš„å¯åŠ¨å‘½ä»¤éœ€è¦çš„å‚æ•°åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>   env      &lt;<span style="color:#f92672">[]</span>Object&gt; <span style="color:#75715e"># å®¹å™¨ç¯å¢ƒå˜é‡çš„é…ç½®</span>
</span></span><span style="display:flex;"><span>   ports    &lt;<span style="color:#f92672">[]</span>Object&gt;     <span style="color:#75715e"># å®¹å™¨éœ€è¦æš´éœ²çš„ç«¯å£å·åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>   resources &lt;Object&gt;      <span style="color:#75715e"># èµ„æºé™åˆ¶å’Œèµ„æºè¯·æ±‚çš„è®¾ç½®</span>
</span></span></code></pre></div><h5 id="521-åŸºæœ¬é…ç½®">5.2.1 åŸºæœ¬é…ç½®<a hidden class="anchor" aria-hidden="true" href="#521-åŸºæœ¬é…ç½®">#</a></h5>
<p>åˆ›å»ºpod-base.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-base</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">user</span>: <span style="color:#ae81ff">heima</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span></code></pre></div><p><img loading="lazy" src="/kubernetes.images/image-20210617223823675-1626781695411.png" alt="image-20210617223823675"  />
</p>
<p>ä¸Šé¢å®šä¹‰äº†ä¸€ä¸ªæ¯”è¾ƒç®€å•Podçš„é…ç½®ï¼Œé‡Œé¢æœ‰ä¸¤ä¸ªå®¹å™¨ï¼š</p>
<ul>
<li>nginxï¼šç”¨1.17.1ç‰ˆæœ¬çš„nginxé•œåƒåˆ›å»ºï¼Œï¼ˆnginxæ˜¯ä¸€ä¸ªè½»é‡çº§webå®¹å™¨ï¼‰</li>
<li>busyboxï¼šç”¨1.30ç‰ˆæœ¬çš„busyboxé•œåƒåˆ›å»ºï¼Œï¼ˆbusyboxæ˜¯ä¸€ä¸ªå°å·§çš„linuxå‘½ä»¤é›†åˆï¼‰</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºPod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pod<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f pod-base.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-base created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹PodçŠ¶å†µ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># READY 1/2 : è¡¨ç¤ºå½“å‰Podä¸­æœ‰2ä¸ªå®¹å™¨ï¼Œå…¶ä¸­1ä¸ªå‡†å¤‡å°±ç»ªï¼Œ1ä¸ªæœªå°±ç»ª</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RESTARTS  : é‡å¯æ¬¡æ•°ï¼Œå› ä¸ºæœ‰1ä¸ªå®¹å™¨æ•…éšœäº†ï¼ŒPodä¸€ç›´åœ¨é‡å¯è¯•å›¾æ¢å¤å®ƒ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pod<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n dev</span>
</span></span><span style="display:flex;"><span>NAME       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod-base   1/2     Running   <span style="color:#ae81ff">4</span>          95s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯ä»¥é€šè¿‡describeæŸ¥çœ‹å†…éƒ¨çš„è¯¦æƒ…</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ­¤æ—¶å·²ç»è¿è¡Œèµ·æ¥äº†ä¸€ä¸ªåŸºæœ¬çš„Podï¼Œè™½ç„¶å®ƒæš‚æ—¶æœ‰é—®é¢˜</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pod<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe pod pod-base -n dev</span>
</span></span></code></pre></div><h5 id="522-é•œåƒæ‹‰å–">5.2.2 é•œåƒæ‹‰å–<a hidden class="anchor" aria-hidden="true" href="#522-é•œåƒæ‹‰å–">#</a></h5>
<p>åˆ›å»ºpod-imagepullpolicy.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-imagepullpolicy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">Never</span> <span style="color:#75715e"># ç”¨äºè®¾ç½®é•œåƒæ‹‰å–ç­–ç•¥</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span></code></pre></div><p><img loading="lazy" src="/kubernetes.images/image-20210617223923659.png" alt="image-20210617223923659"  />
</p>
<p>imagePullPolicyï¼Œç”¨äºè®¾ç½®é•œåƒæ‹‰å–ç­–ç•¥ï¼Œkubernetesæ”¯æŒé…ç½®ä¸‰ç§æ‹‰å–ç­–ç•¥ï¼š</p>
<ul>
<li>Alwaysï¼šæ€»æ˜¯ä»è¿œç¨‹ä»“åº“æ‹‰å–é•œåƒï¼ˆä¸€ç›´è¿œç¨‹ä¸‹è½½ï¼‰</li>
<li>IfNotPresentï¼šæœ¬åœ°æœ‰åˆ™ä½¿ç”¨æœ¬åœ°é•œåƒï¼Œæœ¬åœ°æ²¡æœ‰åˆ™ä»è¿œç¨‹ä»“åº“æ‹‰å–é•œåƒï¼ˆæœ¬åœ°æœ‰å°±æœ¬åœ° æœ¬åœ°æ²¡è¿œç¨‹ä¸‹è½½ï¼‰</li>
<li>Neverï¼šåªä½¿ç”¨æœ¬åœ°é•œåƒï¼Œä»ä¸å»è¿œç¨‹ä»“åº“æ‹‰å–ï¼Œæœ¬åœ°æ²¡æœ‰å°±æŠ¥é”™ ï¼ˆä¸€ç›´ä½¿ç”¨æœ¬åœ°ï¼‰</li>
</ul>
<blockquote>
<p>é»˜è®¤å€¼è¯´æ˜ï¼š</p>
<p>å¦‚æœé•œåƒtagä¸ºå…·ä½“ç‰ˆæœ¬å·ï¼Œ é»˜è®¤ç­–ç•¥æ˜¯ï¼šIfNotPresent</p>
<p>å¦‚æœé•œåƒtagä¸ºï¼šlatestï¼ˆæœ€ç»ˆç‰ˆæœ¬ï¼‰ ï¼Œé»˜è®¤ç­–ç•¥æ˜¯always</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºPod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pod<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-imagepullpolicy.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-imagepullpolicy created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹Podè¯¦æƒ…</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ­¤æ—¶æ˜æ˜¾å¯ä»¥çœ‹åˆ°nginxé•œåƒæœ‰ä¸€æ­¥Pulling image &#34;nginx:1.17.1&#34;çš„è¿‡ç¨‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pod<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe pod pod-imagepullpolicy -n dev</span>
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type     Reason     Age               From               Message
</span></span><span style="display:flex;"><span>  ----     ------     ----              ----               -------
</span></span><span style="display:flex;"><span>  Normal   Scheduled  &lt;unknown&gt;         default-scheduler  Successfully assigned dev/pod-imagePullPolicy to node1
</span></span><span style="display:flex;"><span>  Normal   Pulling    32s               kubelet, node1     Pulling image <span style="color:#e6db74">&#34;nginx:1.17.1&#34;</span>
</span></span><span style="display:flex;"><span>  Normal   Pulled     26s               kubelet, node1     Successfully pulled image <span style="color:#e6db74">&#34;nginx:1.17.1&#34;</span>
</span></span><span style="display:flex;"><span>  Normal   Created    26s               kubelet, node1     Created container nginx
</span></span><span style="display:flex;"><span>  Normal   Started    25s               kubelet, node1     Started container nginx
</span></span><span style="display:flex;"><span>  Normal   Pulled     7s <span style="color:#f92672">(</span>x3 over 25s<span style="color:#f92672">)</span>  kubelet, node1     Container image <span style="color:#e6db74">&#34;busybox:1.30&#34;</span> already present on machine
</span></span><span style="display:flex;"><span>  Normal   Created    7s <span style="color:#f92672">(</span>x3 over 25s<span style="color:#f92672">)</span>  kubelet, node1     Created container busybox
</span></span><span style="display:flex;"><span>  Normal   Started    7s <span style="color:#f92672">(</span>x3 over 25s<span style="color:#f92672">)</span>  kubelet, node1     Started container busybox
</span></span></code></pre></div><h5 id="523-å¯åŠ¨å‘½ä»¤">5.2.3 å¯åŠ¨å‘½ä»¤<a hidden class="anchor" aria-hidden="true" href="#523-å¯åŠ¨å‘½ä»¤">#</a></h5>
<p>åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­ï¼Œä¸€ç›´æœ‰ä¸€ä¸ªé—®é¢˜æ²¡æœ‰è§£å†³ï¼Œå°±æ˜¯çš„busyboxå®¹å™¨ä¸€ç›´æ²¡æœ‰æˆåŠŸè¿è¡Œï¼Œé‚£ä¹ˆåˆ°åº•æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´è¿™ä¸ªå®¹å™¨çš„æ•…éšœå‘¢ï¼Ÿ</p>
<p>åŸæ¥busyboxå¹¶ä¸æ˜¯ä¸€ä¸ªç¨‹åºï¼Œè€Œæ˜¯ç±»ä¼¼äºä¸€ä¸ªå·¥å…·ç±»çš„é›†åˆï¼Œkubernetesé›†ç¾¤å¯åŠ¨ç®¡ç†åï¼Œå®ƒä¼šè‡ªåŠ¨å…³é—­ã€‚è§£å†³æ–¹æ³•å°±æ˜¯è®©å…¶ä¸€ç›´åœ¨è¿è¡Œï¼Œè¿™å°±ç”¨åˆ°äº†commandé…ç½®ã€‚</p>
<p>åˆ›å»ºpod-command.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-command</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;touch /tmp/hello.txt;while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt; sleep 3; done;&#34;</span>]
</span></span></code></pre></div><p><img loading="lazy" src="/kubernetes.images/image-20210617224457945.png" alt="image-20210617224457945"  />
</p>
<p>commandï¼Œç”¨äºåœ¨podä¸­çš„å®¹å™¨åˆå§‹åŒ–å®Œæ¯•ä¹‹åè¿è¡Œä¸€ä¸ªå‘½ä»¤ã€‚</p>
<blockquote>
<p>ç¨å¾®è§£é‡Šä¸‹ä¸Šé¢å‘½ä»¤çš„æ„æ€ï¼š</p>
<p>&ldquo;/bin/sh&rdquo;,&quot;-c&rdquo;, ä½¿ç”¨shæ‰§è¡Œå‘½ä»¤</p>
<p>touch /tmp/hello.txt; åˆ›å»ºä¸€ä¸ª/tmp/hello.txt æ–‡ä»¶</p>
<p>while true;do /bin/echo $(date +%T) &raquo; /tmp/hello.txt; sleep 3; done; æ¯éš”3ç§’å‘æ–‡ä»¶ä¸­å†™å…¥å½“å‰æ—¶é—´</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºPod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pod<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create  -f pod-command.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-command created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹PodçŠ¶æ€</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ­¤æ—¶å‘ç°ä¸¤ä¸ªpodéƒ½æ­£å¸¸è¿è¡Œäº†</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pod<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods pod-command -n dev</span>
</span></span><span style="display:flex;"><span>NAME          READY   STATUS   RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod-command   2/2     Runing   <span style="color:#ae81ff">0</span>          2s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è¿›å…¥podä¸­çš„busyboxå®¹å™¨ï¼ŒæŸ¥çœ‹æ–‡ä»¶å†…å®¹</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è¡¥å……ä¸€ä¸ªå‘½ä»¤: kubectl exec  podåç§° -n å‘½åç©ºé—´ -it -c å®¹å™¨åç§° /bin/sh  åœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œå‘½ä»¤</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä½¿ç”¨è¿™ä¸ªå‘½ä»¤å°±å¯ä»¥è¿›å…¥æŸä¸ªå®¹å™¨çš„å†…éƒ¨ï¼Œç„¶åè¿›è¡Œç›¸å…³æ“ä½œäº†</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¯”å¦‚ï¼Œå¯ä»¥æŸ¥çœ‹txtæ–‡ä»¶çš„å†…å®¹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pod<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl exec pod-command -n dev -it -c busybox /bin/sh</span>
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># tail -f /tmp/hello.txt</span>
</span></span><span style="display:flex;"><span>14:44:19
</span></span><span style="display:flex;"><span>14:44:22
</span></span><span style="display:flex;"><span>14:44:25
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>ç‰¹åˆ«è¯´æ˜ï¼š
</span></span><span style="display:flex;"><span>    é€šè¿‡ä¸Šé¢å‘ç°commandå·²ç»å¯ä»¥å®Œæˆå¯åŠ¨å‘½ä»¤å’Œä¼ é€’å‚æ•°çš„åŠŸèƒ½ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œè¿˜è¦æä¾›ä¸€ä¸ªargsé€‰é¡¹ï¼Œç”¨äºä¼ é€’å‚æ•°å‘¢?è¿™å…¶å®è·Ÿdockeræœ‰ç‚¹å…³ç³»ï¼Œkubernetesä¸­çš„commandã€argsä¸¤é¡¹å…¶å®æ˜¯å®ç°è¦†ç›–Dockerfileä¸­ENTRYPOINTçš„åŠŸèƒ½ã€‚
</span></span><span style="display:flex;"><span> 1 å¦‚æœcommandå’Œargså‡æ²¡æœ‰å†™ï¼Œé‚£ä¹ˆç”¨Dockerfileçš„é…ç½®ã€‚
</span></span><span style="display:flex;"><span> 2 å¦‚æœcommandå†™äº†ï¼Œä½†argsæ²¡æœ‰å†™ï¼Œé‚£ä¹ˆDockerfileé»˜è®¤çš„é…ç½®ä¼šè¢«å¿½ç•¥ï¼Œæ‰§è¡Œè¾“å…¥çš„command
</span></span><span style="display:flex;"><span> 3 å¦‚æœcommandæ²¡å†™ï¼Œä½†argså†™äº†ï¼Œé‚£ä¹ˆDockerfileä¸­é…ç½®çš„ENTRYPOINTçš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œä½¿ç”¨å½“å‰argsçš„å‚æ•°
</span></span><span style="display:flex;"><span> 4 å¦‚æœcommandå’Œargséƒ½å†™äº†ï¼Œé‚£ä¹ˆDockerfileçš„é…ç½®è¢«å¿½ç•¥ï¼Œæ‰§è¡Œcommandå¹¶è¿½åŠ ä¸Šargså‚æ•°
</span></span></code></pre></div><h5 id="524-ç¯å¢ƒå˜é‡">5.2.4 ç¯å¢ƒå˜é‡<a hidden class="anchor" aria-hidden="true" href="#524-ç¯å¢ƒå˜é‡">#</a></h5>
<p>åˆ›å»ºpod-env.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-env</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;while true;do /bin/echo $(date +%T);sleep 60; done;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env</span>: <span style="color:#75715e"># è®¾ç½®ç¯å¢ƒå˜é‡åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;username&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;admin&#34;</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;password&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;123456&#34;</span>
</span></span></code></pre></div><p>envï¼Œç¯å¢ƒå˜é‡ï¼Œç”¨äºåœ¨podä¸­çš„å®¹å™¨è®¾ç½®ç¯å¢ƒå˜é‡ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºPod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-env.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-env created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è¿›å…¥å®¹å™¨ï¼Œè¾“å‡ºç¯å¢ƒå˜é‡</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl exec pod-env -n dev -c busybox -it /bin/sh</span>
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># echo $username</span>
</span></span><span style="display:flex;"><span>admin
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># echo $password</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">123456</span>
</span></span></code></pre></div><p>è¿™ç§æ–¹å¼ä¸æ˜¯å¾ˆæ¨èï¼Œæ¨èå°†è¿™äº›é…ç½®å•ç‹¬å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œè¿™ç§æ–¹å¼å°†åœ¨åé¢ä»‹ç»ã€‚</p>
<h5 id="525-ç«¯å£è®¾ç½®">5.2.5 ç«¯å£è®¾ç½®<a hidden class="anchor" aria-hidden="true" href="#525-ç«¯å£è®¾ç½®">#</a></h5>
<p>æœ¬å°èŠ‚æ¥ä»‹ç»å®¹å™¨çš„ç«¯å£è®¾ç½®ï¼Œä¹Ÿå°±æ˜¯containersçš„portsé€‰é¡¹ã€‚</p>
<p>é¦–å…ˆçœ‹ä¸‹portsæ”¯æŒçš„å­é€‰é¡¹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl explain pod.spec.containers.ports</span>
</span></span><span style="display:flex;"><span>KIND:     Pod
</span></span><span style="display:flex;"><span>VERSION:  v1
</span></span><span style="display:flex;"><span>RESOURCE: ports &lt;<span style="color:#f92672">[]</span>Object&gt;
</span></span><span style="display:flex;"><span>FIELDS:
</span></span><span style="display:flex;"><span>   name         &lt;string&gt;  <span style="color:#75715e"># ç«¯å£åç§°ï¼Œå¦‚æœæŒ‡å®šï¼Œå¿…é¡»ä¿è¯nameåœ¨podä¸­æ˜¯å”¯ä¸€çš„  </span>
</span></span><span style="display:flex;"><span>   containerPort&lt;integer&gt; <span style="color:#75715e"># å®¹å™¨è¦ç›‘å¬çš„ç«¯å£(0&lt;x&lt;65536)</span>
</span></span><span style="display:flex;"><span>   hostPort     &lt;integer&gt; <span style="color:#75715e"># å®¹å™¨è¦åœ¨ä¸»æœºä¸Šå…¬å¼€çš„ç«¯å£ï¼Œå¦‚æœè®¾ç½®ï¼Œä¸»æœºä¸Šåªèƒ½è¿è¡Œå®¹å™¨çš„ä¸€ä¸ªå‰¯æœ¬(ä¸€èˆ¬çœç•¥) </span>
</span></span><span style="display:flex;"><span>   hostIP       &lt;string&gt;  <span style="color:#75715e"># è¦å°†å¤–éƒ¨ç«¯å£ç»‘å®šåˆ°çš„ä¸»æœºIP(ä¸€èˆ¬çœç•¥)</span>
</span></span><span style="display:flex;"><span>   protocol     &lt;string&gt;  <span style="color:#75715e"># ç«¯å£åè®®ã€‚å¿…é¡»æ˜¯UDPã€TCPæˆ–SCTPã€‚é»˜è®¤ä¸ºâ€œTCPâ€ã€‚</span>
</span></span></code></pre></div><p>æ¥ä¸‹æ¥ï¼Œç¼–å†™ä¸€ä¸ªæµ‹è¯•æ¡ˆä¾‹ï¼Œåˆ›å»ºpod-ports.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-ports</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>: <span style="color:#75715e"># è®¾ç½®å®¹å™¨æš´éœ²çš„ç«¯å£åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºPod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-ports.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-ports created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pod</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åœ¨ä¸‹é¢å¯ä»¥æ˜æ˜¾çœ‹åˆ°é…ç½®ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod pod-ports -n dev -o yaml</span>
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - image: nginx:1.17.1
</span></span><span style="display:flex;"><span>    imagePullPolicy: IfNotPresent
</span></span><span style="display:flex;"><span>    name: nginx
</span></span><span style="display:flex;"><span>    ports:
</span></span><span style="display:flex;"><span>    - containerPort: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      name: nginx-port
</span></span><span style="display:flex;"><span>      protocol: TCP
</span></span><span style="display:flex;"><span>......
</span></span></code></pre></div><p>è®¿é—®å®¹å™¨ä¸­çš„ç¨‹åºéœ€è¦ä½¿ç”¨çš„æ˜¯<code>Podip:containerPort</code></p>
<h5 id="526-èµ„æºé…é¢">5.2.6 èµ„æºé…é¢<a hidden class="anchor" aria-hidden="true" href="#526-èµ„æºé…é¢">#</a></h5>
<p>å®¹å™¨ä¸­çš„ç¨‹åºè¦è¿è¡Œï¼Œè‚¯å®šæ˜¯è¦å ç”¨ä¸€å®šèµ„æºçš„ï¼Œæ¯”å¦‚cpuå’Œå†…å­˜ç­‰ï¼Œå¦‚æœä¸å¯¹æŸä¸ªå®¹å™¨çš„èµ„æºåšé™åˆ¶ï¼Œé‚£ä¹ˆå®ƒå°±å¯èƒ½åƒæ‰å¤§é‡èµ„æºï¼Œå¯¼è‡´å…¶å®ƒå®¹å™¨æ— æ³•è¿è¡Œã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œkubernetesæä¾›äº†å¯¹å†…å­˜å’Œcpuçš„èµ„æºè¿›è¡Œé…é¢çš„æœºåˆ¶ï¼Œè¿™ç§æœºåˆ¶ä¸»è¦é€šè¿‡resourcesé€‰é¡¹å®ç°ï¼Œä»–æœ‰ä¸¤ä¸ªå­é€‰é¡¹ï¼š</p>
<ul>
<li>limitsï¼šç”¨äºé™åˆ¶è¿è¡Œæ—¶å®¹å™¨çš„æœ€å¤§å ç”¨èµ„æºï¼Œå½“å®¹å™¨å ç”¨èµ„æºè¶…è¿‡limitsæ—¶ä¼šè¢«ç»ˆæ­¢ï¼Œå¹¶è¿›è¡Œé‡å¯</li>
<li>requests ï¼šç”¨äºè®¾ç½®å®¹å™¨éœ€è¦çš„æœ€å°èµ„æºï¼Œå¦‚æœç¯å¢ƒèµ„æºä¸å¤Ÿï¼Œå®¹å™¨å°†æ— æ³•å¯åŠ¨</li>
</ul>
<p>å¯ä»¥é€šè¿‡ä¸Šé¢ä¸¤ä¸ªé€‰é¡¹è®¾ç½®èµ„æºçš„ä¸Šä¸‹é™ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œç¼–å†™ä¸€ä¸ªæµ‹è¯•æ¡ˆä¾‹ï¼Œåˆ›å»ºpod-resources.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-resources</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">resources</span>: <span style="color:#75715e"># èµ„æºé…é¢</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">limits</span>:  <span style="color:#75715e"># é™åˆ¶èµ„æºï¼ˆä¸Šé™ï¼‰</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;2&#34;</span> <span style="color:#75715e"># CPUé™åˆ¶ï¼Œå•ä½æ˜¯coreæ•°</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;10Gi&#34;</span> <span style="color:#75715e"># å†…å­˜é™åˆ¶</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requests</span>: <span style="color:#75715e"># è¯·æ±‚èµ„æºï¼ˆä¸‹é™ï¼‰</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;1&#34;</span>  <span style="color:#75715e"># CPUé™åˆ¶ï¼Œå•ä½æ˜¯coreæ•°</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">memory</span>: <span style="color:#e6db74">&#34;10Mi&#34;</span>  <span style="color:#75715e"># å†…å­˜é™åˆ¶</span>
</span></span></code></pre></div><p>åœ¨è¿™å¯¹cpuå’Œmemoryçš„å•ä½åšä¸€ä¸ªè¯´æ˜ï¼š</p>
<ul>
<li>cpuï¼šcoreæ•°ï¼Œå¯ä»¥ä¸ºæ•´æ•°æˆ–å°æ•°</li>
<li>memoryï¼š å†…å­˜å¤§å°ï¼Œå¯ä»¥ä½¿ç”¨Giã€Miã€Gã€Mç­‰å½¢å¼</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># è¿è¡ŒPod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create  -f pod-resources.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-resources created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹å‘ç°podè¿è¡Œæ­£å¸¸</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod pod-resources -n dev</span>
</span></span><span style="display:flex;"><span>NAME            READY   STATUS    RESTARTS   AGE  
</span></span><span style="display:flex;"><span>pod-resources   1/1     Running   <span style="color:#ae81ff">0</span>          39s   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¥ä¸‹æ¥ï¼Œåœæ­¢Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete  -f pod-resources.yaml</span>
</span></span><span style="display:flex;"><span>pod <span style="color:#e6db74">&#34;pod-resources&#34;</span> deleted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¼–è¾‘podï¼Œä¿®æ”¹resources.requests.memoryçš„å€¼ä¸º10Gi</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim pod-resources.yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å†æ¬¡å¯åŠ¨pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create  -f pod-resources.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-resources created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹PodçŠ¶æ€ï¼Œå‘ç°Podå¯åŠ¨å¤±è´¥</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod pod-resources -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME            READY   STATUS    RESTARTS   AGE          
</span></span><span style="display:flex;"><span>pod-resources   0/1     Pending   <span style="color:#ae81ff">0</span>          20s    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹podè¯¦æƒ…ä¼šå‘ç°ï¼Œå¦‚ä¸‹æç¤º</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe pod pod-resources -n dev</span>
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>Warning  FailedScheduling  35s   default-scheduler  0/3 nodes are available: <span style="color:#ae81ff">1</span> node<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> had taint <span style="color:#f92672">{</span>node-role.kubernetes.io/master: <span style="color:#f92672">}</span>, that the pod didn<span style="color:#960050;background-color:#1e0010">&#39;</span>t tolerate, <span style="color:#ae81ff">2</span> Insufficient memory.<span style="color:#f92672">(</span>å†…å­˜ä¸è¶³<span style="color:#f92672">)</span>
</span></span></code></pre></div><h4 id="53-podç”Ÿå‘½å‘¨æœŸ">5.3 Podç”Ÿå‘½å‘¨æœŸ<a hidden class="anchor" aria-hidden="true" href="#53-podç”Ÿå‘½å‘¨æœŸ">#</a></h4>
<p>æˆ‘ä»¬ä¸€èˆ¬å°†podå¯¹è±¡ä»åˆ›å»ºè‡³ç»ˆçš„è¿™æ®µæ—¶é—´èŒƒå›´ç§°ä¸ºpodçš„ç”Ÿå‘½å‘¨æœŸï¼Œå®ƒä¸»è¦åŒ…å«ä¸‹é¢çš„è¿‡ç¨‹ï¼š</p>
<ul>
<li>podåˆ›å»ºè¿‡ç¨‹</li>
<li>è¿è¡Œåˆå§‹åŒ–å®¹å™¨ï¼ˆinit containerï¼‰è¿‡ç¨‹</li>
<li>è¿è¡Œä¸»å®¹å™¨ï¼ˆmain containerï¼‰
<ul>
<li>å®¹å™¨å¯åŠ¨åé’©å­ï¼ˆpost startï¼‰ã€å®¹å™¨ç»ˆæ­¢å‰é’©å­ï¼ˆpre stopï¼‰</li>
<li>å®¹å™¨çš„å­˜æ´»æ€§æ¢æµ‹ï¼ˆliveness probeï¼‰ã€å°±ç»ªæ€§æ¢æµ‹ï¼ˆreadiness probeï¼‰</li>
</ul>
</li>
<li>podç»ˆæ­¢è¿‡ç¨‹</li>
</ul>
<p><img loading="lazy" src="/kubernetes.images/image-20200412111402706-1626782188724.png" alt="image-20200412111402706"  />
</p>
<p>åœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ï¼ŒPodä¼šå‡ºç°5ç§çŠ¶æ€ï¼ˆç›¸ä½ï¼‰ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</p>
<ul>
<li>æŒ‚èµ·ï¼ˆPendingï¼‰ï¼šapiserverå·²ç»åˆ›å»ºäº†podèµ„æºå¯¹è±¡ï¼Œä½†å®ƒå°šæœªè¢«è°ƒåº¦å®Œæˆæˆ–è€…ä»å¤„äºä¸‹è½½é•œåƒçš„è¿‡ç¨‹ä¸­</li>
<li>è¿è¡Œä¸­ï¼ˆRunningï¼‰ï¼špodå·²ç»è¢«è°ƒåº¦è‡³æŸèŠ‚ç‚¹ï¼Œå¹¶ä¸”æ‰€æœ‰å®¹å™¨éƒ½å·²ç»è¢«kubeletåˆ›å»ºå®Œæˆ</li>
<li>æˆåŠŸï¼ˆSucceededï¼‰ï¼špodä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å·²ç»æˆåŠŸç»ˆæ­¢å¹¶ä¸”ä¸ä¼šè¢«é‡å¯</li>
<li>å¤±è´¥ï¼ˆFailedï¼‰ï¼šæ‰€æœ‰å®¹å™¨éƒ½å·²ç»ç»ˆæ­¢ï¼Œä½†è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨ç»ˆæ­¢å¤±è´¥ï¼Œå³å®¹å™¨è¿”å›äº†é0å€¼çš„é€€å‡ºçŠ¶æ€</li>
<li>æœªçŸ¥ï¼ˆUnknownï¼‰ï¼šapiserveræ— æ³•æ­£å¸¸è·å–åˆ°podå¯¹è±¡çš„çŠ¶æ€ä¿¡æ¯ï¼Œé€šå¸¸ç”±ç½‘ç»œé€šä¿¡å¤±è´¥æ‰€å¯¼è‡´</li>
</ul>
<h5 id="531-åˆ›å»ºå’Œç»ˆæ­¢">5.3.1 åˆ›å»ºå’Œç»ˆæ­¢<a hidden class="anchor" aria-hidden="true" href="#531-åˆ›å»ºå’Œç»ˆæ­¢">#</a></h5>
<p>podçš„åˆ›å»ºè¿‡ç¨‹</p>
<ol>
<li>
<p>ç”¨æˆ·é€šè¿‡kubectlæˆ–å…¶ä»–apiå®¢æˆ·ç«¯æäº¤éœ€è¦åˆ›å»ºçš„podä¿¡æ¯ç»™apiServer</p>
</li>
<li>
<p>apiServerå¼€å§‹ç”Ÿæˆpodå¯¹è±¡çš„ä¿¡æ¯ï¼Œå¹¶å°†ä¿¡æ¯å­˜å…¥etcdï¼Œç„¶åè¿”å›ç¡®è®¤ä¿¡æ¯è‡³å®¢æˆ·ç«¯</p>
</li>
<li>
<p>apiServerå¼€å§‹åæ˜ etcdä¸­çš„podå¯¹è±¡çš„å˜åŒ–ï¼Œå…¶å®ƒç»„ä»¶ä½¿ç”¨watchæœºåˆ¶æ¥è·Ÿè¸ªæ£€æŸ¥apiServerä¸Šçš„å˜åŠ¨</p>
</li>
<li>
<p>schedulerå‘ç°æœ‰æ–°çš„podå¯¹è±¡è¦åˆ›å»ºï¼Œå¼€å§‹ä¸ºPodåˆ†é…ä¸»æœºå¹¶å°†ç»“æœä¿¡æ¯æ›´æ–°è‡³apiServer</p>
</li>
<li>
<p>nodeèŠ‚ç‚¹ä¸Šçš„kubeletå‘ç°æœ‰podè°ƒåº¦è¿‡æ¥ï¼Œå°è¯•è°ƒç”¨dockerå¯åŠ¨å®¹å™¨ï¼Œå¹¶å°†ç»“æœå›é€è‡³apiServer</p>
</li>
<li>
<p>apiServerå°†æ¥æ”¶åˆ°çš„podçŠ¶æ€ä¿¡æ¯å­˜å…¥etcdä¸­</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200406184656917-1626782168787.png" alt="image-20200406184656917"  />
</p>
</li>
</ol>
<p>podçš„ç»ˆæ­¢è¿‡ç¨‹</p>
<ol>
<li>ç”¨æˆ·å‘apiServerå‘é€åˆ é™¤podå¯¹è±¡çš„å‘½ä»¤</li>
<li>apiServcerä¸­çš„podå¯¹è±¡ä¿¡æ¯ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œæ›´æ–°ï¼Œåœ¨å®½é™æœŸå†…ï¼ˆé»˜è®¤30sï¼‰ï¼Œpodè¢«è§†ä¸ºdead</li>
<li>å°†podæ ‡è®°ä¸ºterminatingçŠ¶æ€</li>
<li>kubeletåœ¨ç›‘æ§åˆ°podå¯¹è±¡è½¬ä¸ºterminatingçŠ¶æ€çš„åŒæ—¶å¯åŠ¨podå…³é—­è¿‡ç¨‹</li>
<li>ç«¯ç‚¹æ§åˆ¶å™¨ç›‘æ§åˆ°podå¯¹è±¡çš„å…³é—­è¡Œä¸ºæ—¶å°†å…¶ä»æ‰€æœ‰åŒ¹é…åˆ°æ­¤ç«¯ç‚¹çš„serviceèµ„æºçš„ç«¯ç‚¹åˆ—è¡¨ä¸­ç§»é™¤</li>
<li>å¦‚æœå½“å‰podå¯¹è±¡å®šä¹‰äº†preStopé’©å­å¤„ç†å™¨ï¼Œåˆ™åœ¨å…¶æ ‡è®°ä¸ºterminatingåå³ä¼šä»¥åŒæ­¥çš„æ–¹å¼å¯åŠ¨æ‰§è¡Œ</li>
<li>podå¯¹è±¡ä¸­çš„å®¹å™¨è¿›ç¨‹æ”¶åˆ°åœæ­¢ä¿¡å·</li>
<li>å®½é™æœŸç»“æŸåï¼Œè‹¥podä¸­è¿˜å­˜åœ¨ä»åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œé‚£ä¹ˆpodå¯¹è±¡ä¼šæ”¶åˆ°ç«‹å³ç»ˆæ­¢çš„ä¿¡å·</li>
<li>kubeletè¯·æ±‚apiServerå°†æ­¤podèµ„æºçš„å®½é™æœŸè®¾ç½®ä¸º0ä»è€Œå®Œæˆåˆ é™¤æ“ä½œï¼Œæ­¤æ—¶podå¯¹äºç”¨æˆ·å·²ä¸å¯è§</li>
</ol>
<h5 id="532-åˆå§‹åŒ–å®¹å™¨">5.3.2 åˆå§‹åŒ–å®¹å™¨<a hidden class="anchor" aria-hidden="true" href="#532-åˆå§‹åŒ–å®¹å™¨">#</a></h5>
<p>åˆå§‹åŒ–å®¹å™¨æ˜¯åœ¨podçš„ä¸»å®¹å™¨å¯åŠ¨ä¹‹å‰è¦è¿è¡Œçš„å®¹å™¨ï¼Œä¸»è¦æ˜¯åšä¸€äº›ä¸»å®¹å™¨çš„å‰ç½®å·¥ä½œï¼Œå®ƒå…·æœ‰ä¸¤å¤§ç‰¹å¾ï¼š</p>
<ol>
<li>åˆå§‹åŒ–å®¹å™¨å¿…é¡»è¿è¡Œå®Œæˆç›´è‡³ç»“æŸï¼Œè‹¥æŸåˆå§‹åŒ–å®¹å™¨è¿è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆkuberneteséœ€è¦é‡å¯å®ƒç›´åˆ°æˆåŠŸå®Œæˆ</li>
<li>åˆå§‹åŒ–å®¹å™¨å¿…é¡»æŒ‰ç…§å®šä¹‰çš„é¡ºåºæ‰§è¡Œï¼Œå½“ä¸”ä»…å½“å‰ä¸€ä¸ªæˆåŠŸä¹‹åï¼Œåé¢çš„ä¸€ä¸ªæ‰èƒ½è¿è¡Œ</li>
</ol>
<p>åˆå§‹åŒ–å®¹å™¨æœ‰å¾ˆå¤šçš„åº”ç”¨åœºæ™¯ï¼Œä¸‹é¢åˆ—å‡ºçš„æ˜¯æœ€å¸¸è§çš„å‡ ä¸ªï¼š</p>
<ul>
<li>æä¾›ä¸»å®¹å™¨é•œåƒä¸­ä¸å…·å¤‡çš„å·¥å…·ç¨‹åºæˆ–è‡ªå®šä¹‰ä»£ç </li>
<li>åˆå§‹åŒ–å®¹å™¨è¦å…ˆäºåº”ç”¨å®¹å™¨ä¸²è¡Œå¯åŠ¨å¹¶è¿è¡Œå®Œæˆï¼Œå› æ­¤å¯ç”¨äºå»¶ååº”ç”¨å®¹å™¨çš„å¯åŠ¨ç›´è‡³å…¶ä¾èµ–çš„æ¡ä»¶å¾—åˆ°æ»¡è¶³</li>
</ul>
<p>æ¥ä¸‹æ¥åšä¸€ä¸ªæ¡ˆä¾‹ï¼Œæ¨¡æ‹Ÿä¸‹é¢è¿™ä¸ªéœ€æ±‚ï¼š</p>
<p>å‡è®¾è¦ä»¥ä¸»å®¹å™¨æ¥è¿è¡Œnginxï¼Œä½†æ˜¯è¦æ±‚åœ¨è¿è¡Œnginxä¹‹å‰å…ˆè¦èƒ½å¤Ÿè¿æ¥ä¸Šmysqlå’Œredisæ‰€åœ¨æœåŠ¡å™¨</p>
<p>ä¸ºäº†ç®€åŒ–æµ‹è¯•ï¼Œäº‹å…ˆè§„å®šå¥½mysql<code>(192.168.90.14)</code>å’Œredis<code>(192.168.90.15)</code>æœåŠ¡å™¨çš„åœ°å€</p>
<p>åˆ›å»ºpod-initcontainer.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-initcontainer</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">main-container</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>: 
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">initContainers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">test-mysql</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#39;sh&#39;</span>, <span style="color:#e6db74">&#39;-c&#39;</span>, <span style="color:#e6db74">&#39;until ping 192.168.90.14 -c 1 ; do echo waiting for mysql...; sleep 2; done;&#39;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">test-redis</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#39;sh&#39;</span>, <span style="color:#e6db74">&#39;-c&#39;</span>, <span style="color:#e6db74">&#39;until ping 192.168.90.15 -c 1 ; do echo waiting for reids...; sleep 2; done;&#39;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºpod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-initcontainer.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-initcontainer created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹podçŠ¶æ€</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å‘ç°podå¡åœ¨å¯åŠ¨ç¬¬ä¸€ä¸ªåˆå§‹åŒ–å®¹å™¨è¿‡ç¨‹ä¸­ï¼Œåé¢çš„å®¹å™¨ä¸ä¼šè¿è¡Œ</span>
</span></span><span style="display:flex;"><span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe pod  pod-initcontainer -n dev</span>
</span></span><span style="display:flex;"><span>........
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type    Reason     Age   From               Message
</span></span><span style="display:flex;"><span>  ----    ------     ----  ----               -------
</span></span><span style="display:flex;"><span>  Normal  Scheduled  49s   default-scheduler  Successfully assigned dev/pod-initcontainer to node1
</span></span><span style="display:flex;"><span>  Normal  Pulled     48s   kubelet, node1     Container image <span style="color:#e6db74">&#34;busybox:1.30&#34;</span> already present on machine
</span></span><span style="display:flex;"><span>  Normal  Created    48s   kubelet, node1     Created container test-mysql
</span></span><span style="display:flex;"><span>  Normal  Started    48s   kubelet, node1     Started container test-mysql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åŠ¨æ€æŸ¥çœ‹pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods pod-initcontainer -n dev -w</span>
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS     RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod-initcontainer                0/1     Init:0/2   <span style="color:#ae81ff">0</span>          15s
</span></span><span style="display:flex;"><span>pod-initcontainer                0/1     Init:1/2   <span style="color:#ae81ff">0</span>          52s
</span></span><span style="display:flex;"><span>pod-initcontainer                0/1     Init:1/2   <span style="color:#ae81ff">0</span>          53s
</span></span><span style="display:flex;"><span>pod-initcontainer                0/1     PodInitializing   <span style="color:#ae81ff">0</span>          89s
</span></span><span style="display:flex;"><span>pod-initcontainer                1/1     Running           <span style="color:#ae81ff">0</span>          90s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¥ä¸‹æ¥æ–°å¼€ä¸€ä¸ªshellï¼Œä¸ºå½“å‰æœåŠ¡å™¨æ–°å¢ä¸¤ä¸ªipï¼Œè§‚å¯Ÿpodçš„å˜åŒ–</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ifconfig ens33:1 192.168.90.14 netmask 255.255.255.0 up</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ifconfig ens33:2 192.168.90.15 netmask 255.255.255.0 up</span>
</span></span></code></pre></div><h5 id="533-é’©å­å‡½æ•°">5.3.3 é’©å­å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#533-é’©å­å‡½æ•°">#</a></h5>
<p>é’©å­å‡½æ•°èƒ½å¤Ÿæ„ŸçŸ¥è‡ªèº«ç”Ÿå‘½å‘¨æœŸä¸­çš„äº‹ä»¶ï¼Œå¹¶åœ¨ç›¸åº”çš„æ—¶åˆ»åˆ°æ¥æ—¶è¿è¡Œç”¨æˆ·æŒ‡å®šçš„ç¨‹åºä»£ç ã€‚</p>
<p>kubernetesåœ¨ä¸»å®¹å™¨çš„å¯åŠ¨ä¹‹åå’Œåœæ­¢ä¹‹å‰æä¾›äº†ä¸¤ä¸ªé’©å­å‡½æ•°ï¼š</p>
<ul>
<li>post startï¼šå®¹å™¨åˆ›å»ºä¹‹åæ‰§è¡Œï¼Œå¦‚æœå¤±è´¥äº†ä¼šé‡å¯å®¹å™¨</li>
<li>pre stop ï¼šå®¹å™¨ç»ˆæ­¢ä¹‹å‰æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæˆä¹‹åå®¹å™¨å°†æˆåŠŸç»ˆæ­¢ï¼Œåœ¨å…¶å®Œæˆä¹‹å‰ä¼šé˜»å¡åˆ é™¤å®¹å™¨çš„æ“ä½œ</li>
</ul>
<p>é’©å­å¤„ç†å™¨æ”¯æŒä½¿ç”¨ä¸‹é¢ä¸‰ç§æ–¹å¼å®šä¹‰åŠ¨ä½œï¼š</p>
<ul>
<li>
<p>Execå‘½ä»¤ï¼šåœ¨å®¹å™¨å†…æ‰§è¡Œä¸€æ¬¡å‘½ä»¤</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">â€¦â€¦</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">lifecycle</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">postStart</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">cat</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">/tmp/healthy</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">â€¦â€¦</span>
</span></span></code></pre></div></li>
<li>
<p>TCPSocketï¼šåœ¨å½“å‰å®¹å™¨å°è¯•è®¿é—®æŒ‡å®šçš„socket</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">â€¦â€¦      </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">lifecycle</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">postStart</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tcpSocket</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">â€¦â€¦</span>
</span></span></code></pre></div></li>
<li>
<p>HTTPGetï¼šåœ¨å½“å‰å®¹å™¨ä¸­å‘æŸurlå‘èµ·httpè¯·æ±‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">â€¦â€¦</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">lifecycle</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">postStart</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span> <span style="color:#75715e">#URIåœ°å€</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e">#ç«¯å£å·</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">host</span>: <span style="color:#ae81ff">192.168.5.3</span> <span style="color:#75715e">#ä¸»æœºåœ°å€</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span> <span style="color:#75715e">#æ”¯æŒçš„åè®®ï¼Œhttpæˆ–è€…https</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">â€¦â€¦</span>
</span></span></code></pre></div></li>
</ul>
<p>æ¥ä¸‹æ¥ï¼Œä»¥execæ–¹å¼ä¸ºä¾‹ï¼Œæ¼”ç¤ºä¸‹é’©å­å‡½æ•°çš„ä½¿ç”¨ï¼Œåˆ›å»ºpod-hook-exec.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-hook-exec</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">main-container</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">lifecycle</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">postStart</span>: 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">exec</span>: <span style="color:#75715e"># åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œä¿®æ”¹æ‰nginxçš„é»˜è®¤é¦–é¡µå†…å®¹</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;echo postStart... &gt; /usr/share/nginx/html/index.html&#34;</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">preStop</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">exec</span>: <span style="color:#75715e"># åœ¨å®¹å™¨åœæ­¢ä¹‹å‰åœæ­¢nginxæœåŠ¡</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/usr/sbin/nginx&#34;</span>,<span style="color:#e6db74">&#34;-s&#34;</span>,<span style="color:#e6db74">&#34;quit&#34;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºpod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-hook-exec.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-hook-exec created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods  pod-hook-exec -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME           READY   STATUS     RESTARTS   AGE    IP            NODE    
</span></span><span style="display:flex;"><span>pod-hook-exec  1/1     Running    <span style="color:#ae81ff">0</span>          29s    10.244.2.48   node2   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è®¿é—®pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># curl 10.244.2.48</span>
</span></span><span style="display:flex;"><span>postStart...
</span></span></code></pre></div><h5 id="534-å®¹å™¨æ¢æµ‹">5.3.4 å®¹å™¨æ¢æµ‹<a hidden class="anchor" aria-hidden="true" href="#534-å®¹å™¨æ¢æµ‹">#</a></h5>
<p>å®¹å™¨æ¢æµ‹ç”¨äºæ£€æµ‹å®¹å™¨ä¸­çš„åº”ç”¨å®ä¾‹æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œæ˜¯ä¿éšœä¸šåŠ¡å¯ç”¨æ€§çš„ä¸€ç§ä¼ ç»Ÿæœºåˆ¶ã€‚å¦‚æœç»è¿‡æ¢æµ‹ï¼Œå®ä¾‹çš„çŠ¶æ€ä¸ç¬¦åˆé¢„æœŸï¼Œé‚£ä¹ˆkuberneteså°±ä¼šæŠŠè¯¥é—®é¢˜å®ä¾‹&rdquo; æ‘˜é™¤ &ldquo;ï¼Œä¸æ‰¿æ‹…ä¸šåŠ¡æµé‡ã€‚kubernetesæä¾›äº†ä¸¤ç§æ¢é’ˆæ¥å®ç°å®¹å™¨æ¢æµ‹ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>liveness probesï¼šå­˜æ´»æ€§æ¢é’ˆï¼Œç”¨äºæ£€æµ‹åº”ç”¨å®ä¾‹å½“å‰æ˜¯å¦å¤„äºæ­£å¸¸è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯ï¼Œk8sä¼šé‡å¯å®¹å™¨</li>
<li>readiness probesï¼šå°±ç»ªæ€§æ¢é’ˆï¼Œç”¨äºæ£€æµ‹åº”ç”¨å®ä¾‹å½“å‰æ˜¯å¦å¯ä»¥æ¥æ”¶è¯·æ±‚ï¼Œå¦‚æœä¸èƒ½ï¼Œk8sä¸ä¼šè½¬å‘æµé‡</li>
</ul>
<blockquote>
<p>livenessProbe å†³å®šæ˜¯å¦é‡å¯å®¹å™¨ï¼ŒreadinessProbe å†³å®šæ˜¯å¦å°†è¯·æ±‚è½¬å‘ç»™å®¹å™¨ã€‚</p>
</blockquote>
<p>ä¸Šé¢ä¸¤ç§æ¢é’ˆç›®å‰å‡æ”¯æŒä¸‰ç§æ¢æµ‹æ–¹å¼ï¼š</p>
<ul>
<li>
<p>Execå‘½ä»¤ï¼šåœ¨å®¹å™¨å†…æ‰§è¡Œä¸€æ¬¡å‘½ä»¤ï¼Œå¦‚æœå‘½ä»¤æ‰§è¡Œçš„é€€å‡ºç ä¸º0ï¼Œåˆ™è®¤ä¸ºç¨‹åºæ­£å¸¸ï¼Œå¦åˆ™ä¸æ­£å¸¸</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">â€¦â€¦</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">command</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">cat</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">/tmp/healthy</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">â€¦â€¦</span>
</span></span></code></pre></div></li>
<li>
<p>TCPSocketï¼šå°†ä¼šå°è¯•è®¿é—®ä¸€ä¸ªç”¨æˆ·å®¹å™¨çš„ç«¯å£ï¼Œå¦‚æœèƒ½å¤Ÿå»ºç«‹è¿™æ¡è¿æ¥ï¼Œåˆ™è®¤ä¸ºç¨‹åºæ­£å¸¸ï¼Œå¦åˆ™ä¸æ­£å¸¸</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">â€¦â€¦      </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tcpSocket</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">â€¦â€¦</span>
</span></span></code></pre></div></li>
<li>
<p>HTTPGetï¼šè°ƒç”¨å®¹å™¨å†…Webåº”ç”¨çš„URLï¼Œå¦‚æœè¿”å›çš„çŠ¶æ€ç åœ¨200å’Œ399ä¹‹é—´ï¼Œåˆ™è®¤ä¸ºç¨‹åºæ­£å¸¸ï¼Œå¦åˆ™ä¸æ­£å¸¸</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">â€¦â€¦</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span> <span style="color:#75715e">#URIåœ°å€</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e">#ç«¯å£å·</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">host</span>: <span style="color:#ae81ff">127.0.0.1</span> <span style="color:#75715e">#ä¸»æœºåœ°å€</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span> <span style="color:#75715e">#æ”¯æŒçš„åè®®ï¼Œhttpæˆ–è€…https</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">â€¦â€¦</span>
</span></span></code></pre></div></li>
</ul>
<p>ä¸‹é¢ä»¥liveness probesä¸ºä¾‹ï¼Œåšå‡ ä¸ªæ¼”ç¤ºï¼š</p>
<p>æ–¹å¼ä¸€ï¼šExec</p>
<p>åˆ›å»ºpod-liveness-exec.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-liveness-exec</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>: 
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">exec</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/cat&#34;</span>,<span style="color:#e6db74">&#34;/tmp/hello.txt&#34;</span>] <span style="color:#75715e"># æ‰§è¡Œä¸€ä¸ªæŸ¥çœ‹æ–‡ä»¶çš„å‘½ä»¤</span>
</span></span></code></pre></div><p>åˆ›å»ºpodï¼Œè§‚å¯Ÿæ•ˆæœ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºPod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-liveness-exec.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-liveness-exec created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹Podè¯¦æƒ…</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe pods pod-liveness-exec -n dev</span>
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>  Normal   Created    20s <span style="color:#f92672">(</span>x2 over 50s<span style="color:#f92672">)</span>  kubelet, node1     Created container nginx
</span></span><span style="display:flex;"><span>  Normal   Started    20s <span style="color:#f92672">(</span>x2 over 50s<span style="color:#f92672">)</span>  kubelet, node1     Started container nginx
</span></span><span style="display:flex;"><span>  Normal   Killing    20s                kubelet, node1     Container nginx failed liveness probe, will be restarted
</span></span><span style="display:flex;"><span>  Warning  Unhealthy  0s <span style="color:#f92672">(</span>x5 over 40s<span style="color:#f92672">)</span>   kubelet, node1     Liveness probe failed: cat: can<span style="color:#e6db74">&#39;t open &#39;</span>/tmp/hello11.txt<span style="color:#960050;background-color:#1e0010">&#39;</span>: No such file or directory
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è§‚å¯Ÿä¸Šé¢çš„ä¿¡æ¯å°±ä¼šå‘ç°nginxå®¹å™¨å¯åŠ¨ä¹‹åå°±è¿›è¡Œäº†å¥åº·æ£€æŸ¥</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ£€æŸ¥å¤±è´¥ä¹‹åï¼Œå®¹å™¨è¢«killæ‰ï¼Œç„¶åå°è¯•è¿›è¡Œé‡å¯ï¼ˆè¿™æ˜¯é‡å¯ç­–ç•¥çš„ä½œç”¨ï¼Œåé¢è®²è§£ï¼‰</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¨ç­‰ä¸€ä¼šä¹‹åï¼Œå†è§‚å¯Ÿpodä¿¡æ¯ï¼Œå°±å¯ä»¥çœ‹åˆ°RESTARTSä¸å†æ˜¯0ï¼Œè€Œæ˜¯ä¸€ç›´å¢é•¿</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods pod-liveness-exec -n dev</span>
</span></span><span style="display:flex;"><span>NAME                READY   STATUS             RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod-liveness-exec   0/1     CrashLoopBackOff   <span style="color:#ae81ff">2</span>          3m19s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å½“ç„¶æ¥ä¸‹æ¥ï¼Œå¯ä»¥ä¿®æ”¹æˆä¸€ä¸ªå­˜åœ¨çš„æ–‡ä»¶ï¼Œæ¯”å¦‚/tmp/hello.txtï¼Œå†è¯•ï¼Œç»“æœå°±æ­£å¸¸äº†......</span>
</span></span></code></pre></div><p>æ–¹å¼äºŒï¼šTCPSocket</p>
<p>åˆ›å»ºpod-liveness-tcpsocket.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-liveness-tcpsocket</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>: 
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">tcpSocket</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span> <span style="color:#75715e"># å°è¯•è®¿é—®8080ç«¯å£</span>
</span></span></code></pre></div><p>åˆ›å»ºpodï¼Œè§‚å¯Ÿæ•ˆæœ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºPod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-liveness-tcpsocket.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-liveness-tcpsocket created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹Podè¯¦æƒ…</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe pods pod-liveness-tcpsocket -n dev</span>
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>  Normal   Scheduled  31s                            default-scheduler  Successfully assigned dev/pod-liveness-tcpsocket to node2
</span></span><span style="display:flex;"><span>  Normal   Pulled     &lt;invalid&gt;                      kubelet, node2     Container image <span style="color:#e6db74">&#34;nginx:1.17.1&#34;</span> already present on machine
</span></span><span style="display:flex;"><span>  Normal   Created    &lt;invalid&gt;                      kubelet, node2     Created container nginx
</span></span><span style="display:flex;"><span>  Normal   Started    &lt;invalid&gt;                      kubelet, node2     Started container nginx
</span></span><span style="display:flex;"><span>  Warning  Unhealthy  &lt;invalid&gt; <span style="color:#f92672">(</span>x2 over &lt;invalid&gt;<span style="color:#f92672">)</span>  kubelet, node2     Liveness probe failed: dial tcp 10.244.2.44:8080: connect: connection refused
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è§‚å¯Ÿä¸Šé¢çš„ä¿¡æ¯ï¼Œå‘ç°å°è¯•è®¿é—®8080ç«¯å£,ä½†æ˜¯å¤±è´¥äº†</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¨ç­‰ä¸€ä¼šä¹‹åï¼Œå†è§‚å¯Ÿpodä¿¡æ¯ï¼Œå°±å¯ä»¥çœ‹åˆ°RESTARTSä¸å†æ˜¯0ï¼Œè€Œæ˜¯ä¸€ç›´å¢é•¿</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods pod-liveness-tcpsocket  -n dev</span>
</span></span><span style="display:flex;"><span>NAME                     READY   STATUS             RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod-liveness-tcpsocket   0/1     CrashLoopBackOff   <span style="color:#ae81ff">2</span>          3m19s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å½“ç„¶æ¥ä¸‹æ¥ï¼Œå¯ä»¥ä¿®æ”¹æˆä¸€ä¸ªå¯ä»¥è®¿é—®çš„ç«¯å£ï¼Œæ¯”å¦‚80ï¼Œå†è¯•ï¼Œç»“æœå°±æ­£å¸¸äº†......</span>
</span></span></code></pre></div><p>æ–¹å¼ä¸‰ï¼šHTTPGet</p>
<p>åˆ›å»ºpod-liveness-httpget.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-liveness-httpget</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">httpGet</span>:  <span style="color:#75715e"># å…¶å®å°±æ˜¯è®¿é—®http:/127.0.0.1:80/hello  </span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span> <span style="color:#75715e">#æ”¯æŒçš„åè®®ï¼Œhttpæˆ–è€…https</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e">#ç«¯å£å·</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/hello</span> <span style="color:#75715e">#URIåœ°å€</span>
</span></span></code></pre></div><p>åˆ›å»ºpodï¼Œè§‚å¯Ÿæ•ˆæœ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºPod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-liveness-httpget.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-liveness-httpget created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹Podè¯¦æƒ…</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe pod pod-liveness-httpget -n dev</span>
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span>  Normal   Pulled     6s <span style="color:#f92672">(</span>x3 over 64s<span style="color:#f92672">)</span>  kubelet, node1     Container image <span style="color:#e6db74">&#34;nginx:1.17.1&#34;</span> already present on machine
</span></span><span style="display:flex;"><span>  Normal   Created    6s <span style="color:#f92672">(</span>x3 over 64s<span style="color:#f92672">)</span>  kubelet, node1     Created container nginx
</span></span><span style="display:flex;"><span>  Normal   Started    6s <span style="color:#f92672">(</span>x3 over 63s<span style="color:#f92672">)</span>  kubelet, node1     Started container nginx
</span></span><span style="display:flex;"><span>  Warning  Unhealthy  6s <span style="color:#f92672">(</span>x6 over 56s<span style="color:#f92672">)</span>  kubelet, node1     Liveness probe failed: HTTP probe failed with statuscode: <span style="color:#ae81ff">404</span>
</span></span><span style="display:flex;"><span>  Normal   Killing    6s <span style="color:#f92672">(</span>x2 over 36s<span style="color:#f92672">)</span>  kubelet, node1     Container nginx failed liveness probe, will be restarted
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è§‚å¯Ÿä¸Šé¢ä¿¡æ¯ï¼Œå°è¯•è®¿é—®è·¯å¾„ï¼Œä½†æ˜¯æœªæ‰¾åˆ°,å‡ºç°404é”™è¯¯</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¨ç­‰ä¸€ä¼šä¹‹åï¼Œå†è§‚å¯Ÿpodä¿¡æ¯ï¼Œå°±å¯ä»¥çœ‹åˆ°RESTARTSä¸å†æ˜¯0ï¼Œè€Œæ˜¯ä¸€ç›´å¢é•¿</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod pod-liveness-httpget -n dev</span>
</span></span><span style="display:flex;"><span>NAME                   READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod-liveness-httpget   1/1     Running   <span style="color:#ae81ff">5</span>          3m17s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å½“ç„¶æ¥ä¸‹æ¥ï¼Œå¯ä»¥ä¿®æ”¹æˆä¸€ä¸ªå¯ä»¥è®¿é—®çš„è·¯å¾„pathï¼Œæ¯”å¦‚/ï¼Œå†è¯•ï¼Œç»“æœå°±æ­£å¸¸äº†......</span>
</span></span></code></pre></div><p>è‡³æ­¤ï¼Œå·²ç»ä½¿ç”¨liveness Probeæ¼”ç¤ºäº†ä¸‰ç§æ¢æµ‹æ–¹å¼ï¼Œä½†æ˜¯æŸ¥çœ‹livenessProbeçš„å­å±æ€§ï¼Œä¼šå‘ç°é™¤äº†è¿™ä¸‰ç§æ–¹å¼ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„é…ç½®ï¼Œåœ¨è¿™é‡Œä¸€å¹¶è§£é‡Šä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl explain pod.spec.containers.livenessProbe</span>
</span></span><span style="display:flex;"><span>FIELDS:
</span></span><span style="display:flex;"><span>   exec &lt;Object&gt;  
</span></span><span style="display:flex;"><span>   tcpSocket    &lt;Object&gt;
</span></span><span style="display:flex;"><span>   httpGet      &lt;Object&gt;
</span></span><span style="display:flex;"><span>   initialDelaySeconds  &lt;integer&gt;  <span style="color:#75715e"># å®¹å™¨å¯åŠ¨åç­‰å¾…å¤šå°‘ç§’æ‰§è¡Œç¬¬ä¸€æ¬¡æ¢æµ‹</span>
</span></span><span style="display:flex;"><span>   timeoutSeconds       &lt;integer&gt;  <span style="color:#75715e"># æ¢æµ‹è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤1ç§’ï¼Œæœ€å°1ç§’</span>
</span></span><span style="display:flex;"><span>   periodSeconds        &lt;integer&gt;  <span style="color:#75715e"># æ‰§è¡Œæ¢æµ‹çš„é¢‘ç‡ã€‚é»˜è®¤æ˜¯10ç§’ï¼Œæœ€å°1ç§’</span>
</span></span><span style="display:flex;"><span>   failureThreshold     &lt;integer&gt;  <span style="color:#75715e"># è¿ç»­æ¢æµ‹å¤±è´¥å¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºå¤±è´¥ã€‚é»˜è®¤æ˜¯3ã€‚æœ€å°å€¼æ˜¯1</span>
</span></span><span style="display:flex;"><span>   successThreshold     &lt;integer&gt;  <span style="color:#75715e"># è¿ç»­æ¢æµ‹æˆåŠŸå¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºæˆåŠŸã€‚é»˜è®¤æ˜¯1</span>
</span></span></code></pre></div><p>ä¸‹é¢ç¨å¾®é…ç½®ä¸¤ä¸ªï¼Œæ¼”ç¤ºä¸‹æ•ˆæœå³å¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>[<span style="color:#ae81ff">root@k8s-master01 ~]# more pod-liveness-httpget.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-liveness-httpget</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">initialDelaySeconds</span>: <span style="color:#ae81ff">30</span> <span style="color:#75715e"># å®¹å™¨å¯åŠ¨å30så¼€å§‹æ¢æµ‹</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">timeoutSeconds</span>: <span style="color:#ae81ff">5</span> <span style="color:#75715e"># æ¢æµ‹è¶…æ—¶æ—¶é—´ä¸º5s</span>
</span></span></code></pre></div><h5 id="535-é‡å¯ç­–ç•¥">5.3.5 é‡å¯ç­–ç•¥<a hidden class="anchor" aria-hidden="true" href="#535-é‡å¯ç­–ç•¥">#</a></h5>
<p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œä¸€æ—¦å®¹å™¨æ¢æµ‹å‡ºç°äº†é—®é¢˜ï¼Œkuberneteså°±ä¼šå¯¹å®¹å™¨æ‰€åœ¨çš„Podè¿›è¡Œé‡å¯ï¼Œå…¶å®è¿™æ˜¯ç”±podçš„é‡å¯ç­–ç•¥å†³å®šçš„ï¼Œpodçš„é‡å¯ç­–ç•¥æœ‰ 3 ç§ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</p>
<ul>
<li>Always ï¼šå®¹å™¨å¤±æ•ˆæ—¶ï¼Œè‡ªåŠ¨é‡å¯è¯¥å®¹å™¨ï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤å€¼ã€‚</li>
<li>OnFailure ï¼š å®¹å™¨ç»ˆæ­¢è¿è¡Œä¸”é€€å‡ºç ä¸ä¸º0æ—¶é‡å¯</li>
<li>Never ï¼š ä¸è®ºçŠ¶æ€ä¸ºä½•ï¼Œéƒ½ä¸é‡å¯è¯¥å®¹å™¨</li>
</ul>
<p>é‡å¯ç­–ç•¥é€‚ç”¨äºpodå¯¹è±¡ä¸­çš„æ‰€æœ‰å®¹å™¨ï¼Œé¦–æ¬¡éœ€è¦é‡å¯çš„å®¹å™¨ï¼Œå°†åœ¨å…¶éœ€è¦æ—¶ç«‹å³è¿›è¡Œé‡å¯ï¼Œéšåå†æ¬¡éœ€è¦é‡å¯çš„æ“ä½œå°†ç”±kubeletå»¶è¿Ÿä¸€æ®µæ—¶é—´åè¿›è¡Œï¼Œä¸”åå¤çš„é‡å¯æ“ä½œçš„å»¶è¿Ÿæ—¶é•¿ä»¥æ­¤ä¸º10sã€20sã€40sã€80sã€160så’Œ300sï¼Œ300sæ˜¯æœ€å¤§å»¶è¿Ÿæ—¶é•¿ã€‚</p>
<p>åˆ›å»ºpod-restartpolicy.yamlï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-restartpolicy</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-port</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">livenessProbe</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">httpGet</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">HTTP</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/hello</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never</span> <span style="color:#75715e"># è®¾ç½®é‡å¯ç­–ç•¥ä¸ºNever</span>
</span></span></code></pre></div><p>è¿è¡ŒPodæµ‹è¯•</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºPod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-restartpolicy.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-restartpolicy created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹Podè¯¦æƒ…ï¼Œå‘ç°nginxå®¹å™¨å¤±è´¥</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl  describe pods pod-restartpolicy  -n dev</span>
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>  Warning  Unhealthy  15s <span style="color:#f92672">(</span>x3 over 35s<span style="color:#f92672">)</span>  kubelet, node1     Liveness probe failed: HTTP probe failed with statuscode: <span style="color:#ae81ff">404</span>
</span></span><span style="display:flex;"><span>  Normal   Killing    15s                kubelet, node1     Container nginx failed liveness probe
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¤šç­‰ä¸€ä¼šï¼Œå†è§‚å¯Ÿpodçš„é‡å¯æ¬¡æ•°ï¼Œå‘ç°ä¸€ç›´æ˜¯0ï¼Œå¹¶æœªé‡å¯   </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl  get pods pod-restartpolicy -n dev</span>
</span></span><span style="display:flex;"><span>NAME                   READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod-restartpolicy      0/1     Running   <span style="color:#ae81ff">0</span>          5min42s
</span></span></code></pre></div><h4 id="54-podè°ƒåº¦">5.4 Podè°ƒåº¦<a hidden class="anchor" aria-hidden="true" href="#54-podè°ƒåº¦">#</a></h4>
<p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªPodåœ¨å“ªä¸ªNodeèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œæ˜¯ç”±Schedulerç»„ä»¶é‡‡ç”¨ç›¸åº”çš„ç®—æ³•è®¡ç®—å‡ºæ¥çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸å—äººå·¥æ§åˆ¶çš„ã€‚ä½†æ˜¯åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¿™å¹¶ä¸æ»¡è¶³çš„éœ€æ±‚ï¼Œå› ä¸ºå¾ˆå¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æƒ³æ§åˆ¶æŸäº›Podåˆ°è¾¾æŸäº›èŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿè¿™å°±è¦æ±‚äº†è§£kuberneteså¯¹Podçš„è°ƒåº¦è§„åˆ™ï¼Œkubernetesæä¾›äº†å››å¤§ç±»è°ƒåº¦æ–¹å¼ï¼š</p>
<ul>
<li>è‡ªåŠ¨è°ƒåº¦ï¼šè¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šå®Œå…¨ç”±Schedulerç»è¿‡ä¸€ç³»åˆ—çš„ç®—æ³•è®¡ç®—å¾—å‡º</li>
<li>å®šå‘è°ƒåº¦ï¼šNodeNameã€NodeSelector</li>
<li>äº²å’Œæ€§è°ƒåº¦ï¼šNodeAffinityã€PodAffinityã€PodAntiAffinity</li>
<li>æ±¡ç‚¹ï¼ˆå®¹å¿ï¼‰è°ƒåº¦ï¼šTaintsã€Toleration</li>
</ul>
<h5 id="541-å®šå‘è°ƒåº¦">5.4.1 å®šå‘è°ƒåº¦<a hidden class="anchor" aria-hidden="true" href="#541-å®šå‘è°ƒåº¦">#</a></h5>
<p>å®šå‘è°ƒåº¦ï¼ŒæŒ‡çš„æ˜¯åˆ©ç”¨åœ¨podä¸Šå£°æ˜nodeNameæˆ–è€…nodeSelectorï¼Œä»¥æ­¤å°†Podè°ƒåº¦åˆ°æœŸæœ›çš„nodeèŠ‚ç‚¹ä¸Šã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„è°ƒåº¦æ˜¯å¼ºåˆ¶çš„ï¼Œè¿™å°±æ„å‘³ç€å³ä½¿è¦è°ƒåº¦çš„ç›®æ ‡Nodeä¸å­˜åœ¨ï¼Œä¹Ÿä¼šå‘ä¸Šé¢è¿›è¡Œè°ƒåº¦ï¼Œåªä¸è¿‡podè¿è¡Œå¤±è´¥è€Œå·²ã€‚</p>
<p>NodeName</p>
<p>NodeNameç”¨äºå¼ºåˆ¶çº¦æŸå°†Podè°ƒåº¦åˆ°æŒ‡å®šçš„Nameçš„NodeèŠ‚ç‚¹ä¸Šã€‚è¿™ç§æ–¹å¼ï¼Œå…¶å®æ˜¯ç›´æ¥è·³è¿‡Schedulerçš„è°ƒåº¦é€»è¾‘ï¼Œç›´æ¥å°†Podè°ƒåº¦åˆ°æŒ‡å®šåç§°çš„èŠ‚ç‚¹ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œå®éªŒä¸€ä¸‹ï¼šåˆ›å»ºä¸€ä¸ªpod-nodename.yamlæ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-nodename</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeName</span>: <span style="color:#ae81ff">node1</span> <span style="color:#75715e"># æŒ‡å®šè°ƒåº¦åˆ°node1èŠ‚ç‚¹ä¸Š</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#åˆ›å»ºPod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-nodename.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-nodename created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#æŸ¥çœ‹Podè°ƒåº¦åˆ°NODEå±æ€§ï¼Œç¡®å®æ˜¯è°ƒåº¦åˆ°äº†node1èŠ‚ç‚¹ä¸Š</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods pod-nodename -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME           READY   STATUS    RESTARTS   AGE   IP            NODE      ......
</span></span><span style="display:flex;"><span>pod-nodename   1/1     Running   <span style="color:#ae81ff">0</span>          56s   10.244.1.87   node1     ......   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¥ä¸‹æ¥ï¼Œåˆ é™¤podï¼Œä¿®æ”¹nodeNameçš„å€¼ä¸ºnode3ï¼ˆå¹¶æ²¡æœ‰node3èŠ‚ç‚¹ï¼‰</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete -f pod-nodename.yaml</span>
</span></span><span style="display:flex;"><span>pod <span style="color:#e6db74">&#34;pod-nodename&#34;</span> deleted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim pod-nodename.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-nodename.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-nodename created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#å†æ¬¡æŸ¥çœ‹ï¼Œå‘ç°å·²ç»å‘Node3èŠ‚ç‚¹è°ƒåº¦ï¼Œä½†æ˜¯ç”±äºä¸å­˜åœ¨node3èŠ‚ç‚¹ï¼Œæ‰€ä»¥podæ— æ³•æ­£å¸¸è¿è¡Œ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods pod-nodename -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME           READY   STATUS    RESTARTS   AGE   IP       NODE    ......
</span></span><span style="display:flex;"><span>pod-nodename   0/1     Pending   <span style="color:#ae81ff">0</span>          6s    &lt;none&gt;   node3   ......           
</span></span></code></pre></div><p>NodeSelector</p>
<p>NodeSelectorç”¨äºå°†podè°ƒåº¦åˆ°æ·»åŠ äº†æŒ‡å®šæ ‡ç­¾çš„nodeèŠ‚ç‚¹ä¸Šã€‚å®ƒæ˜¯é€šè¿‡kubernetesçš„label-selectoræœºåˆ¶å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨podåˆ›å»ºä¹‹å‰ï¼Œä¼šç”±schedulerä½¿ç”¨MatchNodeSelectorè°ƒåº¦ç­–ç•¥è¿›è¡ŒlabelåŒ¹é…ï¼Œæ‰¾å‡ºç›®æ ‡nodeï¼Œç„¶åå°†podè°ƒåº¦åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œè¯¥åŒ¹é…è§„åˆ™æ˜¯å¼ºåˆ¶çº¦æŸã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œå®éªŒä¸€ä¸‹ï¼š</p>
<p>1 é¦–å…ˆåˆ†åˆ«ä¸ºnodeèŠ‚ç‚¹æ·»åŠ æ ‡ç­¾</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl label nodes node1 nodeenv=pro</span>
</span></span><span style="display:flex;"><span>node/node2 labeled
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl label nodes node2 nodeenv=test</span>
</span></span><span style="display:flex;"><span>node/node2 labeled
</span></span></code></pre></div><p>2 åˆ›å»ºä¸€ä¸ªpod-nodeselector.yamlæ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨å®ƒåˆ›å»ºPod</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-nodeselector</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeSelector</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodeenv</span>: <span style="color:#ae81ff">pro</span> <span style="color:#75715e"># æŒ‡å®šè°ƒåº¦åˆ°å…·æœ‰nodeenv=proæ ‡ç­¾çš„èŠ‚ç‚¹ä¸Š</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#åˆ›å»ºPod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-nodeselector.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-nodeselector created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#æŸ¥çœ‹Podè°ƒåº¦åˆ°NODEå±æ€§ï¼Œç¡®å®æ˜¯è°ƒåº¦åˆ°äº†node1èŠ‚ç‚¹ä¸Š</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods pod-nodeselector -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME               READY   STATUS    RESTARTS   AGE     IP          NODE    ......
</span></span><span style="display:flex;"><span>pod-nodeselector   1/1     Running   <span style="color:#ae81ff">0</span>          47s   10.244.1.87   node1   ......
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¥ä¸‹æ¥ï¼Œåˆ é™¤podï¼Œä¿®æ”¹nodeSelectorçš„å€¼ä¸ºnodeenv: xxxxï¼ˆä¸å­˜åœ¨æ‰“æœ‰æ­¤æ ‡ç­¾çš„èŠ‚ç‚¹ï¼‰</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete -f pod-nodeselector.yaml</span>
</span></span><span style="display:flex;"><span>pod <span style="color:#e6db74">&#34;pod-nodeselector&#34;</span> deleted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim pod-nodeselector.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-nodeselector.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-nodeselector created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#å†æ¬¡æŸ¥çœ‹ï¼Œå‘ç°podæ— æ³•æ­£å¸¸è¿è¡Œ,Nodeçš„å€¼ä¸ºnone</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME               READY   STATUS    RESTARTS   AGE     IP       NODE    
</span></span><span style="display:flex;"><span>pod-nodeselector   0/1     Pending   <span style="color:#ae81ff">0</span>          2m20s   &lt;none&gt;   &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹è¯¦æƒ…,å‘ç°node selectoråŒ¹é…å¤±è´¥çš„æç¤º</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe pods pod-nodeselector -n dev</span>
</span></span><span style="display:flex;"><span>.......
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type     Reason            Age        From               Message
</span></span><span style="display:flex;"><span>  ----     ------            ----       ----               -------
</span></span><span style="display:flex;"><span>  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available: <span style="color:#ae81ff">3</span> node<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> didn<span style="color:#960050;background-color:#1e0010">&#39;</span>t match node selector.
</span></span></code></pre></div><h5 id="542-äº²å’Œæ€§è°ƒåº¦">5.4.2 äº²å’Œæ€§è°ƒåº¦<a hidden class="anchor" aria-hidden="true" href="#542-äº²å’Œæ€§è°ƒåº¦">#</a></h5>
<p>ä¸Šä¸€èŠ‚ï¼Œä»‹ç»äº†ä¸¤ç§å®šå‘è°ƒåº¦çš„æ–¹å¼ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€å®šçš„é—®é¢˜ï¼Œé‚£å°±æ˜¯å¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„Nodeï¼Œé‚£ä¹ˆPodå°†ä¸ä¼šè¢«è¿è¡Œï¼Œå³ä½¿åœ¨é›†ç¾¤ä¸­è¿˜æœ‰å¯ç”¨Nodeåˆ—è¡¨ä¹Ÿä¸è¡Œï¼Œè¿™å°±é™åˆ¶äº†å®ƒçš„ä½¿ç”¨åœºæ™¯ã€‚</p>
<p>åŸºäºä¸Šé¢çš„é—®é¢˜ï¼Œkubernetesè¿˜æä¾›äº†ä¸€ç§äº²å’Œæ€§è°ƒåº¦ï¼ˆAffinityï¼‰ã€‚å®ƒåœ¨NodeSelectorçš„åŸºç¡€ä¹‹ä¸Šçš„è¿›è¡Œäº†æ‰©å±•ï¼Œå¯ä»¥é€šè¿‡é…ç½®çš„å½¢å¼ï¼Œå®ç°ä¼˜å…ˆé€‰æ‹©æ»¡è¶³æ¡ä»¶çš„Nodeè¿›è¡Œè°ƒåº¦ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä¹Ÿå¯ä»¥è°ƒåº¦åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Šï¼Œä½¿è°ƒåº¦æ›´åŠ çµæ´»ã€‚</p>
<p>Affinityä¸»è¦åˆ†ä¸ºä¸‰ç±»ï¼š</p>
<ul>
<li>nodeAffinity(nodeäº²å’Œæ€§ï¼‰: ä»¥nodeä¸ºç›®æ ‡ï¼Œè§£å†³podå¯ä»¥è°ƒåº¦åˆ°å“ªäº›nodeçš„é—®é¢˜</li>
<li>podAffinity(podäº²å’Œæ€§) : ä»¥podä¸ºç›®æ ‡ï¼Œè§£å†³podå¯ä»¥å’Œå“ªäº›å·²å­˜åœ¨çš„podéƒ¨ç½²åœ¨åŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸­çš„é—®é¢˜</li>
<li>podAntiAffinity(podåäº²å’Œæ€§) : ä»¥podä¸ºç›®æ ‡ï¼Œè§£å†³podä¸èƒ½å’Œå“ªäº›å·²å­˜åœ¨podéƒ¨ç½²åœ¨åŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸­çš„é—®é¢˜</li>
</ul>
<blockquote>
<p>å…³äºäº²å’Œæ€§(åäº²å’Œæ€§)ä½¿ç”¨åœºæ™¯çš„è¯´æ˜ï¼š</p>
<p>äº²å’Œæ€§ï¼šå¦‚æœä¸¤ä¸ªåº”ç”¨é¢‘ç¹äº¤äº’ï¼Œé‚£å°±æœ‰å¿…è¦åˆ©ç”¨äº²å’Œæ€§è®©ä¸¤ä¸ªåº”ç”¨çš„å°½å¯èƒ½çš„é è¿‘ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å› ç½‘ç»œé€šä¿¡è€Œå¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚</p>
<p>åäº²å’Œæ€§ï¼šå½“åº”ç”¨çš„é‡‡ç”¨å¤šå‰¯æœ¬éƒ¨ç½²æ—¶ï¼Œæœ‰å¿…è¦é‡‡ç”¨åäº²å’Œæ€§è®©å„ä¸ªåº”ç”¨å®ä¾‹æ‰“æ•£åˆ†å¸ƒåœ¨å„ä¸ªnodeä¸Šï¼Œè¿™æ ·å¯ä»¥æé«˜æœåŠ¡çš„é«˜å¯ç”¨æ€§ã€‚</p>
</blockquote>
<p>NodeAffinity</p>
<p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹<code>NodeAffinity</code>çš„å¯é…ç½®é¡¹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span>pod.spec.affinity.nodeAffinity
</span></span><span style="display:flex;"><span>  requiredDuringSchedulingIgnoredDuringExecution  NodeèŠ‚ç‚¹å¿…é¡»æ»¡è¶³æŒ‡å®šçš„æ‰€æœ‰è§„åˆ™æ‰å¯ä»¥ï¼Œç›¸å½“äºç¡¬é™åˆ¶
</span></span><span style="display:flex;"><span>    nodeSelectorTerms  èŠ‚ç‚¹é€‰æ‹©åˆ—è¡¨
</span></span><span style="display:flex;"><span>      matchFields   æŒ‰èŠ‚ç‚¹å­—æ®µåˆ—å‡ºçš„èŠ‚ç‚¹é€‰æ‹©å™¨è¦æ±‚åˆ—è¡¨
</span></span><span style="display:flex;"><span>      matchExpressions   æŒ‰èŠ‚ç‚¹æ ‡ç­¾åˆ—å‡ºçš„èŠ‚ç‚¹é€‰æ‹©å™¨è¦æ±‚åˆ—è¡¨(æ¨è)
</span></span><span style="display:flex;"><span>        key    é”®
</span></span><span style="display:flex;"><span>        values å€¼
</span></span><span style="display:flex;"><span>        operat or å…³ç³»ç¬¦ æ”¯æŒExists, DoesNotExist, In, NotIn, Gt, Lt
</span></span><span style="display:flex;"><span>  preferredDuringSchedulingIgnoredDuringExecution ä¼˜å…ˆè°ƒåº¦åˆ°æ»¡è¶³æŒ‡å®šçš„è§„åˆ™çš„Nodeï¼Œç›¸å½“äºè½¯é™åˆ¶ (å€¾å‘)
</span></span><span style="display:flex;"><span>    preference   ä¸€ä¸ªèŠ‚ç‚¹é€‰æ‹©å™¨é¡¹ï¼Œä¸ç›¸åº”çš„æƒé‡ç›¸å…³è”
</span></span><span style="display:flex;"><span>      matchFields   æŒ‰èŠ‚ç‚¹å­—æ®µåˆ—å‡ºçš„èŠ‚ç‚¹é€‰æ‹©å™¨è¦æ±‚åˆ—è¡¨
</span></span><span style="display:flex;"><span>      matchExpressions   æŒ‰èŠ‚ç‚¹æ ‡ç­¾åˆ—å‡ºçš„èŠ‚ç‚¹é€‰æ‹©å™¨è¦æ±‚åˆ—è¡¨(æ¨è)
</span></span><span style="display:flex;"><span>        key    é”®
</span></span><span style="display:flex;"><span>        values å€¼
</span></span><span style="display:flex;"><span>        operator å…³ç³»ç¬¦ æ”¯æŒIn, NotIn, Exists, DoesNotExist, Gt, Lt
</span></span><span style="display:flex;"><span> weight å€¾å‘æƒé‡ï¼Œåœ¨èŒƒå›´1-100ã€‚
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>å…³ç³»ç¬¦çš„ä½¿ç”¨è¯´æ˜:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- matchExpressions:
</span></span><span style="display:flex;"><span>  - key: nodeenv              <span style="color:#75715e"># åŒ¹é…å­˜åœ¨æ ‡ç­¾çš„keyä¸ºnodeenvçš„èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span>    operator: Exists
</span></span><span style="display:flex;"><span>  - key: nodeenv              <span style="color:#75715e"># åŒ¹é…æ ‡ç­¾çš„keyä¸ºnodeenv,ä¸”valueæ˜¯&#34;xxx&#34;æˆ–&#34;yyy&#34;çš„èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span>    operator: In
</span></span><span style="display:flex;"><span>    values: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;xxx&#34;</span>,<span style="color:#e6db74">&#34;yyy&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  - key: nodeenv              <span style="color:#75715e"># åŒ¹é…æ ‡ç­¾çš„keyä¸ºnodeenv,ä¸”valueå¤§äº&#34;xxx&#34;çš„èŠ‚ç‚¹</span>
</span></span><span style="display:flex;"><span>    operator: Gt
</span></span><span style="display:flex;"><span>    values: <span style="color:#e6db74">&#34;xxx&#34;</span>
</span></span></code></pre></div><p>æ¥ä¸‹æ¥é¦–å…ˆæ¼”ç¤ºä¸€ä¸‹<code>requiredDuringSchedulingIgnoredDuringExecution</code> ,</p>
<p>åˆ›å»ºpod-nodeaffinity-required.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-nodeaffinity-required</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">affinity</span>:  <span style="color:#75715e">#äº²å’Œæ€§è®¾ç½®</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodeAffinity</span>: <span style="color:#75715e">#è®¾ç½®nodeäº²å’Œæ€§</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requiredDuringSchedulingIgnoredDuringExecution</span>: <span style="color:#75715e"># ç¡¬é™åˆ¶</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">nodeSelectorTerms</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># åŒ¹é…envçš„å€¼åœ¨[&#34;xxx&#34;,&#34;yyy&#34;]ä¸­çš„æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">nodeenv</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">values</span>: [<span style="color:#e6db74">&#34;xxx&#34;</span>,<span style="color:#e6db74">&#34;yyy&#34;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºpod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-nodeaffinity-required.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-nodeaffinity-required created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹podçŠ¶æ€ ï¼ˆè¿è¡Œå¤±è´¥ï¼‰</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods pod-nodeaffinity-required -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                        READY   STATUS    RESTARTS   AGE   IP       NODE    ...... 
</span></span><span style="display:flex;"><span>pod-nodeaffinity-required   0/1     Pending   <span style="color:#ae81ff">0</span>          16s   &lt;none&gt;   &lt;none&gt;  ......
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹Podçš„è¯¦æƒ…</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å‘ç°è°ƒåº¦å¤±è´¥ï¼Œæç¤ºnodeé€‰æ‹©å¤±è´¥</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe pod pod-nodeaffinity-required -n dev</span>
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available: <span style="color:#ae81ff">3</span> node<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> didn<span style="color:#e6db74">&#39;t match node selector.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available: 3 node(s) didn&#39;</span>t match node selector.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#æ¥ä¸‹æ¥ï¼Œåœæ­¢pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete -f pod-nodeaffinity-required.yaml</span>
</span></span><span style="display:flex;"><span>pod <span style="color:#e6db74">&#34;pod-nodeaffinity-required&#34;</span> deleted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿®æ”¹æ–‡ä»¶ï¼Œå°†values: [&#34;xxx&#34;,&#34;yyy&#34;]------&gt; [&#34;pro&#34;,&#34;yyy&#34;]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim pod-nodeaffinity-required.yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å†æ¬¡å¯åŠ¨</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-nodeaffinity-required.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-nodeaffinity-required created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ­¤æ—¶æŸ¥çœ‹ï¼Œå‘ç°è°ƒåº¦æˆåŠŸï¼Œå·²ç»å°†podè°ƒåº¦åˆ°äº†node1ä¸Š</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods pod-nodeaffinity-required -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                        READY   STATUS    RESTARTS   AGE   IP            NODE  ...... 
</span></span><span style="display:flex;"><span>pod-nodeaffinity-required   1/1     Running   <span style="color:#ae81ff">0</span>          11s   10.244.1.89   node1 ......
</span></span></code></pre></div><p>æ¥ä¸‹æ¥å†æ¼”ç¤ºä¸€ä¸‹<code>requiredDuringSchedulingIgnoredDuringExecution</code> ,</p>
<p>åˆ›å»ºpod-nodeaffinity-preferred.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-nodeaffinity-preferred</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">affinity</span>:  <span style="color:#75715e">#äº²å’Œæ€§è®¾ç½®</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodeAffinity</span>: <span style="color:#75715e">#è®¾ç½®nodeäº²å’Œæ€§</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">preferredDuringSchedulingIgnoredDuringExecution</span>: <span style="color:#75715e"># è½¯é™åˆ¶</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">weight</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">preference</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># åŒ¹é…envçš„å€¼åœ¨[&#34;xxx&#34;,&#34;yyy&#34;]ä¸­çš„æ ‡ç­¾(å½“å‰ç¯å¢ƒæ²¡æœ‰)</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">nodeenv</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">values</span>: [<span style="color:#e6db74">&#34;xxx&#34;</span>,<span style="color:#e6db74">&#34;yyy&#34;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºpod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-nodeaffinity-preferred.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-nodeaffinity-preferred created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹podçŠ¶æ€ ï¼ˆè¿è¡ŒæˆåŠŸï¼‰</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod pod-nodeaffinity-preferred -n dev</span>
</span></span><span style="display:flex;"><span>NAME                         READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod-nodeaffinity-preferred   1/1     Running   <span style="color:#ae81ff">0</span>          40s
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>NodeAffinityè§„åˆ™è®¾ç½®çš„æ³¨æ„äº‹é¡¹ï¼š
</span></span><span style="display:flex;"><span>    1 å¦‚æœåŒæ—¶å®šä¹‰äº†nodeSelectorå’ŒnodeAffinityï¼Œé‚£ä¹ˆå¿…é¡»ä¸¤ä¸ªæ¡ä»¶éƒ½å¾—åˆ°æ»¡è¶³ï¼ŒPodæ‰èƒ½è¿è¡Œåœ¨æŒ‡å®šçš„Nodeä¸Š
</span></span><span style="display:flex;"><span>    2 å¦‚æœnodeAffinityæŒ‡å®šäº†å¤šä¸ªnodeSelectorTermsï¼Œé‚£ä¹ˆåªéœ€è¦å…¶ä¸­ä¸€ä¸ªèƒ½å¤ŸåŒ¹é…æˆåŠŸå³å¯
</span></span><span style="display:flex;"><span>    3 å¦‚æœä¸€ä¸ªnodeSelectorTermsä¸­æœ‰å¤šä¸ªmatchExpressions ï¼Œåˆ™ä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»æ»¡è¶³æ‰€æœ‰çš„æ‰èƒ½åŒ¹é…æˆåŠŸ
</span></span><span style="display:flex;"><span>    4 å¦‚æœä¸€ä¸ªpodæ‰€åœ¨çš„Nodeåœ¨Podè¿è¡ŒæœŸé—´å…¶æ ‡ç­¾å‘ç”Ÿäº†æ”¹å˜ï¼Œä¸å†ç¬¦åˆè¯¥Podçš„èŠ‚ç‚¹äº²å’Œæ€§éœ€æ±‚ï¼Œåˆ™ç³»ç»Ÿå°†å¿½ç•¥æ­¤å˜åŒ–
</span></span></code></pre></div><p>PodAffinity</p>
<p>PodAffinityä¸»è¦å®ç°ä»¥è¿è¡Œçš„Podä¸ºå‚ç…§ï¼Œå®ç°è®©æ–°åˆ›å»ºçš„Podè·Ÿå‚ç…§podåœ¨ä¸€ä¸ªåŒºåŸŸçš„åŠŸèƒ½ã€‚</p>
<p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹<code>PodAffinity</code>çš„å¯é…ç½®é¡¹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span>pod.spec.affinity.podAffinity
</span></span><span style="display:flex;"><span>  requiredDuringSchedulingIgnoredDuringExecution  ç¡¬é™åˆ¶
</span></span><span style="display:flex;"><span>    namespaces       æŒ‡å®šå‚ç…§podçš„namespace
</span></span><span style="display:flex;"><span>    topologyKey      æŒ‡å®šè°ƒåº¦ä½œç”¨åŸŸ
</span></span><span style="display:flex;"><span>    labelSelector    æ ‡ç­¾é€‰æ‹©å™¨
</span></span><span style="display:flex;"><span>      matchExpressions  æŒ‰èŠ‚ç‚¹æ ‡ç­¾åˆ—å‡ºçš„èŠ‚ç‚¹é€‰æ‹©å™¨è¦æ±‚åˆ—è¡¨(æ¨è)
</span></span><span style="display:flex;"><span>        key    é”®
</span></span><span style="display:flex;"><span>        values å€¼
</span></span><span style="display:flex;"><span>        operator å…³ç³»ç¬¦ æ”¯æŒIn, NotIn, Exists, DoesNotExist.
</span></span><span style="display:flex;"><span>      matchLabels    æŒ‡å¤šä¸ªmatchExpressionsæ˜ å°„çš„å†…å®¹
</span></span><span style="display:flex;"><span>  preferredDuringSchedulingIgnoredDuringExecution è½¯é™åˆ¶
</span></span><span style="display:flex;"><span>    podAffinityTerm  é€‰é¡¹
</span></span><span style="display:flex;"><span>      namespaces      
</span></span><span style="display:flex;"><span>      topologyKey
</span></span><span style="display:flex;"><span>      labelSelector
</span></span><span style="display:flex;"><span>        matchExpressions  
</span></span><span style="display:flex;"><span>          key    é”®
</span></span><span style="display:flex;"><span>          values å€¼
</span></span><span style="display:flex;"><span>          operator
</span></span><span style="display:flex;"><span>        matchLabels 
</span></span><span style="display:flex;"><span>    weight å€¾å‘æƒé‡ï¼Œåœ¨èŒƒå›´1-100
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span>topologyKeyç”¨äºæŒ‡å®šè°ƒåº¦æ—¶ä½œç”¨åŸŸ,ä¾‹å¦‚:
</span></span><span style="display:flex;"><span>å¦‚æœæŒ‡å®šä¸ºkubernetes.io/hostnameï¼Œé‚£å°±æ˜¯ä»¥NodeèŠ‚ç‚¹ä¸ºåŒºåˆ†èŒƒå›´
</span></span><span style="display:flex;"><span>å¦‚æœæŒ‡å®šä¸ºbeta.kubernetes.io/os,åˆ™ä»¥NodeèŠ‚ç‚¹çš„æ“ä½œç³»ç»Ÿç±»å‹æ¥åŒºåˆ†
</span></span></code></pre></div><p>æ¥ä¸‹æ¥ï¼Œæ¼”ç¤ºä¸‹<code>requiredDuringSchedulingIgnoredDuringExecution</code>,</p>
<p>1ï¼‰é¦–å…ˆåˆ›å»ºä¸€ä¸ªå‚ç…§Podï¼Œpod-podaffinity-target.yamlï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-podaffinity-target</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">podenv</span>: <span style="color:#ae81ff">pro</span> <span style="color:#75715e">#è®¾ç½®æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeName</span>: <span style="color:#ae81ff">node1</span> <span style="color:#75715e"># å°†ç›®æ ‡podåç¡®æŒ‡å®šåˆ°node1ä¸Š</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># å¯åŠ¨ç›®æ ‡pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-podaffinity-target.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-podaffinity-target created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹podçŠ¶å†µ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods  pod-podaffinity-target -n dev</span>
</span></span><span style="display:flex;"><span>NAME                     READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod-podaffinity-target   1/1     Running   <span style="color:#ae81ff">0</span>          4s
</span></span></code></pre></div><p>2ï¼‰åˆ›å»ºpod-podaffinity-required.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-podaffinity-required</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">affinity</span>:  <span style="color:#75715e">#äº²å’Œæ€§è®¾ç½®</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">podAffinity</span>: <span style="color:#75715e">#è®¾ç½®podäº²å’Œæ€§</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requiredDuringSchedulingIgnoredDuringExecution</span>: <span style="color:#75715e"># ç¡¬é™åˆ¶</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">labelSelector</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># åŒ¹é…envçš„å€¼åœ¨[&#34;xxx&#34;,&#34;yyy&#34;]ä¸­çš„æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">podenv</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">values</span>: [<span style="color:#e6db74">&#34;xxx&#34;</span>,<span style="color:#e6db74">&#34;yyy&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">topologyKey</span>: <span style="color:#ae81ff">kubernetes.io/hostname</span>
</span></span></code></pre></div><p>ä¸Šé¢é…ç½®è¡¨è¾¾çš„æ„æ€æ˜¯ï¼šæ–°Podå¿…é¡»è¦ä¸æ‹¥æœ‰æ ‡ç­¾nodeenv=xxxæˆ–è€…nodeenv=yyyçš„podåœ¨åŒä¸€Nodeä¸Šï¼Œæ˜¾ç„¶ç°åœ¨æ²¡æœ‰è¿™æ ·podï¼Œæ¥ä¸‹æ¥ï¼Œè¿è¡Œæµ‹è¯•ä¸€ä¸‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># å¯åŠ¨pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-podaffinity-required.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-podaffinity-required created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹podçŠ¶æ€ï¼Œå‘ç°æœªè¿è¡Œ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods pod-podaffinity-required -n dev</span>
</span></span><span style="display:flex;"><span>NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod-podaffinity-required   0/1     Pending   <span style="color:#ae81ff">0</span>          9s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe pods pod-podaffinity-required  -n dev</span>
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type     Reason            Age        From               Message
</span></span><span style="display:flex;"><span>  ----     ------            ----       ----               -------
</span></span><span style="display:flex;"><span>  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available: <span style="color:#ae81ff">2</span> node<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> didn<span style="color:#e6db74">&#39;t match pod affinity rules, 1 node(s) had taints that the pod didn&#39;</span>t tolerate.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¥ä¸‹æ¥ä¿®æ”¹  values: [&#34;xxx&#34;,&#34;yyy&#34;]-----&gt;values:[&#34;pro&#34;,&#34;yyy&#34;]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ„æ€æ˜¯ï¼šæ–°Podå¿…é¡»è¦ä¸æ‹¥æœ‰æ ‡ç­¾nodeenv=xxxæˆ–è€…nodeenv=yyyçš„podåœ¨åŒä¸€Nodeä¸Š</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim pod-podaffinity-required.yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç„¶åé‡æ–°åˆ›å»ºpodï¼ŒæŸ¥çœ‹æ•ˆæœ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete -f  pod-podaffinity-required.yaml</span>
</span></span><span style="display:flex;"><span>pod <span style="color:#e6db74">&#34;pod-podaffinity-required&#34;</span> de leted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-podaffinity-required.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-podaffinity-required created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å‘ç°æ­¤æ—¶Podè¿è¡Œæ­£å¸¸</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods pod-podaffinity-required -n dev</span>
</span></span><span style="display:flex;"><span>NAME                       READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span style="display:flex;"><span>pod-podaffinity-required   1/1     Running   <span style="color:#ae81ff">0</span>          6s    &lt;none&gt;
</span></span></code></pre></div><p>å…³äº<code>PodAffinity</code>çš„ <code>preferredDuringSchedulingIgnoredDuringExecution</code>ï¼Œè¿™é‡Œä¸å†æ¼”ç¤ºã€‚</p>
<p>PodAntiAffinity</p>
<p>PodAntiAffinityä¸»è¦å®ç°ä»¥è¿è¡Œçš„Podä¸ºå‚ç…§ï¼Œè®©æ–°åˆ›å»ºçš„Podè·Ÿå‚ç…§podä¸åœ¨ä¸€ä¸ªåŒºåŸŸä¸­çš„åŠŸèƒ½ã€‚</p>
<p>å®ƒçš„é…ç½®æ–¹å¼å’Œé€‰é¡¹è·ŸPodAffintyæ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œä¸å†åšè¯¦ç»†è§£é‡Šï¼Œç›´æ¥åšä¸€ä¸ªæµ‹è¯•æ¡ˆä¾‹ã€‚</p>
<p>1ï¼‰ç»§ç»­ä½¿ç”¨ä¸Šä¸ªæ¡ˆä¾‹ä¸­ç›®æ ‡pod</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -o wide --show-labels</span>
</span></span><span style="display:flex;"><span>NAME                     READY   STATUS    RESTARTS   AGE     IP            NODE    LABELS
</span></span><span style="display:flex;"><span>pod-podaffinity-required 1/1     Running   <span style="color:#ae81ff">0</span>          3m29s   10.244.1.38   node1   &lt;none&gt;     
</span></span><span style="display:flex;"><span>pod-podaffinity-target   1/1     Running   <span style="color:#ae81ff">0</span>          9m25s   10.244.1.37   node1   podenv<span style="color:#f92672">=</span>pro
</span></span></code></pre></div><p>2ï¼‰åˆ›å»ºpod-podantiaffinity-required.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-podantiaffinity-required</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">affinity</span>:  <span style="color:#75715e">#äº²å’Œæ€§è®¾ç½®</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">podAntiAffinity</span>: <span style="color:#75715e">#è®¾ç½®podäº²å’Œæ€§</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">requiredDuringSchedulingIgnoredDuringExecution</span>: <span style="color:#75715e"># ç¡¬é™åˆ¶</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">labelSelector</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># åŒ¹é…podenvçš„å€¼åœ¨[&#34;pro&#34;]ä¸­çš„æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">podenv</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">values</span>: [<span style="color:#e6db74">&#34;pro&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">topologyKey</span>: <span style="color:#ae81ff">kubernetes.io/hostname</span>
</span></span></code></pre></div><p>ä¸Šé¢é…ç½®è¡¨è¾¾çš„æ„æ€æ˜¯ï¼šæ–°Podå¿…é¡»è¦ä¸æ‹¥æœ‰æ ‡ç­¾nodeenv=proçš„podä¸åœ¨åŒä¸€Nodeä¸Šï¼Œè¿è¡Œæµ‹è¯•ä¸€ä¸‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºpod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-podantiaffinity-required.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-podantiaffinity-required created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pod</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å‘ç°è°ƒåº¦åˆ°äº†node2ä¸Š</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods pod-podantiaffinity-required -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                           READY   STATUS    RESTARTS   AGE   IP            NODE   .. 
</span></span><span style="display:flex;"><span>pod-podantiaffinity-required   1/1     Running   <span style="color:#ae81ff">0</span>          30s   10.244.1.96   node2  ..
</span></span></code></pre></div><h5 id="543-æ±¡ç‚¹å’Œå®¹å¿">5.4.3 æ±¡ç‚¹å’Œå®¹å¿<a hidden class="anchor" aria-hidden="true" href="#543-æ±¡ç‚¹å’Œå®¹å¿">#</a></h5>
<p>æ±¡ç‚¹ï¼ˆTaintsï¼‰</p>
<p>å‰é¢çš„è°ƒåº¦æ–¹å¼éƒ½æ˜¯ç«™åœ¨Podçš„è§’åº¦ä¸Šï¼Œé€šè¿‡åœ¨Podä¸Šæ·»åŠ å±æ€§ï¼Œæ¥ç¡®å®šPodæ˜¯å¦è¦è°ƒåº¦åˆ°æŒ‡å®šçš„Nodeä¸Šï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥ç«™åœ¨Nodeçš„è§’åº¦ä¸Šï¼Œé€šè¿‡åœ¨Nodeä¸Šæ·»åŠ æ±¡ç‚¹å±æ€§ï¼Œæ¥å†³å®šæ˜¯å¦å…è®¸Podè°ƒåº¦è¿‡æ¥ã€‚</p>
<p>Nodeè¢«è®¾ç½®ä¸Šæ±¡ç‚¹ä¹‹åå°±å’ŒPodä¹‹é—´å­˜åœ¨äº†ä¸€ç§ç›¸æ–¥çš„å…³ç³»ï¼Œè¿›è€Œæ‹’ç»Podè°ƒåº¦è¿›æ¥ï¼Œç”šè‡³å¯ä»¥å°†å·²ç»å­˜åœ¨çš„Podé©±é€å‡ºå»ã€‚</p>
<p>æ±¡ç‚¹çš„æ ¼å¼ä¸ºï¼š<code>key=value:effect</code>, keyå’Œvalueæ˜¯æ±¡ç‚¹çš„æ ‡ç­¾ï¼Œeffectæè¿°æ±¡ç‚¹çš„ä½œç”¨ï¼Œæ”¯æŒå¦‚ä¸‹ä¸‰ä¸ªé€‰é¡¹ï¼š</p>
<ul>
<li>PreferNoScheduleï¼škuberneteså°†å°½é‡é¿å…æŠŠPodè°ƒåº¦åˆ°å…·æœ‰è¯¥æ±¡ç‚¹çš„Nodeä¸Šï¼Œé™¤éæ²¡æœ‰å…¶ä»–èŠ‚ç‚¹å¯è°ƒåº¦</li>
<li>NoScheduleï¼škuberneteså°†ä¸ä¼šæŠŠPodè°ƒåº¦åˆ°å…·æœ‰è¯¥æ±¡ç‚¹çš„Nodeä¸Šï¼Œä½†ä¸ä¼šå½±å“å½“å‰Nodeä¸Šå·²å­˜åœ¨çš„Pod</li>
<li>NoExecuteï¼škuberneteså°†ä¸ä¼šæŠŠPodè°ƒåº¦åˆ°å…·æœ‰è¯¥æ±¡ç‚¹çš„Nodeä¸Šï¼ŒåŒæ—¶ä¹Ÿä¼šå°†Nodeä¸Šå·²å­˜åœ¨çš„Podé©±ç¦»</li>
</ul>
<p><img loading="lazy" src="/kubernetes.images/image-20200605021831545.png" alt="image-20200605021606508"  />
</p>
<p>ä½¿ç”¨kubectlè®¾ç½®å’Œå»é™¤æ±¡ç‚¹çš„å‘½ä»¤ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># è®¾ç½®æ±¡ç‚¹</span>
</span></span><span style="display:flex;"><span>kubectl taint nodes node1 key<span style="color:#f92672">=</span>value:effect
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å»é™¤æ±¡ç‚¹</span>
</span></span><span style="display:flex;"><span>kubectl taint nodes node1 key:effect-
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å»é™¤æ‰€æœ‰æ±¡ç‚¹</span>
</span></span><span style="display:flex;"><span>kubectl taint nodes node1 key-
</span></span></code></pre></div><p>æ¥ä¸‹æ¥ï¼Œæ¼”ç¤ºä¸‹æ±¡ç‚¹çš„æ•ˆæœï¼š</p>
<ol>
<li>å‡†å¤‡èŠ‚ç‚¹node1ï¼ˆä¸ºäº†æ¼”ç¤ºæ•ˆæœæ›´åŠ æ˜æ˜¾ï¼Œæš‚æ—¶åœæ­¢node2èŠ‚ç‚¹ï¼‰</li>
<li>ä¸ºnode1èŠ‚ç‚¹è®¾ç½®ä¸€ä¸ªæ±¡ç‚¹: <code>tag=heima:PreferNoSchedule</code>ï¼›ç„¶ååˆ›å»ºpod1( pod1 å¯ä»¥ )</li>
<li>ä¿®æ”¹ä¸ºnode1èŠ‚ç‚¹è®¾ç½®ä¸€ä¸ªæ±¡ç‚¹: <code>tag=heima:NoSchedule</code>ï¼›ç„¶ååˆ›å»ºpod2( pod1 æ­£å¸¸ pod2 å¤±è´¥ )</li>
<li>ä¿®æ”¹ä¸ºnode1èŠ‚ç‚¹è®¾ç½®ä¸€ä¸ªæ±¡ç‚¹: <code>tag=heima:NoExecute</code>ï¼›ç„¶ååˆ›å»ºpod3 ( 3ä¸ªpodéƒ½å¤±è´¥ )</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ä¸ºnode1è®¾ç½®æ±¡ç‚¹(PreferNoSchedule)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl taint nodes node1 tag=heima:PreferNoSchedule</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºpod1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl run taint1 --image=nginx:1.17.1 -n dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                      READY   STATUS    RESTARTS   AGE     IP           NODE   
</span></span><span style="display:flex;"><span>taint1-7665f7fd85-574h4   1/1     Running   <span style="color:#ae81ff">0</span>          2m24s   10.244.1.59   node1    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸ºnode1è®¾ç½®æ±¡ç‚¹(å–æ¶ˆPreferNoScheduleï¼Œè®¾ç½®NoSchedule)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl taint nodes node1 tag:PreferNoSchedule-</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl taint nodes node1 tag=heima:NoSchedule</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºpod2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl run taint2 --image=nginx:1.17.1 -n dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods taint2 -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                      READY   STATUS    RESTARTS   AGE     IP            NODE
</span></span><span style="display:flex;"><span>taint1-7665f7fd85-574h4   1/1     Running   <span style="color:#ae81ff">0</span>          2m24s   10.244.1.59   node1 
</span></span><span style="display:flex;"><span>taint2-544694789-6zmlf    0/1     Pending   <span style="color:#ae81ff">0</span>          21s     &lt;none&gt;        &lt;none&gt;   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸ºnode1è®¾ç½®æ±¡ç‚¹(å–æ¶ˆNoScheduleï¼Œè®¾ç½®NoExecute)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl taint nodes node1 tag:NoSchedule-</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl taint nodes node1 tag=heima:NoExecute</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºpod3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl run taint3 --image=nginx:1.17.1 -n dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                      READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED 
</span></span><span style="display:flex;"><span>taint1-7665f7fd85-htkmp   0/1     Pending   <span style="color:#ae81ff">0</span>          35s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;    
</span></span><span style="display:flex;"><span>taint2-544694789-bn7wb    0/1     Pending   <span style="color:#ae81ff">0</span>          35s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;     
</span></span><span style="display:flex;"><span>taint3-6d78dbd749-tktkq   0/1     Pending   <span style="color:#ae81ff">0</span>          6s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;     
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>å°æç¤ºï¼š
</span></span><span style="display:flex;"><span>    ä½¿ç”¨kubeadmæ­å»ºçš„é›†ç¾¤ï¼Œé»˜è®¤å°±ä¼šç»™masterèŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªæ±¡ç‚¹æ ‡è®°,æ‰€ä»¥podå°±ä¸ä¼šè°ƒåº¦åˆ°masterèŠ‚ç‚¹ä¸Š.
</span></span></code></pre></div><p>å®¹å¿ï¼ˆTolerationï¼‰</p>
<p>ä¸Šé¢ä»‹ç»äº†æ±¡ç‚¹çš„ä½œç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨nodeä¸Šæ·»åŠ æ±¡ç‚¹ç”¨äºæ‹’ç»podè°ƒåº¦ä¸Šæ¥ï¼Œä½†æ˜¯å¦‚æœå°±æ˜¯æƒ³å°†ä¸€ä¸ªpodè°ƒåº¦åˆ°ä¸€ä¸ªæœ‰æ±¡ç‚¹çš„nodeä¸Šå»ï¼Œè¿™æ—¶å€™åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿè¿™å°±è¦ä½¿ç”¨åˆ°å®¹å¿ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200514095913741.png" alt="image-20200514095913741"  />
</p>
<blockquote>
<p>æ±¡ç‚¹å°±æ˜¯æ‹’ç»ï¼Œå®¹å¿å°±æ˜¯å¿½ç•¥ï¼ŒNodeé€šè¿‡æ±¡ç‚¹æ‹’ç»podè°ƒåº¦ä¸Šå»ï¼ŒPodé€šè¿‡å®¹å¿å¿½ç•¥æ‹’ç»</p>
</blockquote>
<p>ä¸‹é¢å…ˆé€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹çœ‹ä¸‹æ•ˆæœï¼š</p>
<ol>
<li>ä¸Šä¸€å°èŠ‚ï¼Œå·²ç»åœ¨node1èŠ‚ç‚¹ä¸Šæ‰“ä¸Šäº†<code>NoExecute</code>çš„æ±¡ç‚¹ï¼Œæ­¤æ—¶podæ˜¯è°ƒåº¦ä¸ä¸Šå»çš„</li>
<li>æœ¬å°èŠ‚ï¼Œå¯ä»¥é€šè¿‡ç»™podæ·»åŠ å®¹å¿ï¼Œç„¶åå°†å…¶è°ƒåº¦ä¸Šå»</li>
</ol>
<p>åˆ›å»ºpod-toleration.yaml,å†…å®¹å¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-toleration</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tolerations</span>:      <span style="color:#75715e"># æ·»åŠ å®¹å¿</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">key</span>: <span style="color:#e6db74">&#34;tag&#34;</span>        <span style="color:#75715e"># è¦å®¹å¿çš„æ±¡ç‚¹çš„key</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">operator</span>: <span style="color:#e6db74">&#34;Equal&#34;</span> <span style="color:#75715e"># æ“ä½œç¬¦</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;heima&#34;</span>    <span style="color:#75715e"># å®¹å¿çš„æ±¡ç‚¹çš„value</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">effect</span>: <span style="color:#e6db74">&#34;NoExecute&#34;</span>   <span style="color:#75715e"># æ·»åŠ å®¹å¿çš„è§„åˆ™ï¼Œè¿™é‡Œå¿…é¡»å’Œæ ‡è®°çš„æ±¡ç‚¹è§„åˆ™ç›¸åŒ</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># æ·»åŠ å®¹å¿ä¹‹å‰çš„pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME             READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED 
</span></span><span style="display:flex;"><span>pod-toleration   0/1     Pending   <span style="color:#ae81ff">0</span>          3s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ·»åŠ å®¹å¿ä¹‹åçš„pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME             READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED
</span></span><span style="display:flex;"><span>pod-toleration   1/1     Running   <span style="color:#ae81ff">0</span>          3s    10.244.1.62   node1   &lt;none&gt;        
</span></span></code></pre></div><p>ä¸‹é¢çœ‹ä¸€ä¸‹å®¹å¿çš„è¯¦ç»†é…ç½®:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl explain pod.spec.tolerations</span>
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>FIELDS:
</span></span><span style="display:flex;"><span>   key       <span style="color:#75715e"># å¯¹åº”ç€è¦å®¹å¿çš„æ±¡ç‚¹çš„é”®ï¼Œç©ºæ„å‘³ç€åŒ¹é…æ‰€æœ‰çš„é”®</span>
</span></span><span style="display:flex;"><span>   value     <span style="color:#75715e"># å¯¹åº”ç€è¦å®¹å¿çš„æ±¡ç‚¹çš„å€¼</span>
</span></span><span style="display:flex;"><span>   operator  <span style="color:#75715e"># key-valueçš„è¿ç®—ç¬¦ï¼Œæ”¯æŒEqualå’ŒExistsï¼ˆé»˜è®¤ï¼‰</span>
</span></span><span style="display:flex;"><span>   effect    <span style="color:#75715e"># å¯¹åº”æ±¡ç‚¹çš„effectï¼Œç©ºæ„å‘³ç€åŒ¹é…æ‰€æœ‰å½±å“</span>
</span></span><span style="display:flex;"><span>   tolerationSeconds   <span style="color:#75715e"># å®¹å¿æ—¶é—´, å½“effectä¸ºNoExecuteæ—¶ç”Ÿæ•ˆï¼Œè¡¨ç¤ºpodåœ¨Nodeä¸Šçš„åœç•™æ—¶é—´</span>
</span></span></code></pre></div><h3 id="6-podæ§åˆ¶å™¨è¯¦è§£">6. Podæ§åˆ¶å™¨è¯¦è§£<a hidden class="anchor" aria-hidden="true" href="#6-podæ§åˆ¶å™¨è¯¦è§£">#</a></h3>
<h4 id="61-podæ§åˆ¶å™¨ä»‹ç»">6.1 Podæ§åˆ¶å™¨ä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#61-podæ§åˆ¶å™¨ä»‹ç»">#</a></h4>
<p>Podæ˜¯kubernetesçš„æœ€å°ç®¡ç†å•å…ƒï¼Œåœ¨kubernetesä¸­ï¼ŒæŒ‰ç…§podçš„åˆ›å»ºæ–¹å¼å¯ä»¥å°†å…¶åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ul>
<li>è‡ªä¸»å¼podï¼škubernetesç›´æ¥åˆ›å»ºå‡ºæ¥çš„Podï¼Œè¿™ç§podåˆ é™¤åå°±æ²¡æœ‰äº†ï¼Œä¹Ÿä¸ä¼šé‡å»º</li>
<li>æ§åˆ¶å™¨åˆ›å»ºçš„podï¼škubernetesé€šè¿‡æ§åˆ¶å™¨åˆ›å»ºçš„podï¼Œè¿™ç§podåˆ é™¤äº†ä¹‹åè¿˜ä¼šè‡ªåŠ¨é‡å»º</li>
</ul>
<blockquote>
<p><code>ä»€ä¹ˆæ˜¯Podæ§åˆ¶å™¨</code></p>
<p>Podæ§åˆ¶å™¨æ˜¯ç®¡ç†podçš„ä¸­é—´å±‚ï¼Œä½¿ç”¨Podæ§åˆ¶å™¨ä¹‹åï¼Œåªéœ€è¦å‘Šè¯‰Podæ§åˆ¶å™¨ï¼Œæƒ³è¦å¤šå°‘ä¸ªä»€ä¹ˆæ ·çš„Podå°±å¯ä»¥äº†ï¼Œå®ƒä¼šåˆ›å»ºå‡ºæ»¡è¶³æ¡ä»¶çš„Podå¹¶ç¡®ä¿æ¯ä¸€ä¸ªPodèµ„æºå¤„äºç”¨æˆ·æœŸæœ›çš„ç›®æ ‡çŠ¶æ€ã€‚å¦‚æœPodèµ„æºåœ¨è¿è¡Œä¸­å‡ºç°æ•…éšœï¼Œå®ƒä¼šåŸºäºæŒ‡å®šç­–ç•¥é‡æ–°ç¼–æ’Podã€‚</p>
</blockquote>
<p>åœ¨kubernetesä¸­ï¼Œæœ‰å¾ˆå¤šç±»å‹çš„podæ§åˆ¶å™¨ï¼Œæ¯ç§éƒ½æœ‰è‡ªå·±çš„é€‚åˆçš„åœºæ™¯ï¼Œå¸¸è§çš„æœ‰ä¸‹é¢è¿™äº›ï¼š</p>
<ul>
<li>ReplicationControllerï¼šæ¯”è¾ƒåŸå§‹çš„podæ§åˆ¶å™¨ï¼Œå·²ç»è¢«åºŸå¼ƒï¼Œç”±ReplicaSetæ›¿ä»£</li>
<li>ReplicaSetï¼šä¿è¯å‰¯æœ¬æ•°é‡ä¸€ç›´ç»´æŒåœ¨æœŸæœ›å€¼ï¼Œå¹¶æ”¯æŒpodæ•°é‡æ‰©ç¼©å®¹ï¼Œé•œåƒç‰ˆæœ¬å‡çº§</li>
<li>Deploymentï¼šé€šè¿‡æ§åˆ¶ReplicaSetæ¥æ§åˆ¶Podï¼Œå¹¶æ”¯æŒæ»šåŠ¨å‡çº§ã€å›é€€ç‰ˆæœ¬</li>
<li>Horizontal Pod Autoscalerï¼šå¯ä»¥æ ¹æ®é›†ç¾¤è´Ÿè½½è‡ªåŠ¨æ°´å¹³è°ƒæ•´Podçš„æ•°é‡ï¼Œå®ç°å‰Šå³°å¡«è°·</li>
<li>DaemonSetï¼šåœ¨é›†ç¾¤ä¸­çš„æŒ‡å®šNodeä¸Šè¿è¡Œä¸”ä»…è¿è¡Œä¸€ä¸ªå‰¯æœ¬ï¼Œä¸€èˆ¬ç”¨äºå®ˆæŠ¤è¿›ç¨‹ç±»çš„ä»»åŠ¡</li>
<li>Jobï¼šå®ƒåˆ›å»ºå‡ºæ¥çš„podåªè¦å®Œæˆä»»åŠ¡å°±ç«‹å³é€€å‡ºï¼Œä¸éœ€è¦é‡å¯æˆ–é‡å»ºï¼Œç”¨äºæ‰§è¡Œä¸€æ¬¡æ€§ä»»åŠ¡</li>
<li>Cronjobï¼šå®ƒåˆ›å»ºçš„Podè´Ÿè´£å‘¨æœŸæ€§ä»»åŠ¡æ§åˆ¶ï¼Œä¸éœ€è¦æŒç»­åå°è¿è¡Œ</li>
<li>StatefulSetï¼šç®¡ç†æœ‰çŠ¶æ€åº”ç”¨</li>
</ul>
<h4 id="62-replicasetrs">6.2 ReplicaSet(RS)<a hidden class="anchor" aria-hidden="true" href="#62-replicasetrs">#</a></h4>
<p>ReplicaSetçš„ä¸»è¦ä½œç”¨æ˜¯ä¿è¯ä¸€å®šæ•°é‡çš„podæ­£å¸¸è¿è¡Œï¼Œå®ƒä¼šæŒç»­ç›‘å¬è¿™äº›Podçš„è¿è¡ŒçŠ¶æ€ï¼Œä¸€æ—¦Podå‘ç”Ÿæ•…éšœï¼Œå°±ä¼šé‡å¯æˆ–é‡å»ºã€‚åŒæ—¶å®ƒè¿˜æ”¯æŒå¯¹podæ•°é‡çš„æ‰©ç¼©å®¹å’Œé•œåƒç‰ˆæœ¬çš„å‡é™çº§ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200612005334159.png" alt="img"  />
</p>
<p>ReplicaSetçš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span> <span style="color:#75715e"># ç‰ˆæœ¬å·</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ReplicaSet</span> <span style="color:#75715e"># ç±»å‹       </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># å…ƒæ•°æ®</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#75715e"># rsåç§° </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#75715e"># æ‰€å±å‘½åç©ºé—´ </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>: <span style="color:#75715e">#æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">rs</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># è¯¦æƒ…æè¿°</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># å‰¯æœ¬æ•°é‡</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># é€‰æ‹©å™¨ï¼Œé€šè¿‡å®ƒæŒ‡å®šè¯¥æ§åˆ¶å™¨ç®¡ç†å“ªäº›pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:      <span style="color:#75715e"># LabelsåŒ¹é…è§„åˆ™</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># ExpressionsåŒ¹é…è§„åˆ™</span>
</span></span><span style="display:flex;"><span>      - {<span style="color:#f92672">key: app, operator: In, values</span>: [<span style="color:#ae81ff">nginx-pod]}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>: <span style="color:#75715e"># æ¨¡æ¿ï¼Œå½“å‰¯æœ¬æ•°é‡ä¸è¶³æ—¶ï¼Œä¼šæ ¹æ®ä¸‹é¢çš„æ¨¡æ¿åˆ›å»ºpodå‰¯æœ¬</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><p>åœ¨è¿™é‡Œé¢ï¼Œéœ€è¦æ–°äº†è§£çš„é…ç½®é¡¹å°±æ˜¯<code>spec</code>ä¸‹é¢å‡ ä¸ªé€‰é¡¹ï¼š</p>
<ul>
<li>
<p>replicasï¼šæŒ‡å®šå‰¯æœ¬æ•°é‡ï¼Œå…¶å®å°±æ˜¯å½“å‰rsåˆ›å»ºå‡ºæ¥çš„podçš„æ•°é‡ï¼Œé»˜è®¤ä¸º1</p>
</li>
<li>
<p>selectorï¼šé€‰æ‹©å™¨ï¼Œå®ƒçš„ä½œç”¨æ˜¯å»ºç«‹podæ§åˆ¶å™¨å’Œpodä¹‹é—´çš„å…³è”å…³ç³»ï¼Œé‡‡ç”¨çš„Label Selectoræœºåˆ¶</p>
<p>åœ¨podæ¨¡æ¿ä¸Šå®šä¹‰labelï¼Œåœ¨æ§åˆ¶å™¨ä¸Šå®šä¹‰é€‰æ‹©å™¨ï¼Œå°±å¯ä»¥è¡¨æ˜å½“å‰æ§åˆ¶å™¨èƒ½ç®¡ç†å“ªäº›podäº†</p>
</li>
<li>
<p>templateï¼šæ¨¡æ¿ï¼Œå°±æ˜¯å½“å‰æ§åˆ¶å™¨åˆ›å»ºpodæ‰€ä½¿ç”¨çš„æ¨¡æ¿æ¿ï¼Œé‡Œé¢å…¶å®å°±æ˜¯å‰ä¸€ç« å­¦è¿‡çš„podçš„å®šä¹‰</p>
</li>
</ul>
<p>åˆ›å»ºReplicaSet</p>
<p>åˆ›å»ºpc-replicaset.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ReplicaSet   </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-replicaset</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºrs</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pc-replicaset.yaml</span>
</span></span><span style="display:flex;"><span>replicaset.apps/pc-replicaset created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹rs</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DESIRED:æœŸæœ›å‰¯æœ¬æ•°é‡  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CURRENT:å½“å‰å‰¯æœ¬æ•°é‡  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># READY:å·²ç»å‡†å¤‡å¥½æä¾›æœåŠ¡çš„å‰¯æœ¬æ•°é‡</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs pc-replicaset -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME          DESIRED   CURRENT READY AGE   CONTAINERS   IMAGES             SELECTOR
</span></span><span style="display:flex;"><span>pc-replicaset <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>       <span style="color:#ae81ff">3</span>     22s   nginx        nginx:1.17.1       app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹å½“å‰æ§åˆ¶å™¨åˆ›å»ºå‡ºæ¥çš„pod</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è¿™é‡Œå‘ç°æ§åˆ¶å™¨åˆ›å»ºå‡ºæ¥çš„podçš„åç§°æ˜¯åœ¨æ§åˆ¶å™¨åç§°åé¢æ‹¼æ¥äº†-xxxxxéšæœºç </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n dev</span>
</span></span><span style="display:flex;"><span>NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-replicaset-6vmvt   1/1     Running   <span style="color:#ae81ff">0</span>          54s
</span></span><span style="display:flex;"><span>pc-replicaset-fmb8f   1/1     Running   <span style="color:#ae81ff">0</span>          54s
</span></span><span style="display:flex;"><span>pc-replicaset-snrk2   1/1     Running   <span style="color:#ae81ff">0</span>          54s
</span></span></code></pre></div><p>æ‰©ç¼©å®¹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ç¼–è¾‘rsçš„å‰¯æœ¬æ•°é‡ï¼Œä¿®æ”¹spec:replicas: 6å³å¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl edit rs pc-replicaset -n dev</span>
</span></span><span style="display:flex;"><span>replicaset.apps/pc-replicaset edited
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-replicaset-6vmvt   1/1     Running   <span style="color:#ae81ff">0</span>          114m
</span></span><span style="display:flex;"><span>pc-replicaset-cftnp   1/1     Running   <span style="color:#ae81ff">0</span>          10s
</span></span><span style="display:flex;"><span>pc-replicaset-fjlm6   1/1     Running   <span style="color:#ae81ff">0</span>          10s
</span></span><span style="display:flex;"><span>pc-replicaset-fmb8f   1/1     Running   <span style="color:#ae81ff">0</span>          114m
</span></span><span style="display:flex;"><span>pc-replicaset-s2whj   1/1     Running   <span style="color:#ae81ff">0</span>          10s
</span></span><span style="display:flex;"><span>pc-replicaset-snrk2   1/1     Running   <span style="color:#ae81ff">0</span>          114m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨å‘½ä»¤å®ç°</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä½¿ç”¨scaleå‘½ä»¤å®ç°æ‰©ç¼©å®¹ï¼Œ åé¢--replicas=nç›´æ¥æŒ‡å®šç›®æ ‡æ•°é‡å³å¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl scale rs pc-replicaset --replicas=2 -n dev</span>
</span></span><span style="display:flex;"><span>replicaset.apps/pc-replicaset scaled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å‘½ä»¤è¿è¡Œå®Œæ¯•ï¼Œç«‹å³æŸ¥çœ‹ï¼Œå‘ç°å·²ç»æœ‰4ä¸ªå¼€å§‹å‡†å¤‡é€€å‡ºäº†</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                       READY   STATUS        RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-replicaset-6vmvt   0/1     Terminating   <span style="color:#ae81ff">0</span>          118m
</span></span><span style="display:flex;"><span>pc-replicaset-cftnp   0/1     Terminating   <span style="color:#ae81ff">0</span>          4m17s
</span></span><span style="display:flex;"><span>pc-replicaset-fjlm6   0/1     Terminating   <span style="color:#ae81ff">0</span>          4m17s
</span></span><span style="display:flex;"><span>pc-replicaset-fmb8f   1/1     Running       <span style="color:#ae81ff">0</span>          118m
</span></span><span style="display:flex;"><span>pc-replicaset-s2whj   0/1     Terminating   <span style="color:#ae81ff">0</span>          4m17s
</span></span><span style="display:flex;"><span>pc-replicaset-snrk2   1/1     Running       <span style="color:#ae81ff">0</span>          118m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ç¨ç­‰ç‰‡åˆ»ï¼Œå°±åªå‰©ä¸‹2ä¸ªäº†</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-replicaset-fmb8f   1/1     Running   <span style="color:#ae81ff">0</span>          119m
</span></span><span style="display:flex;"><span>pc-replicaset-snrk2   1/1     Running   <span style="color:#ae81ff">0</span>          119m
</span></span></code></pre></div><p>é•œåƒå‡çº§</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ç¼–è¾‘rsçš„å®¹å™¨é•œåƒ - image: nginx:1.17.2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl edit rs pc-replicaset -n dev</span>
</span></span><span style="display:flex;"><span>replicaset.apps/pc-replicaset edited
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å†æ¬¡æŸ¥çœ‹ï¼Œå‘ç°é•œåƒç‰ˆæœ¬å·²ç»å˜æ›´äº†</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES        ...
</span></span><span style="display:flex;"><span>pc-replicaset       <span style="color:#ae81ff">2</span>        <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>       140m   nginx         nginx:1.17.2  ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åŒæ ·çš„é“ç†ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤å®Œæˆè¿™ä¸ªå·¥ä½œ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubectl set image rs rsåç§° å®¹å™¨=é•œåƒç‰ˆæœ¬ -n namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl set image rs pc-replicaset nginx=nginx:1.17.1  -n dev</span>
</span></span><span style="display:flex;"><span>replicaset.apps/pc-replicaset image updated
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å†æ¬¡æŸ¥çœ‹ï¼Œå‘ç°é•œåƒç‰ˆæœ¬å·²ç»å˜æ›´äº†</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                 DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES            ...
</span></span><span style="display:flex;"><span>pc-replicaset        <span style="color:#ae81ff">2</span>        <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>       145m   nginx        nginx:1.17.1 ... 
</span></span></code></pre></div><p>åˆ é™¤ReplicaSet</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ä½¿ç”¨kubectl deleteå‘½ä»¤ä¼šåˆ é™¤æ­¤RSä»¥åŠå®ƒç®¡ç†çš„Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åœ¨kubernetesåˆ é™¤RSå‰ï¼Œä¼šå°†RSçš„replicasclearè°ƒæ•´ä¸º0ï¼Œç­‰å¾…æ‰€æœ‰çš„Podè¢«åˆ é™¤åï¼Œåœ¨æ‰§è¡ŒRSå¯¹è±¡çš„åˆ é™¤</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete rs pc-replicaset -n dev</span>
</span></span><span style="display:flex;"><span>replicaset.apps <span style="color:#e6db74">&#34;pc-replicaset&#34;</span> deleted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n dev -o wide</span>
</span></span><span style="display:flex;"><span>No resources found in dev namespace.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¦‚æœå¸Œæœ›ä»…ä»…åˆ é™¤RSå¯¹è±¡ï¼ˆä¿ç•™Podï¼‰ï¼Œå¯ä»¥ä½¿ç”¨kubectl deleteå‘½ä»¤æ—¶æ·»åŠ --cascade=falseé€‰é¡¹ï¼ˆä¸æ¨èï¼‰ã€‚</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete rs pc-replicaset -n dev --cascade=false</span>
</span></span><span style="display:flex;"><span>replicaset.apps <span style="color:#e6db74">&#34;pc-replicaset&#34;</span> deleted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                  READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-replicaset-cl82j   1/1     Running   <span style="color:#ae81ff">0</span>          75s
</span></span><span style="display:flex;"><span>pc-replicaset-dslhb   1/1     Running   <span style="color:#ae81ff">0</span>          75s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¹Ÿå¯ä»¥ä½¿ç”¨yamlç›´æ¥åˆ é™¤(æ¨è)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete -f pc-replicaset.yaml</span>
</span></span><span style="display:flex;"><span>replicaset.apps <span style="color:#e6db74">&#34;pc-replicaset&#34;</span> deleted
</span></span></code></pre></div><h4 id="63-deploymentdeploy">6.3 Deployment(Deploy)<a hidden class="anchor" aria-hidden="true" href="#63-deploymentdeploy">#</a></h4>
<p>ä¸ºäº†æ›´å¥½çš„è§£å†³æœåŠ¡ç¼–æ’çš„é—®é¢˜ï¼Œkubernetesåœ¨V1.2ç‰ˆæœ¬å¼€å§‹ï¼Œå¼•å…¥äº†Deploymentæ§åˆ¶å™¨ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™ç§æ§åˆ¶å™¨å¹¶ä¸ç›´æ¥ç®¡ç†podï¼Œè€Œæ˜¯é€šè¿‡ç®¡ç†ReplicaSetæ¥ç®€ä»‹ç®¡ç†Podï¼Œå³ï¼šDeploymentç®¡ç†ReplicaSetï¼ŒReplicaSetç®¡ç†Podã€‚æ‰€ä»¥Deploymentæ¯”ReplicaSetåŠŸèƒ½æ›´åŠ å¼ºå¤§ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200612005524778.png" alt="img"  />
</p>
<p>Deploymentä¸»è¦åŠŸèƒ½æœ‰ä¸‹é¢å‡ ä¸ªï¼š</p>
<ul>
<li>æ”¯æŒReplicaSetçš„æ‰€æœ‰åŠŸèƒ½</li>
<li>æ”¯æŒå‘å¸ƒçš„åœæ­¢ã€ç»§ç»­</li>
<li>æ”¯æŒæ»šåŠ¨å‡çº§å’Œå›æ»šç‰ˆæœ¬</li>
</ul>
<p>Deploymentçš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span> <span style="color:#75715e"># ç‰ˆæœ¬å·</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span> <span style="color:#75715e"># ç±»å‹       </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># å…ƒæ•°æ®</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#75715e"># rsåç§° </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#75715e"># æ‰€å±å‘½åç©ºé—´ </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>: <span style="color:#75715e">#æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">deploy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># è¯¦æƒ…æè¿°</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># å‰¯æœ¬æ•°é‡</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># ä¿ç•™å†å²ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paused</span>: <span style="color:#66d9ef">false</span> <span style="color:#75715e"># æš‚åœéƒ¨ç½²ï¼Œé»˜è®¤æ˜¯false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#ae81ff">600</span> <span style="color:#75715e"># éƒ¨ç½²è¶…æ—¶æ—¶é—´ï¼ˆsï¼‰ï¼Œé»˜è®¤æ˜¯600</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>: <span style="color:#75715e"># ç­–ç•¥</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span> <span style="color:#75715e"># æ»šåŠ¨æ›´æ–°ç­–ç•¥</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>: <span style="color:#75715e"># æ»šåŠ¨æ›´æ–°</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxè¿è§„è¯æ±‡</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%</span> <span style="color:#75715e"># æœ€å¤§é¢å¤–å¯ä»¥å­˜åœ¨çš„å‰¯æœ¬æ•°ï¼Œå¯ä»¥ä¸ºç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯ä»¥ä¸ºæ•´æ•°</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%</span> <span style="color:#75715e"># æœ€å¤§ä¸å¯ç”¨çŠ¶æ€çš„ Pod çš„æœ€å¤§å€¼ï¼Œå¯ä»¥ä¸ºç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯ä»¥ä¸ºæ•´æ•°</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># é€‰æ‹©å™¨ï¼Œé€šè¿‡å®ƒæŒ‡å®šè¯¥æ§åˆ¶å™¨ç®¡ç†å“ªäº›pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:      <span style="color:#75715e"># LabelsåŒ¹é…è§„åˆ™</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># ExpressionsåŒ¹é…è§„åˆ™</span>
</span></span><span style="display:flex;"><span>      - {<span style="color:#f92672">key: app, operator: In, values</span>: [<span style="color:#ae81ff">nginx-pod]}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>: <span style="color:#75715e"># æ¨¡æ¿ï¼Œå½“å‰¯æœ¬æ•°é‡ä¸è¶³æ—¶ï¼Œä¼šæ ¹æ®ä¸‹é¢çš„æ¨¡æ¿åˆ›å»ºpodå‰¯æœ¬</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><h5 id="631-åˆ›å»ºdeployment">6.3.1 åˆ›å»ºdeployment<a hidden class="anchor" aria-hidden="true" href="#631-åˆ›å»ºdeployment">#</a></h5>
<p>åˆ›å»ºpc-deployment.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment      </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-deployment</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºdeployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pc-deployment.yaml --record=true</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># UP-TO-DATE æœ€æ–°ç‰ˆæœ¬çš„podçš„æ•°é‡</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AVAILABLE  å½“å‰å¯ç”¨çš„podçš„æ•°é‡</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy pc-deployment -n dev</span>
</span></span><span style="display:flex;"><span>NAME            READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>pc-deployment   3/3     <span style="color:#ae81ff">3</span>            <span style="color:#ae81ff">3</span>           15s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹rs</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å‘ç°rsçš„åç§°æ˜¯åœ¨åŸæ¥deploymentçš„åå­—åé¢æ·»åŠ äº†ä¸€ä¸ª10ä½æ•°çš„éšæœºä¸²</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs -n dev</span>
</span></span><span style="display:flex;"><span>NAME                       DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78   <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>       23s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-d2c8n   1/1     Running   <span style="color:#ae81ff">0</span>          107s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-smpvp   1/1     Running   <span style="color:#ae81ff">0</span>          107s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-wvjd8   1/1     Running   <span style="color:#ae81ff">0</span>          107s
</span></span></code></pre></div><h5 id="632-æ‰©ç¼©å®¹">6.3.2 æ‰©ç¼©å®¹<a hidden class="anchor" aria-hidden="true" href="#632-æ‰©ç¼©å®¹">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># å˜æ›´å‰¯æœ¬æ•°é‡ä¸º5ä¸ª</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl scale deploy pc-deployment --replicas=5  -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment scaled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy pc-deployment -n dev</span>
</span></span><span style="display:flex;"><span>NAME            READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>pc-deployment   5/5     <span style="color:#ae81ff">5</span>            <span style="color:#ae81ff">5</span>           2m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e">#  kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-d2c8n   1/1     Running   <span style="color:#ae81ff">0</span>          4m19s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-jxmdq   1/1     Running   <span style="color:#ae81ff">0</span>          94s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-mktqv   1/1     Running   <span style="color:#ae81ff">0</span>          93s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-smpvp   1/1     Running   <span style="color:#ae81ff">0</span>          4m19s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-wvjd8   1/1     Running   <span style="color:#ae81ff">0</span>          4m19s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¼–è¾‘deploymentçš„å‰¯æœ¬æ•°é‡ï¼Œä¿®æ”¹spec:replicas: 4å³å¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl edit deploy pc-deployment -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment edited
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-d2c8n   1/1     Running   <span style="color:#ae81ff">0</span>          5m23s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-jxmdq   1/1     Running   <span style="color:#ae81ff">0</span>          2m38s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-smpvp   1/1     Running   <span style="color:#ae81ff">0</span>          5m23s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-wvjd8   1/1     Running   <span style="color:#ae81ff">0</span>          5m23s
</span></span></code></pre></div><p>é•œåƒæ›´æ–°</p>
<p>deploymentæ”¯æŒä¸¤ç§æ›´æ–°ç­–ç•¥:<code>é‡å»ºæ›´æ–°</code>å’Œ<code>æ»šåŠ¨æ›´æ–°</code>,å¯ä»¥é€šè¿‡<code>strategy</code>æŒ‡å®šç­–ç•¥ç±»å‹,æ”¯æŒä¸¤ä¸ªå±æ€§:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span>strategyï¼šæŒ‡å®šæ–°çš„Podæ›¿æ¢æ—§çš„Podçš„ç­–ç•¥ï¼Œ æ”¯æŒä¸¤ä¸ªå±æ€§ï¼š
</span></span><span style="display:flex;"><span>  typeï¼šæŒ‡å®šç­–ç•¥ç±»å‹ï¼Œæ”¯æŒä¸¤ç§ç­–ç•¥
</span></span><span style="display:flex;"><span>    Recreateï¼šåœ¨åˆ›å»ºå‡ºæ–°çš„Podä¹‹å‰ä¼šå…ˆæ€æ‰æ‰€æœ‰å·²å­˜åœ¨çš„Pod
</span></span><span style="display:flex;"><span>    RollingUpdateï¼šæ»šåŠ¨æ›´æ–°ï¼Œå°±æ˜¯æ€æ­»ä¸€éƒ¨åˆ†ï¼Œå°±å¯åŠ¨ä¸€éƒ¨åˆ†ï¼Œåœ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œå­˜åœ¨ä¸¤ä¸ªç‰ˆæœ¬Pod
</span></span><span style="display:flex;"><span>  rollingUpdateï¼šå½“typeä¸ºRollingUpdateæ—¶ç”Ÿæ•ˆï¼Œç”¨äºä¸ºRollingUpdateè®¾ç½®å‚æ•°ï¼Œæ”¯æŒä¸¤ä¸ªå±æ€§ï¼š
</span></span><span style="display:flex;"><span>    maxUnavailableï¼šç”¨æ¥æŒ‡å®šåœ¨å‡çº§è¿‡ç¨‹ä¸­ä¸å¯ç”¨Podçš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤ä¸º25%ã€‚
</span></span><span style="display:flex;"><span>    maxè¿è§„è¯æ±‡ï¼š ç”¨æ¥æŒ‡å®šåœ¨å‡çº§è¿‡ç¨‹ä¸­å¯ä»¥è¶…è¿‡æœŸæœ›çš„Podçš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤ä¸º25%ã€‚
</span></span></code></pre></div><p>é‡å»ºæ›´æ–°</p>
<ol>
<li>ç¼–è¾‘pc-deployment.yaml,åœ¨specèŠ‚ç‚¹ä¸‹æ·»åŠ æ›´æ–°ç­–ç•¥</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>: <span style="color:#75715e"># ç­–ç•¥</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Recreate</span> <span style="color:#75715e"># é‡å»ºæ›´æ–°</span>
</span></span></code></pre></div><p>åˆ›å»ºdeployè¿›è¡ŒéªŒè¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># å˜æ›´é•œåƒ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl set image deployment pc-deployment nginx=nginx:1.17.2 -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment image updated
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è§‚å¯Ÿå‡çº§è¿‡ç¨‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e">#  kubectl get pods -n dev -w</span>
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-65qcw   1/1     Running   <span style="color:#ae81ff">0</span>          31s
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-w5nzv   1/1     Running   <span style="color:#ae81ff">0</span>          31s
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-xpt7w   1/1     Running   <span style="color:#ae81ff">0</span>          31s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-xpt7w   1/1     Terminating   <span style="color:#ae81ff">0</span>          41s
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-65qcw   1/1     Terminating   <span style="color:#ae81ff">0</span>          41s
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-w5nzv   1/1     Terminating   <span style="color:#ae81ff">0</span>          41s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-grn8z   0/1     Pending       <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-hbl4v   0/1     Pending       <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-67nz2   0/1     Pending       <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-grn8z   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-hbl4v   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-67nz2   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-grn8z   1/1     Running             <span style="color:#ae81ff">0</span>          1s
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-67nz2   1/1     Running             <span style="color:#ae81ff">0</span>          1s
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-hbl4v   1/1     Running             <span style="color:#ae81ff">0</span>          2s
</span></span></code></pre></div><p>æ»šåŠ¨æ›´æ–°</p>
<ol>
<li>ç¼–è¾‘pc-deployment.yaml,åœ¨specèŠ‚ç‚¹ä¸‹æ·»åŠ æ›´æ–°ç­–ç•¥</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>: <span style="color:#75715e"># ç­–ç•¥</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span> <span style="color:#75715e"># æ»šåŠ¨æ›´æ–°ç­–ç•¥</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxè¿è§„è¯æ±‡</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">% </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%</span>
</span></span></code></pre></div><p>åˆ›å»ºdeployè¿›è¡ŒéªŒè¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># å˜æ›´é•œåƒ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl set image deployment pc-deployment nginx=nginx:1.17.3 -n dev </span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment image updated
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è§‚å¯Ÿå‡çº§è¿‡ç¨‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -w</span>
</span></span><span style="display:flex;"><span>NAME                           READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-deployment-c848d767-8rbzt   1/1     Running   <span style="color:#ae81ff">0</span>          31m
</span></span><span style="display:flex;"><span>pc-deployment-c848d767-h4p68   1/1     Running   <span style="color:#ae81ff">0</span>          31m
</span></span><span style="display:flex;"><span>pc-deployment-c848d767-hlmz4   1/1     Running   <span style="color:#ae81ff">0</span>          31m
</span></span><span style="display:flex;"><span>pc-deployment-c848d767-rrqcn   1/1     Running   <span style="color:#ae81ff">0</span>          31m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pc-deployment-966bf7f44-226rx   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-966bf7f44-226rx   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-966bf7f44-226rx   1/1     Running             <span style="color:#ae81ff">0</span>          1s
</span></span><span style="display:flex;"><span>pc-deployment-c848d767-h4p68    0/1     Terminating         <span style="color:#ae81ff">0</span>          34m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pc-deployment-966bf7f44-cnd44   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-966bf7f44-cnd44   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-966bf7f44-cnd44   1/1     Running             <span style="color:#ae81ff">0</span>          2s
</span></span><span style="display:flex;"><span>pc-deployment-c848d767-hlmz4    0/1     Terminating         <span style="color:#ae81ff">0</span>          34m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pc-deployment-966bf7f44-px48p   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-966bf7f44-px48p   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-966bf7f44-px48p   1/1     Running             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-c848d767-8rbzt    0/1     Terminating         <span style="color:#ae81ff">0</span>          34m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pc-deployment-966bf7f44-dkmqp   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-966bf7f44-dkmqp   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-966bf7f44-dkmqp   1/1     Running             <span style="color:#ae81ff">0</span>          2s
</span></span><span style="display:flex;"><span>pc-deployment-c848d767-rrqcn    0/1     Terminating         <span style="color:#ae81ff">0</span>          34m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è‡³æ­¤ï¼Œæ–°ç‰ˆæœ¬çš„podåˆ›å»ºå®Œæ¯•ï¼Œå°±ç‰ˆæœ¬çš„podé”€æ¯å®Œæ¯•</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸­é—´è¿‡ç¨‹æ˜¯æ»šåŠ¨è¿›è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¾¹é”€æ¯è¾¹åˆ›å»º</span>
</span></span></code></pre></div><p>æ»šåŠ¨æ›´æ–°çš„è¿‡ç¨‹ï¼š</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200416140251491.png" alt="img"  />
</p>
<p>é•œåƒæ›´æ–°ä¸­rsçš„å˜åŒ–</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹rs,å‘ç°åŸæ¥çš„rsçš„ä¾æ—§å­˜åœ¨ï¼Œåªæ˜¯podæ•°é‡å˜ä¸ºäº†0ï¼Œè€Œååˆæ–°äº§ç”Ÿäº†ä¸€ä¸ªrsï¼Œpodæ•°é‡ä¸º4</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å…¶å®è¿™å°±æ˜¯deploymentèƒ½å¤Ÿè¿›è¡Œç‰ˆæœ¬å›é€€çš„å¥¥å¦™æ‰€åœ¨ï¼Œåé¢ä¼šè¯¦ç»†è§£é‡Š</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs -n dev</span>
</span></span><span style="display:flex;"><span>NAME                       DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78   <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       7m37s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b11   <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       5m37s
</span></span><span style="display:flex;"><span>pc-deployment-c848d76789   <span style="color:#ae81ff">4</span>         <span style="color:#ae81ff">4</span>         <span style="color:#ae81ff">4</span>       72s
</span></span></code></pre></div><h5 id="633-ç‰ˆæœ¬å›é€€">6.3.3 ç‰ˆæœ¬å›é€€<a hidden class="anchor" aria-hidden="true" href="#633-ç‰ˆæœ¬å›é€€">#</a></h5>
<p>deploymentæ”¯æŒç‰ˆæœ¬å‡çº§è¿‡ç¨‹ä¸­çš„æš‚åœã€ç»§ç»­åŠŸèƒ½ä»¥åŠç‰ˆæœ¬å›é€€ç­‰è¯¸å¤šåŠŸèƒ½ï¼Œä¸‹é¢å…·ä½“æ¥çœ‹.</p>
<p>kubectl rolloutï¼š ç‰ˆæœ¬å‡çº§ç›¸å…³åŠŸèƒ½ï¼Œæ”¯æŒä¸‹é¢çš„é€‰é¡¹ï¼š</p>
<ul>
<li>status æ˜¾ç¤ºå½“å‰å‡çº§çŠ¶æ€</li>
<li>history   æ˜¾ç¤º å‡çº§å†å²è®°å½•</li>
<li>pause    æš‚åœç‰ˆæœ¬å‡çº§è¿‡ç¨‹</li>
<li>resume   ç»§ç»­å·²ç»æš‚åœçš„ç‰ˆæœ¬å‡çº§è¿‡ç¨‹</li>
<li>restart    é‡å¯ç‰ˆæœ¬å‡çº§è¿‡ç¨‹</li>
<li>undo å›æ»šåˆ°ä¸Šä¸€çº§ç‰ˆæœ¬ï¼ˆå¯ä»¥ä½¿ç”¨&ndash;to-revisionå›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ï¼‰</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹å½“å‰å‡çº§ç‰ˆæœ¬çš„çŠ¶æ€</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout status deploy pc-deployment -n dev</span>
</span></span><span style="display:flex;"><span>deployment <span style="color:#e6db74">&#34;pc-deployment&#34;</span> successfully rolled out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹å‡çº§å†å²è®°å½•</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout history deploy pc-deployment -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment
</span></span><span style="display:flex;"><span>REVISION  CHANGE-CAUSE
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>         kubectl create --filename<span style="color:#f92672">=</span>pc-deployment.yaml --record<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>         kubectl create --filename<span style="color:#f92672">=</span>pc-deployment.yaml --record<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>         kubectl create --filename<span style="color:#f92672">=</span>pc-deployment.yaml --record<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯ä»¥å‘ç°æœ‰ä¸‰æ¬¡ç‰ˆæœ¬è®°å½•ï¼Œè¯´æ˜å®Œæˆè¿‡ä¸¤æ¬¡å‡çº§</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç‰ˆæœ¬å›æ»š</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è¿™é‡Œç›´æ¥ä½¿ç”¨--to-revision=1å›æ»šåˆ°äº†1ç‰ˆæœ¬ï¼Œ å¦‚æœçœç•¥è¿™ä¸ªé€‰é¡¹ï¼Œå°±æ˜¯å›é€€åˆ°ä¸Šä¸ªç‰ˆæœ¬ï¼Œå°±æ˜¯2ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout undo deployment pc-deployment --to-revision=1 -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment rolled back
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹å‘ç°ï¼Œé€šè¿‡nginxé•œåƒç‰ˆæœ¬å¯ä»¥å‘ç°åˆ°äº†ç¬¬ä¸€ç‰ˆ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME            READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         
</span></span><span style="display:flex;"><span>pc-deployment   4/4     <span style="color:#ae81ff">4</span>            <span style="color:#ae81ff">4</span>           74m   nginx        nginx:1.17.1   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹rsï¼Œå‘ç°ç¬¬ä¸€ä¸ªrsä¸­æœ‰4ä¸ªpodè¿è¡Œï¼Œåé¢ä¸¤ä¸ªç‰ˆæœ¬çš„rsä¸­podä¸ºè¿è¡Œ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å…¶å®deploymentä¹‹æ‰€ä»¥å¯æ˜¯å®ç°ç‰ˆæœ¬çš„å›æ»šï¼Œå°±æ˜¯é€šè¿‡è®°å½•ä¸‹å†å²rsæ¥å®ç°çš„ï¼Œ</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸€æ—¦æƒ³å›æ»šåˆ°å“ªä¸ªç‰ˆæœ¬ï¼Œåªéœ€è¦å°†å½“å‰ç‰ˆæœ¬podæ•°é‡é™ä¸º0ï¼Œç„¶åå°†å›æ»šç‰ˆæœ¬çš„podæå‡ä¸ºç›®æ ‡æ•°é‡å°±å¯ä»¥äº†</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs -n dev</span>
</span></span><span style="display:flex;"><span>NAME                       DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78   <span style="color:#ae81ff">4</span>         <span style="color:#ae81ff">4</span>         <span style="color:#ae81ff">4</span>       78m
</span></span><span style="display:flex;"><span>pc-deployment-966bf7f44    <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       37m
</span></span><span style="display:flex;"><span>pc-deployment-c848d767     <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       71m
</span></span></code></pre></div><h5 id="634-é‡‘ä¸é›€å‘å¸ƒ">6.3.4 é‡‘ä¸é›€å‘å¸ƒ<a hidden class="anchor" aria-hidden="true" href="#634-é‡‘ä¸é›€å‘å¸ƒ">#</a></h5>
<p>Deploymentæ§åˆ¶å™¨æ”¯æŒæ§åˆ¶æ›´æ–°è¿‡ç¨‹ä¸­çš„æ§åˆ¶ï¼Œå¦‚â€œæš‚åœ(pause)â€æˆ–â€œç»§ç»­(resume)â€æ›´æ–°æ“ä½œã€‚</p>
<p>æ¯”å¦‚æœ‰ä¸€æ‰¹æ–°çš„Podèµ„æºåˆ›å»ºå®Œæˆåç«‹å³æš‚åœæ›´æ–°è¿‡ç¨‹ï¼Œæ­¤æ—¶ï¼Œä»…å­˜åœ¨ä¸€éƒ¨åˆ†æ–°ç‰ˆæœ¬çš„åº”ç”¨ï¼Œä¸»ä½“éƒ¨åˆ†è¿˜æ˜¯æ—§çš„ç‰ˆæœ¬ã€‚ç„¶åï¼Œå†ç­›é€‰ä¸€å°éƒ¨åˆ†çš„ç”¨æˆ·è¯·æ±‚è·¯ç”±åˆ°æ–°ç‰ˆæœ¬çš„Podåº”ç”¨ï¼Œç»§ç»­è§‚å¯Ÿèƒ½å¦ç¨³å®šåœ°æŒ‰æœŸæœ›çš„æ–¹å¼è¿è¡Œã€‚ç¡®å®šæ²¡é—®é¢˜ä¹‹åå†ç»§ç»­å®Œæˆä½™ä¸‹çš„Podèµ„æºæ»šåŠ¨æ›´æ–°ï¼Œå¦åˆ™ç«‹å³å›æ»šæ›´æ–°æ“ä½œã€‚è¿™å°±æ˜¯æ‰€è°“çš„é‡‘ä¸é›€å‘å¸ƒã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># æ›´æ–°deploymentçš„ç‰ˆæœ¬ï¼Œå¹¶é…ç½®æš‚åœdeployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e">#  kubectl set image deploy pc-deployment nginx=nginx:1.17.4 -n dev &amp;&amp; kubectl rollout pause deployment pc-deployment  -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment image updated
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment paused
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#è§‚å¯Ÿæ›´æ–°çŠ¶æ€</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout status deploy pc-deployment -n devã€€</span>
</span></span><span style="display:flex;"><span>Waiting <span style="color:#66d9ef">for</span> deployment <span style="color:#e6db74">&#34;pc-deployment&#34;</span> rollout to finish: <span style="color:#ae81ff">2</span> out of <span style="color:#ae81ff">4</span> new replicas have been updated...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç›‘æ§æ›´æ–°çš„è¿‡ç¨‹ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»æ–°å¢äº†ä¸€ä¸ªèµ„æºï¼Œä½†æ˜¯å¹¶æœªæŒ‰ç…§é¢„æœŸçš„çŠ¶æ€å»åˆ é™¤ä¸€ä¸ªæ—§çš„èµ„æºï¼Œå°±æ˜¯å› ä¸ºä½¿ç”¨äº†pauseæš‚åœå‘½ä»¤</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9   <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>       19m     nginx        nginx:1.17.1   
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b   <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       14m     nginx        nginx:1.17.2   
</span></span><span style="display:flex;"><span>pc-deployment-6c9f56fcfb   <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>       3m16s   nginx        nginx:1.17.4   
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-rj8sq   1/1     Running   <span style="color:#ae81ff">0</span>          7m33s
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-ttwgg   1/1     Running   <span style="color:#ae81ff">0</span>          7m35s
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-v4wvc   1/1     Running   <span style="color:#ae81ff">0</span>          7m34s
</span></span><span style="display:flex;"><span>pc-deployment-6c9f56fcfb-996rt   1/1     Running   <span style="color:#ae81ff">0</span>          3m31s
</span></span><span style="display:flex;"><span>pc-deployment-6c9f56fcfb-j2gtj   1/1     Running   <span style="color:#ae81ff">0</span>          3m31s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç¡®ä¿æ›´æ–°çš„podæ²¡é—®é¢˜äº†ï¼Œç»§ç»­æ›´æ–°</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout resume deploy pc-deployment -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment resumed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹æœ€åçš„æ›´æ–°æƒ…å†µ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9   <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       21m     nginx        nginx:1.17.1   
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b   <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       16m     nginx        nginx:1.17.2   
</span></span><span style="display:flex;"><span>pc-deployment-6c9f56fcfb   <span style="color:#ae81ff">4</span>         <span style="color:#ae81ff">4</span>         <span style="color:#ae81ff">4</span>       5m11s   nginx        nginx:1.17.4   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-deployment-6c9f56fcfb-7bfwh   1/1     Running   <span style="color:#ae81ff">0</span>          37s
</span></span><span style="display:flex;"><span>pc-deployment-6c9f56fcfb-996rt   1/1     Running   <span style="color:#ae81ff">0</span>          5m27s
</span></span><span style="display:flex;"><span>pc-deployment-6c9f56fcfb-j2gtj   1/1     Running   <span style="color:#ae81ff">0</span>          5m27s
</span></span><span style="display:flex;"><span>pc-deployment-6c9f56fcfb-rf84v   1/1     Running   <span style="color:#ae81ff">0</span>          37s
</span></span></code></pre></div><p>åˆ é™¤Deployment</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ é™¤deploymentï¼Œå…¶ä¸‹çš„rså’Œpodä¹Ÿå°†è¢«åˆ é™¤</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete -f pc-deployment.yaml</span>
</span></span><span style="display:flex;"><span>deployment.apps <span style="color:#e6db74">&#34;pc-deployment&#34;</span> deleted
</span></span></code></pre></div><h4 id="64-horizontal-pod-autoscalerhpa">6.4 Horizontal Pod Autoscaler(HPA)<a hidden class="anchor" aria-hidden="true" href="#64-horizontal-pod-autoscalerhpa">#</a></h4>
<p>åœ¨å‰é¢çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥å®ç°é€šè¿‡æ‰‹å·¥æ‰§è¡Œ<code>kubectl scale</code>å‘½ä»¤å®ç°Podæ‰©å®¹æˆ–ç¼©å®¹ï¼Œä½†æ˜¯è¿™æ˜¾ç„¶ä¸ç¬¦åˆKubernetesçš„å®šä½ç›®æ ‡&ndash;è‡ªåŠ¨åŒ–ã€æ™ºèƒ½åŒ–ã€‚ KubernetesæœŸæœ›å¯ä»¥å®ç°é€šè¿‡ç›‘æµ‹Podçš„ä½¿ç”¨æƒ…å†µï¼Œå®ç°podæ•°é‡çš„è‡ªåŠ¨è°ƒæ•´ï¼Œäºæ˜¯å°±äº§ç”Ÿäº†Horizontal Pod Autoscalerï¼ˆHPAï¼‰è¿™ç§æ§åˆ¶å™¨ã€‚</p>
<p>HPAå¯ä»¥è·å–æ¯ä¸ªPodåˆ©ç”¨ç‡ï¼Œç„¶åå’ŒHPAä¸­å®šä¹‰çš„æŒ‡æ ‡è¿›è¡Œå¯¹æ¯”ï¼ŒåŒæ—¶è®¡ç®—å‡ºéœ€è¦ä¼¸ç¼©çš„å…·ä½“å€¼ï¼Œæœ€åå®ç°Podçš„æ•°é‡çš„è°ƒæ•´ã€‚å…¶å®HPAä¸ä¹‹å‰çš„Deploymentä¸€æ ·ï¼Œä¹Ÿå±äºä¸€ç§Kubernetesèµ„æºå¯¹è±¡ï¼Œå®ƒé€šè¿‡è¿½è¸ªåˆ†æRCæ§åˆ¶çš„æ‰€æœ‰ç›®æ ‡Podçš„è´Ÿè½½å˜åŒ–æƒ…å†µï¼Œæ¥ç¡®å®šæ˜¯å¦éœ€è¦é’ˆå¯¹æ€§åœ°è°ƒæ•´ç›®æ ‡Podçš„å‰¯æœ¬æ•°ï¼Œè¿™æ˜¯HPAçš„å®ç°åŸç†ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200608155858271.png" alt="img"  />
</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥åšä¸€ä¸ªå®éªŒ</p>
<h5 id="641-å®‰è£…metrics-server">6.4.1 å®‰è£…metrics-server<a hidden class="anchor" aria-hidden="true" href="#641-å®‰è£…metrics-server">#</a></h5>
<p>metrics-serverå¯ä»¥ç”¨æ¥æ”¶é›†é›†ç¾¤ä¸­çš„èµ„æºä½¿ç”¨æƒ…å†µ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># å®‰è£…git</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># yum install git -y</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è·å–metrics-server, æ³¨æ„ä½¿ç”¨çš„ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># git clone -b v0.3.6 https:/github.com/kubernetes-incubator/metrics-server</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿®æ”¹deployment, æ³¨æ„ä¿®æ”¹çš„æ˜¯é•œåƒå’Œåˆå§‹åŒ–å‚æ•°</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cd /root/metrics-server/deploy/1.8+/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># vim metrics-server-deployment.yaml</span>
</span></span><span style="display:flex;"><span>æŒ‰å›¾ä¸­æ·»åŠ ä¸‹é¢é€‰é¡¹
</span></span><span style="display:flex;"><span>hostNetwork: true
</span></span><span style="display:flex;"><span>image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6
</span></span><span style="display:flex;"><span>args:
</span></span><span style="display:flex;"><span>- --kubelet-insecure-tls
</span></span><span style="display:flex;"><span>- --kubelet-preferred-address-types<span style="color:#f92672">=</span>InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP
</span></span></code></pre></div><p><img loading="lazy" src="/kubernetes.images/image-20200608163326496.png" alt="image-20200608163326496"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># å®‰è£…metrics-server</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f ./</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹podè¿è¡Œæƒ…å†µ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n kube-system</span>
</span></span><span style="display:flex;"><span>metrics-server-6b976979db-2xwbj   1/1     Running   <span style="color:#ae81ff">0</span>          90s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä½¿ç”¨kubectl top node æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl top node</span>
</span></span><span style="display:flex;"><span>NAME           CPU<span style="color:#f92672">(</span>cores<span style="color:#f92672">)</span>   CPU%   MEMORY<span style="color:#f92672">(</span>bytes<span style="color:#f92672">)</span>   MEMORY%
</span></span><span style="display:flex;"><span>k8s-master01   289m         14%    1582Mi          54%       
</span></span><span style="display:flex;"><span>k8s-node01     81m          4%     1195Mi          40%       
</span></span><span style="display:flex;"><span>k8s-node02     72m          3%     1211Mi          41%  
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl top pod -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                              CPU<span style="color:#f92672">(</span>cores<span style="color:#f92672">)</span>   MEMORY<span style="color:#f92672">(</span>bytes<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>coredns-6955765f44-7ptsb          3m           9Mi
</span></span><span style="display:flex;"><span>coredns-6955765f44-vcwr5          3m           8Mi
</span></span><span style="display:flex;"><span>etcd-master                       14m          145Mi
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è‡³æ­¤,metrics-serverå®‰è£…å®Œæˆ</span>
</span></span></code></pre></div><h5 id="642-å‡†å¤‡deploymentå’Œservie">6.4.2 å‡†å¤‡deploymentå’Œservie<a hidden class="anchor" aria-hidden="true" href="#642-å‡†å¤‡deploymentå’Œservie">#</a></h5>
<p>åˆ›å»ºpc-hpa-pod.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>: <span style="color:#75715e"># ç­–ç•¥</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span> <span style="color:#75715e"># æ»šåŠ¨æ›´æ–°ç­–ç•¥</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>: <span style="color:#75715e"># èµ„æºé…é¢</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:  <span style="color:#75715e"># é™åˆ¶èµ„æºï¼ˆä¸Šé™ï¼‰</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;1&#34;</span> <span style="color:#75715e"># CPUé™åˆ¶ï¼Œå•ä½æ˜¯coreæ•°</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>: <span style="color:#75715e"># è¯·æ±‚èµ„æºï¼ˆä¸‹é™ï¼‰</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;100m&#34;</span>  <span style="color:#75715e"># CPUé™åˆ¶ï¼Œå•ä½æ˜¯coreæ•°</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºdeployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl run nginx --image=nginx:1.17.1 --requests=cpu=100m -n dev</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºservice</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl expose deployment nginx --type=NodePort --port=80 -n dev</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deployment,pod,svc -n dev</span>
</span></span><span style="display:flex;"><span>NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/nginx   1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           47s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                         READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/nginx-7df9756ccc-bh8dr   1/1     Running   <span style="color:#ae81ff">0</span>          47s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>        AGE
</span></span><span style="display:flex;"><span>service/nginx   NodePort   10.101.18.29   &lt;none&gt;        80:31830/TCP   35s
</span></span></code></pre></div><h5 id="643-éƒ¨ç½²hpa">6.4.3 éƒ¨ç½²HPA<a hidden class="anchor" aria-hidden="true" href="#643-éƒ¨ç½²hpa">#</a></h5>
<p>åˆ›å»ºpc-hpa.yamlæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">autoscaling/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">HorizontalPodAutoscaler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-hpa</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReplicas</span>: <span style="color:#ae81ff">1</span>  <span style="color:#75715e">#æœ€å°podæ•°é‡</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">maxReplicas</span>: <span style="color:#ae81ff">10</span> <span style="color:#75715e">#æœ€å¤§podæ•°é‡</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">targetCPUUtilizationPercentage</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># CPUä½¿ç”¨ç‡æŒ‡æ ‡</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scaleTargetRef</span>:   <span style="color:#75715e"># æŒ‡å®šè¦æ§åˆ¶çš„nginxä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiVersion</span>:  <span style="color:#ae81ff">/v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºhpa</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pc-hpa.yaml</span>
</span></span><span style="display:flex;"><span>horizontalpodautoscaler.autoscaling/pc-hpa created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹hpa</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get hpa -n dev</span>
</span></span><span style="display:flex;"><span>NAME     REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span style="display:flex;"><span>pc-hpa   Deployment/nginx   0%/3%     <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">10</span>        <span style="color:#ae81ff">1</span>          62s
</span></span></code></pre></div><h5 id="644-æµ‹è¯•">6.4.4 æµ‹è¯•<a hidden class="anchor" aria-hidden="true" href="#644-æµ‹è¯•">#</a></h5>
<p>ä½¿ç”¨å‹æµ‹å·¥å…·å¯¹serviceåœ°å€<code>192.168.5.4:31830</code>è¿›è¡Œå‹æµ‹ï¼Œç„¶åé€šè¿‡æ§åˆ¶å°æŸ¥çœ‹hpaå’Œpodçš„å˜åŒ–</p>
<p>hpaå˜åŒ–</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get hpa -n dev -w</span>
</span></span><span style="display:flex;"><span>NAME   REFERENCE      TARGETS  MINPODS  MAXPODS  REPLICAS  AGE
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  0%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">1</span>      4m11s
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  0%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">1</span>      5m19s
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  22%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">1</span>      6m50s
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  22%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">4</span>      7m5s
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  22%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">8</span>      7m21s
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  6%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">8</span>      7m51s
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  0%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">8</span>      9m6s
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  0%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">8</span>      13m
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  0%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">1</span>      14m
</span></span></code></pre></div><p>deploymentå˜åŒ–</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deployment -n dev -w</span>
</span></span><span style="display:flex;"><span>NAME    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>nginx   1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           11m
</span></span><span style="display:flex;"><span>nginx   1/4     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           13m
</span></span><span style="display:flex;"><span>nginx   1/4     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           13m
</span></span><span style="display:flex;"><span>nginx   1/4     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           13m
</span></span><span style="display:flex;"><span>nginx   1/4     <span style="color:#ae81ff">4</span>            <span style="color:#ae81ff">1</span>           13m
</span></span><span style="display:flex;"><span>nginx   1/8     <span style="color:#ae81ff">4</span>            <span style="color:#ae81ff">1</span>           14m
</span></span><span style="display:flex;"><span>nginx   1/8     <span style="color:#ae81ff">4</span>            <span style="color:#ae81ff">1</span>           14m
</span></span><span style="display:flex;"><span>nginx   1/8     <span style="color:#ae81ff">4</span>            <span style="color:#ae81ff">1</span>           14m
</span></span><span style="display:flex;"><span>nginx   1/8     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">1</span>           14m
</span></span><span style="display:flex;"><span>nginx   2/8     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">2</span>           14m
</span></span><span style="display:flex;"><span>nginx   3/8     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">3</span>           14m
</span></span><span style="display:flex;"><span>nginx   4/8     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">4</span>           14m
</span></span><span style="display:flex;"><span>nginx   5/8     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">5</span>           14m
</span></span><span style="display:flex;"><span>nginx   6/8     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">6</span>           14m
</span></span><span style="display:flex;"><span>nginx   7/8     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">7</span>           14m
</span></span><span style="display:flex;"><span>nginx   8/8     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">8</span>           15m
</span></span><span style="display:flex;"><span>nginx   8/1     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">8</span>           20m
</span></span><span style="display:flex;"><span>nginx   8/1     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">8</span>           20m
</span></span><span style="display:flex;"><span>nginx   1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           20m
</span></span></code></pre></div><p>podå˜åŒ–</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -w</span>
</span></span><span style="display:flex;"><span>NAME                     READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-bh8dr   1/1     Running   <span style="color:#ae81ff">0</span>          11m
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-cpgrv   0/1     Pending   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-8zhwk   0/1     Pending   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-rr9bn   0/1     Pending   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-cpgrv   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-8zhwk   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-rr9bn   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-m9gsj   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-g56qb   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-sl9c6   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-fgst7   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-g56qb   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-m9gsj   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-sl9c6   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-fgst7   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-8zhwk   1/1     Running             <span style="color:#ae81ff">0</span>          19s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-rr9bn   1/1     Running             <span style="color:#ae81ff">0</span>          30s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-m9gsj   1/1     Running             <span style="color:#ae81ff">0</span>          21s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-cpgrv   1/1     Running             <span style="color:#ae81ff">0</span>          47s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-sl9c6   1/1     Running             <span style="color:#ae81ff">0</span>          33s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-g56qb   1/1     Running             <span style="color:#ae81ff">0</span>          48s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-fgst7   1/1     Running             <span style="color:#ae81ff">0</span>          66s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-fgst7   1/1     Terminating         <span style="color:#ae81ff">0</span>          6m50s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-8zhwk   1/1     Terminating         <span style="color:#ae81ff">0</span>          7m5s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-cpgrv   1/1     Terminating         <span style="color:#ae81ff">0</span>          7m5s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-g56qb   1/1     Terminating         <span style="color:#ae81ff">0</span>          6m50s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-rr9bn   1/1     Terminating         <span style="color:#ae81ff">0</span>          7m5s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-m9gsj   1/1     Terminating         <span style="color:#ae81ff">0</span>          6m50s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-sl9c6   1/1     Terminating         <span style="color:#ae81ff">0</span>          6m50s
</span></span></code></pre></div><h4 id="65-daemonsetds">6.5 DaemonSet(DS)<a hidden class="anchor" aria-hidden="true" href="#65-daemonsetds">#</a></h4>
<p>DaemonSetç±»å‹çš„æ§åˆ¶å™¨å¯ä»¥ä¿è¯åœ¨é›†ç¾¤ä¸­çš„æ¯ä¸€å°ï¼ˆæˆ–æŒ‡å®šï¼‰èŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œä¸€ä¸ªå‰¯æœ¬ã€‚ä¸€èˆ¬é€‚ç”¨äºæ—¥å¿—æ”¶é›†ã€èŠ‚ç‚¹ç›‘æ§ç­‰åœºæ™¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªPodæä¾›çš„åŠŸèƒ½æ˜¯èŠ‚ç‚¹çº§åˆ«çš„ï¼ˆæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦ä¸”åªéœ€è¦ä¸€ä¸ªï¼‰ï¼Œé‚£ä¹ˆè¿™ç±»Podå°±é€‚åˆä½¿ç”¨DaemonSetç±»å‹çš„æ§åˆ¶å™¨åˆ›å»ºã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200612010223537.png" alt="img"  />
</p>
<p>DaemonSetæ§åˆ¶å™¨çš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ¯å½“å‘é›†ç¾¤ä¸­æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼ŒæŒ‡å®šçš„ Pod å‰¯æœ¬ä¹Ÿå°†æ·»åŠ åˆ°è¯¥èŠ‚ç‚¹ä¸Š</li>
<li>å½“èŠ‚ç‚¹ä»é›†ç¾¤ä¸­ç§»é™¤æ—¶ï¼ŒPod ä¹Ÿå°±è¢«åƒåœ¾å›æ”¶äº†</li>
</ul>
<p>ä¸‹é¢å…ˆæ¥çœ‹ä¸‹DaemonSetçš„èµ„æºæ¸…å•æ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span> <span style="color:#75715e"># ç‰ˆæœ¬å·</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet</span> <span style="color:#75715e"># ç±»å‹       </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># å…ƒæ•°æ®</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#75715e"># rsåç§° </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#75715e"># æ‰€å±å‘½åç©ºé—´ </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>: <span style="color:#75715e">#æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">daemonset</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># è¯¦æƒ…æè¿°</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># ä¿ç•™å†å²ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>: <span style="color:#75715e"># æ›´æ–°ç­–ç•¥</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span> <span style="color:#75715e"># æ»šåŠ¨æ›´æ–°ç­–ç•¥</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>: <span style="color:#75715e"># æ»šåŠ¨æ›´æ–°</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># æœ€å¤§ä¸å¯ç”¨çŠ¶æ€çš„ Pod çš„æœ€å¤§å€¼ï¼Œå¯ä»¥ä¸ºç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯ä»¥ä¸ºæ•´æ•°</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># é€‰æ‹©å™¨ï¼Œé€šè¿‡å®ƒæŒ‡å®šè¯¥æ§åˆ¶å™¨ç®¡ç†å“ªäº›pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:      <span style="color:#75715e"># LabelsåŒ¹é…è§„åˆ™</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># ExpressionsåŒ¹é…è§„åˆ™</span>
</span></span><span style="display:flex;"><span>      - {<span style="color:#f92672">key: app, operator: In, values</span>: [<span style="color:#ae81ff">nginx-pod]}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>: <span style="color:#75715e"># æ¨¡æ¿ï¼Œå½“å‰¯æœ¬æ•°é‡ä¸è¶³æ—¶ï¼Œä¼šæ ¹æ®ä¸‹é¢çš„æ¨¡æ¿åˆ›å»ºpodå‰¯æœ¬</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><p>åˆ›å»ºpc-daemonset.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet      </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-daemonset</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºdaemonset</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f  pc-daemonset.yaml</span>
</span></span><span style="display:flex;"><span>daemonset.apps/pc-daemonset created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹daemonset</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e">#  kubectl get ds -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME        DESIRED  CURRENT  READY  UP-TO-DATE  AVAILABLE   AGE   CONTAINERS   IMAGES         
</span></span><span style="display:flex;"><span>pc-daemonset   <span style="color:#ae81ff">2</span>        <span style="color:#ae81ff">2</span>        <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">2</span>           <span style="color:#ae81ff">2</span>        24s   nginx        nginx:1.17.1   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pod,å‘ç°åœ¨æ¯ä¸ªNodeä¸Šéƒ½è¿è¡Œä¸€ä¸ªpod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e">#  kubectl get pods -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                 READY   STATUS    RESTARTS   AGE   IP            NODE    
</span></span><span style="display:flex;"><span>pc-daemonset-9bck8   1/1     Running   <span style="color:#ae81ff">0</span>          37s   10.244.1.43   node1     
</span></span><span style="display:flex;"><span>pc-daemonset-k224w   1/1     Running   <span style="color:#ae81ff">0</span>          37s   10.244.2.74   node2      
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ é™¤daemonset</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete -f pc-daemonset.yaml</span>
</span></span><span style="display:flex;"><span>daemonset.apps <span style="color:#e6db74">&#34;pc-daemonset&#34;</span> deleted
</span></span></code></pre></div><h4 id="66-job">6.6 Job<a hidden class="anchor" aria-hidden="true" href="#66-job">#</a></h4>
<p>Jobï¼Œä¸»è¦ç”¨äºè´Ÿè´£æ‰¹é‡å¤„ç†(ä¸€æ¬¡è¦å¤„ç†æŒ‡å®šæ•°é‡ä»»åŠ¡)çŸ­æš‚çš„ä¸€æ¬¡æ€§(æ¯ä¸ªä»»åŠ¡ä»…è¿è¡Œä¸€æ¬¡å°±ç»“æŸ)ä»»åŠ¡ã€‚Jobç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å½“Jobåˆ›å»ºçš„podæ‰§è¡ŒæˆåŠŸç»“æŸæ—¶ï¼ŒJobå°†è®°å½•æˆåŠŸç»“æŸçš„podæ•°é‡</li>
<li>å½“æˆåŠŸç»“æŸçš„podè¾¾åˆ°æŒ‡å®šçš„æ•°é‡æ—¶ï¼ŒJobå°†å®Œæˆæ‰§è¡Œ</li>
</ul>
<p><img loading="lazy" src="/kubernetes.images/image-20200618213054113.png" alt="img"  />
</p>
<p>Jobçš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1</span> <span style="color:#75715e"># ç‰ˆæœ¬å·</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Job</span> <span style="color:#75715e"># ç±»å‹       </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># å…ƒæ•°æ®</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#75715e"># rsåç§° </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#75715e"># æ‰€å±å‘½åç©ºé—´ </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>: <span style="color:#75715e">#æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># è¯¦æƒ…æè¿°</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">completions: 1 # æŒ‡å®šjobéœ€è¦æˆåŠŸè¿è¡ŒPodsçš„æ¬¡æ•°ã€‚é»˜è®¤å€¼</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">parallelism: 1 # æŒ‡å®šjobåœ¨ä»»ä¸€æ—¶åˆ»åº”è¯¥å¹¶å‘è¿è¡ŒPodsçš„æ•°é‡ã€‚é»˜è®¤å€¼</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">activeDeadlineSeconds</span>: <span style="color:#ae81ff">30</span> <span style="color:#75715e"># æŒ‡å®šjobå¯è¿è¡Œçš„æ—¶é—´æœŸé™ï¼Œè¶…è¿‡æ—¶é—´è¿˜æœªç»“æŸï¼Œç³»ç»Ÿå°†ä¼šå°è¯•è¿›è¡Œç»ˆæ­¢ã€‚</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">backoffLimit</span>: <span style="color:#ae81ff">6</span> <span style="color:#75715e"># æŒ‡å®šjobå¤±è´¥åè¿›è¡Œé‡è¯•çš„æ¬¡æ•°ã€‚é»˜è®¤æ˜¯6</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">manualSelector</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># æ˜¯å¦å¯ä»¥ä½¿ç”¨selectoré€‰æ‹©å™¨é€‰æ‹©podï¼Œé»˜è®¤æ˜¯false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># é€‰æ‹©å™¨ï¼Œé€šè¿‡å®ƒæŒ‡å®šè¯¥æ§åˆ¶å™¨ç®¡ç†å“ªäº›pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:      <span style="color:#75715e"># LabelsåŒ¹é…è§„åˆ™</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># ExpressionsåŒ¹é…è§„åˆ™</span>
</span></span><span style="display:flex;"><span>      - {<span style="color:#f92672">key: app, operator: In, values</span>: [<span style="color:#ae81ff">counter-pod]}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>: <span style="color:#75715e"># æ¨¡æ¿ï¼Œå½“å‰¯æœ¬æ•°é‡ä¸è¶³æ—¶ï¼Œä¼šæ ¹æ®ä¸‹é¢çš„æ¨¡æ¿åˆ›å»ºpodå‰¯æœ¬</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never</span> <span style="color:#75715e"># é‡å¯ç­–ç•¥åªèƒ½è®¾ç½®ä¸ºNeveræˆ–è€…OnFailure</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">counter</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 2;done&#34;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span>å…³äºé‡å¯ç­–ç•¥è®¾ç½®çš„è¯´æ˜ï¼š
</span></span><span style="display:flex;"><span>    å¦‚æœæŒ‡å®šä¸ºOnFailureï¼Œåˆ™jobä¼šåœ¨podå‡ºç°æ•…éšœæ—¶é‡å¯å®¹å™¨ï¼Œè€Œä¸æ˜¯åˆ›å»ºpodï¼Œfailedæ¬¡æ•°ä¸å˜
</span></span><span style="display:flex;"><span>    å¦‚æœæŒ‡å®šä¸ºNeverï¼Œåˆ™jobä¼šåœ¨podå‡ºç°æ•…éšœæ—¶åˆ›å»ºæ–°çš„podï¼Œå¹¶ä¸”æ•…éšœpodä¸ä¼šæ¶ˆå¤±ï¼Œä¹Ÿä¸ä¼šé‡å¯ï¼Œfailedæ¬¡æ•°åŠ 1
</span></span><span style="display:flex;"><span>    å¦‚æœæŒ‡å®šä¸ºAlwaysçš„è¯ï¼Œå°±æ„å‘³ç€ä¸€ç›´é‡å¯ï¼Œæ„å‘³ç€jobä»»åŠ¡ä¼šé‡å¤å»æ‰§è¡Œäº†ï¼Œå½“ç„¶ä¸å¯¹ï¼Œæ‰€ä»¥ä¸èƒ½è®¾ç½®ä¸ºAlways
</span></span></code></pre></div><p>åˆ›å»ºpc-job.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Job      </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-job</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">manualSelector</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">counter</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&#34;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºjob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pc-job.yaml</span>
</span></span><span style="display:flex;"><span>job.batch/pc-job created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get job -n dev -o wide  -w</span>
</span></span><span style="display:flex;"><span>NAME     COMPLETIONS   DURATION   AGE   CONTAINERS   IMAGES         SELECTOR
</span></span><span style="display:flex;"><span>pc-job   0/1           21s        21s   counter      busybox:1.30   app<span style="color:#f92672">=</span>counter-pod
</span></span><span style="display:flex;"><span>pc-job   1/1           31s        79s   counter      busybox:1.30   app<span style="color:#f92672">=</span>counter-pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é€šè¿‡è§‚å¯ŸpodçŠ¶æ€å¯ä»¥çœ‹åˆ°ï¼Œpodåœ¨è¿è¡Œå®Œæ¯•ä»»åŠ¡åï¼Œå°±ä¼šå˜æˆCompletedçŠ¶æ€</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -w</span>
</span></span><span style="display:flex;"><span>NAME           READY   STATUS     RESTARTS      AGE
</span></span><span style="display:flex;"><span>pc-job-rxg96   1/1     Running     <span style="color:#ae81ff">0</span>            29s
</span></span><span style="display:flex;"><span>pc-job-rxg96   0/1     Completed   <span style="color:#ae81ff">0</span>            33s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¥ä¸‹æ¥ï¼Œè°ƒæ•´ä¸‹podè¿è¡Œçš„æ€»æ•°é‡å’Œå¹¶è¡Œæ•°é‡ å³ï¼šåœ¨specä¸‹è®¾ç½®ä¸‹é¢ä¸¤ä¸ªé€‰é¡¹</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  completions: 6 # æŒ‡å®šjobéœ€è¦æˆåŠŸè¿è¡ŒPodsçš„æ¬¡æ•°ä¸º6</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  parallelism: 3 # æŒ‡å®šjobå¹¶å‘è¿è¡ŒPodsçš„æ•°é‡ä¸º3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  ç„¶åé‡æ–°è¿è¡Œjobï¼Œè§‚å¯Ÿæ•ˆæœï¼Œæ­¤æ—¶ä¼šå‘ç°ï¼Œjobä¼šæ¯æ¬¡è¿è¡Œ3ä¸ªpodï¼Œæ€»å…±æ‰§è¡Œäº†6ä¸ªpod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -w</span>
</span></span><span style="display:flex;"><span>NAME           READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-job-684ft   1/1     Running   <span style="color:#ae81ff">0</span>          5s
</span></span><span style="display:flex;"><span>pc-job-jhj49   1/1     Running   <span style="color:#ae81ff">0</span>          5s
</span></span><span style="display:flex;"><span>pc-job-pfcvh   1/1     Running   <span style="color:#ae81ff">0</span>          5s
</span></span><span style="display:flex;"><span>pc-job-684ft   0/1     Completed   <span style="color:#ae81ff">0</span>          11s
</span></span><span style="display:flex;"><span>pc-job-v7rhr   0/1     Pending     <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-v7rhr   0/1     Pending     <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-v7rhr   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-jhj49   0/1     Completed           <span style="color:#ae81ff">0</span>          11s
</span></span><span style="display:flex;"><span>pc-job-fhwf7   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-fhwf7   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-pfcvh   0/1     Completed           <span style="color:#ae81ff">0</span>          11s
</span></span><span style="display:flex;"><span>pc-job-5vg2j   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-fhwf7   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-5vg2j   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-5vg2j   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-fhwf7   1/1     Running             <span style="color:#ae81ff">0</span>          2s
</span></span><span style="display:flex;"><span>pc-job-v7rhr   1/1     Running             <span style="color:#ae81ff">0</span>          2s
</span></span><span style="display:flex;"><span>pc-job-5vg2j   1/1     Running             <span style="color:#ae81ff">0</span>          3s
</span></span><span style="display:flex;"><span>pc-job-fhwf7   0/1     Completed           <span style="color:#ae81ff">0</span>          12s
</span></span><span style="display:flex;"><span>pc-job-v7rhr   0/1     Completed           <span style="color:#ae81ff">0</span>          12s
</span></span><span style="display:flex;"><span>pc-job-5vg2j   0/1     Completed           <span style="color:#ae81ff">0</span>          12s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ é™¤job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete -f pc-job.yaml</span>
</span></span><span style="display:flex;"><span>job.batch <span style="color:#e6db74">&#34;pc-job&#34;</span> deleted
</span></span></code></pre></div><h4 id="67-cronjobcj">6.7 CronJob(CJ)<a hidden class="anchor" aria-hidden="true" href="#67-cronjobcj">#</a></h4>
<p>CronJobæ§åˆ¶å™¨ä»¥ Jobæ§åˆ¶å™¨èµ„æºä¸ºå…¶ç®¡æ§å¯¹è±¡ï¼Œå¹¶å€ŸåŠ©å®ƒç®¡ç†podèµ„æºå¯¹è±¡ï¼ŒJobæ§åˆ¶å™¨å®šä¹‰çš„ä½œä¸šä»»åŠ¡åœ¨å…¶æ§åˆ¶å™¨èµ„æºåˆ›å»ºä¹‹åä¾¿ä¼šç«‹å³æ‰§è¡Œï¼Œä½†CronJobå¯ä»¥ä»¥ç±»ä¼¼äºLinuxæ“ä½œç³»ç»Ÿçš„å‘¨æœŸæ€§ä»»åŠ¡ä½œä¸šè®¡åˆ’çš„æ–¹å¼æ§åˆ¶å…¶è¿è¡Œæ—¶é—´ç‚¹åŠé‡å¤è¿è¡Œçš„æ–¹å¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒCronJobå¯ä»¥åœ¨ç‰¹å®šçš„æ—¶é—´ç‚¹(åå¤çš„)å»è¿è¡Œjobä»»åŠ¡ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200618213149531.png" alt="img"  />
</p>
<p>CronJobçš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1beta1</span> <span style="color:#75715e"># ç‰ˆæœ¬å·</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CronJob</span> <span style="color:#75715e"># ç±»å‹       </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># å…ƒæ•°æ®</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#75715e"># rsåç§° </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#75715e"># æ‰€å±å‘½åç©ºé—´ </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>: <span style="color:#75715e">#æ ‡ç­¾</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">cronjob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># è¯¦æƒ…æè¿°</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">schedule</span>: <span style="color:#75715e"># cronæ ¼å¼çš„ä½œä¸šè°ƒåº¦è¿è¡Œæ—¶é—´ç‚¹,ç”¨äºæ§åˆ¶ä»»åŠ¡åœ¨ä»€ä¹ˆæ—¶é—´æ‰§è¡Œ</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">concurrencyPolicy</span>: <span style="color:#75715e"># å¹¶å‘æ‰§è¡Œç­–ç•¥ï¼Œç”¨äºå®šä¹‰å‰ä¸€æ¬¡ä½œä¸šè¿è¡Œå°šæœªå®Œæˆæ—¶æ˜¯å¦ä»¥åŠå¦‚ä½•è¿è¡Œåä¸€æ¬¡çš„ä½œä¸š</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">failedJobHistoryLimit</span>: <span style="color:#75715e"># ä¸ºå¤±è´¥çš„ä»»åŠ¡æ‰§è¡Œä¿ç•™çš„å†å²è®°å½•æ•°ï¼Œé»˜è®¤ä¸º1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">successfulJobHistoryLimit</span>: <span style="color:#75715e"># ä¸ºæˆåŠŸçš„ä»»åŠ¡æ‰§è¡Œä¿ç•™çš„å†å²è®°å½•æ•°ï¼Œé»˜è®¤ä¸º3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">startingDeadlineSeconds</span>: <span style="color:#75715e"># å¯åŠ¨ä½œä¸šé”™è¯¯çš„è¶…æ—¶æ—¶é•¿</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">jobTemplate</span>: <span style="color:#75715e"># jobæ§åˆ¶å™¨æ¨¡æ¿ï¼Œç”¨äºä¸ºcronjobæ§åˆ¶å™¨ç”Ÿæˆjobå¯¹è±¡;ä¸‹é¢å…¶å®å°±æ˜¯jobçš„å®šä¹‰</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">completions</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">parallelism</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">activeDeadlineSeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">backoffLimit</span>: <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">manualSelector</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchExpressions</span>: <span style="color:#ae81ff">è§„åˆ™</span>
</span></span><span style="display:flex;"><span>          - {<span style="color:#f92672">key: app, operator: In, values</span>: [<span style="color:#ae81ff">counter-pod]}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never </span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">counter</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 20;done&#34;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-markdown" data-lang="markdown"><span style="display:flex;"><span>éœ€è¦é‡ç‚¹è§£é‡Šçš„å‡ ä¸ªé€‰é¡¹ï¼š
</span></span><span style="display:flex;"><span>schedule: cronè¡¨è¾¾å¼ï¼Œç”¨äºæŒ‡å®šä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´
</span></span><span style="display:flex;"><span>    <span style="font-style:italic">*/1    *</span>      <span style="font-style:italic">*    *</span>     *
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">&lt;</span>åˆ†é’Ÿ&gt; <span style="color:#960050;background-color:#1e0010">&lt;</span>å°æ—¶&gt; <span style="color:#960050;background-color:#1e0010">&lt;</span>æ—¥&gt; <span style="color:#960050;background-color:#1e0010">&lt;</span>æœˆä»½&gt; <span style="color:#960050;background-color:#1e0010">&lt;</span>æ˜ŸæœŸ&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    åˆ†é’Ÿ å€¼ä» 0 åˆ° 59.
</span></span><span style="display:flex;"><span>    å°æ—¶ å€¼ä» 0 åˆ° 23.
</span></span><span style="display:flex;"><span>    æ—¥ å€¼ä» 1 åˆ° 31.
</span></span><span style="display:flex;"><span>    æœˆ å€¼ä» 1 åˆ° 12.
</span></span><span style="display:flex;"><span>    æ˜ŸæœŸ å€¼ä» 0 åˆ° 6, 0 ä»£è¡¨æ˜ŸæœŸæ—¥
</span></span><span style="display:flex;"><span>    å¤šä¸ªæ—¶é—´å¯ä»¥ç”¨é€—å·éš”å¼€ï¼› èŒƒå›´å¯ä»¥ç”¨è¿å­—ç¬¦ç»™å‡ºï¼›*å¯ä»¥ä½œä¸ºé€šé…ç¬¦ï¼› /è¡¨ç¤ºæ¯...
</span></span><span style="display:flex;"><span>concurrencyPolicy:
</span></span><span style="display:flex;"><span>    Allow:   å…è®¸Jobså¹¶å‘è¿è¡Œ(é»˜è®¤)
</span></span><span style="display:flex;"><span>    Forbid:  ç¦æ­¢å¹¶å‘è¿è¡Œï¼Œå¦‚æœä¸Šä¸€æ¬¡è¿è¡Œå°šæœªå®Œæˆï¼Œåˆ™è·³è¿‡ä¸‹ä¸€æ¬¡è¿è¡Œ
</span></span><span style="display:flex;"><span>    Replace: æ›¿æ¢ï¼Œå–æ¶ˆå½“å‰æ­£åœ¨è¿è¡Œçš„ä½œä¸šå¹¶ç”¨æ–°ä½œä¸šæ›¿æ¢å®ƒ
</span></span></code></pre></div><p>åˆ›å»ºpc-cronjob.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CronJob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-cronjob</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">cronjob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">schedule</span>: <span style="color:#e6db74">&#34;*/1 * * * *&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">jobTemplate</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">counter</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&#34;</span>]
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºcronjob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pc-cronjob.yaml</span>
</span></span><span style="display:flex;"><span>cronjob.batch/pc-cronjob created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹cronjob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get cronjobs -n dev</span>
</span></span><span style="display:flex;"><span>NAME         SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
</span></span><span style="display:flex;"><span>pc-cronjob   */1 * * * *   False     <span style="color:#ae81ff">0</span>        &lt;none&gt;          6s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get jobs -n dev</span>
</span></span><span style="display:flex;"><span>NAME                    COMPLETIONS   DURATION   AGE
</span></span><span style="display:flex;"><span>pc-cronjob-1592587800   1/1           28s        3m26s
</span></span><span style="display:flex;"><span>pc-cronjob-1592587860   1/1           28s        2m26s
</span></span><span style="display:flex;"><span>pc-cronjob-1592587920   1/1           28s        86s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>pc-cronjob-1592587800-x4tsm   0/1     Completed   <span style="color:#ae81ff">0</span>          2m24s
</span></span><span style="display:flex;"><span>pc-cronjob-1592587860-r5gv4   0/1     Completed   <span style="color:#ae81ff">0</span>          84s
</span></span><span style="display:flex;"><span>pc-cronjob-1592587920-9dxxq   1/1     Running     <span style="color:#ae81ff">0</span>          24s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ é™¤cronjob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl  delete -f pc-cronjob.yaml</span>
</span></span><span style="display:flex;"><span>cronjob.batch <span style="color:#e6db74">&#34;pc-cronjob&#34;</span> deleted
</span></span></code></pre></div><h3 id="7-serviceè¯¦è§£">7. Serviceè¯¦è§£<a hidden class="anchor" aria-hidden="true" href="#7-serviceè¯¦è§£">#</a></h3>
<h4 id="71-serviceä»‹ç»">7.1 Serviceä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#71-serviceä»‹ç»">#</a></h4>
<p>åœ¨kubernetesä¸­ï¼Œpodæ˜¯åº”ç”¨ç¨‹åºçš„è½½ä½“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡podçš„ipæ¥è®¿é—®åº”ç”¨ç¨‹åºï¼Œä½†æ˜¯podçš„ipåœ°å€ä¸æ˜¯å›ºå®šçš„ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ä¸æ–¹ä¾¿ç›´æ¥é‡‡ç”¨podçš„ipå¯¹æœåŠ¡è¿›è¡Œè®¿é—®ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œkubernetesæä¾›äº†Serviceèµ„æºï¼ŒServiceä¼šå¯¹æä¾›åŒä¸€ä¸ªæœåŠ¡çš„å¤šä¸ªpodè¿›è¡Œèšåˆï¼Œå¹¶ä¸”æä¾›ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£åœ°å€ã€‚é€šè¿‡è®¿é—®Serviceçš„å…¥å£åœ°å€å°±èƒ½è®¿é—®åˆ°åé¢çš„podæœåŠ¡ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200408194716912-1626783758946.png" alt="img"  />
</p>
<p>Serviceåœ¨å¾ˆå¤šæƒ…å†µä¸‹åªæ˜¯ä¸€ä¸ªæ¦‚å¿µï¼ŒçœŸæ­£èµ·ä½œç”¨çš„å…¶å®æ˜¯kube-proxyæœåŠ¡è¿›ç¨‹ï¼Œæ¯ä¸ªNodeèŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œç€ä¸€ä¸ªkube-proxyæœåŠ¡è¿›ç¨‹ã€‚å½“åˆ›å»ºServiceçš„æ—¶å€™ä¼šé€šè¿‡api-serverå‘etcdå†™å…¥åˆ›å»ºçš„serviceçš„ä¿¡æ¯ï¼Œè€Œkube-proxyä¼šåŸºäºç›‘å¬çš„æœºåˆ¶å‘ç°è¿™ç§Serviceçš„å˜åŠ¨ï¼Œç„¶åå®ƒä¼šå°†æœ€æ–°çš„Serviceä¿¡æ¯è½¬æ¢æˆå¯¹åº”çš„è®¿é—®è§„åˆ™ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200509121254425.png" alt="img"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># 10.97.97.97:80 æ˜¯serviceæä¾›çš„è®¿é—®å…¥å£
</span></span><span style="display:flex;"><span># å½“è®¿é—®è¿™ä¸ªå…¥å£çš„æ—¶å€™ï¼Œå¯ä»¥å‘ç°åé¢æœ‰ä¸‰ä¸ªpodçš„æœåŠ¡åœ¨ç­‰å¾…è°ƒç”¨ï¼Œ
</span></span><span style="display:flex;"><span># kube-proxyä¼šåŸºäºrrï¼ˆè½®è¯¢ï¼‰çš„ç­–ç•¥ï¼Œå°†è¯·æ±‚åˆ†å‘åˆ°å…¶ä¸­ä¸€ä¸ªpodä¸Šå»
</span></span><span style="display:flex;"><span># è¿™ä¸ªè§„åˆ™ä¼šåŒæ—¶åœ¨é›†ç¾¤å†…çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šéƒ½ç”Ÿæˆï¼Œæ‰€ä»¥åœ¨ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œéƒ½å¯ä»¥è®¿é—®ã€‚
</span></span><span style="display:flex;"><span>[root@node1 ~]# ipvsadm -Ln
</span></span><span style="display:flex;"><span>IP Virtual Server version 1.2.1 (size=4096)
</span></span><span style="display:flex;"><span>Prot LocalAddress:Port Scheduler Flags
</span></span><span style="display:flex;"><span>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</span></span><span style="display:flex;"><span>TCP  10.97.97.97:80 rr
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.39:80               Masq    1      0          0
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.40:80               Masq    1      0          0
</span></span><span style="display:flex;"><span>  -&gt; 10.244.2.33:80               Masq    1      0          0
</span></span></code></pre></div><p>kube-proxyç›®å‰æ”¯æŒä¸‰ç§å·¥ä½œæ¨¡å¼:</p>
<h5 id="711-userspace-æ¨¡å¼">7.1.1 userspace æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#711-userspace-æ¨¡å¼">#</a></h5>
<p>userspaceæ¨¡å¼ä¸‹ï¼Œkube-proxyä¼šä¸ºæ¯ä¸€ä¸ªServiceåˆ›å»ºä¸€ä¸ªç›‘å¬ç«¯å£ï¼Œå‘å‘Cluster IPçš„è¯·æ±‚è¢«Iptablesè§„åˆ™é‡å®šå‘åˆ°kube-proxyç›‘å¬çš„ç«¯å£ä¸Šï¼Œkube-proxyæ ¹æ®LBç®—æ³•é€‰æ‹©ä¸€ä¸ªæä¾›æœåŠ¡çš„Podå¹¶å’Œå…¶å»ºç«‹é“¾æ¥ï¼Œä»¥å°†è¯·æ±‚è½¬å‘åˆ°Podä¸Šã€‚  è¯¥æ¨¡å¼ä¸‹ï¼Œkube-proxyå……å½“äº†ä¸€ä¸ªå››å±‚è´Ÿè´£å‡è¡¡å™¨çš„è§’è‰²ã€‚ç”±äºkube-proxyè¿è¡Œåœ¨userspaceä¸­ï¼Œåœ¨è¿›è¡Œè½¬å‘å¤„ç†æ—¶ä¼šå¢åŠ å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´çš„æ•°æ®æ‹·è´ï¼Œè™½ç„¶æ¯”è¾ƒç¨³å®šï¼Œä½†æ˜¯æ•ˆç‡æ¯”è¾ƒä½ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200509151424280.png" alt="img"  />
</p>
<h5 id="712-iptables-æ¨¡å¼">7.1.2 iptables æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#712-iptables-æ¨¡å¼">#</a></h5>
<p>iptablesæ¨¡å¼ä¸‹ï¼Œkube-proxyä¸ºserviceåç«¯çš„æ¯ä¸ªPodåˆ›å»ºå¯¹åº”çš„iptablesè§„åˆ™ï¼Œç›´æ¥å°†å‘å‘Cluster IPçš„è¯·æ±‚é‡å®šå‘åˆ°ä¸€ä¸ªPod IPã€‚  è¯¥æ¨¡å¼ä¸‹kube-proxyä¸æ‰¿æ‹…å››å±‚è´Ÿè´£å‡è¡¡å™¨çš„è§’è‰²ï¼Œåªè´Ÿè´£åˆ›å»ºiptablesè§„åˆ™ã€‚è¯¥æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯è¾ƒuserspaceæ¨¡å¼æ•ˆç‡æ›´é«˜ï¼Œä½†ä¸èƒ½æä¾›çµæ´»çš„LBç­–ç•¥ï¼Œå½“åç«¯Podä¸å¯ç”¨æ—¶ä¹Ÿæ— æ³•è¿›è¡Œé‡è¯•ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200509152947714.png" alt="img"  />
</p>
<h5 id="713-ipvs-æ¨¡å¼">7.1.3 ipvs æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#713-ipvs-æ¨¡å¼">#</a></h5>
<p>ipvsæ¨¡å¼å’Œiptablesç±»ä¼¼ï¼Œkube-proxyç›‘æ§Podçš„å˜åŒ–å¹¶åˆ›å»ºç›¸åº”çš„ipvsè§„åˆ™ã€‚ipvsç›¸å¯¹iptablesè½¬å‘æ•ˆç‡æ›´é«˜ã€‚é™¤æ­¤ä»¥å¤–ï¼Œipvsæ”¯æŒæ›´å¤šçš„LBç®—æ³•ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200509153731363.png" alt="img"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># æ­¤æ¨¡å¼å¿…é¡»å®‰è£…ipvså†…æ ¸æ¨¡å—ï¼Œå¦åˆ™ä¼šé™çº§ä¸ºiptables</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¼€å¯ipvs</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl edit cm kube-proxy -n kube-system</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿®æ”¹mode: &#34;ipvs&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete pod -l k8s-app=kube-proxy -n kube-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@node1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ipvsadm -Ln</span>
</span></span><span style="display:flex;"><span>IP Virtual Server version 1.2.1 <span style="color:#f92672">(</span>size<span style="color:#f92672">=</span>4096<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Prot LocalAddress:Port Scheduler Flags
</span></span><span style="display:flex;"><span>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</span></span><span style="display:flex;"><span>TCP  10.97.97.97:80 rr
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.39:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.40:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.2.33:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><h4 id="72-serviceç±»å‹">7.2 Serviceç±»å‹<a hidden class="anchor" aria-hidden="true" href="#72-serviceç±»å‹">#</a></h4>
<p>Serviceçš„èµ„æºæ¸…å•æ–‡ä»¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service </span> <span style="color:#75715e"># èµ„æºç±»å‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1 </span> <span style="color:#75715e"># èµ„æºç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># å…ƒæ•°æ®</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service</span> <span style="color:#75715e"># èµ„æºåç§°</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span> <span style="color:#75715e"># å‘½åç©ºé—´</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># æè¿°</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># æ ‡ç­¾é€‰æ‹©å™¨ï¼Œç”¨äºç¡®å®šå½“å‰serviceä»£ç†å“ªäº›pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#75715e"># Serviceç±»å‹ï¼ŒæŒ‡å®šserviceçš„è®¿é—®æ–¹å¼</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>:  <span style="color:#75715e"># è™šæ‹ŸæœåŠ¡çš„ipåœ°å€</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sessionAffinity</span>: <span style="color:#75715e"># sessionäº²å’Œæ€§ï¼Œæ”¯æŒClientIPã€Noneä¸¤ä¸ªé€‰é¡¹</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>: <span style="color:#75715e"># ç«¯å£ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">3017</span>  <span style="color:#75715e"># serviceç«¯å£</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">5003</span> <span style="color:#75715e"># podç«¯å£</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">31122</span> <span style="color:#75715e"># ä¸»æœºç«¯å£</span>
</span></span></code></pre></div><ul>
<li>ClusterIPï¼šé»˜è®¤å€¼ï¼Œå®ƒæ˜¯Kubernetesç³»ç»Ÿè‡ªåŠ¨åˆ†é…çš„è™šæ‹ŸIPï¼Œåªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®</li>
<li>NodePortï¼šå°†Serviceé€šè¿‡æŒ‡å®šçš„Nodeä¸Šçš„ç«¯å£æš´éœ²ç»™å¤–éƒ¨ï¼Œé€šè¿‡æ­¤æ–¹æ³•ï¼Œå°±å¯ä»¥åœ¨é›†ç¾¤å¤–éƒ¨è®¿é—®æœåŠ¡</li>
<li>LoadBalancerï¼šä½¿ç”¨å¤–æ¥è´Ÿè½½å‡è¡¡å™¨å®Œæˆåˆ°æœåŠ¡çš„è´Ÿè½½åˆ†å‘ï¼Œæ³¨æ„æ­¤æ¨¡å¼éœ€è¦å¤–éƒ¨äº‘ç¯å¢ƒæ”¯æŒ</li>
<li>ExternalNameï¼š æŠŠé›†ç¾¤å¤–éƒ¨çš„æœåŠ¡å¼•å…¥é›†ç¾¤å†…éƒ¨ï¼Œç›´æ¥ä½¿ç”¨</li>
</ul>
<h4 id="73-serviceä½¿ç”¨">7.3 Serviceä½¿ç”¨<a hidden class="anchor" aria-hidden="true" href="#73-serviceä½¿ç”¨">#</a></h4>
<h5 id="731-å®éªŒç¯å¢ƒå‡†å¤‡">7.3.1 å®éªŒç¯å¢ƒå‡†å¤‡<a hidden class="anchor" aria-hidden="true" href="#731-å®éªŒç¯å¢ƒå‡†å¤‡">#</a></h5>
<p>åœ¨ä½¿ç”¨serviceä¹‹å‰ï¼Œé¦–å…ˆåˆ©ç”¨Deploymentåˆ›å»ºå‡º3ä¸ªpodï¼Œæ³¨æ„è¦ä¸ºpodè®¾ç½®<code>app=nginx-pod</code>çš„æ ‡ç­¾</p>
<p>åˆ›å»ºdeployment.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment      </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-deployment</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f deployment.yaml</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹podè¯¦æƒ…</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -o wide --show-labels</span>
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS     IP            NODE     LABELS
</span></span><span style="display:flex;"><span>pc-deployment-66cb59b984-8p84h   1/1     Running    10.244.1.39   node1    app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>pc-deployment-66cb59b984-vx8vx   1/1     Running    10.244.2.33   node2    app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>pc-deployment-66cb59b984-wnncx   1/1     Running    10.244.1.40   node1    app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸ºäº†æ–¹ä¾¿åé¢çš„æµ‹è¯•ï¼Œä¿®æ”¹ä¸‹ä¸‰å°nginxçš„index.htmlé¡µé¢ï¼ˆä¸‰å°ä¿®æ”¹çš„IPåœ°å€ä¸ä¸€è‡´ï¼‰</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># echo &#34;10.244.1.39&#34; &gt; /usr/share/nginx/html/index.html</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ä¿®æ”¹å®Œæ¯•ä¹‹åï¼Œè®¿é—®æµ‹è¯•</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># curl 10.244.1.39</span>
</span></span><span style="display:flex;"><span>10.244.1.39
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># curl 10.244.2.33</span>
</span></span><span style="display:flex;"><span>10.244.2.33
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># curl 10.244.1.40</span>
</span></span><span style="display:flex;"><span>10.244.1.40
</span></span></code></pre></div><h5 id="732-clusteripç±»å‹çš„service">7.3.2 ClusterIPç±»å‹çš„Service<a hidden class="anchor" aria-hidden="true" href="#732-clusteripç±»å‹çš„service">#</a></h5>
<p>åˆ›å»ºservice-clusterip.yamlæ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-clusterip</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">10.97.97.97</span> <span style="color:#75715e"># serviceçš„ipåœ°å€ï¼Œå¦‚æœä¸å†™ï¼Œé»˜è®¤ä¼šç”Ÿæˆä¸€ä¸ª</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>  <span style="color:#75715e"># Serviceç«¯å£       </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># podç«¯å£</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºservice</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f service-clusterip.yaml</span>
</span></span><span style="display:flex;"><span>service/service-clusterip created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>   AGE   SELECTOR
</span></span><span style="display:flex;"><span>service-clusterip   ClusterIP   10.97.97.97   &lt;none&gt;        80/TCP    13s   app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹serviceçš„è¯¦ç»†ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åœ¨è¿™é‡Œæœ‰ä¸€ä¸ªEndpointsåˆ—è¡¨ï¼Œé‡Œé¢å°±æ˜¯å½“å‰serviceå¯ä»¥è´Ÿè½½åˆ°çš„æœåŠ¡å…¥å£</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe svc service-clusterip -n dev</span>
</span></span><span style="display:flex;"><span>Name:              service-clusterip
</span></span><span style="display:flex;"><span>Namespace:         dev
</span></span><span style="display:flex;"><span>Labels:            &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Selector:          app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>Type:              ClusterIP
</span></span><span style="display:flex;"><span>IP:                10.97.97.97
</span></span><span style="display:flex;"><span>Port:              &lt;unset&gt;  80/TCP
</span></span><span style="display:flex;"><span>TargetPort:        80/TCP
</span></span><span style="display:flex;"><span>Endpoints:         10.244.1.39:80,10.244.1.40:80,10.244.2.33:80
</span></span><span style="display:flex;"><span>Session Affinity:  None
</span></span><span style="display:flex;"><span>Events:            &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹ipvsçš„æ˜ å°„è§„åˆ™</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ipvsadm -Ln</span>
</span></span><span style="display:flex;"><span>TCP  10.97.97.97:80 rr
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.39:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.40:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.2.33:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è®¿é—®10.97.97.97:80è§‚å¯Ÿæ•ˆæœ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># curl 10.97.97.97:80</span>
</span></span><span style="display:flex;"><span>10.244.2.33
</span></span></code></pre></div><h5 id="733-endpoint">7.3.3 Endpoint<a hidden class="anchor" aria-hidden="true" href="#733-endpoint">#</a></h5>
<p>Endpointæ˜¯kubernetesä¸­çš„ä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œå­˜å‚¨åœ¨etcdä¸­ï¼Œç”¨æ¥è®°å½•ä¸€ä¸ªserviceå¯¹åº”çš„æ‰€æœ‰podçš„è®¿é—®åœ°å€ï¼Œå®ƒæ˜¯æ ¹æ®serviceé…ç½®æ–‡ä»¶ä¸­selectoræè¿°äº§ç”Ÿçš„ã€‚</p>
<p>ä¸€ä¸ªServiceç”±ä¸€ç»„Podç»„æˆï¼Œè¿™äº›Podé€šè¿‡Endpointsæš´éœ²å‡ºæ¥ï¼ŒEndpointsæ˜¯å®ç°å®é™…æœåŠ¡çš„ç«¯ç‚¹é›†åˆã€‚æ¢å¥è¯è¯´ï¼Œserviceå’Œpodä¹‹é—´çš„è”ç³»æ˜¯é€šè¿‡endpointså®ç°çš„ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200509191917069.png" alt="image-20200509191917069"  />
</p>
<p>è´Ÿè½½åˆ†å‘ç­–ç•¥</p>
<p>å¯¹Serviceçš„è®¿é—®è¢«åˆ†å‘åˆ°äº†åç«¯çš„Podä¸Šå»ï¼Œç›®å‰kubernetesæä¾›äº†ä¸¤ç§è´Ÿè½½åˆ†å‘ç­–ç•¥ï¼š</p>
<ul>
<li>
<p>å¦‚æœä¸å®šä¹‰ï¼Œé»˜è®¤ä½¿ç”¨kube-proxyçš„ç­–ç•¥ï¼Œæ¯”å¦‚éšæœºã€è½®è¯¢</p>
</li>
<li>
<p>åŸºäºå®¢æˆ·ç«¯åœ°å€çš„ä¼šè¯ä¿æŒæ¨¡å¼ï¼Œå³æ¥è‡ªåŒä¸€ä¸ªå®¢æˆ·ç«¯å‘èµ·çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šè½¬å‘åˆ°å›ºå®šçš„ä¸€ä¸ªPodä¸Š</p>
<p>æ­¤æ¨¡å¼å¯ä»¥ä½¿åœ¨specä¸­æ·»åŠ <code>sessionAffinity:ClientIP</code>é€‰é¡¹</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹ipvsçš„æ˜ å°„è§„åˆ™ã€rr è½®è¯¢ã€‘</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ipvsadm -Ln</span>
</span></span><span style="display:flex;"><span>TCP  10.97.97.97:80 rr
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.39:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.40:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.2.33:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¾ªç¯è®¿é—®æµ‹è¯•</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># while true;do curl 10.97.97.97:80; sleep 5; done;</span>
</span></span><span style="display:flex;"><span>10.244.1.40
</span></span><span style="display:flex;"><span>10.244.1.39
</span></span><span style="display:flex;"><span>10.244.2.33
</span></span><span style="display:flex;"><span>10.244.1.40
</span></span><span style="display:flex;"><span>10.244.1.39
</span></span><span style="display:flex;"><span>10.244.2.33
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿®æ”¹åˆ†å‘ç­–ç•¥----sessionAffinity:ClientIP</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹ipvsè§„åˆ™ã€persistent ä»£è¡¨æŒä¹…ã€‘</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ipvsadm -Ln</span>
</span></span><span style="display:flex;"><span>TCP  10.97.97.97:80 rr persistent <span style="color:#ae81ff">10800</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.39:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.40:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.2.33:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¾ªç¯è®¿é—®æµ‹è¯•</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># while true;do curl 10.97.97.97; sleep 5; done;</span>
</span></span><span style="display:flex;"><span>10.244.2.33
</span></span><span style="display:flex;"><span>10.244.2.33
</span></span><span style="display:flex;"><span>10.244.2.33
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ é™¤service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete -f service-clusterip.yaml</span>
</span></span><span style="display:flex;"><span>service <span style="color:#e6db74">&#34;service-clusterip&#34;</span> deleted
</span></span></code></pre></div><h5 id="734-headlinessç±»å‹çš„service">7.3.4 HeadLinessç±»å‹çš„Service<a hidden class="anchor" aria-hidden="true" href="#734-headlinessç±»å‹çš„service">#</a></h5>
<p>åœ¨æŸäº›åœºæ™¯ä¸­ï¼Œå¼€å‘äººå‘˜å¯èƒ½ä¸æƒ³ä½¿ç”¨Serviceæä¾›çš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œè€Œå¸Œæœ›è‡ªå·±æ¥æ§åˆ¶è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µï¼Œkubernetesæä¾›äº†HeadLiness Serviceï¼Œè¿™ç±»Serviceä¸ä¼šåˆ†é…Cluster IPï¼Œå¦‚æœæƒ³è¦è®¿é—®serviceï¼Œåªèƒ½é€šè¿‡serviceçš„åŸŸåè¿›è¡ŒæŸ¥è¯¢ã€‚</p>
<p>åˆ›å»ºservice-headliness.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-headliness</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None</span> <span style="color:#75715e"># å°†clusterIPè®¾ç½®ä¸ºNoneï¼Œå³å¯åˆ›å»ºheadliness Service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºservice</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f service-headliness.yaml</span>
</span></span><span style="display:flex;"><span>service/service-headliness created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è·å–serviceï¼Œ å‘ç°CLUSTER-IPæœªåˆ†é…</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc service-headliness -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>   AGE   SELECTOR
</span></span><span style="display:flex;"><span>service-headliness   ClusterIP   None         &lt;none&gt;        80/TCP    11s   app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹serviceè¯¦æƒ…</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe svc service-headliness  -n dev</span>
</span></span><span style="display:flex;"><span>Name:              service-headliness
</span></span><span style="display:flex;"><span>Namespace:         dev
</span></span><span style="display:flex;"><span>Labels:            &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Selector:          app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>Type:              ClusterIP
</span></span><span style="display:flex;"><span>IP:                None
</span></span><span style="display:flex;"><span>Port:              &lt;unset&gt;  80/TCP
</span></span><span style="display:flex;"><span>TargetPort:        80/TCP
</span></span><span style="display:flex;"><span>Endpoints:         10.244.1.39:80,10.244.1.40:80,10.244.2.33:80
</span></span><span style="display:flex;"><span>Session Affinity:  None
</span></span><span style="display:flex;"><span>Events:            &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹åŸŸåçš„è§£ææƒ…å†µ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span>
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># cat /etc/resolv.conf</span>
</span></span><span style="display:flex;"><span>nameserver 10.96.0.10
</span></span><span style="display:flex;"><span>search dev.svc.cluster.local svc.cluster.local cluster.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># dig @10.96.0.10 service-headliness.dev.svc.cluster.local</span>
</span></span><span style="display:flex;"><span>service-headliness.dev.svc.cluster.local. <span style="color:#ae81ff">30</span> IN A 10.244.1.40
</span></span><span style="display:flex;"><span>service-headliness.dev.svc.cluster.local. <span style="color:#ae81ff">30</span> IN A 10.244.1.39
</span></span><span style="display:flex;"><span>service-headliness.dev.svc.cluster.local. <span style="color:#ae81ff">30</span> IN A 10.244.2.33
</span></span></code></pre></div><h5 id="735-nodeportç±»å‹çš„service">7.3.5 NodePortç±»å‹çš„Service<a hidden class="anchor" aria-hidden="true" href="#735-nodeportç±»å‹çš„service">#</a></h5>
<p>åœ¨ä¹‹å‰çš„æ ·ä¾‹ä¸­ï¼Œåˆ›å»ºçš„Serviceçš„ipåœ°å€åªæœ‰é›†ç¾¤å†…éƒ¨æ‰å¯ä»¥è®¿é—®ï¼Œå¦‚æœå¸Œæœ›å°†Serviceæš´éœ²ç»™é›†ç¾¤å¤–éƒ¨ä½¿ç”¨ï¼Œé‚£ä¹ˆå°±è¦ä½¿ç”¨åˆ°å¦å¤–ä¸€ç§ç±»å‹çš„Serviceï¼Œç§°ä¸ºNodePortç±»å‹ã€‚NodePortçš„å·¥ä½œåŸç†å…¶å®å°±æ˜¯å°†serviceçš„ç«¯å£æ˜ å°„åˆ°Nodeçš„ä¸€ä¸ªç«¯å£ä¸Šï¼Œç„¶åå°±å¯ä»¥é€šè¿‡<code>NodeIp:NodePort</code>æ¥è®¿é—®serviceäº†ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200620175731338.png" alt="img"  />
</p>
<p>åˆ›å»ºservice-nodeport.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-nodeport</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span> <span style="color:#75715e"># serviceç±»å‹</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30002</span> <span style="color:#75715e"># æŒ‡å®šç»‘å®šçš„nodeçš„ç«¯å£(é»˜è®¤çš„å–å€¼èŒƒå›´æ˜¯ï¼š30000-32767), å¦‚æœä¸æŒ‡å®šï¼Œä¼šé»˜è®¤åˆ†é…</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºservice</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f service-nodeport.yaml</span>
</span></span><span style="display:flex;"><span>service/service-nodeport created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME               TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>       SELECTOR
</span></span><span style="display:flex;"><span>service-nodeport   NodePort   10.105.64.191   &lt;none&gt;        80:30002/TCP  app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¥ä¸‹æ¥å¯ä»¥é€šè¿‡ç”µè„‘ä¸»æœºçš„æµè§ˆå™¨å»è®¿é—®é›†ç¾¤ä¸­ä»»æ„ä¸€ä¸ªnodeipçš„30002ç«¯å£ï¼Œå³å¯è®¿é—®åˆ°pod</span>
</span></span></code></pre></div><h5 id="736-loadbalancerç±»å‹çš„service">7.3.6 LoadBalancerç±»å‹çš„Service<a hidden class="anchor" aria-hidden="true" href="#736-loadbalancerç±»å‹çš„service">#</a></h5>
<p>LoadBalancerå’ŒNodePortå¾ˆç›¸ä¼¼ï¼Œç›®çš„éƒ½æ˜¯å‘å¤–éƒ¨æš´éœ²ä¸€ä¸ªç«¯å£ï¼ŒåŒºåˆ«åœ¨äºLoadBalancerä¼šåœ¨é›†ç¾¤çš„å¤–éƒ¨å†æ¥åšä¸€ä¸ªè´Ÿè½½å‡è¡¡è®¾å¤‡ï¼Œè€Œè¿™ä¸ªè®¾å¤‡éœ€è¦å¤–éƒ¨ç¯å¢ƒæ”¯æŒçš„ï¼Œå¤–éƒ¨æœåŠ¡å‘é€åˆ°è¿™ä¸ªè®¾å¤‡ä¸Šçš„è¯·æ±‚ï¼Œä¼šè¢«è®¾å¤‡è´Ÿè½½ä¹‹åè½¬å‘åˆ°é›†ç¾¤ä¸­ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200510103945494.png" alt="img"  />
</p>
<h5 id="737-externalnameç±»å‹çš„service">7.3.7 ExternalNameç±»å‹çš„Service<a hidden class="anchor" aria-hidden="true" href="#737-externalnameç±»å‹çš„service">#</a></h5>
<p>ExternalNameç±»å‹çš„Serviceç”¨äºå¼•å…¥é›†ç¾¤å¤–éƒ¨çš„æœåŠ¡ï¼Œå®ƒé€šè¿‡<code>externalName</code>å±æ€§æŒ‡å®šå¤–éƒ¨ä¸€ä¸ªæœåŠ¡çš„åœ°å€ï¼Œç„¶ååœ¨é›†ç¾¤å†…éƒ¨è®¿é—®æ­¤serviceå°±å¯ä»¥è®¿é—®åˆ°å¤–éƒ¨çš„æœåŠ¡äº†ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200510113311209.png" alt="img"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: service-externalname
</span></span><span style="display:flex;"><span>  namespace: dev
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  type: ExternalName <span style="color:#75715e"># serviceç±»å‹</span>
</span></span><span style="display:flex;"><span>  externalName: www.baidu.com  <span style="color:#75715e">#æ”¹æˆipåœ°å€ä¹Ÿå¯ä»¥</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºservice</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl  create -f service-externalname.yaml</span>
</span></span><span style="display:flex;"><span>service/service-externalname created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åŸŸåè§£æ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># dig @10.96.0.10 service-externalname.dev.svc.cluster.local</span>
</span></span><span style="display:flex;"><span>service-externalname.dev.svc.cluster.local. <span style="color:#ae81ff">30</span> IN CNAME www.baidu.com.
</span></span><span style="display:flex;"><span>www.baidu.com.          <span style="color:#ae81ff">30</span>      IN      CNAME   www.a.shifen.com.
</span></span><span style="display:flex;"><span>www.a.shifen.com.       <span style="color:#ae81ff">30</span>      IN      A       39.156.66.18
</span></span><span style="display:flex;"><span>www.a.shifen.com.       <span style="color:#ae81ff">30</span>      IN      A       39.156.66.14
</span></span></code></pre></div><h4 id="74-ingressä»‹ç»">7.4 Ingressä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#74-ingressä»‹ç»">#</a></h4>
<p>åœ¨å‰é¢è¯¾ç¨‹ä¸­å·²ç»æåˆ°ï¼ŒServiceå¯¹é›†ç¾¤ä¹‹å¤–æš´éœ²æœåŠ¡çš„ä¸»è¦æ–¹å¼æœ‰ä¸¤ç§ï¼šNotePortå’ŒLoadBalancerï¼Œä½†æ˜¯è¿™ä¸¤ç§æ–¹å¼ï¼Œéƒ½æœ‰ä¸€å®šçš„ç¼ºç‚¹ï¼š</p>
<ul>
<li>NodePortæ–¹å¼çš„ç¼ºç‚¹æ˜¯ä¼šå ç”¨å¾ˆå¤šé›†ç¾¤æœºå™¨çš„ç«¯å£ï¼Œé‚£ä¹ˆå½“é›†ç¾¤æœåŠ¡å˜å¤šçš„æ—¶å€™ï¼Œè¿™ä¸ªç¼ºç‚¹å°±æ„ˆå‘æ˜æ˜¾</li>
<li>LBæ–¹å¼çš„ç¼ºç‚¹æ˜¯æ¯ä¸ªserviceéœ€è¦ä¸€ä¸ªLBï¼Œæµªè´¹ã€éº»çƒ¦ï¼Œå¹¶ä¸”éœ€è¦kubernetesä¹‹å¤–è®¾å¤‡çš„æ”¯æŒ</li>
</ul>
<p>åŸºäºè¿™ç§ç°çŠ¶ï¼Œkubernetesæä¾›äº†Ingressèµ„æºå¯¹è±¡ï¼ŒIngressåªéœ€è¦ä¸€ä¸ªNodePortæˆ–è€…ä¸€ä¸ªLBå°±å¯ä»¥æ»¡è¶³æš´éœ²å¤šä¸ªServiceçš„éœ€æ±‚ã€‚å·¥ä½œæœºåˆ¶å¤§è‡´å¦‚ä¸‹å›¾è¡¨ç¤ºï¼š</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200623092808049.png" alt="img"  />
</p>
<p>å®é™…ä¸Šï¼ŒIngressç›¸å½“äºä¸€ä¸ª7å±‚çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œæ˜¯kuberneteså¯¹åå‘ä»£ç†çš„ä¸€ä¸ªæŠ½è±¡ï¼Œå®ƒçš„å·¥ä½œåŸç†ç±»ä¼¼äºNginxï¼Œå¯ä»¥ç†è§£æˆåœ¨Ingressé‡Œå»ºç«‹è¯¸å¤šæ˜ å°„è§„åˆ™ï¼ŒIngress Controlleré€šè¿‡ç›‘å¬è¿™äº›é…ç½®è§„åˆ™å¹¶è½¬åŒ–æˆNginxçš„åå‘ä»£ç†é…ç½® , ç„¶åå¯¹å¤–éƒ¨æä¾›æœåŠ¡ã€‚åœ¨è¿™é‡Œæœ‰ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š</p>
<ul>
<li>ingressï¼škubernetesä¸­çš„ä¸€ä¸ªå¯¹è±¡ï¼Œä½œç”¨æ˜¯å®šä¹‰è¯·æ±‚å¦‚ä½•è½¬å‘åˆ°serviceçš„è§„åˆ™</li>
<li>ingress controllerï¼šå…·ä½“å®ç°åå‘ä»£ç†åŠè´Ÿè½½å‡è¡¡çš„ç¨‹åºï¼Œå¯¹ingresså®šä¹‰çš„è§„åˆ™è¿›è¡Œè§£æï¼Œæ ¹æ®é…ç½®çš„è§„åˆ™æ¥å®ç°è¯·æ±‚è½¬å‘ï¼Œå®ç°æ–¹å¼æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚Nginx, Contour, Haproxyç­‰ç­‰</li>
</ul>
<p>Ingressï¼ˆä»¥Nginxä¸ºä¾‹ï¼‰çš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç”¨æˆ·ç¼–å†™Ingressè§„åˆ™ï¼Œè¯´æ˜å“ªä¸ªåŸŸåå¯¹åº”kubernetesé›†ç¾¤ä¸­çš„å“ªä¸ªService</li>
<li>Ingressæ§åˆ¶å™¨åŠ¨æ€æ„ŸçŸ¥IngressæœåŠ¡è§„åˆ™çš„å˜åŒ–ï¼Œç„¶åç”Ÿæˆä¸€æ®µå¯¹åº”çš„Nginxåå‘ä»£ç†é…ç½®</li>
<li>Ingressæ§åˆ¶å™¨ä¼šå°†ç”Ÿæˆçš„Nginxé…ç½®å†™å…¥åˆ°ä¸€ä¸ªè¿è¡Œç€çš„NginxæœåŠ¡ä¸­ï¼Œå¹¶åŠ¨æ€æ›´æ–°</li>
<li>åˆ°æ­¤ä¸ºæ­¢ï¼Œå…¶å®çœŸæ­£åœ¨å·¥ä½œçš„å°±æ˜¯ä¸€ä¸ªNginxäº†ï¼Œå†…éƒ¨é…ç½®äº†ç”¨æˆ·å®šä¹‰çš„è¯·æ±‚è½¬å‘è§„åˆ™</li>
</ol>
<p><img loading="lazy" src="/kubernetes.images/image-20200516112704764.png" alt="img"  />
</p>
<h4 id="75-ingressä½¿ç”¨">7.5 Ingressä½¿ç”¨<a hidden class="anchor" aria-hidden="true" href="#75-ingressä½¿ç”¨">#</a></h4>
<h5 id="751-ç¯å¢ƒå‡†å¤‡-æ­å»ºingressç¯å¢ƒ">7.5.1 ç¯å¢ƒå‡†å¤‡ æ­å»ºingressç¯å¢ƒ<a hidden class="anchor" aria-hidden="true" href="#751-ç¯å¢ƒå‡†å¤‡-æ­å»ºingressç¯å¢ƒ">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºæ–‡ä»¶å¤¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">[root@k8s-master01</span> <span style="color:#960050;background-color:#1e0010">~]</span><span style="color:#75715e"># mkdir ingress-controller
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">[root@k8s-master01</span> <span style="color:#960050;background-color:#1e0010">~]</span><span style="color:#75715e"># cd ingress-controller/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è·å–ingress-nginxï¼Œæœ¬æ¬¡æ¡ˆä¾‹ä½¿ç”¨çš„æ˜¯0.30ç‰ˆæœ¬
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">[root@k8s-master01 ingress-controller]# wget https</span><span style="color:#f92672">:</span>/raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">[root@k8s-master01 ingress-controller]# wget https</span><span style="color:#f92672">:</span>/raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿®æ”¹mandatory.yamlæ–‡ä»¶ä¸­çš„ä»“åº“
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿®æ”¹quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸ºquay-mirror.qiniu.com/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºingress-nginx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">[root@k8s-master01</span> <span style="color:#960050;background-color:#1e0010">ingress-controller]</span><span style="color:#75715e"># kubectl apply -f ./
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹ingress-nginx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">[root@k8s-master01</span> <span style="color:#960050;background-color:#1e0010">ingress-controller]</span><span style="color:#75715e"># kubectl get pod -n ingress-nginx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">NAME</span>                                           <span style="color:#960050;background-color:#1e0010">READY</span>   <span style="color:#960050;background-color:#1e0010">STATUS</span>    <span style="color:#960050;background-color:#1e0010">RESTARTS</span>   <span style="color:#960050;background-color:#1e0010">AGE</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">pod/nginx-ingress-controller-fbf967dd5-4qpbp</span>   <span style="color:#960050;background-color:#1e0010">1/1</span>     <span style="color:#960050;background-color:#1e0010">Running</span>   <span style="color:#960050;background-color:#1e0010">0</span>          <span style="color:#960050;background-color:#1e0010">12h</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹service
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">[root@k8s-master01</span> <span style="color:#960050;background-color:#1e0010">ingress-controller]</span><span style="color:#75715e"># kubectl get svc -n ingress-nginx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">NAME</span>            <span style="color:#960050;background-color:#1e0010">TYPE</span>       <span style="color:#960050;background-color:#1e0010">CLUSTER-IP</span>     <span style="color:#960050;background-color:#1e0010">EXTERNAL-IP</span>   <span style="color:#960050;background-color:#1e0010">PORT(S)</span>                      <span style="color:#960050;background-color:#1e0010">AGE</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ingress-nginx   NodePort   10.98.75.163   &lt;none&gt;        80</span><span style="color:#f92672">:</span>32240/TCP,443:31335/TCP   11h
</span></span></code></pre></div><h5 id="752-å‡†å¤‡serviceå’Œpod">7.5.2 å‡†å¤‡serviceå’Œpod<a hidden class="anchor" aria-hidden="true" href="#752-å‡†å¤‡serviceå’Œpod">#</a></h5>
<p>ä¸ºäº†åé¢çš„å®éªŒæ¯”è¾ƒæ–¹ä¾¿ï¼Œåˆ›å»ºå¦‚ä¸‹å›¾æ‰€ç¤ºçš„æ¨¡å‹</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200516102419998.png" alt="img"  />
</p>
<p>åˆ›å»ºtomcat-nginx.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-deployment</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tomcat-deployment</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">tomcat-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">tomcat-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tomcat</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">tomcat:8.5-jre10-slim</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tomcat-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">tomcat-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»º</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f tomcat-nginx.yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc -n dev</span>
</span></span><span style="display:flex;"><span>NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>    AGE
</span></span><span style="display:flex;"><span>nginx-service    ClusterIP   None         &lt;none&gt;        80/TCP     48s
</span></span><span style="display:flex;"><span>tomcat-service   ClusterIP   None         &lt;none&gt;        8080/TCP   48s
</span></span></code></pre></div><h5 id="753-httpä»£ç†">7.5.3 Httpä»£ç†<a hidden class="anchor" aria-hidden="true" href="#753-httpä»£ç†">#</a></h5>
<p>åˆ›å»ºingress-http.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-http</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">nginx.itheima.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">nginx-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">tomcat.itheima.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">tomcat-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">8080</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»º</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f ingress-http.yaml</span>
</span></span><span style="display:flex;"><span>ingress.extensions/ingress-http created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get ing ingress-http -n dev</span>
</span></span><span style="display:flex;"><span>NAME           HOSTS                                  ADDRESS   PORTS   AGE
</span></span><span style="display:flex;"><span>ingress-http   nginx.itheima.com,tomcat.itheima.com             <span style="color:#ae81ff">80</span>      22s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹è¯¦æƒ…</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe ing ingress-http  -n dev</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Rules:
</span></span><span style="display:flex;"><span>Host                Path  Backends
</span></span><span style="display:flex;"><span>----                ----  --------
</span></span><span style="display:flex;"><span>nginx.itheima.com   / nginx-service:80 <span style="color:#f92672">(</span>10.244.1.96:80,10.244.1.97:80,10.244.2.112:80<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>tomcat.itheima.com  / tomcat-service:8080<span style="color:#f92672">(</span>10.244.1.94:8080,10.244.1.95:8080,10.244.2.111:8080<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¥ä¸‹æ¥,åœ¨æœ¬åœ°ç”µè„‘ä¸Šé…ç½®hostæ–‡ä»¶,è§£æä¸Šé¢çš„ä¸¤ä¸ªåŸŸååˆ°192.168.109.100(master)ä¸Š</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ç„¶å,å°±å¯ä»¥åˆ†åˆ«è®¿é—®tomcat.itheima.com:32240  å’Œ  nginx.itheima.com:32240 æŸ¥çœ‹æ•ˆæœäº†</span>
</span></span></code></pre></div><h5 id="754-httpsä»£ç†">7.5.4 Httpsä»£ç†<a hidden class="anchor" aria-hidden="true" href="#754-httpsä»£ç†">#</a></h5>
<p>åˆ›å»ºè¯ä¹¦</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ç”Ÿæˆè¯ä¹¦</span>
</span></span><span style="display:flex;"><span>openssl req -x509 -sha256 -nodes -days <span style="color:#ae81ff">365</span> -newkey rsa:2048 -keyout tls.key -out tls.crt -subj <span style="color:#e6db74">&#34;/C=CN/ST=BJ/L=BJ/O=nginx/CN=itheima.com&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºå¯†é’¥</span>
</span></span><span style="display:flex;"><span>kubectl create secret tls tls-secret --key tls.key --cert tls.crt
</span></span></code></pre></div><p>åˆ›å»ºingress-https.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-https</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tls</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">nginx.itheima.com</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">tomcat.itheima.com</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">tls-secret</span> <span style="color:#75715e"># æŒ‡å®šç§˜é’¥</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">nginx.itheima.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">nginx-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">tomcat.itheima.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">tomcat-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">8080</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»º</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f ingress-https.yaml</span>
</span></span><span style="display:flex;"><span>ingress.extensions/ingress-https created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get ing ingress-https -n dev</span>
</span></span><span style="display:flex;"><span>NAME            HOSTS                                  ADDRESS         PORTS     AGE
</span></span><span style="display:flex;"><span>ingress-https   nginx.itheima.com,tomcat.itheima.com   10.104.184.38   80, <span style="color:#ae81ff">443</span>   2m42s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹è¯¦æƒ…</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe ing ingress-https -n dev</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>TLS:
</span></span><span style="display:flex;"><span>  tls-secret terminates nginx.itheima.com,tomcat.itheima.com
</span></span><span style="display:flex;"><span>Rules:
</span></span><span style="display:flex;"><span>Host              Path Backends
</span></span><span style="display:flex;"><span>----              ---- --------
</span></span><span style="display:flex;"><span>nginx.itheima.com  /  nginx-service:80 <span style="color:#f92672">(</span>10.244.1.97:80,10.244.1.98:80,10.244.2.119:80<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>tomcat.itheima.com /  tomcat-service:8080<span style="color:#f92672">(</span>10.244.1.99:8080,10.244.2.117:8080,10.244.2.120:8080<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸‹é¢å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®https:/nginx.itheima.com:31335 å’Œ https:/tomcat.itheima.com:31335æ¥æŸ¥çœ‹äº†</span>
</span></span></code></pre></div><h3 id="8-æ•°æ®å­˜å‚¨">8. æ•°æ®å­˜å‚¨<a hidden class="anchor" aria-hidden="true" href="#8-æ•°æ®å­˜å‚¨">#</a></h3>
<p>åœ¨å‰é¢å·²ç»æåˆ°ï¼Œå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸå¯èƒ½å¾ˆçŸ­ï¼Œä¼šè¢«é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯ã€‚é‚£ä¹ˆå®¹å™¨åœ¨é”€æ¯æ—¶ï¼Œä¿å­˜åœ¨å®¹å™¨ä¸­çš„æ•°æ®ä¹Ÿä¼šè¢«æ¸…é™¤ã€‚è¿™ç§ç»“æœå¯¹ç”¨æˆ·æ¥è¯´ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹æ˜¯ä¸ä¹æ„çœ‹åˆ°çš„ã€‚ä¸ºäº†æŒä¹…åŒ–ä¿å­˜å®¹å™¨çš„æ•°æ®ï¼Œkuberneteså¼•å…¥äº†Volumeçš„æ¦‚å¿µã€‚</p>
<p>Volumeæ˜¯Podä¸­èƒ½å¤Ÿè¢«å¤šä¸ªå®¹å™¨è®¿é—®çš„å…±äº«ç›®å½•ï¼Œå®ƒè¢«å®šä¹‰åœ¨Podä¸Šï¼Œç„¶åè¢«ä¸€ä¸ªPodé‡Œçš„å¤šä¸ªå®¹å™¨æŒ‚è½½åˆ°å…·ä½“çš„æ–‡ä»¶ç›®å½•ä¸‹ï¼Œkubernetesé€šè¿‡Volumeå®ç°åŒä¸€ä¸ªPodä¸­ä¸åŒå®¹å™¨ä¹‹é—´çš„æ•°æ®å…±äº«ä»¥åŠæ•°æ®çš„æŒä¹…åŒ–å­˜å‚¨ã€‚Volumeçš„ç”Ÿå‘½å®¹å™¨ä¸ä¸Podä¸­å•ä¸ªå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç›¸å…³ï¼Œå½“å®¹å™¨ç»ˆæ­¢æˆ–è€…é‡å¯æ—¶ï¼ŒVolumeä¸­çš„æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚</p>
<p>kubernetesçš„Volumeæ”¯æŒå¤šç§ç±»å‹ï¼Œæ¯”è¾ƒå¸¸è§çš„æœ‰ä¸‹é¢å‡ ä¸ªï¼š</p>
<ul>
<li>ç®€å•å­˜å‚¨ï¼šEmptyDirã€HostPathã€NFS</li>
<li>é«˜çº§å­˜å‚¨ï¼šPVã€PVC</li>
<li>é…ç½®å­˜å‚¨ï¼šConfigMapã€Secret</li>
</ul>
<h4 id="81-åŸºæœ¬å­˜å‚¨">8.1 åŸºæœ¬å­˜å‚¨<a hidden class="anchor" aria-hidden="true" href="#81-åŸºæœ¬å­˜å‚¨">#</a></h4>
<h5 id="811-emptydir">8.1.1 EmptyDir<a hidden class="anchor" aria-hidden="true" href="#811-emptydir">#</a></h5>
<p>EmptyDiræ˜¯æœ€åŸºç¡€çš„Volumeç±»å‹ï¼Œä¸€ä¸ªEmptyDirå°±æ˜¯Hostä¸Šçš„ä¸€ä¸ªç©ºç›®å½•ã€‚</p>
<p>EmptyDiræ˜¯åœ¨Podè¢«åˆ†é…åˆ°Nodeæ—¶åˆ›å»ºçš„ï¼Œå®ƒçš„åˆå§‹å†…å®¹ä¸ºç©ºï¼Œå¹¶ä¸”æ— é¡»æŒ‡å®šå®¿ä¸»æœºä¸Šå¯¹åº”çš„ç›®å½•æ–‡ä»¶ï¼Œå› ä¸ºkubernetesä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªç›®å½•ï¼Œå½“Podé”€æ¯æ—¶ï¼Œ EmptyDirä¸­çš„æ•°æ®ä¹Ÿä¼šè¢«æ°¸ä¹…åˆ é™¤ã€‚ EmptyDirç”¨é€”å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¸´æ—¶ç©ºé—´ï¼Œä¾‹å¦‚ç”¨äºæŸäº›åº”ç”¨ç¨‹åºè¿è¡Œæ—¶æ‰€éœ€çš„ä¸´æ—¶ç›®å½•ï¼Œä¸”æ— é¡»æ°¸ä¹…ä¿ç•™</li>
<li>ä¸€ä¸ªå®¹å™¨éœ€è¦ä»å¦ä¸€ä¸ªå®¹å™¨ä¸­è·å–æ•°æ®çš„ç›®å½•ï¼ˆå¤šå®¹å™¨å…±äº«ç›®å½•ï¼‰</li>
</ul>
<p>æ¥ä¸‹æ¥ï¼Œé€šè¿‡ä¸€ä¸ªå®¹å™¨ä¹‹é—´æ–‡ä»¶å…±äº«çš„æ¡ˆä¾‹æ¥ä½¿ç”¨ä¸€ä¸‹EmptyDirã€‚</p>
<p>åœ¨ä¸€ä¸ªPodä¸­å‡†å¤‡ä¸¤ä¸ªå®¹å™¨nginxå’Œbusyboxï¼Œç„¶åå£°æ˜ä¸€ä¸ªVolumeåˆ†åˆ«æŒ‚åœ¨åˆ°ä¸¤ä¸ªå®¹å™¨çš„ç›®å½•ä¸­ï¼Œç„¶ånginxå®¹å™¨è´Ÿè´£å‘Volumeä¸­å†™æ—¥å¿—ï¼Œbusyboxä¸­é€šè¿‡å‘½ä»¤å°†æ—¥å¿—å†…å®¹è¯»åˆ°æ§åˆ¶å°ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200413174713773.png" alt="img"  />
</p>
<p>åˆ›å»ºä¸€ä¸ªvolume-emptydir.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-emptydir</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:  <span style="color:#75715e"># å°†logs-volumeæŒ‚åœ¨åˆ°nginxå®¹å™¨ä¸­ï¼Œå¯¹åº”çš„ç›®å½•ä¸º /var/log/nginx</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>] <span style="color:#75715e"># åˆå§‹å‘½ä»¤ï¼ŒåŠ¨æ€è¯»å–æŒ‡å®šæ–‡ä»¶ä¸­å†…å®¹</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:  <span style="color:#75715e"># å°†logs-volume æŒ‚åœ¨åˆ°busyboxå®¹å™¨ä¸­ï¼Œå¯¹åº”çš„ç›®å½•ä¸º /logs</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>: <span style="color:#75715e"># å£°æ˜volumeï¼Œ nameä¸ºlogs-volumeï¼Œç±»å‹ä¸ºemptyDir</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">emptyDir</span>: {}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºPod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f volume-emptydir.yaml</span>
</span></span><span style="display:flex;"><span>pod/volume-emptydir created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods volume-emptydir -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                  READY   STATUS    RESTARTS   AGE      IP       NODE   ...... 
</span></span><span style="display:flex;"><span>volume-emptydir       2/2     Running   <span style="color:#ae81ff">0</span>          97s   10.42.2.9   node1  ......
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é€šè¿‡podIpè®¿é—®nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># curl 10.42.2.9</span>
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é€šè¿‡kubectl logså‘½ä»¤æŸ¥çœ‹æŒ‡å®šå®¹å™¨çš„æ ‡å‡†è¾“å‡º</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl logs -f volume-emptydir -n dev -c busybox</span>
</span></span><span style="display:flex;"><span>10.42.1.0 - - <span style="color:#f92672">[</span>27/Jun/2021:15:08:54 +0000<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET / HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">612</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;curl/7.29.0&#34;</span> <span style="color:#e6db74">&#34;-&#34;</span>
</span></span></code></pre></div><h5 id="812-hostpath">8.1.2 HostPath<a hidden class="anchor" aria-hidden="true" href="#812-hostpath">#</a></h5>
<p>ä¸ŠèŠ‚è¯¾æåˆ°ï¼ŒEmptyDirä¸­æ•°æ®ä¸ä¼šè¢«æŒä¹…åŒ–ï¼Œå®ƒä¼šéšç€Podçš„ç»“æŸè€Œé”€æ¯ï¼Œå¦‚æœæƒ³ç®€å•çš„å°†æ•°æ®æŒä¹…åŒ–åˆ°ä¸»æœºä¸­ï¼Œå¯ä»¥é€‰æ‹©HostPathã€‚</p>
<p>HostPathå°±æ˜¯å°†Nodeä¸»æœºä¸­ä¸€ä¸ªå®é™…ç›®å½•æŒ‚åœ¨åˆ°Podä¸­ï¼Œä»¥ä¾›å®¹å™¨ä½¿ç”¨ï¼Œè¿™æ ·çš„è®¾è®¡å°±å¯ä»¥ä¿è¯Podé”€æ¯äº†ï¼Œä½†æ˜¯æ•°æ®ä¾æ®å¯ä»¥å­˜åœ¨äºNodeä¸»æœºä¸Šã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200413214031331.png" alt="img"  />
</p>
<p>åˆ›å»ºä¸€ä¸ªvolume-hostpath.yamlï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-hostpath</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">hostPath</span>: 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/logs</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">type</span>: <span style="color:#ae81ff">DirectoryOrCreate </span> <span style="color:#75715e"># ç›®å½•å­˜åœ¨å°±ä½¿ç”¨ï¼Œä¸å­˜åœ¨å°±å…ˆåˆ›å»ºåä½¿ç”¨</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>å…³äºtypeçš„å€¼çš„ä¸€ç‚¹è¯´æ˜ï¼š
</span></span><span style="display:flex;"><span>    DirectoryOrCreate ç›®å½•å­˜åœ¨å°±ä½¿ç”¨ï¼Œä¸å­˜åœ¨å°±å…ˆåˆ›å»ºåä½¿ç”¨
</span></span><span style="display:flex;"><span>    Directory   ç›®å½•å¿…é¡»å­˜åœ¨
</span></span><span style="display:flex;"><span>    FileOrCreate  æ–‡ä»¶å­˜åœ¨å°±ä½¿ç”¨ï¼Œä¸å­˜åœ¨å°±å…ˆåˆ›å»ºåä½¿ç”¨
</span></span><span style="display:flex;"><span>    File æ–‡ä»¶å¿…é¡»å­˜åœ¨ 
</span></span><span style="display:flex;"><span>    Socket  unixå¥—æ¥å­—å¿…é¡»å­˜åœ¨
</span></span><span style="display:flex;"><span>    CharDevice  å­—ç¬¦è®¾å¤‡å¿…é¡»å­˜åœ¨
</span></span><span style="display:flex;"><span>    BlockDevice å—è®¾å¤‡å¿…é¡»å­˜åœ¨
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºPod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f volume-hostpath.yaml</span>
</span></span><span style="display:flex;"><span>pod/volume-hostpath created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods volume-hostpath -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                  READY   STATUS    RESTARTS   AGE   IP             NODE   ......
</span></span><span style="display:flex;"><span>pod-volume-hostpath   2/2     Running   <span style="color:#ae81ff">0</span>          16s   10.42.2.10     node1  ......
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#è®¿é—®nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># curl 10.42.2.10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl logs -f volume-emptydir -n dev -c busybox</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ¥ä¸‹æ¥å°±å¯ä»¥å»hostçš„/root/logsç›®å½•ä¸‹æŸ¥çœ‹å­˜å‚¨çš„æ–‡ä»¶äº†</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">###  æ³¨æ„: ä¸‹é¢çš„æ“ä½œéœ€è¦åˆ°Podæ‰€åœ¨çš„èŠ‚ç‚¹è¿è¡Œï¼ˆæ¡ˆä¾‹ä¸­æ˜¯node1ï¼‰</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@node1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ls /root/logs/</span>
</span></span><span style="display:flex;"><span>access.log  error.log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åŒæ ·çš„é“ç†ï¼Œå¦‚æœåœ¨æ­¤ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œåˆ°å®¹å™¨ä¸­ä¹Ÿæ˜¯å¯ä»¥çœ‹åˆ°çš„</span>
</span></span></code></pre></div><h5 id="813-nfs">8.1.3 NFS<a hidden class="anchor" aria-hidden="true" href="#813-nfs">#</a></h5>
<p>HostPathå¯ä»¥è§£å†³æ•°æ®æŒä¹…åŒ–çš„é—®é¢˜ï¼Œä½†æ˜¯ä¸€æ—¦NodeèŠ‚ç‚¹æ•…éšœäº†ï¼ŒPodå¦‚æœè½¬ç§»åˆ°äº†åˆ«çš„èŠ‚ç‚¹ï¼Œåˆä¼šå‡ºç°é—®é¢˜äº†ï¼Œæ­¤æ—¶éœ€è¦å‡†å¤‡å•ç‹¬çš„ç½‘ç»œå­˜å‚¨ç³»ç»Ÿï¼Œæ¯”è¾ƒå¸¸ç”¨çš„ç”¨NFSã€CIFSã€‚</p>
<p>NFSæ˜¯ä¸€ä¸ªç½‘ç»œæ–‡ä»¶å­˜å‚¨ç³»ç»Ÿï¼Œå¯ä»¥æ­å»ºä¸€å°NFSæœåŠ¡å™¨ï¼Œç„¶åå°†Podä¸­çš„å­˜å‚¨ç›´æ¥è¿æ¥åˆ°NFSç³»ç»Ÿä¸Šï¼Œè¿™æ ·çš„è¯ï¼Œæ— è®ºPodåœ¨èŠ‚ç‚¹ä¸Šæ€ä¹ˆè½¬ç§»ï¼Œåªè¦Nodeè·ŸNFSçš„å¯¹æ¥æ²¡é—®é¢˜ï¼Œæ•°æ®å°±å¯ä»¥æˆåŠŸè®¿é—®ã€‚</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200413215133559.png" alt="img"  />
</p>
<p>1ï¼‰é¦–å…ˆè¦å‡†å¤‡nfsçš„æœåŠ¡å™¨ï¼Œè¿™é‡Œä¸ºäº†ç®€å•ï¼Œç›´æ¥æ˜¯masterèŠ‚ç‚¹åšnfsæœåŠ¡å™¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åœ¨nfsä¸Šå®‰è£…nfsæœåŠ¡</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@nfs ~<span style="color:#f92672">]</span><span style="color:#75715e"># yum install nfs-utils -y</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å‡†å¤‡ä¸€ä¸ªå…±äº«ç›®å½•</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@nfs ~<span style="color:#f92672">]</span><span style="color:#75715e"># mkdir /root/data/nfs -pv</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å°†å…±äº«ç›®å½•ä»¥è¯»å†™æƒé™æš´éœ²ç»™192.168.5.0/24ç½‘æ®µä¸­çš„æ‰€æœ‰ä¸»æœº</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@nfs ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim /etc/exports</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@nfs ~<span style="color:#f92672">]</span><span style="color:#75715e"># more /etc/exports</span>
</span></span><span style="display:flex;"><span>/root/data/nfs     192.168.5.0/24<span style="color:#f92672">(</span>rw,no_root_squash<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯åŠ¨nfsæœåŠ¡</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@nfs ~<span style="color:#f92672">]</span><span style="color:#75715e"># systemctl restart nfs</span>
</span></span></code></pre></div><p>2ï¼‰æ¥ä¸‹æ¥ï¼Œè¦åœ¨çš„æ¯ä¸ªnodeèŠ‚ç‚¹ä¸Šéƒ½å®‰è£…ä¸‹nfsï¼Œè¿™æ ·çš„ç›®çš„æ˜¯ä¸ºäº†nodeèŠ‚ç‚¹å¯ä»¥é©±åŠ¨nfsè®¾å¤‡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åœ¨nodeä¸Šå®‰è£…nfsæœåŠ¡ï¼Œæ³¨æ„ä¸éœ€è¦å¯åŠ¨</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># yum install nfs-utils -y</span>
</span></span></code></pre></div><p>3ï¼‰æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥ç¼–å†™podçš„é…ç½®æ–‡ä»¶äº†ï¼Œåˆ›å»ºvolume-nfs.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume-nfs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/log/nginx</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;tail -f /logs/access.log&#34;</span>] 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/logs</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">logs-volume</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nfs</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.5.6</span>  <span style="color:#75715e">#nfsæœåŠ¡å™¨åœ°å€</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/data/nfs</span> <span style="color:#75715e">#å…±äº«æ–‡ä»¶è·¯å¾„</span>
</span></span></code></pre></div><p>4ï¼‰æœ€åï¼Œè¿è¡Œä¸‹podï¼Œè§‚å¯Ÿç»“æœ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºpod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f volume-nfs.yaml</span>
</span></span><span style="display:flex;"><span>pod/volume-nfs created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods volume-nfs -n dev</span>
</span></span><span style="display:flex;"><span>NAME                  READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>volume-nfs        2/2     Running   <span style="color:#ae81ff">0</span>          2m9s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹nfsæœåŠ¡å™¨ä¸Šçš„å…±äº«ç›®å½•ï¼Œå‘ç°å·²ç»æœ‰æ–‡ä»¶äº†</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ls /root/data/</span>
</span></span><span style="display:flex;"><span>access.log  error.log
</span></span></code></pre></div><h4 id="82-é«˜çº§å­˜å‚¨">8.2 é«˜çº§å­˜å‚¨<a hidden class="anchor" aria-hidden="true" href="#82-é«˜çº§å­˜å‚¨">#</a></h4>
<p>å‰é¢å·²ç»å­¦ä¹ äº†ä½¿ç”¨NFSæä¾›å­˜å‚¨ï¼Œæ­¤æ—¶å°±è¦æ±‚ç”¨æˆ·ä¼šæ­å»ºNFSç³»ç»Ÿï¼Œå¹¶ä¸”ä¼šåœ¨yamlé…ç½®nfsã€‚ç”±äºkubernetesæ”¯æŒçš„å­˜å‚¨ç³»ç»Ÿæœ‰å¾ˆå¤šï¼Œè¦æ±‚å®¢æˆ·å…¨éƒ½æŒæ¡ï¼Œæ˜¾ç„¶ä¸ç°å®ã€‚ä¸ºäº†èƒ½å¤Ÿå±è”½åº•å±‚å­˜å‚¨å®ç°çš„ç»†èŠ‚ï¼Œæ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨ï¼Œ kuberneteså¼•å…¥PVå’ŒPVCä¸¤ç§èµ„æºå¯¹è±¡ã€‚</p>
<ul>
<li>
<p>PVï¼ˆPersistent Volumeï¼‰æ˜¯æŒä¹…åŒ–å·çš„æ„æ€ï¼Œæ˜¯å¯¹åº•å±‚çš„å…±äº«å­˜å‚¨çš„ä¸€ç§æŠ½è±¡ã€‚ä¸€èˆ¬æƒ…å†µä¸‹PVç”±kubernetesç®¡ç†å‘˜è¿›è¡Œåˆ›å»ºå’Œé…ç½®ï¼Œå®ƒä¸åº•å±‚å…·ä½“çš„å…±äº«å­˜å‚¨æŠ€æœ¯æœ‰å…³ï¼Œå¹¶é€šè¿‡æ’ä»¶å®Œæˆä¸å…±äº«å­˜å‚¨çš„å¯¹æ¥ã€‚</p>
</li>
<li>
<p>PVCï¼ˆPersistent Volume Claimï¼‰æ˜¯æŒä¹…å·å£°æ˜çš„æ„æ€ï¼Œæ˜¯ç”¨æˆ·å¯¹äºå­˜å‚¨éœ€æ±‚çš„ä¸€ç§å£°æ˜ã€‚æ¢å¥è¯è¯´ï¼ŒPVCå…¶å®å°±æ˜¯ç”¨æˆ·å‘kubernetesç³»ç»Ÿå‘å‡ºçš„ä¸€ç§èµ„æºéœ€æ±‚ç”³è¯·ã€‚</p>
</li>
</ul>
<p><img loading="lazy" src="/kubernetes.images/image-20200514194111567.png" alt="img"  />
</p>
<p>ä½¿ç”¨äº†PVå’ŒPVCä¹‹åï¼Œå·¥ä½œå¯ä»¥å¾—åˆ°è¿›ä¸€æ­¥çš„ç»†åˆ†ï¼š</p>
<ul>
<li>å­˜å‚¨ï¼šå­˜å‚¨å·¥ç¨‹å¸ˆç»´æŠ¤</li>
<li>PVï¼š kubernetesç®¡ç†å‘˜ç»´æŠ¤</li>
<li>PVCï¼škubernetesç”¨æˆ·ç»´æŠ¤</li>
</ul>
<h5 id="821-pv">8.2.1 PV<a hidden class="anchor" aria-hidden="true" href="#821-pv">#</a></h5>
<p>PVæ˜¯å­˜å‚¨èµ„æºçš„æŠ½è±¡ï¼Œä¸‹é¢æ˜¯èµ„æºæ¸…å•æ–‡ä»¶:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1  </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pv2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nfs</span>: <span style="color:#75715e"># å­˜å‚¨ç±»å‹ï¼Œä¸åº•å±‚çœŸæ­£å­˜å‚¨å¯¹åº”</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">capacity</span>:  <span style="color:#75715e"># å­˜å‚¨èƒ½åŠ›ï¼Œç›®å‰åªæ”¯æŒå­˜å‚¨ç©ºé—´çš„è®¾ç½®</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">2Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:  <span style="color:#75715e"># è®¿é—®æ¨¡å¼</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#75715e"># å­˜å‚¨ç±»åˆ«</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#75715e"># å›æ”¶ç­–ç•¥</span>
</span></span></code></pre></div><p>PV çš„å…³é”®é…ç½®å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li>
<p>å­˜å‚¨ç±»å‹</p>
<p>åº•å±‚å®é™…å­˜å‚¨çš„ç±»å‹ï¼Œkubernetesæ”¯æŒå¤šç§å­˜å‚¨ç±»å‹ï¼Œæ¯ç§å­˜å‚¨ç±»å‹çš„é…ç½®éƒ½æœ‰æ‰€å·®å¼‚</p>
</li>
<li>
<p>å­˜å‚¨èƒ½åŠ›ï¼ˆcapacityï¼‰</p>
</li>
</ul>
<p>ç›®å‰åªæ”¯æŒå­˜å‚¨ç©ºé—´çš„è®¾ç½®( storage=1Gi )ï¼Œä¸è¿‡æœªæ¥å¯èƒ½ä¼šåŠ å…¥IOPSã€ååé‡ç­‰æŒ‡æ ‡çš„é…ç½®</p>
<ul>
<li>
<p>è®¿é—®æ¨¡å¼ï¼ˆaccessModesï¼‰</p>
<p>ç”¨äºæè¿°ç”¨æˆ·åº”ç”¨å¯¹å­˜å‚¨èµ„æºçš„è®¿é—®æƒé™ï¼Œè®¿é—®æƒé™åŒ…æ‹¬ä¸‹é¢å‡ ç§æ–¹å¼ï¼š</p>
<ul>
<li>ReadWriteOnceï¼ˆRWOï¼‰ï¼šè¯»å†™æƒé™ï¼Œä½†æ˜¯åªèƒ½è¢«å•ä¸ªèŠ‚ç‚¹æŒ‚è½½</li>
<li>ReadOnlyManyï¼ˆROXï¼‰ï¼š åªè¯»æƒé™ï¼Œå¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½</li>
<li>ReadWriteManyï¼ˆRWXï¼‰ï¼šè¯»å†™æƒé™ï¼Œå¯ä»¥è¢«å¤šä¸ªèŠ‚ç‚¹æŒ‚è½½</li>
</ul>
<p><code>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåº•å±‚ä¸åŒçš„å­˜å‚¨ç±»å‹å¯èƒ½æ”¯æŒçš„è®¿é—®æ¨¡å¼ä¸åŒ</code></p>
</li>
<li>
<p>å›æ”¶ç­–ç•¥ï¼ˆpersistentVolumeReclaimPolicyï¼‰</p>
<p>å½“PVä¸å†è¢«ä½¿ç”¨äº†ä¹‹åï¼Œå¯¹å…¶çš„å¤„ç†æ–¹å¼ã€‚ç›®å‰æ”¯æŒä¸‰ç§ç­–ç•¥ï¼š</p>
<ul>
<li>Retain ï¼ˆä¿ç•™ï¼‰ ä¿ç•™æ•°æ®ï¼Œéœ€è¦ç®¡ç†å‘˜æ‰‹å·¥æ¸…ç†æ•°æ®</li>
<li>Recycleï¼ˆå›æ”¶ï¼‰ æ¸…é™¤ PV ä¸­çš„æ•°æ®ï¼Œæ•ˆæœç›¸å½“äºæ‰§è¡Œ rm -rf /thevolume/*</li>
<li>Delete ï¼ˆåˆ é™¤ï¼‰ ä¸ PV ç›¸è¿çš„åç«¯å­˜å‚¨å®Œæˆ volume çš„åˆ é™¤æ“ä½œï¼Œå½“ç„¶è¿™å¸¸è§äºäº‘æœåŠ¡å•†çš„å­˜å‚¨æœåŠ¡</li>
</ul>
<p><code>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåº•å±‚ä¸åŒçš„å­˜å‚¨ç±»å‹å¯èƒ½æ”¯æŒçš„å›æ”¶ç­–ç•¥ä¸åŒ</code></p>
</li>
<li>
<p>å­˜å‚¨ç±»åˆ«</p>
<p>PVå¯ä»¥é€šè¿‡storageClassNameå‚æ•°æŒ‡å®šä¸€ä¸ªå­˜å‚¨ç±»åˆ«</p>
<ul>
<li>å…·æœ‰ç‰¹å®šç±»åˆ«çš„PVåªèƒ½ä¸è¯·æ±‚äº†è¯¥ç±»åˆ«çš„PVCè¿›è¡Œç»‘å®š</li>
<li>æœªè®¾å®šç±»åˆ«çš„PVåˆ™åªèƒ½ä¸ä¸è¯·æ±‚ä»»ä½•ç±»åˆ«çš„PVCè¿›è¡Œç»‘å®š</li>
</ul>
</li>
<li>
<p>çŠ¶æ€ï¼ˆstatusï¼‰</p>
<p>ä¸€ä¸ª PV çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå¯èƒ½ä¼šå¤„äº4ä¸­ä¸åŒçš„é˜¶æ®µï¼š</p>
<ul>
<li>Availableï¼ˆå¯ç”¨ï¼‰ï¼š è¡¨ç¤ºå¯ç”¨çŠ¶æ€ï¼Œè¿˜æœªè¢«ä»»ä½• PVC ç»‘å®š</li>
<li>Boundï¼ˆå·²ç»‘å®šï¼‰ï¼š è¡¨ç¤º PV å·²ç»è¢« PVC ç»‘å®š</li>
<li>Releasedï¼ˆå·²é‡Šæ”¾ï¼‰ï¼š è¡¨ç¤º PVC è¢«åˆ é™¤ï¼Œä½†æ˜¯èµ„æºè¿˜æœªè¢«é›†ç¾¤é‡æ–°å£°æ˜</li>
<li>Failedï¼ˆå¤±è´¥ï¼‰ï¼š è¡¨ç¤ºè¯¥ PV çš„è‡ªåŠ¨å›æ”¶å¤±è´¥</li>
</ul>
</li>
</ul>
<p>å®éªŒ</p>
<p>ä½¿ç”¨NFSä½œä¸ºå­˜å‚¨ï¼Œæ¥æ¼”ç¤ºPVçš„ä½¿ç”¨ï¼Œåˆ›å»º3ä¸ªPVï¼Œå¯¹åº”NFSä¸­çš„3ä¸ªæš´éœ²çš„è·¯å¾„ã€‚</p>
<ol>
<li>å‡†å¤‡NFSç¯å¢ƒ</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºç›®å½•</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@nfs ~<span style="color:#f92672">]</span><span style="color:#75715e"># mkdir /root/data/{pv1,pv2,pv3} -pv</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æš´éœ²æœåŠ¡</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@nfs ~<span style="color:#f92672">]</span><span style="color:#75715e"># more /etc/exports</span>
</span></span><span style="display:flex;"><span>/root/data/pv1     192.168.5.0/24<span style="color:#f92672">(</span>rw,no_root_squash<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>/root/data/pv2     192.168.5.0/24<span style="color:#f92672">(</span>rw,no_root_squash<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>/root/data/pv3     192.168.5.0/24<span style="color:#f92672">(</span>rw,no_root_squash<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># é‡å¯æœåŠ¡</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@nfs ~<span style="color:#f92672">]</span><span style="color:#75715e">#  systemctl restart nfs</span>
</span></span></code></pre></div><p>åˆ›å»ºpv.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>:  <span style="color:#ae81ff">pv1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">capacity</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">1Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nfs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/data/pv1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.5.6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>:  <span style="color:#ae81ff">pv2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">capacity</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">2Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nfs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/data/pv2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.5.6</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>:  <span style="color:#ae81ff">pv3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">capacity</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">3Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nfs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/root/data/pv3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">server</span>: <span style="color:#ae81ff">192.168.5.6</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»º pv</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pv.yaml</span>
</span></span><span style="display:flex;"><span>persistentvolume/pv1 created
</span></span><span style="display:flex;"><span>persistentvolume/pv2 created
</span></span><span style="display:flex;"><span>persistentvolume/pv3 created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pv</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pv -o wide</span>
</span></span><span style="display:flex;"><span>NAME   CAPACITY   ACCESS MODES  RECLAIM POLICY  STATUS      AGE   VOLUMEMODE
</span></span><span style="display:flex;"><span>pv1    1Gi        RWX            Retain        Available    10s   Filesystem
</span></span><span style="display:flex;"><span>pv2    2Gi        RWX            Retain        Available    10s   Filesystem
</span></span><span style="display:flex;"><span>pv3    3Gi        RWX            Retain        Available    9s    Filesystem
</span></span></code></pre></div><h5 id="822-pvc">8.2.2 PVC<a hidden class="anchor" aria-hidden="true" href="#822-pvc">#</a></h5>
<p>PVCæ˜¯èµ„æºçš„ç”³è¯·ï¼Œç”¨æ¥å£°æ˜å¯¹å­˜å‚¨ç©ºé—´ã€è®¿é—®æ¨¡å¼ã€å­˜å‚¨ç±»åˆ«éœ€æ±‚ä¿¡æ¯ã€‚ä¸‹é¢æ˜¯èµ„æºæ¸…å•æ–‡ä»¶:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pvc</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>: <span style="color:#75715e"># è®¿é—®æ¨¡å¼</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># é‡‡ç”¨æ ‡ç­¾å¯¹PVé€‰æ‹©</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#75715e"># å­˜å‚¨ç±»åˆ«</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>: <span style="color:#75715e"># è¯·æ±‚ç©ºé—´</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">5Gi</span>
</span></span></code></pre></div><p>PVC çš„å…³é”®é…ç½®å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li>è®¿é—®æ¨¡å¼ï¼ˆaccessModesï¼‰</li>
</ul>
<p>ç”¨äºæè¿°ç”¨æˆ·åº”ç”¨å¯¹å­˜å‚¨èµ„æºçš„è®¿é—®æƒé™</p>
<ul>
<li>
<p>é€‰æ‹©æ¡ä»¶ï¼ˆselectorï¼‰</p>
<p>é€šè¿‡Label Selectorçš„è®¾ç½®ï¼Œå¯ä½¿PVCå¯¹äºç³»ç»Ÿä¸­å·±å­˜åœ¨çš„PVè¿›è¡Œç­›é€‰</p>
</li>
<li>
<p>å­˜å‚¨ç±»åˆ«ï¼ˆstorageClassNameï¼‰</p>
<p>PVCåœ¨å®šä¹‰æ—¶å¯ä»¥è®¾å®šéœ€è¦çš„åç«¯å­˜å‚¨çš„ç±»åˆ«ï¼Œåªæœ‰è®¾ç½®äº†è¯¥classçš„pvæ‰èƒ½è¢«ç³»ç»Ÿé€‰å‡º</p>
</li>
<li>
<p>èµ„æºè¯·æ±‚ï¼ˆResources ï¼‰</p>
<p>æè¿°å¯¹å­˜å‚¨èµ„æºçš„è¯·æ±‚</p>
</li>
</ul>
<p>å®éªŒ</p>
<ol>
<li>åˆ›å»ºpvc.yamlï¼Œç”³è¯·pv</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pvc1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>: 
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">1Gi</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pvc2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>: 
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">1Gi</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pvc3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>: 
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">1Gi</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºpvc</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pvc.yaml</span>
</span></span><span style="display:flex;"><span>persistentvolumeclaim/pvc1 created
</span></span><span style="display:flex;"><span>persistentvolumeclaim/pvc2 created
</span></span><span style="display:flex;"><span>persistentvolumeclaim/pvc3 created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pvc</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pvc  -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE   VOLUMEMODE
</span></span><span style="display:flex;"><span>pvc1   Bound    pv1      1Gi        RWX                           15s   Filesystem
</span></span><span style="display:flex;"><span>pvc2   Bound    pv2      2Gi        RWX                           15s   Filesystem
</span></span><span style="display:flex;"><span>pvc3   Bound    pv3      3Gi        RWX                           15s   Filesystem
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pv</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pv -o wide</span>
</span></span><span style="display:flex;"><span>NAME  CAPACITY ACCESS MODES  RECLAIM POLICY  STATUS    CLAIM       AGE     VOLUMEMODE
</span></span><span style="display:flex;"><span>pv1    1Gi        RWx        Retain          Bound    dev/pvc1    3h37m    Filesystem
</span></span><span style="display:flex;"><span>pv2    2Gi        RWX        Retain          Bound    dev/pvc2    3h37m    Filesystem
</span></span><span style="display:flex;"><span>pv3    3Gi        RWX        Retain          Bound    dev/pvc3    3h37m    Filesystem   
</span></span></code></pre></div><p>åˆ›å»ºpods.yaml, ä½¿ç”¨pv</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;while true;do echo pod1 &gt;&gt; /root/out.txt; sleep 10; done;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/root/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">claimName</span>: <span style="color:#ae81ff">pvc1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">busybox</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;/bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;while true;do echo pod2 &gt;&gt; /root/out.txt; sleep 10; done;&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/root/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">volume</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">claimName</span>: <span style="color:#ae81ff">pvc2</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºpod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pods.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod1 created
</span></span><span style="display:flex;"><span>pod/pod2 created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME   READY   STATUS    RESTARTS   AGE   IP            NODE   
</span></span><span style="display:flex;"><span>pod1   1/1     Running   <span style="color:#ae81ff">0</span>          14s   10.244.1.69   node1   
</span></span><span style="display:flex;"><span>pod2   1/1     Running   <span style="color:#ae81ff">0</span>          14s   10.244.1.70   node1  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pvc</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pvc -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME   STATUS   VOLUME   CAPACITY   ACCESS MODES      AGE   VOLUMEMODE
</span></span><span style="display:flex;"><span>pvc1   Bound    pv1      1Gi        RWX               94m   Filesystem
</span></span><span style="display:flex;"><span>pvc2   Bound    pv2      2Gi        RWX               94m   Filesystem
</span></span><span style="display:flex;"><span>pvc3   Bound    pv3      3Gi        RWX               94m   Filesystem
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pv</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pv -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM       AGE     VOLUMEMODE
</span></span><span style="display:flex;"><span>pv1    1Gi        RWX            Retain           Bound    dev/pvc1    5h11m   Filesystem
</span></span><span style="display:flex;"><span>pv2    2Gi        RWX            Retain           Bound    dev/pvc2    5h11m   Filesystem
</span></span><span style="display:flex;"><span>pv3    3Gi        RWX            Retain           Bound    dev/pvc3    5h11m   Filesystem
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹nfsä¸­çš„æ–‡ä»¶å­˜å‚¨</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@nfs ~<span style="color:#f92672">]</span><span style="color:#75715e"># more /root/data/pv1/out.txt</span>
</span></span><span style="display:flex;"><span>node1
</span></span><span style="display:flex;"><span>node1
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@nfs ~<span style="color:#f92672">]</span><span style="color:#75715e"># more /root/data/pv2/out.txt</span>
</span></span><span style="display:flex;"><span>node2
</span></span><span style="display:flex;"><span>node2
</span></span></code></pre></div><h5 id="823-ç”Ÿå‘½å‘¨æœŸ">8.2.3 ç”Ÿå‘½å‘¨æœŸ<a hidden class="anchor" aria-hidden="true" href="#823-ç”Ÿå‘½å‘¨æœŸ">#</a></h5>
<p>PVCå’ŒPVæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼ŒPVå’ŒPVCä¹‹é—´çš„ç›¸äº’ä½œç”¨éµå¾ªä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸï¼š</p>
<ul>
<li>
<p>èµ„æºä¾›åº”ï¼šç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºåº•å±‚å­˜å‚¨å’ŒPV</p>
</li>
<li>
<p>èµ„æºç»‘å®šï¼šç”¨æˆ·åˆ›å»ºPVCï¼Œkubernetesè´Ÿè´£æ ¹æ®PVCçš„å£°æ˜å»å¯»æ‰¾PVï¼Œå¹¶ç»‘å®š</p>
<p>åœ¨ç”¨æˆ·å®šä¹‰å¥½PVCä¹‹åï¼Œç³»ç»Ÿå°†æ ¹æ®PVCå¯¹å­˜å‚¨èµ„æºçš„è¯·æ±‚åœ¨å·²å­˜åœ¨çš„PVä¸­é€‰æ‹©ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„</p>
<ul>
<li>ä¸€æ—¦æ‰¾åˆ°ï¼Œå°±å°†è¯¥PVä¸ç”¨æˆ·å®šä¹‰çš„PVCè¿›è¡Œç»‘å®šï¼Œç”¨æˆ·çš„åº”ç”¨å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªPVCäº†</li>
<li>å¦‚æœæ‰¾ä¸åˆ°ï¼ŒPVCåˆ™ä¼šæ— é™æœŸå¤„äºPendingçŠ¶æ€ï¼Œç›´åˆ°ç­‰åˆ°ç³»ç»Ÿç®¡ç†å‘˜åˆ›å»ºäº†ä¸€ä¸ªç¬¦åˆå…¶è¦æ±‚çš„PV</li>
</ul>
<p>PVä¸€æ—¦ç»‘å®šåˆ°æŸä¸ªPVCä¸Šï¼Œå°±ä¼šè¢«è¿™ä¸ªPVCç‹¬å ï¼Œä¸èƒ½å†ä¸å…¶ä»–PVCè¿›è¡Œç»‘å®šäº†</p>
</li>
<li>
<p>èµ„æºä½¿ç”¨ï¼šç”¨æˆ·å¯åœ¨podä¸­åƒvolumeä¸€æ ·ä½¿ç”¨pvc</p>
<p>Podä½¿ç”¨Volumeçš„å®šä¹‰ï¼Œå°†PVCæŒ‚è½½åˆ°å®¹å™¨å†…çš„æŸä¸ªè·¯å¾„è¿›è¡Œä½¿ç”¨ã€‚</p>
</li>
<li>
<p>èµ„æºé‡Šæ”¾ï¼šç”¨æˆ·åˆ é™¤pvcæ¥é‡Šæ”¾pv</p>
<p>å½“å­˜å‚¨èµ„æºä½¿ç”¨å®Œæ¯•åï¼Œç”¨æˆ·å¯ä»¥åˆ é™¤PVCï¼Œä¸è¯¥PVCç»‘å®šçš„PVå°†ä¼šè¢«æ ‡è®°ä¸ºâ€œå·²é‡Šæ”¾â€ï¼Œä½†è¿˜ä¸èƒ½ç«‹åˆ»ä¸å…¶ä»–PVCè¿›è¡Œç»‘å®šã€‚é€šè¿‡ä¹‹å‰PVCå†™å…¥çš„æ•°æ®å¯èƒ½è¿˜è¢«ç•™åœ¨å­˜å‚¨è®¾å¤‡ä¸Šï¼Œåªæœ‰åœ¨æ¸…é™¤ä¹‹åè¯¥PVæ‰èƒ½å†æ¬¡ä½¿ç”¨ã€‚</p>
</li>
<li>
<p>èµ„æºå›æ”¶ï¼škubernetesæ ¹æ®pvè®¾ç½®çš„å›æ”¶ç­–ç•¥è¿›è¡Œèµ„æºçš„å›æ”¶</p>
<p>å¯¹äºPVï¼Œç®¡ç†å‘˜å¯ä»¥è®¾å®šå›æ”¶ç­–ç•¥ï¼Œç”¨äºè®¾ç½®ä¸ä¹‹ç»‘å®šçš„PVCé‡Šæ”¾èµ„æºä¹‹åå¦‚ä½•å¤„ç†é—ç•™æ•°æ®çš„é—®é¢˜ã€‚åªæœ‰PVçš„å­˜å‚¨ç©ºé—´å®Œæˆå›æ”¶ï¼Œæ‰èƒ½ä¾›æ–°çš„PVCç»‘å®šå’Œä½¿ç”¨</p>
</li>
</ul>
<p><img loading="lazy" src="/kubernetes.images/image-20200515002806726.png" alt="img"  />
</p>
<h4 id="83-é…ç½®å­˜å‚¨">8.3 é…ç½®å­˜å‚¨<a hidden class="anchor" aria-hidden="true" href="#83-é…ç½®å­˜å‚¨">#</a></h4>
<h5 id="831-configmap">8.3.1 ConfigMap<a hidden class="anchor" aria-hidden="true" href="#831-configmap">#</a></h5>
<p>ConfigMapæ˜¯ä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„å­˜å‚¨å·ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ç”¨æ¥å­˜å‚¨é…ç½®ä¿¡æ¯çš„ã€‚</p>
<p>åˆ›å»ºconfigmap.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">info</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    username:admin
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    password:123456</span>    
</span></span></code></pre></div><p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨æ­¤é…ç½®æ–‡ä»¶åˆ›å»ºconfigmap</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºconfigmap</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f configmap.yaml</span>
</span></span><span style="display:flex;"><span>configmap/configmap created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹configmapè¯¦æƒ…</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe cm configmap -n dev</span>
</span></span><span style="display:flex;"><span>Name:         configmap
</span></span><span style="display:flex;"><span>Namespace:    dev
</span></span><span style="display:flex;"><span>Labels:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Data
</span></span><span style="display:flex;"><span><span style="color:#f92672">====</span>
</span></span><span style="display:flex;"><span>info:
</span></span><span style="display:flex;"><span>----
</span></span><span style="display:flex;"><span>username:admin
</span></span><span style="display:flex;"><span>password:123456
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Events:  &lt;none&gt;
</span></span></code></pre></div><p>æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ªpod-configmap.yamlï¼Œå°†ä¸Šé¢åˆ›å»ºçš„configmapæŒ‚è½½è¿›å»</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-configmap</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># å°†configmapæŒ‚è½½åˆ°ç›®å½•</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/configmap/config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>: <span style="color:#75715e"># å¼•ç”¨configmap</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">configMap</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">configmap</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºpod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-configmap.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-configmap created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod pod-configmap -n dev</span>
</span></span><span style="display:flex;"><span>NAME            READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod-configmap   1/1     Running   <span style="color:#ae81ff">0</span>          6s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#è¿›å…¥å®¹å™¨</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl exec -it pod-configmap -n dev /bin/sh</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cd /configmap/config/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ls</span>
</span></span><span style="display:flex;"><span>info
</span></span><span style="display:flex;"><span><span style="color:#75715e"># more info</span>
</span></span><span style="display:flex;"><span>username:admin
</span></span><span style="display:flex;"><span>password:123456
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯ä»¥çœ‹åˆ°æ˜ å°„å·²ç»æˆåŠŸï¼Œæ¯ä¸ªconfigmapéƒ½æ˜ å°„æˆäº†ä¸€ä¸ªç›®å½•</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># key---&gt;æ–‡ä»¶     value----&gt;æ–‡ä»¶ä¸­çš„å†…å®¹</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ­¤æ—¶å¦‚æœæ›´æ–°configmapçš„å†…å®¹, å®¹å™¨ä¸­çš„å€¼ä¹Ÿä¼šåŠ¨æ€æ›´æ–°</span>
</span></span></code></pre></div><h5 id="832-secret">8.3.2 Secret<a hidden class="anchor" aria-hidden="true" href="#832-secret">#</a></h5>
<p>åœ¨kubernetesä¸­ï¼Œè¿˜å­˜åœ¨ä¸€ç§å’ŒConfigMapéå¸¸ç±»ä¼¼çš„å¯¹è±¡ï¼Œç§°ä¸ºSecretå¯¹è±¡ã€‚å®ƒä¸»è¦ç”¨äºå­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å¯†ç ã€ç§˜é’¥ã€è¯ä¹¦ç­‰ç­‰ã€‚</p>
<ol>
<li>é¦–å…ˆä½¿ç”¨base64å¯¹æ•°æ®è¿›è¡Œç¼–ç </li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># echo -n &#39;admin&#39; | base64 #å‡†å¤‡username</span>
</span></span><span style="display:flex;"><span>YWRtaW4<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># echo -n &#39;123456&#39; | base64 #å‡†å¤‡password</span>
</span></span><span style="display:flex;"><span>MTIzNDU2
</span></span></code></pre></div><p>æ¥ä¸‹æ¥ç¼–å†™secret.yamlï¼Œå¹¶åˆ›å»ºSecret</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">secret</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">Opaque</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">username</span>: <span style="color:#ae81ff">YWRtaW4=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">password</span>: <span style="color:#ae81ff">MTIzNDU2</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºsecret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f secret.yaml</span>
</span></span><span style="display:flex;"><span>secret/secret created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹secretè¯¦æƒ…</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe secret secret -n dev</span>
</span></span><span style="display:flex;"><span>Name:         secret
</span></span><span style="display:flex;"><span>Namespace:    dev
</span></span><span style="display:flex;"><span>Labels:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex;"><span>Type:  Opaque
</span></span><span style="display:flex;"><span>Data
</span></span><span style="display:flex;"><span><span style="color:#f92672">====</span>
</span></span><span style="display:flex;"><span>password:  <span style="color:#ae81ff">6</span> bytes
</span></span><span style="display:flex;"><span>username:  <span style="color:#ae81ff">5</span> bytes
</span></span></code></pre></div><p>åˆ›å»ºpod-secret.yamlï¼Œå°†ä¸Šé¢åˆ›å»ºçš„secretæŒ‚è½½è¿›å»ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pod-secret</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># å°†secretæŒ‚è½½åˆ°ç›®å½•</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/secret/config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">secret</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">secret</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºpod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pod-secret.yaml</span>
</span></span><span style="display:flex;"><span>pod/pod-secret created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod pod-secret -n dev</span>
</span></span><span style="display:flex;"><span>NAME            READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod-secret      1/1     Running   <span style="color:#ae81ff">0</span>          2m28s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è¿›å…¥å®¹å™¨ï¼ŒæŸ¥çœ‹secretä¿¡æ¯ï¼Œå‘ç°å·²ç»è‡ªåŠ¨è§£ç äº†</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl exec -it pod-secret /bin/sh -n dev</span>
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># ls /secret/config/</span>
</span></span><span style="display:flex;"><span>password  username
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># more /secret/config/username</span>
</span></span><span style="display:flex;"><span>admin
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># more /secret/config/password</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">123456</span>
</span></span></code></pre></div><p>è‡³æ­¤ï¼Œå·²ç»å®ç°äº†åˆ©ç”¨secretå®ç°äº†ä¿¡æ¯çš„ç¼–ç ã€‚</p>
<h3 id="9-å®‰å…¨è®¤è¯">9. å®‰å…¨è®¤è¯<a hidden class="anchor" aria-hidden="true" href="#9-å®‰å…¨è®¤è¯">#</a></h3>
<h4 id="91-è®¿é—®æ§åˆ¶æ¦‚è¿°">9.1 è®¿é—®æ§åˆ¶æ¦‚è¿°<a hidden class="anchor" aria-hidden="true" href="#91-è®¿é—®æ§åˆ¶æ¦‚è¿°">#</a></h4>
<p>Kubernetesä½œä¸ºä¸€ä¸ªåˆ†å¸ƒå¼é›†ç¾¤çš„ç®¡ç†å·¥å…·ï¼Œä¿è¯é›†ç¾¤çš„å®‰å…¨æ€§æ˜¯å…¶ä¸€ä¸ªé‡è¦çš„ä»»åŠ¡ã€‚æ‰€è°“çš„å®‰å…¨æ€§å…¶å®å°±æ˜¯ä¿è¯å¯¹Kubernetesçš„å„ç§å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯å’Œé‰´æƒæ“ä½œã€‚</p>
<p>å®¢æˆ·ç«¯</p>
<p>åœ¨Kubernetesé›†ç¾¤ä¸­ï¼Œå®¢æˆ·ç«¯é€šå¸¸æœ‰ä¸¤ç±»ï¼š</p>
<ul>
<li>User Accountï¼šä¸€èˆ¬æ˜¯ç‹¬ç«‹äºkubernetesä¹‹å¤–çš„å…¶ä»–æœåŠ¡ç®¡ç†çš„ç”¨æˆ·è´¦å·ã€‚</li>
<li>Service Accountï¼škubernetesç®¡ç†çš„è´¦å·ï¼Œç”¨äºä¸ºPodä¸­çš„æœåŠ¡è¿›ç¨‹åœ¨è®¿é—®Kubernetesæ—¶æä¾›èº«ä»½æ ‡è¯†ã€‚</li>
</ul>
<p><img loading="lazy" src="/kubernetes.images/image-20200520102949189.png" alt="img"  />
</p>
<p>è®¤è¯ã€æˆæƒä¸å‡†å…¥æ§åˆ¶</p>
<p>ApiServeræ˜¯è®¿é—®åŠç®¡ç†èµ„æºå¯¹è±¡çš„å”¯ä¸€å…¥å£ã€‚ä»»ä½•ä¸€ä¸ªè¯·æ±‚è®¿é—®ApiServerï¼Œéƒ½è¦ç»è¿‡ä¸‹é¢ä¸‰ä¸ªæµç¨‹ï¼š</p>
<ul>
<li>Authenticationï¼ˆè®¤è¯ï¼‰ï¼šèº«ä»½é‰´åˆ«ï¼Œåªæœ‰æ­£ç¡®çš„è´¦å·æ‰èƒ½å¤Ÿé€šè¿‡è®¤è¯</li>
<li>Authorizationï¼ˆæˆæƒï¼‰ï¼š åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰æƒé™å¯¹è®¿é—®çš„èµ„æºæ‰§è¡Œç‰¹å®šçš„åŠ¨ä½œ</li>
<li>Admission Controlï¼ˆå‡†å…¥æ§åˆ¶ï¼‰ï¼šç”¨äºè¡¥å……æˆæƒæœºåˆ¶ä»¥å®ç°æ›´åŠ ç²¾ç»†çš„è®¿é—®æ§åˆ¶åŠŸèƒ½ã€‚</li>
</ul>
<p><img loading="lazy" src="/kubernetes.images/image-20200520103942580.png" alt="img"  />
</p>
<h4 id="92-è®¤è¯ç®¡ç†">9.2 è®¤è¯ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#92-è®¤è¯ç®¡ç†">#</a></h4>
<p>Kubernetesé›†ç¾¤å®‰å…¨çš„æœ€å…³é”®ç‚¹åœ¨äºå¦‚ä½•è¯†åˆ«å¹¶è®¤è¯å®¢æˆ·ç«¯èº«ä»½ï¼Œå®ƒæä¾›äº†3ç§å®¢æˆ·ç«¯èº«ä»½è®¤è¯æ–¹å¼ï¼š</p>
<ul>
<li>
<p>HTTP Baseè®¤è¯ï¼šé€šè¿‡ç”¨æˆ·å+å¯†ç çš„æ–¹å¼è®¤è¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>    è¿™ç§è®¤è¯æ–¹å¼æ˜¯æŠŠâ€œç”¨æˆ·å:å¯†ç â€ç”¨BASE64ç®—æ³•è¿›è¡Œç¼–ç åçš„å­—ç¬¦ä¸²æ”¾åœ¨HTTPè¯·æ±‚ä¸­çš„Header AuthorizationåŸŸé‡Œå‘é€ç»™æœåŠ¡ç«¯ã€‚æœåŠ¡ç«¯æ”¶åˆ°åè¿›è¡Œè§£ç ï¼Œè·å–ç”¨æˆ·ååŠå¯†ç ï¼Œç„¶åè¿›è¡Œç”¨æˆ·èº«ä»½è®¤è¯çš„è¿‡ç¨‹ã€‚
</span></span></code></pre></div></li>
<li>
<p>HTTP Tokenè®¤è¯ï¼šé€šè¿‡ä¸€ä¸ªTokenæ¥è¯†åˆ«åˆæ³•ç”¨æˆ·</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>    è¿™ç§è®¤è¯æ–¹å¼æ˜¯ç”¨ä¸€ä¸ªå¾ˆé•¿çš„éš¾ä»¥è¢«æ¨¡ä»¿çš„å­—ç¬¦ä¸²--Tokenæ¥è¡¨æ˜å®¢æˆ·èº«ä»½çš„ä¸€ç§æ–¹å¼ã€‚æ¯ä¸ªTokenå¯¹åº”ä¸€ä¸ªç”¨æˆ·åï¼Œå½“å®¢æˆ·ç«¯å‘èµ·APIè°ƒç”¨è¯·æ±‚æ—¶ï¼Œéœ€è¦åœ¨HTTP Headeré‡Œæ”¾å…¥Tokenï¼ŒAPI Serveræ¥åˆ°Tokenåä¼šè·ŸæœåŠ¡å™¨ä¸­ä¿å­˜çš„tokenè¿›è¡Œæ¯”å¯¹ï¼Œç„¶åè¿›è¡Œç”¨æˆ·èº«ä»½è®¤è¯çš„è¿‡ç¨‹ã€‚
</span></span></code></pre></div></li>
<li>
<p>HTTPSè¯ä¹¦è®¤è¯ï¼šåŸºäºCAæ ¹è¯ä¹¦ç­¾åçš„åŒå‘æ•°å­—è¯ä¹¦è®¤è¯æ–¹å¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>    è¿™ç§è®¤è¯æ–¹å¼æ˜¯å®‰å…¨æ€§æœ€é«˜çš„ä¸€ç§æ–¹å¼ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿæ˜¯æ“ä½œèµ·æ¥æœ€éº»çƒ¦çš„ä¸€ç§æ–¹å¼ã€‚
</span></span></code></pre></div></li>
</ul>
<p><img loading="lazy" src="/kubernetes.images/image-20200518211037434.png" alt="img"  />
</p>
<p>HTTPSè®¤è¯å¤§ä½“åˆ†ä¸º3ä¸ªè¿‡ç¨‹ï¼š</p>
<ol>
<li>
<p>è¯ä¹¦ç”³è¯·å’Œä¸‹å‘</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>  HTTPSé€šä¿¡åŒæ–¹çš„æœåŠ¡å™¨å‘CAæœºæ„ç”³è¯·è¯ä¹¦ï¼ŒCAæœºæ„ä¸‹å‘æ ¹è¯ä¹¦ã€æœåŠ¡ç«¯è¯ä¹¦åŠç§é’¥ç»™ç”³è¯·è€…
</span></span></code></pre></div></li>
<li>
<p>å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„åŒå‘è®¤è¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>  1&gt; å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡ç«¯ä¸‹å‘è‡ªå·±çš„è¯ä¹¦ç»™å®¢æˆ·ç«¯ï¼Œ
</span></span><span style="display:flex;"><span>     å®¢æˆ·ç«¯æ¥æ”¶åˆ°è¯ä¹¦åï¼Œé€šè¿‡ç§é’¥è§£å¯†è¯ä¹¦ï¼Œåœ¨è¯ä¹¦ä¸­è·å¾—æœåŠ¡ç«¯çš„å…¬é’¥ï¼Œ
</span></span><span style="display:flex;"><span>     å®¢æˆ·ç«¯åˆ©ç”¨æœåŠ¡å™¨ç«¯çš„å…¬é’¥è®¤è¯è¯ä¹¦ä¸­çš„ä¿¡æ¯ï¼Œå¦‚æœä¸€è‡´ï¼Œåˆ™è®¤å¯è¿™ä¸ªæœåŠ¡å™¨
</span></span><span style="display:flex;"><span>  2&gt; å®¢æˆ·ç«¯å‘é€è‡ªå·±çš„è¯ä¹¦ç»™æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡ç«¯æ¥æ”¶åˆ°è¯ä¹¦åï¼Œé€šè¿‡ç§é’¥è§£å¯†è¯ä¹¦ï¼Œ
</span></span><span style="display:flex;"><span>     åœ¨è¯ä¹¦ä¸­è·å¾—å®¢æˆ·ç«¯çš„å…¬é’¥ï¼Œå¹¶ç”¨è¯¥å…¬é’¥è®¤è¯è¯ä¹¦ä¿¡æ¯ï¼Œç¡®è®¤å®¢æˆ·ç«¯æ˜¯å¦åˆæ³•
</span></span></code></pre></div></li>
<li>
<p>æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>  æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯åå•†å¥½åŠ å¯†æ–¹æ¡ˆåï¼Œå®¢æˆ·ç«¯ä¼šäº§ç”Ÿä¸€ä¸ªéšæœºçš„ç§˜é’¥å¹¶åŠ å¯†ï¼Œç„¶åå‘é€åˆ°æœåŠ¡å™¨ç«¯ã€‚
</span></span><span style="display:flex;"><span>  æœåŠ¡å™¨ç«¯æ¥æ”¶è¿™ä¸ªç§˜é’¥åï¼ŒåŒæ–¹æ¥ä¸‹æ¥é€šä¿¡çš„æ‰€æœ‰å†…å®¹éƒ½é€šè¿‡è¯¥éšæœºç§˜é’¥åŠ å¯†
</span></span></code></pre></div></li>
</ol>
<blockquote>
<p>æ³¨æ„: Kuberneteså…è®¸åŒæ—¶é…ç½®å¤šç§è®¤è¯æ–¹å¼ï¼Œåªè¦å…¶ä¸­ä»»æ„ä¸€ä¸ªæ–¹å¼è®¤è¯é€šè¿‡å³å¯</p>
</blockquote>
<h4 id="93-æˆæƒç®¡ç†">9.3 æˆæƒç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#93-æˆæƒç®¡ç†">#</a></h4>
<p>æˆæƒå‘ç”Ÿåœ¨è®¤è¯æˆåŠŸä¹‹åï¼Œé€šè¿‡è®¤è¯å°±å¯ä»¥çŸ¥é“è¯·æ±‚ç”¨æˆ·æ˜¯è°ï¼Œ ç„¶åKubernetesä¼šæ ¹æ®äº‹å…ˆå®šä¹‰çš„æˆæƒç­–ç•¥æ¥å†³å®šç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±ç§°ä¸ºæˆæƒã€‚</p>
<p>æ¯ä¸ªå‘é€åˆ°ApiServerçš„è¯·æ±‚éƒ½å¸¦ä¸Šäº†ç”¨æˆ·å’Œèµ„æºçš„ä¿¡æ¯ï¼šæ¯”å¦‚å‘é€è¯·æ±‚çš„ç”¨æˆ·ã€è¯·æ±‚çš„è·¯å¾„ã€è¯·æ±‚çš„åŠ¨ä½œç­‰ï¼Œæˆæƒå°±æ˜¯æ ¹æ®è¿™äº›ä¿¡æ¯å’Œæˆæƒç­–ç•¥è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç¬¦åˆç­–ç•¥ï¼Œåˆ™è®¤ä¸ºæˆæƒé€šè¿‡ï¼Œå¦åˆ™ä¼šè¿”å›é”™è¯¯ã€‚</p>
<p>API Serverç›®å‰æ”¯æŒä»¥ä¸‹å‡ ç§æˆæƒç­–ç•¥ï¼š</p>
<ul>
<li>AlwaysDenyï¼šè¡¨ç¤ºæ‹’ç»æ‰€æœ‰è¯·æ±‚ï¼Œä¸€èˆ¬ç”¨äºæµ‹è¯•</li>
<li>AlwaysAllowï¼šå…è®¸æ¥æ”¶æ‰€æœ‰è¯·æ±‚ï¼Œç›¸å½“äºé›†ç¾¤ä¸éœ€è¦æˆæƒæµç¨‹ï¼ˆKubernetesé»˜è®¤çš„ç­–ç•¥ï¼‰</li>
<li>ABACï¼šåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼Œè¡¨ç¤ºä½¿ç”¨ç”¨æˆ·é…ç½®çš„æˆæƒè§„åˆ™å¯¹ç”¨æˆ·è¯·æ±‚è¿›è¡ŒåŒ¹é…å’Œæ§åˆ¶</li>
<li>Webhookï¼šé€šè¿‡è°ƒç”¨å¤–éƒ¨RESTæœåŠ¡å¯¹ç”¨æˆ·è¿›è¡Œæˆæƒ</li>
<li>Nodeï¼šæ˜¯ä¸€ç§ä¸“ç”¨æ¨¡å¼ï¼Œç”¨äºå¯¹kubeletå‘å‡ºçš„è¯·æ±‚è¿›è¡Œè®¿é—®æ§åˆ¶</li>
<li>RBACï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆkubeadmå®‰è£…æ–¹å¼ä¸‹çš„é»˜è®¤é€‰é¡¹ï¼‰</li>
</ul>
<p>RBAC(Role-Based Access Control) åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œä¸»è¦æ˜¯åœ¨æè¿°ä¸€ä»¶äº‹æƒ…ï¼šç»™å“ªäº›å¯¹è±¡æˆäºˆäº†å“ªäº›æƒé™</p>
<p>å…¶ä¸­æ¶‰åŠåˆ°äº†ä¸‹é¢å‡ ä¸ªæ¦‚å¿µï¼š</p>
<ul>
<li>å¯¹è±¡ï¼šUserã€Groupsã€ServiceAccount</li>
<li>è§’è‰²ï¼šä»£è¡¨ç€ä¸€ç»„å®šä¹‰åœ¨èµ„æºä¸Šçš„å¯æ“ä½œåŠ¨ä½œ(æƒé™)çš„é›†åˆ</li>
<li>ç»‘å®šï¼šå°†å®šä¹‰å¥½çš„è§’è‰²è·Ÿç”¨æˆ·ç»‘å®šåœ¨ä¸€èµ·</li>
</ul>
<p><img loading="lazy" src="/kubernetes.images/image-20200519181209566.png" alt="img"  />
</p>
<p>RBACå¼•å…¥äº†4ä¸ªé¡¶çº§èµ„æºå¯¹è±¡ï¼š</p>
<ul>
<li>Roleã€ClusterRoleï¼šè§’è‰²ï¼Œç”¨äºæŒ‡å®šä¸€ç»„æƒé™</li>
<li>RoleBindingã€ClusterRoleBindingï¼šè§’è‰²ç»‘å®šï¼Œç”¨äºå°†è§’è‰²ï¼ˆæƒé™ï¼‰èµ‹äºˆç»™å¯¹è±¡</li>
</ul>
<p>Roleã€ClusterRole</p>
<p>ä¸€ä¸ªè§’è‰²å°±æ˜¯ä¸€ç»„æƒé™çš„é›†åˆï¼Œè¿™é‡Œçš„æƒé™éƒ½æ˜¯è®¸å¯å½¢å¼çš„ï¼ˆç™½åå•ï¼‰ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Roleåªèƒ½å¯¹å‘½åç©ºé—´å†…çš„èµ„æºè¿›è¡Œæˆæƒï¼Œéœ€è¦æŒ‡å®šnameapce</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]  <span style="color:#75715e"># æ”¯æŒçš„APIç»„åˆ—è¡¨,&#34;&#34; ç©ºå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºæ ¸å¿ƒAPIç¾¤</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;pods&#34;</span>] <span style="color:#75715e"># æ”¯æŒçš„èµ„æºå¯¹è±¡åˆ—è¡¨</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>] <span style="color:#75715e"># å…è®¸çš„å¯¹èµ„æºå¯¹è±¡çš„æ“ä½œæ–¹æ³•åˆ—è¡¨</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># ClusterRoleå¯ä»¥å¯¹é›†ç¾¤èŒƒå›´å†…èµ„æºã€è·¨namespacesçš„èŒƒå›´èµ„æºã€éèµ„æºç±»å‹è¿›è¡Œæˆæƒ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-clusterrole</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;pods&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>]
</span></span></code></pre></div><p>éœ€è¦è¯¦ç»†è¯´æ˜çš„æ˜¯ï¼Œrulesä¸­çš„å‚æ•°ï¼š</p>
<ul>
<li>
<p>apiGroups: æ”¯æŒçš„APIç»„åˆ—è¡¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;</span>,<span style="color:#e6db74">&#34;apps&#34;</span>, <span style="color:#e6db74">&#34;autoscaling&#34;</span>, <span style="color:#e6db74">&#34;batch&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>resourcesï¼šæ”¯æŒçš„èµ„æºå¯¹è±¡åˆ—è¡¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#e6db74">&#34;services&#34;</span>, <span style="color:#e6db74">&#34;endpoints&#34;</span>, <span style="color:#e6db74">&#34;pods&#34;</span>,<span style="color:#e6db74">&#34;secrets&#34;</span>,<span style="color:#e6db74">&#34;configmaps&#34;</span>,<span style="color:#e6db74">&#34;crontabs&#34;</span>,<span style="color:#e6db74">&#34;deployments&#34;</span>,<span style="color:#e6db74">&#34;jobs&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;nodes&#34;</span>,<span style="color:#e6db74">&#34;rolebindings&#34;</span>,<span style="color:#e6db74">&#34;clusterroles&#34;</span>,<span style="color:#e6db74">&#34;daemonsets&#34;</span>,<span style="color:#e6db74">&#34;replicasets&#34;</span>,<span style="color:#e6db74">&#34;statefulsets&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;horizontalpodautoscalers&#34;</span>,<span style="color:#e6db74">&#34;replicationcontrollers&#34;</span>,<span style="color:#e6db74">&#34;cronjobs&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>verbsï¼šå¯¹èµ„æºå¯¹è±¡çš„æ“ä½œæ–¹æ³•åˆ—è¡¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>, <span style="color:#e6db74">&#34;create&#34;</span>, <span style="color:#e6db74">&#34;update&#34;</span>, <span style="color:#e6db74">&#34;patch&#34;</span>, <span style="color:#e6db74">&#34;delete&#34;</span>, <span style="color:#e6db74">&#34;exec&#34;</span>
</span></span></code></pre></div></li>
</ul>
<p>RoleBindingã€ClusterRoleBinding</p>
<p>è§’è‰²ç»‘å®šç”¨æ¥æŠŠä¸€ä¸ªè§’è‰²ç»‘å®šåˆ°ä¸€ä¸ªç›®æ ‡å¯¹è±¡ä¸Šï¼Œç»‘å®šç›®æ ‡å¯ä»¥æ˜¯Userã€Groupæˆ–è€…ServiceAccountã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># RoleBindingå¯ä»¥å°†åŒä¸€namespaceä¸­çš„subjectç»‘å®šåˆ°æŸä¸ªRoleä¸‹ï¼Œåˆ™æ­¤subjectå³å…·æœ‰è¯¥Roleå®šä¹‰çš„æƒé™</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-role-binding</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">User</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">heima</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-role</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># ClusterRoleBindingåœ¨æ•´ä¸ªé›†ç¾¤çº§åˆ«å’Œæ‰€æœ‰namespaceså°†ç‰¹å®šçš„subjectä¸ClusterRoleç»‘å®šï¼Œæˆäºˆæƒé™</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span> <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-clusterrole-binding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">User</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">heima</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-clusterrole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span></code></pre></div><p>RoleBindingå¼•ç”¨ClusterRoleè¿›è¡Œæˆæƒ</p>
<p>RoleBindingå¯ä»¥å¼•ç”¨ClusterRoleï¼Œå¯¹å±äºåŒä¸€å‘½åç©ºé—´å†…ClusterRoleå®šä¹‰çš„èµ„æºä¸»ä½“è¿›è¡Œæˆæƒã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>    ä¸€ç§å¾ˆå¸¸ç”¨çš„åšæ³•å°±æ˜¯ï¼Œé›†ç¾¤ç®¡ç†å‘˜ä¸ºé›†ç¾¤èŒƒå›´é¢„å®šä¹‰å¥½ä¸€ç»„è§’è‰²ï¼ˆClusterRoleï¼‰ï¼Œç„¶ååœ¨å¤šä¸ªå‘½åç©ºé—´ä¸­é‡å¤ä½¿ç”¨è¿™äº›ClusterRoleã€‚è¿™æ ·å¯ä»¥å¤§å¹…æé«˜æˆæƒç®¡ç†å·¥ä½œæ•ˆç‡ï¼Œä¹Ÿä½¿å¾—å„ä¸ªå‘½åç©ºé—´ä¸‹çš„åŸºç¡€æ€§æˆæƒè§„åˆ™ä¸ä½¿ç”¨ä½“éªŒä¿æŒä¸€è‡´ã€‚
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># è™½ç„¶authorization-clusterroleæ˜¯ä¸€ä¸ªé›†ç¾¤è§’è‰²ï¼Œä½†æ˜¯å› ä¸ºä½¿ç”¨äº†RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æ‰€ä»¥heimaåªèƒ½è¯»å–devå‘½åç©ºé—´ä¸­çš„èµ„æº</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-role-binding-ns</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">User</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">heima</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-clusterrole</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span></code></pre></div><p>å®æˆ˜ï¼šåˆ›å»ºä¸€ä¸ªåªèƒ½ç®¡ç†devç©ºé—´ä¸‹Podsèµ„æºçš„è´¦å·</p>
<ol>
<li>åˆ›å»ºè´¦å·</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 1) åˆ›å»ºè¯ä¹¦</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pki<span style="color:#f92672">]</span><span style="color:#75715e"># cd /etc/kubernetes/pki/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pki<span style="color:#f92672">]</span><span style="color:#75715e"># (umask 077;openssl genrsa -out devman.key 2048)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2) ç”¨apiserverçš„è¯ä¹¦å»ç­¾ç½²</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2-1) ç­¾åç”³è¯·ï¼Œç”³è¯·çš„ç”¨æˆ·æ˜¯devman,ç»„æ˜¯devgroup</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pki<span style="color:#f92672">]</span><span style="color:#75715e"># openssl req -new -key devman.key -out devman.csr -subj &#34;/CN=devman/O=devgroup&#34;     </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2-2) ç­¾ç½²è¯ä¹¦</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pki<span style="color:#f92672">]</span><span style="color:#75715e"># openssl x509 -req -in devman.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out devman.crt -days 3650</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3) è®¾ç½®é›†ç¾¤ã€ç”¨æˆ·ã€ä¸Šä¸‹æ–‡ä¿¡æ¯</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pki<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config set-cluster kubernetes --embed-certs=true --certificate-authority=/etc/kubernetes/pki/ca.crt --server=https:/192.168.109.100:6443</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pki<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config set-credentials devman --embed-certs=true --client-certificate=/etc/kubernetes/pki/devman.crt --client-key=/etc/kubernetes/pki/devman.key</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pki<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config set-context devman@kubernetes --cluster=kubernetes --user=devman</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ‡æ¢è´¦æˆ·åˆ°devman</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pki<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config use-context devman@kubernetes</span>
</span></span><span style="display:flex;"><span>Switched to context <span style="color:#e6db74">&#34;devman@kubernetes&#34;</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹devä¸‹podï¼Œå‘ç°æ²¡æœ‰æƒé™</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pki<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>Error from server <span style="color:#f92672">(</span>Forbidden<span style="color:#f92672">)</span>: pods is forbidden: User <span style="color:#e6db74">&#34;devman&#34;</span> cannot list resource <span style="color:#e6db74">&#34;pods&#34;</span> in API group <span style="color:#e6db74">&#34;&#34;</span> in the namespace <span style="color:#e6db74">&#34;dev&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># åˆ‡æ¢åˆ°adminè´¦æˆ·</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pki<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config use-context kubernetes-admin@kubernetes</span>
</span></span><span style="display:flex;"><span>Switched to context <span style="color:#e6db74">&#34;kubernetes-admin@kubernetes&#34;</span>.
</span></span></code></pre></div><p>2ï¼‰ åˆ›å»ºRoleå’ŒRoleBindingï¼Œä¸ºdevmanç”¨æˆ·æˆæƒ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dev-role</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">apiGroups</span>: [<span style="color:#e6db74">&#34;&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>: [<span style="color:#e6db74">&#34;pods&#34;</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">verbs</span>: [<span style="color:#e6db74">&#34;get&#34;</span>, <span style="color:#e6db74">&#34;watch&#34;</span>, <span style="color:#e6db74">&#34;list&#34;</span>]
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">RoleBinding</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">authorization-role-binding</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">subjects</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">User</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">devman</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">roleRef</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Role</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">dev-role</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pki<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f dev-role.yaml</span>
</span></span><span style="display:flex;"><span>role.rbac.authorization.k8s.io/dev-role created
</span></span><span style="display:flex;"><span>rolebinding.rbac.authorization.k8s.io/authorization-role-binding created
</span></span></code></pre></div><p>åˆ‡æ¢è´¦æˆ·ï¼Œå†æ¬¡éªŒè¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ‡æ¢è´¦æˆ·åˆ°devman</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pki<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config use-context devman@kubernetes</span>
</span></span><span style="display:flex;"><span>Switched to context <span style="color:#e6db74">&#34;devman@kubernetes&#34;</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å†æ¬¡æŸ¥çœ‹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pki<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                                 READY   STATUS             RESTARTS   AGE
</span></span><span style="display:flex;"><span>nginx-deployment-66cb59b984-8wp2k    1/1     Running            <span style="color:#ae81ff">0</span>          4d1h
</span></span><span style="display:flex;"><span>nginx-deployment-66cb59b984-dc46j    1/1     Running            <span style="color:#ae81ff">0</span>          4d1h
</span></span><span style="display:flex;"><span>nginx-deployment-66cb59b984-thfck    1/1     Running            <span style="color:#ae81ff">0</span>          4d1h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¸ºäº†ä¸å½±å“åé¢çš„å­¦ä¹ ,åˆ‡å›adminè´¦æˆ·</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 pki<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl config use-context kubernetes-admin@kubernetes</span>
</span></span><span style="display:flex;"><span>Switched to context <span style="color:#e6db74">&#34;kubernetes-admin@kubernetes&#34;</span>.
</span></span></code></pre></div><h4 id="94-å‡†å…¥æ§åˆ¶">9.4 å‡†å…¥æ§åˆ¶<a hidden class="anchor" aria-hidden="true" href="#94-å‡†å…¥æ§åˆ¶">#</a></h4>
<p>é€šè¿‡äº†å‰é¢çš„è®¤è¯å’Œæˆæƒä¹‹åï¼Œè¿˜éœ€è¦ç»è¿‡å‡†å…¥æ§åˆ¶å¤„ç†é€šè¿‡ä¹‹åï¼Œapiserveræ‰ä¼šå¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚</p>
<p>å‡†å…¥æ§åˆ¶æ˜¯ä¸€ä¸ªå¯é…ç½®çš„æ§åˆ¶å™¨åˆ—è¡¨ï¼Œå¯ä»¥é€šè¿‡åœ¨Api-Serverä¸Šé€šè¿‡å‘½ä»¤è¡Œè®¾ç½®é€‰æ‹©æ‰§è¡Œå“ªäº›å‡†å…¥æ§åˆ¶å™¨ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>--admission-control<span style="color:#f92672">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeLabel,
</span></span><span style="display:flex;"><span>                      DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds
</span></span></code></pre></div><p>åªæœ‰å½“æ‰€æœ‰çš„å‡†å…¥æ§åˆ¶å™¨éƒ½æ£€æŸ¥é€šè¿‡ä¹‹åï¼Œapiserveræ‰æ‰§è¡Œè¯¥è¯·æ±‚ï¼Œå¦åˆ™è¿”å›æ‹’ç»ã€‚</p>
<p>å½“å‰å¯é…ç½®çš„Admission Controlå‡†å…¥æ§åˆ¶å¦‚ä¸‹ï¼š</p>
<ul>
<li>AlwaysAdmitï¼šå…è®¸æ‰€æœ‰è¯·æ±‚</li>
<li>AlwaysDenyï¼šç¦æ­¢æ‰€æœ‰è¯·æ±‚ï¼Œä¸€èˆ¬ç”¨äºæµ‹è¯•</li>
<li>AlwaysPullImagesï¼šåœ¨å¯åŠ¨å®¹å™¨ä¹‹å‰æ€»å»ä¸‹è½½é•œåƒ</li>
<li>DenyExecOnPrivilegedï¼šå®ƒä¼šæ‹¦æˆªæ‰€æœ‰æƒ³åœ¨Privileged Containerä¸Šæ‰§è¡Œå‘½ä»¤çš„è¯·æ±‚</li>
<li>ImagePolicyWebhookï¼šè¿™ä¸ªæ’ä»¶å°†å…è®¸åç«¯çš„ä¸€ä¸ªWebhookç¨‹åºæ¥å®Œæˆadmission controllerçš„åŠŸèƒ½ã€‚</li>
<li>Service Accountï¼šå®ç°ServiceAccountå®ç°äº†è‡ªåŠ¨åŒ–</li>
<li>SecurityContextDenyï¼šè¿™ä¸ªæ’ä»¶å°†ä½¿ç”¨SecurityContextçš„Podä¸­çš„å®šä¹‰å…¨éƒ¨å¤±æ•ˆ</li>
<li>ResourceQuotaï¼šç”¨äºèµ„æºé…é¢ç®¡ç†ç›®çš„ï¼Œè§‚å¯Ÿæ‰€æœ‰è¯·æ±‚ï¼Œç¡®ä¿åœ¨namespaceä¸Šçš„é…é¢ä¸ä¼šè¶…æ ‡</li>
<li>LimitRangerï¼šç”¨äºèµ„æºé™åˆ¶ç®¡ç†ï¼Œä½œç”¨äºnamespaceä¸Šï¼Œç¡®ä¿å¯¹Podè¿›è¡Œèµ„æºé™åˆ¶</li>
<li>InitialResourcesï¼šä¸ºæœªè®¾ç½®èµ„æºè¯·æ±‚ä¸é™åˆ¶çš„Podï¼Œæ ¹æ®å…¶é•œåƒçš„å†å²èµ„æºçš„ä½¿ç”¨æƒ…å†µè¿›è¡Œè®¾ç½®</li>
<li>NamespaceLifecycleï¼šå¦‚æœå°è¯•åœ¨ä¸€ä¸ªä¸å­˜åœ¨çš„namespaceä¸­åˆ›å»ºèµ„æºå¯¹è±¡ï¼Œåˆ™è¯¥åˆ›å»ºè¯·æ±‚å°†è¢«æ‹’ç»ã€‚å½“åˆ é™¤ä¸€ä¸ªnamespaceæ—¶ï¼Œç³»ç»Ÿå°†ä¼šåˆ é™¤è¯¥namespaceä¸­æ‰€æœ‰å¯¹è±¡ã€‚</li>
<li>DefaultStorageClassï¼šä¸ºäº†å®ç°å…±äº«å­˜å‚¨çš„åŠ¨æ€ä¾›åº”ï¼Œä¸ºæœªæŒ‡å®šStorageClassæˆ–PVçš„PVCå°è¯•åŒ¹é…é»˜è®¤çš„StorageClassï¼Œå°½å¯èƒ½å‡å°‘ç”¨æˆ·åœ¨ç”³è¯·PVCæ—¶æ‰€éœ€äº†è§£çš„åç«¯å­˜å‚¨ç»†èŠ‚</li>
<li>DefaultTolerationSecondsï¼šè¿™ä¸ªæ’ä»¶ä¸ºé‚£äº›æ²¡æœ‰è®¾ç½®forgiveness tolerationså¹¶å…·æœ‰notready:NoExecuteå’Œunreachable:NoExecuteä¸¤ç§taintsçš„Podè®¾ç½®é»˜è®¤çš„â€œå®¹å¿â€æ—¶é—´ï¼Œä¸º5min</li>
<li>PodSecurityPolicyï¼šè¿™ä¸ªæ’ä»¶ç”¨äºåœ¨åˆ›å»ºæˆ–ä¿®æ”¹Podæ—¶å†³å®šæ˜¯å¦æ ¹æ®Podçš„security contextå’Œå¯ç”¨çš„PodSecurityPolicyå¯¹Podçš„å®‰å…¨ç­–ç•¥è¿›è¡Œæ§åˆ¶</li>
</ul>
<h3 id="10-dashboard">10. DashBoard<a hidden class="anchor" aria-hidden="true" href="#10-dashboard">#</a></h3>
<p>ä¹‹å‰åœ¨kubernetesä¸­å®Œæˆçš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯é€šè¿‡å‘½ä»¤è¡Œå·¥å…·kubectlå®Œæˆçš„ã€‚å…¶å®ï¼Œä¸ºäº†æä¾›æ›´ä¸°å¯Œçš„ç”¨æˆ·ä½“éªŒï¼Œkubernetesè¿˜å¼€å‘äº†ä¸€ä¸ªåŸºäºwebçš„ç”¨æˆ·ç•Œé¢ï¼ˆDashboardï¼‰ã€‚ç”¨æˆ·å¯ä»¥ä½¿ç”¨Dashboardéƒ¨ç½²å®¹å™¨åŒ–çš„åº”ç”¨ï¼Œè¿˜å¯ä»¥ç›‘æ§åº”ç”¨çš„çŠ¶æ€ï¼Œæ‰§è¡Œæ•…éšœæ’æŸ¥ä»¥åŠç®¡ç†kubernetesä¸­å„ç§èµ„æºã€‚</p>
<h4 id="101-éƒ¨ç½²dashboard">10.1 éƒ¨ç½²Dashboard<a hidden class="anchor" aria-hidden="true" href="#101-éƒ¨ç½²dashboard">#</a></h4>
<ol>
<li>ä¸‹è½½yamlï¼Œå¹¶è¿è¡ŒDashboard</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ä¸‹è½½yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># wget  https:/raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¿®æ”¹kubernetes-dashboardçš„Serviceç±»å‹</span>
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  name: kubernetes-dashboard
</span></span><span style="display:flex;"><span>  namespace: kubernetes-dashboard
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  type: NodePort  <span style="color:#75715e"># æ–°å¢</span>
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>    - port: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>      targetPort: <span style="color:#ae81ff">8443</span>
</span></span><span style="display:flex;"><span>      nodePort: <span style="color:#ae81ff">30009</span>  <span style="color:#75715e"># æ–°å¢</span>
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    k8s-app: kubernetes-dashboard
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># éƒ¨ç½²</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f recommended.yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹namespaceä¸‹çš„kubernetes-dashboardä¸‹çš„èµ„æº</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod,svc -n kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span>NAME                                            READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/dashboard-metrics-scraper-c79c65bb7-zwfvw   1/1     Running   <span style="color:#ae81ff">0</span>          111s
</span></span><span style="display:flex;"><span>pod/kubernetes-dashboard-56484d4c5-z95z5        1/1     Running   <span style="color:#ae81ff">0</span>          111s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                               TYPE       CLUSTER-IP      EXTERNAL-IP  PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>         AGE
</span></span><span style="display:flex;"><span>service/dashboard-metrics-scraper  ClusterIP  10.96.89.218    &lt;none&gt;       8000/TCP        111s
</span></span><span style="display:flex;"><span>service/kubernetes-dashboard       NodePort   10.104.178.171  &lt;none&gt;       443:30009/TCP   111s
</span></span></code></pre></div><p>2ï¼‰åˆ›å»ºè®¿é—®è´¦æˆ·ï¼Œè·å–token</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># åˆ›å»ºè´¦å·</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create serviceaccount dashboard-admin -n kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æˆæƒ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01-1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create clusterrolebinding dashboard-admin-rb --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-admin</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è·å–è´¦å·token</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e">#  kubectl get secrets -n kubernetes-dashboard | grep dashboard-admin</span>
</span></span><span style="display:flex;"><span>dashboard-admin-token-xbqhh        kubernetes.io/service-account-token   <span style="color:#ae81ff">3</span>      2m35s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe secrets dashboard-admin-token-xbqhh -n kubernetes-dashboard</span>
</span></span><span style="display:flex;"><span>Name:         dashboard-admin-token-xbqhh
</span></span><span style="display:flex;"><span>Namespace:    kubernetes-dashboard
</span></span><span style="display:flex;"><span>Labels:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:  kubernetes.io/service-account.name: dashboard-admin
</span></span><span style="display:flex;"><span>              kubernetes.io/service-account.uid: 95d84d80-be7a-4d10-a2e0-68f90222d039
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Type:  kubernetes.io/service-account-token
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Data
</span></span><span style="display:flex;"><span><span style="color:#f92672">====</span>
</span></span><span style="display:flex;"><span>namespace:  <span style="color:#ae81ff">20</span> bytes
</span></span><span style="display:flex;"><span>token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImJrYkF4bW5XcDhWcmNGUGJtek5NODFuSXl1aWptMmU2M3o4LTY5a2FKS2cifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4teGJxaGgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiOTVkODRkODAtYmU3YS00ZDEwLWEyZTAtNjhmOTAyMjJkMDM5Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.NAl7e8ZfWWdDoPxkqzJzTB46sK9E8iuJYnUI9vnBaY3Jts7T1g1msjsBnbxzQSYgAG--cV0WYxjndzJY_UWCwaGPrQrt_GunxmOK9AUnzURqm55GR2RXIZtjsWVP2EBatsDgHRmuUbQvTFOvdJB4x3nXcYLN2opAaMqg3rnU2rr-A8zCrIuX_eca12wIp_QiuP3SF-tzpdLpsyRfegTJZl6YnSGyaVkC9id-cxZRb307qdCfXPfCHR_2rt5FVfxARgg_C0e3eFHaaYQO7CitxsnIoIXpOFNAR8aUrmopJyODQIPqBWUehb7FhlU1DCduHnIIXVC_UICZ-MKYewBDLw
</span></span><span style="display:flex;"><span>ca.crt:     <span style="color:#ae81ff">1025</span> bytes
</span></span></code></pre></div><p>3ï¼‰é€šè¿‡æµè§ˆå™¨è®¿é—®Dashboardçš„UI</p>
<p>åœ¨ç™»å½•é¡µé¢ä¸Šè¾“å…¥ä¸Šé¢çš„token</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200520144548997.png" alt="image-20200520144548997"  />
</p>
<p>å‡ºç°ä¸‹é¢çš„é¡µé¢ä»£è¡¨æˆåŠŸ</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200520144959353.png" alt="image-20200520144959353"  />
</p>
<h4 id="102-ä½¿ç”¨dashboard">10.2 ä½¿ç”¨DashBoard<a hidden class="anchor" aria-hidden="true" href="#102-ä½¿ç”¨dashboard">#</a></h4>
<p>æœ¬ç« èŠ‚ä»¥Deploymentä¸ºä¾‹æ¼”ç¤ºDashBoardçš„ä½¿ç”¨</p>
<p>æŸ¥çœ‹</p>
<p>é€‰æ‹©æŒ‡å®šçš„å‘½åç©ºé—´<code>dev</code>ï¼Œç„¶åç‚¹å‡»<code>Deployments</code>ï¼ŒæŸ¥çœ‹devç©ºé—´ä¸‹çš„æ‰€æœ‰deployment</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200520154628679.png" alt="img"  />
</p>
<p>æ‰©ç¼©å®¹</p>
<p>åœ¨<code>Deployment</code>ä¸Šç‚¹å‡»<code>è§„æ¨¡</code>ï¼Œç„¶åæŒ‡å®š<code>ç›®æ ‡å‰¯æœ¬æ•°é‡</code>ï¼Œç‚¹å‡»ç¡®å®š</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200520162605102.png" alt="img"  />
</p>
<p>ç¼–è¾‘</p>
<p>åœ¨<code>Deployment</code>ä¸Šç‚¹å‡»<code>ç¼–è¾‘</code>ï¼Œç„¶åä¿®æ”¹<code>yamlæ–‡ä»¶</code>ï¼Œç‚¹å‡»ç¡®å®š</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200520163253644.png" alt="image-20200520163253644"  />
</p>
<p>æŸ¥çœ‹Pod</p>
<p>ç‚¹å‡»<code>Pods</code>, æŸ¥çœ‹podsåˆ—è¡¨</p>
<p><img loading="lazy" src="/kubernetes.images/image-20200520163552110.png" alt="img"  />
</p>
<p>æ“ä½œPod</p>
<p>é€‰ä¸­æŸä¸ªPodï¼Œå¯ä»¥å¯¹å…¶æ‰§è¡Œæ—¥å¿—ï¼ˆlogsï¼‰ã€è¿›å…¥æ‰§è¡Œï¼ˆexecï¼‰ã€ç¼–è¾‘ã€åˆ é™¤æ“ä½œ</p>
<blockquote>
<p>Dashboardæä¾›äº†kubectlçš„ç»å¤§éƒ¨åˆ†åŠŸèƒ½ï¼Œè¿™é‡Œä¸å†ä¸€ä¸€æ¼”ç¤º</p>
</blockquote>


        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://old.colorfulgz.com/posts/tabby/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Tabby ä¸€æ¬¾å¼ºå¤§è€Œç¾è§‚çš„è·¨å¹³å°ç»ˆç«¯ç¥å™¨</span>
  </a>
  <a class="next" href="https://old.colorfulgz.com/posts/zabbix5%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>zabbix5éƒ¨ç½²å®‰è£…</span>
  </a>
</nav>

        </footer>
    </div>

<style>
    .comments_details summary::marker {
        font-size: 20px;
        content: 'ğŸ‘‰å±•å¼€è¯„è®º';
        color: var(--content);
    }
    .comments_details[open] summary::marker{
        font-size: 20px;
        content: 'ğŸ‘‡å…³é—­è¯„è®º';
        color: var(--content);
    }
</style>


<div>
    <details class="comments_details">
        <summary style="cursor: pointer; margin: 50px 0 20px 0;width: 130px;">
            <span style="font-size: 20px;color: var(--content);">...</span>
        </summary>
        <div id="tcomment"></div>
    </details>
    <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js">
    </script>
    <script>
        twikoo.init({
            envId:  null ,
        el: "#tcomment",
            lang: 'zh-CN',
            region:  null ,
        path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
        })
    </script>
</div>
</article>
</main>

<footer class="footer">
    <span>
        Copyright
        &copy;
        -2024
        <a href="https://old.colorfulgz.com" style="color:#939393;">DevOpsHub</a>
        All Rights Reserved
    </span>
    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;"></a>&nbsp;
    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"
           style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="" style="float:left;margin: 0px 5px 0px 0px;"/>
            
        </a>
    </span>
    <span id="busuanzi_container">
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
        <span class="fa fa-eye"></span> <span id="busuanzi_value_site_pv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"DevOpsHub"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"DevOpsHub"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerText = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"DevOpsHub"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>
</body>

</html>
